-- DROP PROCEDURE process.hmb_account_webservice_wf(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_account_webservice_wf(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
		
	begin	
		
		IF checkCU = 'insert' then
			insert into process.account
			(
				external_id__c
				, corporateregistrationnumber__c
				, name
				, corporaterepresentativename__c
				, ori_cd__c
				, x_contracted_since__c
				, registrysource__c
				, phone
				, fax
				, emailaddress
				, website
				, fleet__c
				, industry
				, numberofemployees
				, x_tot_flt_size__c
				, businesstype__c
				, addr_landing_id
				, billingstreet
				, billingstreet_2__c
				, billingstreet_3__c
				, billingcountry
				, billingcity
				, billingstate
				, billingpostalcode
				, inter_flag
			)
			select
				soe.row_id
			    , soe.X_CNPJ
			    , soe.NAME
			    , soe.X_NICKNAME
			    , soe.ORI_CD
			    , soe.X_CONTRACTED_SINCE
			    , soe.SOURCE_CD
			    , soe.MAIN_PH_NUM
			    , soe.MAIN_FAX_PH_NUM
			    , soe.MAIN_EMAIL_ADDR
			    , soe.URL
			    , soex.X_FLT_ACCT_TYPE
			    , soex.X_FLT_IND_TYPE
			    , soex.ATTRIB_07
			    , soex.X_TOT_FLT_SIZE
			    , soex.X_FLT_ORG_TYPE
			    , sap.row_id
			    , sap.ADDR
			    , sap.ADDR_LINE_2
			    , sap.ADDR_LINE_3
			    , sap.COUNTY
			    , sap.CITY
			    , sap.STATE
			    , sap.ZIPCODE
			    , 'if_in'
			from   
				landing.S_ORG_EXT soe
			join
				landing.S_ORG_EXT_X soex
			on
				soe.row_id = soex.par_row_id
			join
				landing.S_ADDR_PER sap
			on
				soe.pr_addr_id = sap.row_id
			where 
				soe.row_id = PARAM_ID;
		end if;
		IF checkCU !='insert' then
		
		
			update process.account a set
						corporateregistrationnumber__c = soe.X_CNPJ
						--, name = soe.name
						, corporaterepresentativename__c = soe.X_NICKNAME
						, ori_cd__c = soe.ORI_CD
						, x_contracted_since__c = soe.X_CONTRACTED_SINCE
						, registrysource__c = soe.SOURCE_CD
						, phone = soe.MAIN_PH_NUM
						, fax = soe.MAIN_FAX_PH_NUM
						, emailaddress = soe.MAIN_EMAIL_ADDR
						, website = soe.URL
						, inter_flag = 'if_up'
					from landing.S_ORG_EXT as soe
					where 
						a.external_id__c = soe.row_id
					and 
						a.external_id__c = PARAM_ID;
					
				update process.account as a set
						fleet__c = soex.X_FLT_ACCT_TYPE
					    , industry = soex.X_FLT_IND_TYPE
					    , numberofemployees = soex.ATTRIB_07
					    , x_tot_flt_size__c = soex.X_TOT_FLT_SIZE
					    , businesstype__c = soex.X_FLT_ORG_TYPE
					    , inter_flag = 'if_up'
					from landing.S_ORG_EXT_X as soex
					where 
						a.external_id__c = soex.par_row_id
					and 
						a.external_id__c = PARAM_ID;
				
				update process.account as a set
						billingstreet = sap.ADDR
					    , billingstreet_2__c = sap.ADDR_LINE_2
					    , billingstreet_3__c = sap.ADDR_LINE_3
					    , billingcountry = sap.COUNTY
					    , billingcity = sap.CITY
					    , billingstate = sap.STATE
					    , billingpostalcode = sap.ZIPCODE
					    , inter_flag = 'if_up'
					from landing.S_ADDR_PER as sap
					where 
						a.addr_landing_id = sap.row_id
					and 
						a.addr_landing_id = (select sap.row_id from landing.S_ORG_EXT soe join landing.S_ADDR_PER sap on soe.pr_addr_id = sap.row_id where soe.row_id = PARAM_ID);	
			
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_account_webservice_wf(varchar);

CREATE OR REPLACE PROCEDURE process.hmb_account_webservice_wf(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		insert into process.account
		(
			external_id__c
			, corporateregistrationnumber__c
			, name
			, corporaterepresentativename__c
			, ori_cd__c
			, x_contracted_since__c
			, registrysource__c
			, phone
			, fax
			, emailaddress
			, website
			, fleet__c
			, industry
			, numberofemployees
			, x_tot_flt_size__c
			, businesstype__c
			, billingstreet
			, billingstreet_2__c
			, billingstreet_3__c
			, billingcountry
			, billingcity
			, billingstate
			, billingpostalcode
			, inter_flag
		)
		select
			soe.INTEGRATION_ID
		    , soe.X_CNPJ
		    , soe.NAME
		    , soe.X_NICKNAME
		    , soe.ORI_CD
		    , soe.X_CONTRACTED_SINCE
		    , soe.SOURCE_CD
		    , soe.MAIN_PH_NUM
		    , soe.MAIN_FAX_PH_NUM
		    , soe.MAIN_EMAIL_ADDR
		    , soe.URL
		    , soex.X_FLT_ACCT_TYPE
		    , soex.X_FLT_IND_TYPE
		    , soex.ATTRIB_07
		    , soex.X_TOT_FLT_SIZE
		    , soex.X_FLT_ORG_TYPE
		    , sap.ADDR
		    , sap.ADDR_LINE_2
		    , sap.ADDR_LINE_3
		    , sap.COUNTY
		    , sap.CITY
		    , sap.STATE
		    , sap.ZIPCODE
		    , 'if_in'
		from   
			landing.S_ORG_EXT soe
		join
			landing.S_ORG_EXT_X soex
		on
			soe.row_id = soex.par_row_id
		join
			landing.S_ADDR_PER sap
		on
			soe.pr_addr_id = sap.row_id
		where 
			soe.row_id = PARAM_ID; 
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_asset_contact_upsert_webservice_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_asset_contact_upsert_webservice_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	begin
		 
		IF checkCU = 'insert' then
			insert into process.asset_con
			(
				asset_id
                , contact_id
                , relation_type_cd
                , attrib_26
                , external_id__c
                , inter_flag
			)
			select
	            --(select row_id from process.asset where external_id__c = sac.asset_id)
                --, (select row_id from process.account where external_id__c = sac.contact_id)
                sac.asset_id
                , sac.contact_id
                , sac.relation_type_cd
                , sac.attrib_26
                , sac.row_id
                , 'if_in'
			from   
				landing.s_asset_con sac
			where 
				sac.row_id = PARAM_ID;
		end if;
	
		IF checkCU ='update' then
			update process.asset_con pac 
			   set relation_type_cd = sac.relation_type_cd
                , attrib_26 = sac.attrib_26
                , inter_flag = 'if_up'
			from landing.s_asset_con as sac
			where
				pac.external_id__c = sac.row_id
			and 
				pac.external_id__c = param_id;
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_auto_vehicle_rsa_claim_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_auto_vehicle_rsa_claim_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare rowid varchar(22);
	begin
		rowid := concat('proc'::text || lpad(nextval('seq_cx_sr_rsa_x'::regclass)::text, 18, '0'::text))::character varying;
		IF checkcu = 'insert' then
			insert into process.road_side_assistant
			(
				row_id
				, par_row_id
	            , INTEGRATION_ID
	            , REQ_FIRST_NAME
	            , REQ_LAST_NAME
	            , REQ_DOCUMENT
	            , REQ_VEHICLE_REL
	            , CLAIM_DATE
	            , CLAIM_REASON
	            , BRKDWN_DESC
	            , BRKDWN_CD
	            , BRKDWN_NATURE
	            , STATUS_CD
	            , EFF_START_DATE
	            , EFF_END_DATE
	            , EXCHANGE_DATE
	            , MILEAGE
	            , external_id__c
	            , inter_flag
			)
			select
	            rowid
				, rowid
	            , csrx.INTEGRATION_ID
	            , csrx.REQ_FIRST_NAME
	            , csrx.REQ_LAST_NAME
	            , csrx.REQ_DOCUMENT
	            , csrx.REQ_VEHICLE_REL
	            , csrx.CLAIM_DATE
	            , csrx.CLAIM_REASON
	            , csrx.BRKDWN_DESC
	            , csrx.BRKDWN_CD
	            , csrx.BRKDWN_NATURE
	            , csrx.STATUS_CD
	            , csrx.EFF_START_DATE
	            , csrx.EFF_END_DATE
	            , csrx.EXCHANGE_DATE
	            , csrx.MILEAGE
	            , csrx.row_id
	            , 'if_in'
			from   
				landing.CX_SR_RSA_X csrx
			where 
				csrx.row_id = PARAM_ID;
			
			
			insert into process.road_side_assistant_service
			(
				par_row_id
				, "name"
				, createdate__c
				, servicecode__c
				, specialty__c
				, provider__c
				, vehicleproblem__c
				, problemdescription__c
				, tmcpredicted__c
				, important__c
				, requeststatus__c
				, actuationstatus__c
				, addressname__c
				, addressnumber__c
				, addresscomplement__c
				, county__c
				, city__c
				, state__c
				, latitude__c
				, longitude__c
				, reference__c
				, zipcode__c
				, dealername__c
				, dealernickname__c
				, expense__c
				, external_id__c
				, inter_flag
			)
			select
				rowid
	            , ssrx.NAME
				, ssrx.ATTRIB_26
				, ssrx.ATTRIB_35
				, ssrx.ATTRIB_36
				, ssrx.ATTRIB_01
				, ssrx.ATTRIB_37
				, ssrx.X_ATTRIB_50
				, ssrx.ATTRIB_14
				, ssrx.X_ATTRIB_51
				, ssrx.ATTRIB_38
				, ssrx.ATTRIB_39
				, ssrx.ATTRIB_47
				, ssrx.ATTRIB_05
				, ssrx.ATTRIB_02
				, ssrx.ATTRIB_44
				, ssrx.ATTRIB_45
				, ssrx.ATTRIB_40
				, ssrx.ATTRIB_15
				, ssrx.ATTRIB_16
				, ssrx.X_ATTRIB_48
				, ssrx.ATTRIB_06
				, ssrx.ATTRIB_46
				, ssrx.X_ATTRIB_49
				, ssrx.ATTRIB_07
				, ssrx.row_id
				, 'if_in'
			from   
				landing.S_SRV_REQ_XM ssrx
			where 
				ssrx.par_row_id = PARAM_ID;
		end if;
		IF checkCU ='update' then
		
		
			update process.road_side_assistant prsa set
						REQ_FIRST_NAME = csrx.REQ_FIRST_NAME
			            , REQ_LAST_NAME = csrx.REQ_LAST_NAME
			            , REQ_DOCUMENT = csrx.REQ_DOCUMENT
			            , REQ_VEHICLE_REL = csrx.REQ_VEHICLE_REL
			            , CLAIM_DATE = csrx.CLAIM_DATE
			            , CLAIM_REASON = csrx.CLAIM_REASON
			            , BRKDWN_DESC = csrx.BRKDWN_DESC
			            , BRKDWN_CD = csrx.BRKDWN_CD
			            , BRKDWN_NATURE = csrx.BRKDWN_NATURE
			            , STATUS_CD = csrx.STATUS_CD
			            , EFF_START_DATE = csrx.EFF_START_DATE
			            , EFF_END_DATE = csrx.EFF_END_DATE
			            , EXCHANGE_DATE = csrx.EXCHANGE_DATE
			            , MILEAGE = csrx.MILEAGE
			            , inter_flag = 'if_up'
					from landing.CX_SR_RSA_X as csrx
					where 
						prsa.external_id__c = csrx.row_id
					and 
						prsa.external_id__c = param_id;
			
			delete from process.road_side_assistant_service where par_row_id = rowId;
		
			insert into process.road_side_assistant_service
			(
				par_row_id
				, "name"
				, createdate__c
				, servicecode__c
				, specialty__c
				, provider__c
				, vehicleproblem__c
				, problemdescription__c
				, tmcpredicted__c
				, important__c
				, requeststatus__c
				, actuationstatus__c
				, addressname__c
				, addressnumber__c
				, addresscomplement__c
				, county__c
				, city__c
				, state__c
				, latitude__c
				, longitude__c
				, reference__c
				, zipcode__c
				, dealername__c
				, dealernickname__c
				, expense__c
				, external_id__c
				, inter_flag
			)
			select
				rowid
	            , ssrx.NAME
				, ssrx.ATTRIB_26
				, ssrx.ATTRIB_35
				, ssrx.ATTRIB_36
				, ssrx.ATTRIB_01
				, ssrx.ATTRIB_37
				, ssrx.X_ATTRIB_50
				, ssrx.ATTRIB_14
				, ssrx.X_ATTRIB_51
				, ssrx.ATTRIB_38
				, ssrx.ATTRIB_39
				, ssrx.ATTRIB_47
				, ssrx.ATTRIB_05
				, ssrx.ATTRIB_02
				, ssrx.ATTRIB_44
				, ssrx.ATTRIB_45
				, ssrx.ATTRIB_40
				, ssrx.ATTRIB_15
				, ssrx.ATTRIB_16
				, ssrx.X_ATTRIB_48
				, ssrx.ATTRIB_06
				, ssrx.ATTRIB_46
				, ssrx.X_ATTRIB_49
				, ssrx.ATTRIB_07
				, ssrx.row_id
				, 'if_in'
			from   
				landing.S_SRV_REQ_XM ssrx
			where 
				ssrx.par_row_id = PARAM_ID; 
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_auto_vehicle_webservice_wf(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_auto_vehicle_webservice_wf(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare assetrowId varchar(15);
	begin
		assetrowId := concat('proc'::text || lpad(nextval('process.seq_asset'::regclass)::text, 11, '0'::text))::character varying;
		IF checkcu = 'insert' then
			insert into process.asset
			(
				row_id
				, status
				, serialnumber
				, carregistrationnumber__c
				, warranty_start_dt__c
				, billing_date__c
				, oper_status_cd__c
				, ownr_type_cd__c
				, dlr_con_int_id__c
				, enginenumber__c
				, vehicleinternalcolor__c
				, vehiclecolor__c
				, renavam_code__c
				, fueltype__c
				, purchaseprice__c
				, manufacturedate
				, latestmileage__c
				, dealer_rcpt_dt__c
				, vehicledeliverydate__c
				, external_id__c
				, prod_id
				, inter_flag
			)
			select
				assetrowId
	            , lsa.status_cd
	            , lsa.serial_num
	            , lsa.lcns_num
	            , lsa.warranty_start_dt
	            , lsa.asgn_dt
	            , lsa.oper_status_cd
	            , lsa.ownr_type_cd
	            , lsa.dlr_con_int_id
	            , lsax.attrib_38
	            , lsax.attrib_05
	            , lsax.attrib_06
	            , lsaa.x_renavam_code
	            , lsaa.x_fuel
	            , lsaa.prchs_price
	            , lsaa.x_manufacture_year
	            , lsaa.odomtr_sale
	            , lsaa.dealer_rcpt_dt
	            , lsaa.first_sale_dt
	            , lsa.row_id
	            , lsa.prod_id
	            , 'if_in'
			from   
				landing.s_asset lsa
			join
				landing.s_asset_x lsax
			on
				lsa.row_id = lsax.par_row_id
			join
				landing.s_asset_atx lsaa
			on
				lsa.row_id = lsaa.par_row_id
			where 
				lsa.row_id = PARAM_ID;
			
			insert into process.asset_con
			(
				contact_id
	            , relation_type_cd
	            , status_cd
	            , asset_id
	            , external_id__c
	            , inter_flag
			)
			select
                sac.contact_id
                , sac.relation_type_cd
                , sac.status_cd
                , sac.asset_id
                , sac.row_id
                , 'if_in'
			from   
				landing.s_asset_con sac
			where 
				sac.asset_id = PARAM_ID;
			
			update process.asset as pa set 
				account_row_id__c = sac.contact_id
				, "name" = (select DESC_TEXT from landing.S_PROD_INT where row_id = pa.prod_id)
				, fsc__c = (select "name" from landing.S_PROD_INT where row_id = pa.prod_id)
			from landing.s_asset_con as sac
			where 
        		pa.external_id__c = sac.asset_id
        	and 
        		pa.external_id__c = param_id; 
			
			insert into process.asset_accnt
			(
				 accnt_id
	            , rel_type_cd
	            , status_cd
	            , asset_id
	            , external_id__c
	            , inter_flag
			)
			select
                saa.accnt_id
                , saa.rel_type_cd
                , saa.status_cd
                , saa.asset_id
                , saa.row_id
                , 'if_in'
			from   
				landing.s_asset_accnt as saa
			where 
				saa.asset_id = PARAM_ID;
			
			update process.asset as pa set 
				account_row_id__c = saa.accnt_id
				, "name" = (select DESC_TEXT from landing.S_PROD_INT where row_id = pa.prod_id)
				, fsc__c = (select "name" from landing.S_PROD_INT where row_id = pa.prod_id) 
				, inter_flag = 'if_up'
			from landing.s_asset_accnt as saa
			where 
        		pa.external_id__c = saa.asset_id
        	and 
        		pa.external_id__c = param_id; 
			
		end if;
		IF checkcu !='insert' then
		
		
			update process.asset as pa set
						status = lsa.status_cd
						, serialnumber = lsa.serial_num
						, carregistrationnumber__c = lsa.lcns_num
						, warranty_start_dt__c = lsa.warranty_start_dt
						, billing_date__c = lsa.asgn_dt
						, oper_status_cd__c = lsa.oper_status_cd
						, ownr_type_cd__c = lsa.ownr_type_cd
						, dlr_con_int_id__c = lsa.dlr_con_int_id
						, inter_flag = 'if_up'
					from landing.s_asset as lsa
					where 
						pa.external_id__c = lsa.row_id
					and 
						pa.external_id__c = param_id;
					
			update process.asset as pa set
						enginenumber__c = lsax.attrib_38
						, vehicleinternalcolor__c = lsax.attrib_05
						, vehiclecolor__c = lsax.attrib_06
						, inter_flag = 'if_up'
					from landing.s_asset_x as lsax
					where 
						pa.external_id__c = lsax.par_row_id
					and 
						pa.external_id__c = param_id;
					
			update process.asset as pa set
						renavam_code__c = lsaa.x_renavam_code
						, fueltype__c = lsaa.x_fuel
						, purchaseprice__c = lsaa.prchs_price
						, manufacturedate = lsaa.x_manufacture_year
						, latestmileage__c = lsaa.odomtr_sale
						, dealer_rcpt_dt__c = lsaa.dealer_rcpt_dt
						, vehicledeliverydate__c = lsaa.first_sale_dt
						, inter_flag = 'if_up'
					from landing.s_asset_atx as lsaa
					where 
						pa.external_id__c = lsaa.par_row_id
					and 
						pa.external_id__c = param_id;	
					
			update process.asset_con as pac set
						relation_type_cd = sac.relation_type_cd
	            		, status_cd = sac.status_cd
	            		, inter_flag = 'if_up'
	            	from landing.s_asset_con as sac
	            	where 
	            		pac.contact_id = sac.contact_id
	            	and 
	            		pac.asset_id = sac.asset_id
	            	and 
	            		pac.asset_id = param_id;
	            	
	         update process.asset_accnt as paa set
						rel_type_cd = saa.rel_type_cd
	            		, status_cd = saa.status_cd
	            		, inter_flag = 'if_up'
	            	from landing.s_asset_accnt as saa
	            	where 
	            		paa.accnt_id = saa.accnt_id
	            	and 
	            		paa.asset_id = saa.asset_id
	            	and 
	            		paa.asset_id = param_id; 	
			
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_inbound_channel_partner_interface_workflow(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_inbound_channel_partner_interface_workflow(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		IF checkcu = 'insert' then
			insert into process.account
				(
					external_id__c, 
					corporateregistrationnumber__c, 
					name, 
					corporaterepresentativename__c, 
					situationstatusreason__c, 
					dealercode__c, 
					phone, 
					fax, 
					emailaddress__c,
					prtnrshp_start_dt__c,
					region__c,
					website,
					dealershoptype__c,
					personemail, 
					salesflag__c,
					serviceflag__c,
					businesshours__c,
					facebook__c,
					prtnrshp_end_dt__c,
					inter_flag
				)
			select
				soe.INTEGRATION_ID
                , soe.X_CNPJ
                , soe.NAME
                , soe.X_NICKNAME
                --, soe.PRTNR_FLG
                , soe.X_REASON_STATUS
                , soe.OU_NUM
                , soe.MAIN_PH_NUM
                , soe.MAIN_FAX_PH_NUM
                , soe.MAIN_EMAIL_ADDR
                , soe.PRTNRSHP_START_DT
                , soe.REGION
                , soe.URL
                , soex.ATTRIB_39
                , soex.ATTRIB_51 
                , CASE when soex.ATTRIB_10='Y' then true when soex.ATTRIB_10='N' then false else null end as ATTRIB_10
                , CASE when soex.ATTRIB_11='Y' then true when soex.ATTRIB_11='N' then false else null end as ATTRIB_11
                , soex.X_WORKING_HOURS
                , soex.X_SOCIAL_URL
                , sop.PTSHP_END_DT
                --, sap.ADDR_NAME
                , 'if_in'
			from   
				landing.S_ORG_EXT soe
			join
				landing.S_ORG_EXT_X soex
			on
				soe.row_id = soex.par_row_id
			join 
				landing.S_ORG_PRTNR sop
			on
				soe.row_id = sop.par_row_id
			where 
				soe.row_id = PARAM_ID;
		end if;
		IF checkcu !='insert' then
		
		
			update process.account a set
						external_id__c = soe.INTEGRATION_ID, 
						corporateregistrationnumber__c = soe.X_CNPJ, 
						name = soe.NAME, 
						corporaterepresentativename__c = soe.X_NICKNAME, 
						situationstatusreason__c = soe.X_REASON_STATUS, 
						dealercode__c = soe.OU_NUM, 
						phone = soe.MAIN_PH_NUM, 
						fax = soe.MAIN_FAX_PH_NUM, 
						emailaddress__c = soe.MAIN_EMAIL_ADDR,
						prtnrshp_start_dt__c = soe.PRTNRSHP_START_DT,
						region__c = soe.REGION,
						website = soe.URL,
						inter_flag = 'if_up'
					from landing.S_ORG_EXT as soe
					where 
						a.external_id__c = soe.row_id
					and	
						soe.row_id = PARAM_ID;
					
				update process.account as a set
						dealershoptype__c = soex.ATTRIB_39,
						personemail = soex.ATTRIB_51, 
						salesflag__c = CASE when soex.ATTRIB_10='Y' then true when soex.ATTRIB_10='N' then false else null end,
						serviceflag__c = CASE when soex.ATTRIB_11='Y' then true when soex.ATTRIB_11='N' then false else null end,
						businesshours__c = soex.X_WORKING_HOURS,
						facebook__c = soex.X_SOCIAL_URL,
						inter_flag = 'if_up'
					from landing.S_ORG_EXT_X as soex
					where 
						a.external_id__c = soex.par_row_id
					and 
						soex.par_row_id = PARAM_ID;
				
				update process.account as a set 
						prtnrshp_end_dt__c = sop.PTSHP_END_DT
						, inter_flag = 'if_up'
					from landing.S_ORG_PRTNR
					where 
						a.external_id_c = sop.par_row_id
					and
						sop.par_row_id = PARAM_ID;
			
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_inbound_channel_partner_interface_workflow_contact(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_inbound_channel_partner_interface_workflow_contact(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare accountrowId varchar(15);
	declare contactrowId varchar(15);
	begin
		accountrowId := concat('proc'::text || lpad(nextval('process.seq_account'::regclass)::text, 11, '0'::text))::character varying;
		contactrowId := concat('proc'::text || lpad(nextval('process.seq_contact'::regclass)::text, 11, '0'::text))::character varying;
		
		IF checkcu = 'insert' then
			insert into process.account
				(
					row_id
					, external_id__c
					, firstname
					, lastname
					, personemail
					, personhomephone
					, companyphone__pc
					, occupation__pc
					, sanitized__c
					, billingstreet 
					, billingstreet_2__c
					, billingstreet_3__c
					, billingcountry
					, billingcity 
					, billingstate 
					, billinglatitude
					, billinglongitude
					, billingpostalcode
					, addr_landing_id
					, inter_flag
				)
				select
					accountrowId
					, sc.row_id
					, sc.FST_NAME
					, sc.LAST_NAME
		            , sc.EMAIL_ADDR
		            , sc.HOME_PH_NUM
		            , sc.WORK_PH_NUM
		            , sc.JOB_TITLE
		            , CASE when sc.X_SANITIZED_FLG='Y' then true when sc.X_SANITIZED_FLG='N' then false else null end as X_SANITIZED_FLG
		            , sap.ADDR
		            , sap.ADDR_LINE_2
		            , sap.ADDR_LINE_3
		            , sap.COUNTY
		            , sap.CITY
		            , sap.STATE
		            , sap.LATITUDE
		            , sap.LONGITUDE
		            , sap.ZIPCODE
		            , sap.row_id
		            , 'if_in'
		         from   
					landing.S_CONTACT sc
				 join
					landing.S_ADDR_PER sap
				on
					sc.pr_per_addr_id = sap.row_id
				where 
					sc.row_id = PARAM_ID;   
		
		
		
			insert into process.contact
				(
					external_id__c
					, cpf__c
					, firstname
					, lastname
					, email
					, homephone
					, companyphone__c
					, title
					, x_sanitized_flg__c
					, con_cd__c
					, account_row_id
					, inter_flag
				)
				select
					sc.row_id
		            , sc.X_CPF
		            , sc.FST_NAME
		            , sc.LAST_NAME
		            , sc.EMAIL_ADDR
		            , sc.HOME_PH_NUM
		            , sc.WORK_PH_NUM
		            , sc.JOB_TITLE
		            , CASE when sc.X_SANITIZED_FLG='Y' then true when sc.X_SANITIZED_FLG='N' then false else null end as X_SANITIZED_FLG
		            , sc.CON_CD
		            , accountrowId
		            , 'if_in'
				from   
					landing.S_CONTACT sc
				where 
					sc.row_id = PARAM_ID;
		end if;
		IF checkcu !='insert' then
		
				update process.account a set
						firstname = sc.FST_NAME
						, lastname = sc.LAST_NAME
						, personemail = sc.EMAIL_ADDR
						, personhomephone = sc.HOME_PH_NUM
						, companyphone__pc = sc.WORK_PH_NUM
						, occupation__pc = sc.JOB_TITLE
						, sanitized__c = CASE when sc.X_SANITIZED_FLG='Y' then true when sc.X_SANITIZED_FLG='N' then false else null end
						, inter_flag = 'if_up'
					from landing.S_CONTACT as sc
					where 
						a.external_id__c = sc.row_id
					and	
						sc.row_id = PARAM_ID;
					
				update process.contact c set
						external_id__c = sc.INTEGRATION_ID
						, cpf__c = sc.X_CPF
						, firstname = sc.FST_NAME
						, lastname = sc.LAST_NAME
						, email = sc.EMAIL_ADDR
						, homephone = sc.HOME_PH_NUM
						, companyphone__c = sc.WORK_PH_NUM
						, title = sc.JOB_TITLE
						, x_sanitized_flg__c = sc.X_SANITIZED_FLG
						, con_cd__c = sc.CON_CD
						, inter_flag = 'if_up'
					from landing.S_CONTACT as sc
					where 
						c.external_id__c = sc.row_id
					and	
						sc.row_id = PARAM_ID;
			
				update process.account as a set
						billingstreet = sap.ADDR
					    , billingstreet_2__c = sap.ADDR_LINE_2
					    , billingstreet_3__c = sap.ADDR_LINE_3
					    , billingcity = sap.CITY
					    , billingstate = sap.STATE
					    , billinglatitude = sap.LATITUDE
						, billinglongitude = sap.LONGITUDE
					    , billingpostalcode = sap.ZIPCODE
					    , inter_flag = 'if_up'
					from landing.S_ADDR_PER as sap
					where 
						a.addr_landing_id = sap.row_id;	
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_inbound_channel_partner_interface_workflow_contact();

CREATE OR REPLACE PROCEDURE process.hmb_inbound_channel_partner_interface_workflow_contact()
 LANGUAGE plpgsql
AS $procedure$
	declare accountrowId varchar(15);
	declare contactrowId varchar(15);
	begin
		accountrowId := concat('proc'::text || lpad(nextval('process.seq_account'::regclass)::text, 11, '0'::text))::character varying;
		contactrowId := concat('proc'::text || lpad(nextval('process.seq_contact'::regclass)::text, 11, '0'::text))::character varying;
		
		IF checkcu = 'insert' then
			insert into process.account
				(
					row_id
					, external_id__c
					, firstname
					, lastname
					, personemail
					, personhomephone
					, companyphone__pc
					, occupation__pc
					, sanitized__c
					, billingstreet 
					, billingstreet_2__c
					, billingstreet_3__c
					, billingcountry
					, billingcity 
					, billingstate 
					, billinglatitude
					, billinglongitude
					, billingpostalcode
					, addr_landing_id
					, inter_flag
				)
				select
					accountrowId
					, sc.row_id
					, sc.FST_NAME
					, sc.LAST_NAME
		            , sc.EMAIL_ADDR
		            , sc.HOME_PH_NUM
		            , sc.WORK_PH_NUM
		            , sc.JOB_TITLE
		            , sc.X_SANITIZED_FLG
		            , sap.ADDR
		            , sap.ADDR_LINE_2
		            , sap.ADDR_LINE_3
		            , sap.COUNTY
		            , sap.CITY
		            , sap.STATE
		            , sap.LATITUDE
		            , sap.LONGITUDE
		            , sap.ZIPCODE
		            , sap.row_id
		            , 'if_in'
		         from   
					landing.S_CONTACT sc
				 join
					landing.S_ADDR_PER sap
				on
					sc.pr_per_addr_id = sap.row_id
				where 
					sc.row_id = PARAM_ID;   
		
		
		
			insert into process.contact
				(
					external_id__c
					, cpf__c
					, firstname
					, lastname
					, email
					, homephone
					, companyphone__c
					, title
					, x_sanitized_flg__c
					, con_cd__c
					, account_row_id
					, inter_flag
				)
				select
					sc.row_id
		            , sc.X_CPF
		            , sc.FST_NAME
		            , sc.LAST_NAME
		            , sc.EMAIL_ADDR
		            , sc.HOME_PH_NUM
		            , sc.WORK_PH_NUM
		            , sc.JOB_TITLE
		            , sc.X_SANITIZED_FLG
		            , sc.CON_CD
		            , accountrowId
		            , 'if_in'
				from   
					landing.S_CONTACT sc
				where 
					sc.row_id = PARAM_ID;
		end if;
		IF checkcu !='insert' then
		
				update process.account a set
						firstname = sc.FST_NAME
						, lastname = sc.LAST_NAME
						, personemail = sc.EMAIL_ADDR
						, personhomephone = sc.HOME_PH_NUM
						, companyphone__pc = sc.WORK_PH_NUM
						, occupation__pc = sc.JOB_TITLE
						, sanitized__c = sc.X_SANITIZED_FLG
						, inter_flag = 'if_up'
					from landing.S_CONTACT as sc
					where 
						a.external_id__c = sc.row_id
					and	
						sc.row_id = PARAM_ID;
					
				update process.contact c set
						external_id__c = sc.INTEGRATION_ID
						, cpf__c = sc.X_CPF
						, firstname = sc.FST_NAME
						, lastname = sc.LAST_NAME
						, email = sc.EMAIL_ADDR
						, homephone = sc.HOME_PH_NUM
						, companyphone__c = sc.WORK_PH_NUM
						, title = sc.JOB_TITLE
						, x_sanitized_flg__c = sc.X_SANITIZED_FLG
						, con_cd__c = sc.CON_CD
						, inter_flag = 'if_up'
					from landing.S_CONTACT as sc
					where 
						c.external_id__c = sc.row_id
					and	
						sc.row_id = PARAM_ID;
			
				update process.account as a set
						billingstreet = sap.ADDR
					    , billingstreet_2__c = sap.ADDR_LINE_2
					    , billingstreet_3__c = sap.ADDR_LINE_3
					    , billingcity = sap.CITY
					    , billingstate = sap.STATE
					    , billinglatitude = sap.LATITUDE
						, billinglongitude = sap.LONGITUDE
					    , billingpostalcode = sap.ZIPCODE
					    , inter_flag = 'if_up'
					from landing.S_ADDR_PER as sap
					where 
						a.addr_landing_id = sap.row_id;	
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_inbound_contact_interface_workflow(varchar);

CREATE OR REPLACE PROCEDURE process.hmb_inbound_contact_interface_workflow(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare accountrowId varchar(15);
	declare contactrowId varchar(15);
	begin
		accountrowId := concat('proc'::text || lpad(nextval('process.seq_account'::regclass)::text, 11, '0'::text))::character varying;
		contactrowId := concat('proc'::text || lpad(nextval('process.seq_contact'::regclass)::text, 11, '0'::text))::character varying;
	
		INSERT INTO process.account(
									row_id,
									external_id__c,
									firstname, 
									lastname, 
									personemail, 
									personhomephone, 
									companyphone__pc, 
									personmobilephone, 
									occupation__pc, 
									gender__pc, 
									personbirthdate, 
									preferredcontactchannel__c, 
									maritalstatus__pc, 
									calloptyn__pc, 
									directmailoptyn__pc, 
									emailoptyn__pc, 
									inter_flag
									)
								    select accountrowId ,
								    		sc.row_id,
								    		sc.FST_NAME, 
								    		sc.LAST_NAME, 
								    		sc.EMAIL_ADDR, 
								    		sc.HOME_PH_NUM, 
								    		sc.WORK_PH_NUM, 
								    		sc.CELL_PH_NUM, 
								    		sc.JOB_TITLE, 
								    		sc.SEX_MF, 
								    		sc.BIRTH_DT, 
											sc.PREF_COMM_METH_CD, 
											CASE when sc.MARITAL_STAT_CD='Y' then true when sc.MARITAL_STAT_CD='N' then false else null end as MARITAL_STAT_CD, 
											CASE when sc.SUPPRESS_CALL_FLG='Y' then true when sc.SUPPRESS_CALL_FLG='N' then false else null end as SUPPRESS_CALL_FLG, 
											CASE when sc.SUPPRESS_MAIL_FLG='Y' then true when sc.SUPPRESS_MAIL_FLG='N' then false else null end as SUPPRESS_MAIL_FLG, 
											CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end as SUPPRESS_EMAIL_FLG,
											'if_in'
								    from landing.s_contact sc
								    left join
								        landing.s_contact_x scx
								    on
								        sc.row_id = scx.par_row_id	         	                     
								    left join
								        landing.s_addr_per sap
								    on
								        sc.pr_per_addr_id  = sap.row_id  	  
								    left join
								        landing.s_contact_fnx scf 
								    on
								        sc.row_id  = scf.par_row_id  	
								    where sc.row_id = PARAM_ID;    
		   
		INSERT INTO process.contact(
									row_id,
									account_row_id, 
									external_id__c, 
									cpf__c, 
									firstname, 
									lastname, 
									email, 
									homephone, 
									companyphone__c, 
									mobilephone, 
									title, 
									gender__c, 
									birthdate, 
									x_sanitized_flg__c, 
									con_cd__c, 
									preferredcontactchannel__c, 
									--maritalstatus__c, 
									calloptyn__c, 
									directmailoptyn__c, 
									emailoptyn__c, 
									x_printed_card__c, 
									leadsource, 
									occupation__c, 
									attrib_36__c, 
									productofinterest__c, 
									literacy__c, 
									x_seg_behavioral__c, 
									x_seg_value__c, 
									x_seg_google__c, 
									x_seg_facebook__c, 
									x_seg_life_cycle__c, 
									x_seg_interest__c, 
									x_loyalty_optin_flg__c, 
									x_amount_friends__c, 
									x_amount_children__c, 
									loyaltyexpirationdate__c, 
									loyaltyactivationdate__c, 
									x_loyalty_exp_dt__c, 
									x_loyalty_engagement__c, 
									x_loyalty_satisfaction__c, 
									x_loyalty_crm_index__c, 
									loyaltystatus__c, 
									x_already_customer__c, 
									mailingstreet, 
									mailingstreet_2__c, 
									mailingstreet_3__c, 
									mailingcountry, 
									mailingcity, 
									mailingstate, 
									mailingpostalcode, 
									salutation, 
									calledby__c, 
									attrib_45__c, 
									attrib_50__c, 
									pcd__c, 
									x_rowid_to_num__c, 
									employee__c, 
									favoritedealer__c, 
									department, 
									x_emp_area__c, 
									emp_work_loc_name__c, 
									receiveproductnewsflag__c, 
									receiveretailoffersflag__c, 
									receiveserviceoffersflag__c, 
									receivenewsletterflag__c, 
									receiveeventsflag__c, 
									receiveresearchflag__c, 
									blockedmobile__c, 
									blockedwhatsapp__c,
									inter_flag
									)
								    select
								    		contactrowId,
								    		accountrowId, 
											sc.row_id, 
											sc.X_CPF, 
											sc.FST_NAME, 
											sc.LAST_NAME, 
											sc.EMAIL_ADDR, 
											sc.HOME_PH_NUM, 
											sc.WORK_PH_NUM, 
											sc.CELL_PH_NUM, 
											sc.JOB_TITLE										, 
											sc.SEX_MF, 
											sc.BIRTH_DT,  
											CASE when sc.X_SANITIZED_FLG='Y' then true when sc.X_SANITIZED_FLG='N' then false else null end as X_SANITIZED_FLG,sc.CON_CD, sc.PREF_COMM_METH_CD, 
											--sc.MARITAL_STAT_CD,
											CASE when sc.SUPPRESS_CALL_FLG='Y' then true when sc.SUPPRESS_CALL_FLG='N' then false else null end as SUPPRESS_CALL_FLG,
											CASE when sc.SUPPRESS_MAIL_FLG='Y' then true when sc.SUPPRESS_MAIL_FLG='N' then false else null end as SUPPRESS_MAIL_FLG, 
											CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end as SUPPRESS_EMAIL_FLG, 
											sc.X_PRINTED_CARD, 
											scx.ATTRIB_50, 
											scx.ATTRIB_34, 
											scx.ATTRIB_36, 
											scx.ATTRIB_49, 
											scx.X_LITERACY, 
											scx.X_SEG_BEHAVIORAL, 
											scx.X_SEG_VALUE, 
											scx.X_SEG_GOOGLE, 
											scx.X_SEG_FACEBOOK, 
											scx.X_SEG_LIFE_CYCLE, 
											scx.X_SEG_INTEREST, 
											scx.X_LOYALTY_OPTIN_FLG, 
											scx.X_AMOUNT_FRIENDS, 
											scx.X_AMOUNT_CHILDREN, 
											scx.X_CNH_EXP_DATE, 
											scx.X_LOYALTY_ACT_DT, 
											scx.X_LOYALTY_EXP_DT, 
											scx.X_LOYALTY_ENGAGEMENT, 
											scx.X_LOYALTY_SATISFACTION, 
											scx.X_LOYALTY_CRM_INDEX, 
											scx.X_LOYALTY_STATUS, 
											scx.X_ALREADY_CUSTOMER, 
											sap.ADDR, 
											sap.ADDR_LINE_2, 
											sap.ADDR_LINE_3, 
											sap.COUNTY, 
											sap.CITY, 
											sap.STATE, 
											sap.ZIPCODE, 
											sc.PER_TITLE, 
											scx.X_CALLED_BY, 
											scx.ATTRIB_45, 
											scx.ATTRIB_50, 
											sc.X_PNE_FLG, 
											sc.X_ROWID_TO_NUM, 
											CASE when scx.X_EMPLOYEE_FLG='Y' then true when scx.X_EMPLOYEE_FLG='N' then false else null end as X_EMPLOYEE_FLG, 
											scx.X_FAVORITE_DEALER, 
											scf.DEPT_TYPE_CD, 
											scf.X_EMP_AREA, 
											sc.EMP_WORK_LOC_NAME, 
											CASE when sc.X_OPTIN_PRODUCT_FLG='Y' then true when sc.X_OPTIN_PRODUCT_FLG='N' then false else null end as X_OPTIN_PRODUCT_FLG, 
											CASE when sc.X_OPTIN_RETAIL_FLG='Y' then true when sc.X_OPTIN_RETAIL_FLG='N' then false else null end as X_OPTIN_RETAIL_FLG, 
											CASE when sc.X_OPTIN_OFFER_FLG='Y' then true when sc.X_OPTIN_OFFER_FLG='N' then false else null end as X_OPTIN_OFFER_FLG, 
											CASE when sc.X_OPTIN_NEWS_FLG='Y' then true when sc.X_OPTIN_NEWS_FLG='N' then false else null end as X_OPTIN_NEWS_FLG, 
											CASE when sc.X_OPTIN_EVENTS_FLG='Y' then true when sc.X_OPTIN_EVENTS_FLG='N' then false else null end as X_OPTIN_EVENTS_FLG, 
											CASE when sc.X_OPTIN_RESEARCH_FLG='Y' then true when sc.X_OPTIN_RESEARCH_FLG='N' then false else null end as X_OPTIN_RESEARCH_FLG, 
											CASE when sc.X_OPTIN_RESEARCH_FLG='Y' then true when sc.X_OPTIN_RESEARCH_FLG='N' then false else null end as X_OPTIN_RESEARCH_FLG, 
											CASE when sc.X_SUP_GONE_AWAY='Y' then true when sc.X_SUP_GONE_AWAY='N' then false when sc.X_SUP_GONE_AWAY is null then false else null end as X_SUP_GONE_AWAY,
											'if_in'
								    from landing.s_contact sc
								    left join
								        landing.s_contact_x scx
								    on
								        sc.row_id = scx.par_row_id	         	                     
								    left join
								        landing.s_addr_per sap
								    on
								        sc.pr_per_addr_id  = sap.row_id  	  
								    left join
								        landing.s_contact_fnx scf 
								    on
								        sc.row_id  = scf.par_row_id  
								    where sc.row_id = PARAM_ID; 
		   
	END;								
$procedure$
;

-- DROP PROCEDURE process.hmb_mntsrvc_manage_dealer_holiday(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_mntsrvc_manage_dealer_holiday(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	begin
		-- param_id --> s_org_ext_xm.row_id
		IF checkCU = 'insert' then
			insert into process.dealerholiday
			(
				external_id__c
				, par_row_id__c 
				, type__c
				, holiday_name__c
				, holiday_date__c
				, holiday_day__c
				, inter_flag
			)
			select
	            soex.row_id
	            , (select row_id from process.account where external_id__c = soe.row_id)
	            , soex."type"
	            , soex.ATTRIB_02 -- holiday_date
	            , soex.ATTRIB_12 -- holiday_name
	            , soex.ATTRIB_03 -- holiday_day(dayOfWeek)
	            , 'if_in'
			from   
				landing.S_ORG_EXT_XM soex
			join
				landing.S_ORG_EXT soe
			on
				soe.row_id = soex.par_row_id
			where 
				soex.row_id = param_id;
		end if;
	
	
		IF checkCU ='update' then		
			update process.dealerholiday pho set
						type__c = soex.type
						, holiday_name__c = soex.ATTRIB_02
						, holiday_date__c = soex.ATTRIB_12
						, holiday_day__c = soex.ATTRIB_03
						, lastmodifieddate = now()
						, lastmodifiedby = 'interface'
						, inter_flag = 'if_up'
					from landing.S_ORG_EXT_XM soex
					where 
						pho.external_id__c = soex.row_id
					and 
						pho.external_id__c = param_id;
		
		end if;	
	
		if checkCU ='delete' then
			delete from 
				process.dealerholiday
			where 
				external_id__c = param_id;
			
		end if;			
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_mntsrvc_manage_dealer_service(varchar);

CREATE OR REPLACE PROCEDURE process.hmb_mntsrvc_manage_dealer_service(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare dealeraccountrowid varchar; 
	begin
		select row_id into dealeraccountrowid from process.account where external_id__c = param_id;
		
		delete from 
			process.dealerservice 
		where 
			par_row_id__c = dealeraccountrowid;
		
		insert into process.dealerservice 
		(
			type__c
			, external_id__c
			, par_row_id__c
			, dlr_srvc_type__c
			, dlr_srvc_len__c
			, inter_flag
		)
		select 
			soex."type"
			, soex.row_id
			, dealeraccountrowid
			, soex.x_dlr_srvc_type
			, soex.ATTRIB_14
			, 'if_in'
		from
			landing.s_org_ext_xm soex 
		where 
			soex.par_row_id = param_id
		and 
			soex."type" = 'Dealer Maintenance Service';
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_mntsrvc_manage_dealer_service(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_mntsrvc_manage_dealer_service(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare dealeraccountrowid varchar; 
	begin
		select row_id into dealeraccountrowid from process.account where external_id__c = param_id;
		
		delete from 
			process.dealerservice 
		where 
			par_row_id = dealeraccountrowid;
		
		insert into process.dealerservice 
		(
			type__c
			, external_id__c
			, par_row_id__c
			, dlr_srvc_type__c
			, dlr_srvc_len__c
			, inter_flag
		)
		select 
			soex."type"
			, soex.row_id
			, dealeraccountrowid
			, soex.x_dlr_srvc_type
			, soex.ATTRIB_14
			, 'if_in'
		from
			landing.s_org_ext_xm soex 
		where 
			soex.par_row_id = param_id
		and 
			soex."type" = 'Dealer Maintenance Service';
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_mntsrvc_schedule_maintenance(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_mntsrvc_schedule_maintenance(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		IF checkcu = 'insert' then
		
		insert into process."case" 
			(
				protocol__c
				, service_request_reason__c
				, voctype__c
				, voc_class
				, voc_level_2__c
				, voc_level_3__c
				, origin
				, source__c
				, description
				, priority
				, status
				, sap_code_test_drive__c
				, inter_flag
			)
			select
	            srNumber
	            , srReason
	            , srLevel1
	            , srLevel2
	            , srLevel3
	            , srLevel4
	            , srSource
	            , srMethod
	            , srDescription
	            , srPriority
	            , srStatus
	            , dealerCode
	            , chassis
	            , customerCPF
	            , consultantCPF
	            , technicianCPF
	            , serviceType
	            , serviceStatus
	            , serviceArrivaldate
	            , serviceStartdate
	            , serviceDuration
	            , serviceDeliverydate
	            , 'if_in'
			from   
				landing.hmb_mntsrvc_schedule_maintenance hmsm
			where 
				csrx.row_id = PARAM_ID;
			
			end if;
		IF checkCU ='update' then
		
			
		
			
		
			end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_product_inbound_wf(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_product_inbound_wf(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$

	begin
		
		IF checkCU = 'insert' then
			insert into process.product
			(
				Name 
				, Source__c
				, RecordTypeId
				, SAP_Description__c
				, Advanced_Description__c
				, Model_Year__c
				, Chassi_Model__c
				, Body_Style__c
				, SAP_Cylinder_capacity__c
				, SAP_Engine__c
				, Engine_description__c
				, Version__c
				, Transmission_description__c
				, SAP_Transmission__c
				, Fuel__c
				, Door_Amount__c
				, External_id
				, inter_flag
			)
			select
	            spi.NAME
				, spi.DATA_SRC
				, spi.TYPE
				, spi.PART_NUM
				, spix.X_ATTRIB_61
				, spi.MODEL_YR
				, spix.ATTRIB_34
				, spi.BODY_STYLE_CD
				, spix.ATTRIB_03
				, spi.ENGINE_TYPE_CD
				, spix.ATTRIB_36
				, spix.ATTRIB_37
				, spix.ATTRIB_38
				, spix.ATTRIB_05
				, spix.ATTRIB_06
				, spix.ATTRIB_14
				, spi.row_id
				, 'if_in'
			from   
				landing.S_PROD_INT spi
			join
				landing.S_PROD_INT_X spix
			on
				spi.row_id = spix.par_row_id
			where 
				spi.row_id = PARAM_ID;
		end if;
		IF checkCU !='insert' then
		
		
			update process.product pp set
						Name = spi.name
						, Source__c = DATA_SRC
						, RecordTypeId = TYPE
						, SAP_Description__c = PART_NUM
						, Model_Year__c = MODEL_YR
						, Body_Style__c = BODY_STYLE_CD
						, SAP_Engine__c = ENGINE_TYPE_CD
						, inter_flag = 'if_up'
					from landing.S_PROD_INT as spi
					where 
						pp.External_id = spi.row_id
					and 
						pp.External_id = param_id;
			
			update process.product pp set
						Advanced_Description__c = X_ATTRIB_61
						, Chassi_Model__c = ATTRIB_34
						, SAP_Cylinder_capacity__c = ATTRIB_03
						, Engine_description__c = ATTRIB_36
						, Version__c = ATTRIB_37
						, Transmission_description__c = ATTRIB_38
						, SAP_Transmission__c = ATTRIB_05
						, Fuel__c = ATTRIB_06
						, Door_Amount__c = ATTRIB_14
						, inter_flag = 'if_up'
					from landing.S_PROD_INT_X as spix
					where 
						pp.External_id = spix.par_row_id
					and 
						pp.External_id = param_id;
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_product_list_inbound_wf(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_product_list_inbound_wf(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare contactrowid varchar(15);
	begin
		contactrowid := concat('PRD'::text || lpad(nextval('process.seq_product'::regclass)::text, 11, '0'::text))::character varying;
		IF checkCU = 'insert' then
			insert into process.product
			(
				row_id
				, Name
				, Source__c
				, RecordTypeId
				, External_id
				, inter_flag
			)
			select
				contactrowid
	            , spi.name 
	            , spi.data_src 
	            , spi.type
	            , spi.row_id
	            , 'if_in'
			from   
				landing.S_PROD_INT spi
			where 
				spi.row_id = PARAM_ID;
		end if;
	
	
		IF checkCU !='insert' then	
			update process.product pp set
						Name = spi.name
						, Source__c = data_src
						, RecordTypeId = type
						, inter_flag = 'if_up'
					from landing.S_PROD_INT as spi
					where 
						pp.External_id = spi.row_id
					and 
						pp.External_id = param_id;
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_register_in_application_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_register_in_application_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		IF checkcu = 'insert' then
			insert into process.account_benefit_map
			(
				personid
				, appsource
				, externalid
				, inter_flag
			)
			select
	            ccbx.par_row_id
	            , ccbx.x_src_app
	            , ccbx.row_id
	            , 'if_in'
			from   
				landing.cx_cnt_bnf_xm ccbx 
			where 
				ccbx.row_id = PARAM_ID;
		end if;
		IF checkcu !='insert' then
		
		
			update process.account_benefit_map as pab set
						appsource = ccbx.x_src_app
						, inter_flag = 'if_up'
					from landing.cx_cnt_bnf_xm as ccbx 
					where 
						pab.externalid = ccbx.row_id
					and 
						pab.externalid = param_id;
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_register_loyalty_benefit_used_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.hmb_register_loyalty_benefit_used_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		IF checkcu = 'insert' then
			insert into process.account_benefit_map
			(
				personid
				, businessid
				, benefitname
				, benefiturl
				, appsource
				, externalid
				, inter_flag
			)
			select
	            ccbx.PAR_ROW_ID
                , ccbx.X_ACCOUNT_ID
                , ccbx.NAME
                , ccbx.X_BENEFIT_NAME
                , ccbx.X_BENEFIT_URL
                , ccbx.X_SRC_APP
                , ccbx.row_id
                , 'if_in'
			from   
				landing.cx_cnt_bnf_xm ccbx 
			where 
				ccbx.row_id = PARAM_ID;
		end if;
		IF checkcu !='insert' then
		
		
			update process.account_benefit_map as pab set
						benefitname = ccbx.X_BENEFIT_NAME
						, benefiturl = ccbx.X_BENEFIT_URL
						, appsource = ccbx.x_src_app
						, inter_flag = 'if_up'
					from landing.cx_cnt_bnf_xm as ccbx 
					where 
						pab.externalid = ccbx.row_id
					and 
						pab.externalid = param_id;
		
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.hmb_update_contact_in_wf(varchar);

CREATE OR REPLACE PROCEDURE process.hmb_update_contact_in_wf(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
				update process.contact c set
						emailoptyn__c = CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end
						, x_printed_card__c = sc.X_PRINTED_CARD
						, inter_flag = 'if_up'
					from landing.s_contact as sc
					where 
						c.external_id__c = sc.row_id
					and
						c.external_id__c = param_id;
					
				update 	process.contact c set
						x_cnh_exp_date__c = scx.X_CNH_EXP_DATE
						, inter_flag = 'if_up'
					from landing.s_contact_x as scx
					where 
						c.external_id__c = scx.par_row_id
					and
						c.external_id__c = param_id;	
					
				update process.account a set
						emailoptyn__pc = CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end
						--x_printed_card__c = sc.X_PRINTED_CAR 
						, inter_flag = 'if_up'
					from landing.s_contact as sc
					where 
						a.external_id__c = sc.row_id
					and
						a.external_id__c = param_id;	
					
		
	END;
$procedure$
;

-- DROP PROCEDURE process.hmbinboundchannelpartnerinterfaceworkflow();

CREATE OR REPLACE PROCEDURE process.hmbinboundchannelpartnerinterfaceworkflow()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		
	END;
$procedure$
;

-- DROP PROCEDURE process.if_account_ws_wf(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_account_ws_wf(IN param_id character varying, IN proc_acc_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
    declare account_num int;

    begin
        
        if checkcu = 'insert' then                      
            insert into process.account 
            (
                integrationid 
                , corporateregistrationnumber__c 
                , "name" 
                , corporaterepresentativename__c 
                , ori_cd__c 
--                , fleettype__c
                , businesstype__c
                , industry              
                , numberofemployees
                , x_tot_flt_size__c
                , x_contracted_since__c 
                , registrysource__c
--                , businesstype__c
                , fleettype__c
                , phone
                , fax
                , emailaddress__c 
                , website
                , billingstreet
                , billingstreet_2__c
                , billingstreet_3__c
                , billingcountry
                , billingcity
                , billingstate
                , billingpostalcode 
                , description 
                , inter_flag
                
                , parentid
            )
            select
                iaww.integrationid 
                , iaww.cnpjnumber 
                , iaww."name" 
                , iaww.nickname 
                , iaww.agencycode 
                , iaww.fleetacconttype  
                , iaww.industrytrend 
                , iaww.numberofemployee                  
                , cast(iaww.totalfleetsize as varchar(10))
                , iaww.contractedsince 
                , iaww."source" 
                , iaww.organizationtype 
                , iaww.mainphonenumber 
                , iaww.mainfaxnumber 
                , iaww.mainemailaddress 
                , iaww.homepage 
                , iaww.streetaddress 
                , iaww.streetaddress2 
                , iaww.streetaddress3 
                , iaww.country 
                , iaww.city 
                , iaww.state 
                , iaww.postalcode 
                , iaww.description 
                , 'if_in'
                
                , (select row_id from process.account where name = iaww.parentaccountname limit 1) as parentid
            from 
                landing.if_account_ws_wf iaww 
            where 
                iaww.row_id = CAST(nullif(param_id,'') as INTEGER);
        end if;
            
        

        if checkcu = 'update' then
            update process.account a set                
                corporateregistrationnumber__c   = case when iaww.cnpjnumber isnull then a.corporateregistrationnumber__c when iaww.cnpjnumber = '' then a.corporateregistrationnumber__c else iaww.cnpjnumber end 
                , corporaterepresentativename__c = case when iaww.nickname isnull then a.corporaterepresentativename__c when iaww.nickname = '' then a.corporaterepresentativename__c else iaww.nickname end 
                , ori_cd__c                      = case when iaww.agencycode isnull then a.ori_cd__c when iaww.agencycode = '' then a.ori_cd__c else iaww.agencycode end 
                , fleettype__c                   = case when iaww.fleetacconttype  isnull then a.fleettype__c when iaww.fleetacconttype = '' then a.fleettype__c else iaww.fleetacconttype end 
                , industry                       = case when iaww.industrytrend isnull then a.industry when iaww.industrytrend = '' then a.industry else iaww.industrytrend end 
                , numberofemployees              = case when iaww.numberofemployee isnull then a.numberofemployees when iaww.numberofemployee = '' then a.numberofemployees else iaww.numberofemployee end 
                , x_tot_flt_size__c              = case when cast(iaww.totalfleetsize as varchar(10)) isnull then a.x_tot_flt_size__c else cast(iaww.totalfleetsize as varchar(10)) end 
                , x_contracted_since__c          = case when iaww.contractedsince isnull then a.x_contracted_since__c else iaww.contractedsince end 
                , registrysource__c              = case when iaww."source" isnull then a.registrysource__c when iaww."source" = '' then a.registrysource__c else iaww."source" end 
                , businesstype__c                = case when iaww.organizationtype isnull then a.businesstype__c when iaww.organizationtype = '' then a.businesstype__c else iaww.organizationtype end                 
                , phone                          = case when iaww.mainphonenumber isnull then a.phone when iaww.mainphonenumber = '' then a.phone else iaww.mainphonenumber end 
                , fax                            = case when iaww.mainfaxnumber isnull then a.fax when iaww.mainfaxnumber = '' then a.fax else iaww.mainfaxnumber end 
                , emailaddress__c                = case when iaww.mainemailaddress isnull then a.emailaddress__c when iaww.mainemailaddress = '' then a.emailaddress__c else iaww.mainemailaddress end 
                , website                        = case when iaww.homepage isnull then a.website when iaww.homepage = '' then a.website else iaww.homepage end 
                , billingstreet                  = case when iaww.streetaddress isnull then a.billingstreet when iaww.streetaddress = '' then a.billingstreet else iaww.streetaddress end 
                , billingstreet_2__c             = case when iaww.streetaddress2 isnull then a.billingstreet_2__c when iaww.streetaddress2 = '' then a.billingstreet_2__c else iaww.streetaddress2 end 
                , billingstreet_3__c             = case when iaww.streetaddress3 isnull then a.billingstreet_3__c when iaww.streetaddress3 = '' then a.billingstreet_3__c else iaww.streetaddress3 end 
                , billingcountry                 = case when iaww.country isnull then a.billingcountry when iaww.country = '' then a.billingcountry else iaww.country end 
                , billingcity                    = case when iaww.city isnull then a.billingcity when iaww.city = '' then a.billingcity else iaww.city end 
                , billingstate                   = case when iaww.state isnull then a.billingstate when iaww.state = '' then a.billingstate else iaww.state end 
                , billingpostalcode              = case when iaww.postalcode isnull then a.billingpostalcode when iaww.postalcode = '' then a.billingpostalcode else iaww.postalcode end 
                , description                    = case when iaww.description isnull then a.description  when iaww.description = '' then a.description else iaww.description end
                , inter_flag                     = 'if_up'
                
                , parentid                       = case when (select row_id from process.account where name = iaww.parentaccountname limit 1) isnull then a.parentid else (select row_id from process.account where name = iaww.parentaccountname limit 1) end 
            from 
                landing.if_account_ws_wf iaww 
            where
                a.row_id = proc_acc_id 
            and 
                iaww.row_id = CAST(nullif(param_id,'') as INTEGER);
            
        end if;

    END;
$procedure$
;

-- DROP PROCEDURE process.if_action_in_ws_wf(varchar);

CREATE OR REPLACE PROCEDURE process.if_action_in_ws_wf(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare type_td varchar(30);
	declare protocol_sr varchar(64);
	declare protocol_num_td int;	
	declare protocol_num_qh int;
	declare protocol_num_case int;
	declare integrationid_num_tk int;
	declare event_action_ck int;

	begin
			
		/*if event_action_ck = 0 then*/
			insert into process.service_event_act(
				protocol__c
				, "type"
				, priority
				, planneddt__c
				, status__c
				, description
				, result__c
				, answer__c
				, integrationid__c
				, hotlineid__c
				, hotlinecreation__c
				, pwaid__c
				, pwacreation__c
				, roid__c
				, rocreation__c
				, mobisid__c
				, mobisstatus__c
				, expecteddelivery__c
				, purchasepurposeid__c
				, created
				, ordernum__c
				, legacy_created
				, legacy_created_by
				, legacy_last_upd
				, legacy_last_upd_by
				, external_id__c
				, serialnumber
				, dp_user
				, contact_row_id__c
				, stock__c
				, sra_sr_id
				, inter_flag
			)select
				srprotocol
				, "type"
				, priority
				, planneddt
				, status
				, description
				, "result"
				, answer
				, integrationid
				, hotlineid
				, hotlinecreation
				, pwaid
				, pwacreation::timestamp
				, roid
				, rocreation
				, mobisid
				, mobisstatus
				, expecteddelivery
				, purchasepurposeid
				, created
				, ordernum
				, created
				, created_by
				, last_upd
				, last_upd_by
				, row_id
				, serialnumber
				, dpuser
				, contactid
				, estoque
				, (select row_id from process.service_request where protocol__c = srprotocol)
				, 'if_in'
			from landing.if_action_in_ws_wf aiww
			where 
				aiww.row_id = CAST(param_id AS INTEGER);
		/*else
			
		end if;*/
		select
			"type", protocol__c  into type_td, protocol_sr
		from 
			process.service_event_act
		where 
			external_id__c = param_id;
		
		-- Test Drive
		if type_td = 'Test drive - update' then
			-- Service Request Number (testdrivehistory) 
			select
				count(*) into protocol_num_td
			from 
				process.service_event_act psea
			join 
				process.testdrivehistory tdh
			on
				psea.protocol__c = tdh.protocolid__c
			where
				psea.external_id__c = param_id;
			
			-- update
			if protocol_num_td > 0 then
				update process.testdrivehistory tdh set 
					status__c = 'Done'
					, type_cd = case when psea."type" isnull then tdh.type_cd else psea."type" end
					, active_row_id = psea.row_id
					, inter_flag = 'if_up'
				from 
					process.service_event_act psea
				where 
					tdh.protocolid__c = psea.protocol__c
				and
					psea.external_id__c = param_id;
			end if;
		
		elseif type_td = 'Test drive - add' then
			-- Service Request Number (testdrivehistory) 
			select
				count(*) into protocol_num_td
			from 
				process.service_event_act psea
			join 
				process.testdrivehistory tdh
			on
				psea.protocol__c = tdh.protocolid__c
			where
				psea.external_id__c = param_id;	
		
			if protocol_num_td > 0 then
				-- update  
				update process.testdrivehistory tdh set 
					status__c = case when psea.status__c isnull then tdh.status__c else psea.status__c end
					, "RequestDescription__c" = case when psea.description isnull then tdh."RequestDescription__c" else psea.description end
					, type_cd = case when psea."type" isnull then tdh.type_cd else psea."type" end
					, active_row_id = psea.row_id
					, inter_flag = 'if_up'
				from
					process.service_event_act psea
				where
					tdh.protocolid__c = psea.protocol__c
				and
					psea.external_id__c = param_id;
			end if;
			
		-- Case 
		else
			-- Service Request Number (case) 
			select
				count(*) into protocol_num_case
			from 
				process.service_event_act psea
			join 
				process."case" cs
			on
				psea.protocol__c = cs.protocol__c 
			where
				psea.external_id__c = param_id;
			
			-- IntegrationId (Task) 
			select
				count(*) into integrationid_num_tk
			from 
				process.service_event_act psea
			join 
				process.task tk
			on
				psea.integrationid__c = tk.integrationid__c
			and
				psea.protocol__c = tk.protocol__c
			where
				psea.external_id__c = param_id;
		
			if protocol_num_case > 0 then
				if integrationid_num_tk = 0 then
					-- insert 
					insert into process.task
					(
						protocol__c
						, "type"
						, planneddt__c
						, status
						, result__c
						, answer__c
						, serialnumber__c
						, dpuser__c
						, integrationid__c
						, hotlineid__c
						, hotlinecreation__c
						, pwaid__c
						, pwacreation__c
						, roid__c
						, rocreation__c
						, mobisid__c
						, mobisstatus__c
						, expecteddelivery__c
						, purchasepurposeid__c
						, contactid
						, dealercode__c
						, creationdt__c
						, ordernum__c
						, stock__c
						, priority
						, description
						, created
			            , created_by
			            , last_upd 
			            , last_upd_by
			            , active_row_id
			            , external_id__c
			            , inter_flag
					)
					select
						protocol__c
						, "type"
						, planneddt__c
						, status__c
						, result__c
						, answer__c
						, serialnumber
						, dp_user
						, integrationid__c
						, hotlineid__c
						, hotlinecreation__c
						, pwaid__c
						, pwacreation__c
						, roid__c
						, rocreation__c
						, mobisid__c
						, mobisstatus__c
						, expecteddelivery__c
						, purchasepurposeid__c
						, contact_row_id__c
						, dealercode__c
						, created
						, ordernum__c
						, stock__c	
						, priority
						, description
						, legacy_created
						, legacy_created_by
						, legacy_last_upd
						, legacy_last_upd_by
			            , row_id
			            , param_id
			            , 'if_in'
					from 
						process.service_event_act psea
					where 
						psea.external_id__c = param_id;
				else
					-- update 
					update process.task as tk set 
						"type" = case when psea."type" isnull then tk."type" else psea."type" end
						, planneddt__c = case when psea.planneddt__c isnull then tk.planneddt__c else psea.planneddt__c end 
						, status = case when psea.status__c isnull then tk.status else psea.status__c end
						, result__c = case when psea.result__c isnull then tk.result__c else psea.result__c end
						, answer__c = case when psea.answer__c isnull then tk.answer__c else psea.answer__c end
						, serialnumber__c = case when psea.serialnumber isnull then tk.serialnumber__c else psea.serialnumber end
						, dpuser__c = case when psea.dp_user isnull then tk.dpuser__c else psea.dp_user end
						, hotlinecreation__c = case when psea.hotlinecreation__c isnull then tk.hotlinecreation__c else psea.hotlinecreation__c end
						, pwacreation__c = case when psea.pwacreation__c isnull then tk.pwacreation__c else psea.pwacreation__c end
						, rocreation__c = case when psea.rocreation__c isnull then tk.rocreation__c else psea.rocreation__c end
						, mobisstatus__c = case when psea.mobisstatus__c isnull then tk.mobisstatus__c else psea.mobisstatus__c end
						, expecteddelivery__c = case when psea.expecteddelivery__c isnull then tk.expecteddelivery__c else psea.expecteddelivery__c end
						, purchasepurposeid__c = case when psea.purchasepurposeid__c isnull then tk.purchasepurposeid__c else psea.purchasepurposeid__c end
						, dealercode__c = case when psea.dealercode__c isnull then tk.dealercode__c else psea.dealercode__c end
						, creationdt__c = case when psea.created isnull then tk.creationdt__c else psea.created end
						, ordernum__c = case when psea.ordernum__c isnull then tk.ordernum__c else psea.ordernum__c end
						, stock__c = case when psea.stock__c isnull then tk.stock__c else psea.stock__c end
						, priority = case when psea.priority isnull then tk.priority else psea.priority end
						, description = case when psea.description isnull then tk.description else psea.description end
						, active_row_id = psea.row_id
						, external_id__c = param_id
						, inter_flag = 'if_up'
					from
						process.service_event_act psea
					where 
						tk.protocol__c = psea.protocol__c 
					and
						tk.integrationid__c = psea.integrationid__c
					and
						psea.external_id__c = param_id;
				
				end if;
			else
				
			end if;
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_amaro_csi_survey_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_amaro_csi_survey_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare amaro_rowid varchar(30);
	begin
		
		if checkcu = 'insert' then 
			amaro_rowid := process.get_proc_id('amaro'::character varying);
				
			-- insert 'amaro'
			insert into process.amaro (
				amr_row_id 
				, created
				, created_by
				, last_upd
				, last_upd_by
				, db_last_upd
				, rating_all
				, rating_attendant
				, rating_mechanic
				, research_date
				, sna_cod
				, sna_date
				, account_id
				, asset_id
				, contact_id
				, db_last_upd_src
				, dealer_id
				, integration_id
				, research_name
				, sna_comment
				, sna_type
				, "source"
				, status
				, sub_status
				, sra_sr_id
				, sr_id
				, inter_flag
			)select
				amaro_rowid
				, created
	            , created_by
	            , last_upd
	            , last_upd_by
	            , now()
	            , ratingAll::int
	            , ratingAttendant::int
	            , ratingMechanic::int
	            , researchDate
	            , snaCode::int
	            , snaDate
	            , accountId
	            , assetId
	            , contactId
	            , 'Object Manager - Default'
	            , dealerId
	            , Concat("source"||integrationid)
	            , researchName
	            , snaComment
	            , snaType
	            , "source"
	            , status
	            , substatus
	            , (select row_id from process.service_request where protocol__c = srProtocol)
	            , srProtocol
	            , 'if_in'
			from
				landing.if_amaro_csi_survey_ws iacsw
			where 
				iacsw.row_id = CAST(param_id AS INTEGER);
			
			
			-- insert 'amaro_answer'
			insert into process.amaro_answer(
				created
				, created_by
				, last_upd
				, last_upd_by
				, answer_value
				, db_last_upd
				, answer_compl
				, db_last_upd_src
				, integration_id
				, question_comments
				, question_id
				, question_code
				, answer_long
				, amr_row_id
				, inter_flag
			)select
				created
	            , created_by
	            , last_upd
	            , last_upd_by
	            , answervalue::int
	            , now()
	            , answercomplement
	            , 'Object Manager - Default'
	            , integrationid
	            , questioncomments
	            , questionid
	            , questioncode::int
	            , answerdescription
				, amaro_rowid
				, 'if_in'
			from
				landing.if_amaro_csi_survey_answer_ws iacsaw
			where 
				iacsaw.par_row_id = param_id;
		end if;
	
	
		
		if checkcu = 'update' then
			-- update 'amaro'
			update process.amaro as pa set 
				rating_all = case when la.ratingall isnull then pa.rating_all else la.ratingall::int4 end 
				, rating_attendant = case when la.ratingattendant isnull then pa.rating_attendant else la.ratingattendant::int4 end 
				, rating_mechanic = case when la.ratingmechanic isnull then pa.rating_mechanic else la.ratingmechanic::int4 end
				, research_date = case when la.researchdate isnull then pa.research_date else la.researchdate end 
				, sna_cod = case when la.snacode isnull then pa.sna_cod else la.snacode::int4 end 
				, sna_date = case when la.snadate isnull then pa.sna_date else sna_date end 
				, research_name = case when la.researchname isnull then pa.research_name when la.researchname = '' then pa.research_name else la.researchname end
				, sna_comment = case when la.snacomment isnull then pa.sna_comment when la.snacomment = '' then pa.sna_comment else la.snacomment end 
				, sna_type = case when la.snatype isnull then pa.sna_type when la.snatype = '' then pa.sna_type else la.snatype end 
				, "source" = case when la."source" isnull then pa."source" when la."source" = '' then pa."source" else la."source" end 
				, status = case when la.status isnull then pa.status when la.status = '' then pa.status else la.status end 
				, sub_status = case when la.substatus isnull then pa.sub_status when la.substatus = '' then pa.sub_status else la.substatus end 
				, db_last_upd = now()
				, inter_flag = 'if_up'
			from
				landing.if_amaro_csi_survey_ws la
			where
				la.row_id = cast(param_id as Integer)
			and
				pa.integration_id = concat(la."source"||la.integrationid);
			
			-- update 'amaro_answer'
			update process.amaro_answer as pa set 
				answer_value = case when la.answervalue isnull then pa.answer_value else la.answervalue::int4 end 
				, answer_compl = case when la.answercomplement isnull then pa.answer_compl when la.answercomplement = '' then pa.answer_compl else la.answercomplement end 
				, db_last_upd = now()
				, question_comments = case when la.questioncomments isnull then pa.question_comments when la.questioncomments = '' then pa.question_comments else la.questioncomments end 
				, question_code = case when la.questioncode isnull then pa.question_code else la.questioncode::int4 end 
				, answer_long = case when la.answerdescription isnull then pa.answer_long when la.answerdescription = '' then pa.answer_long else la.answerdescription end 
				, inter_flag = 'if_up'
			from
				landing.if_amaro_csi_survey_answer_ws la
			where
				la.par_row_id = param_id
			and 
				pa.question_id = la.questionid;
			
		end if;
		
	END;
$procedure$
;

-- DROP PROCEDURE process.if_asset_contact_upsert_ws(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_asset_contact_upsert_ws(IN param_id character varying, IN proc_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare proc_asset_id varchar;
	declare fo_count integer;
    begin
	    
	    
	    -- Check First Owner 
	    select 
	    	count(*) into fo_count
	    from 
	    	process.customer_vehicle pc
	    join
	    	landing.if_asset_contact_upsert_ws l
	    on 
	    	pc.asset_id = l.assetid
	    where
	    	lower(pc.relation_type_cd) = 'first owner'
	    and 
	    	lower(pc.cv_type) = 'person'
	    and
	    	l.row_id = cast(param_id as Integer);
	    
	    
	    if fo_count = 0  then
	    
		    --  assetid  customer_vehicle(person) update
	    	update process.customer_vehicle as pc set
				relation_type_cd = 'First Owner'
				, status_cd = 'Inactive'
				, inter_flag = 'if_up'
	    	from
	    		landing.if_asset_contact_upsert_ws l        	
	    	where
	    		pc.asset_id = l.assetid
	    	and
	    		lower(pc.cv_type) = 'person'
	    	and 
	    		lower(pc.status_cd) = 'active' 
			and 
				l.row_id = cast(param_id as Integer);
		else 
		
			update process.customer_vehicle as pc set
				status_cd = 'Inactive'
				, inter_flag = 'if_up'
	    	from
	    		landing.if_asset_contact_upsert_ws l        	
	    	where
	    		pc.asset_id = l.assetid
	    	and
	    		lower(pc.cv_type) = 'person'
	    	and 
	    		lower(pc.status_cd) = 'active' 
			and 
				l.row_id = cast(param_id as Integer);
		
		end if;
	    
        if checkcu = 'insert' then    
        		
            insert into process.customer_vehicle
            (
                asset_id 
                , account_id 
                , relation_type_cd 
                , retail_date 
                , status_cd
                , cv_type
                , inter_flag
            )
            select
                lac.assetid
                , lac.contactid
                , lac.relationship 
                , lac.hkmeretaildate 
                , 'Active'
                , 'Person'
                , 'if_in'
            from
                landing.if_asset_contact_upsert_ws lac
            where
                lac.row_id = cast(param_id as Integer);
               
               
            update process.asset as pa set
            	contact_row_id__c = l.contactid
            	, inter_flag = 'if_up'
            from
            	landing.if_asset_contact_upsert_ws l
            where
            	l.row_id = cast(param_id as Integer)
            and 
           		pa.row_id = l.assetid;
             
        end if;
    
    
        if checkcu = 'update' then  
        
            update process.customer_vehicle as pcv set 
                relation_type_cd = case when lac.relationship isnull then pcv.relation_type_cd when lac.relationship = '' then pcv.relation_type_cd else lac.relationship end 
                , retail_date = case when lac.hkmeretaildate isnull then pcv.retail_date else lac.hkmeretaildate end 
                , status_cd = 'Active'
                , inter_flag = 'if_up'
            from
                landing.if_asset_contact_upsert_ws lac
            where
                lac.row_id = CAST(param_id as Integer)
            and
                pcv.row_id = proc_id;
               
            update process.asset as pa set
            	contact_row_id__c = l.contactid
            	, inter_flag = 'if_up'
            from
            	landing.if_asset_contact_upsert_ws l
            where
            	l.row_id = cast(param_id as Integer)
            and 
           		pa.row_id = l.assetid;
        end if;
    END;
$procedure$
;

-- DROP PROCEDURE process.if_auto_vehicle_bl_ws(_text);

CREATE OR REPLACE PROCEDURE process.if_auto_vehicle_bl_ws(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare 
		v_len integer;
		v_i integer;
		v_count integer;
	begin
		v_len := array_length(param_id, 1);
		
		FOR v_i IN 1..v_len
	     LOOP
	          select 
	          	count(*) into v_count
	          from
	          	landing.if_auto_vehicle_bluelink_ws libl
	          join
	          	process.bluelink pbc 
	          on
	          	libl.chassi = pbc.chassi__c 
	          where
	          	libl."type" = pbc.type__c
	          and
	          	libl.row_id = CAST(param_id[v_i] AS INTEGER);
	          
	          if 0 < v_count then 
	          --	 update
	          	update process.bluelink as pbc set 
	          		firstactivation__c = case when libl.firstactivation isnull then pbc.firstactivation__c else libl.firstactivation end
	          		, latestmileage__c = case when libl.latestmileage isnull then pbc.latestmileage__c else libl.latestmileage end
	          		, activationdate__c = case when libl.activationdate::timestamp isnull then pbc.activationdate__c else libl.activationdate::timestamp end 
	          		, type__c = case when libl."type" isnull then pbc.type__c else libl."type" end
	          		, last_upd = case when libl.last_upd isnull then pbc.last_upd else libl.last_upd end
	          		, last_upd_by = libl.last_upd_by
	          		, inter_flag = 'if_up'
	          	from 
	          		landing.if_auto_vehicle_bluelink_ws libl
	          	where
	          		pbc.chassi__c = libl.chassi
	          	and
	          		pbc.type__c = libl."type"
	          	and
	          		libl.row_id = CAST(param_id[v_i] AS INTEGER);
	          else
	          --	insert into
	          	insert into process.bluelink(
	          		integrationid__c
					, chassi__c
					, latestmileage__c
					, firstactivation__c
					, activationdate__c
					, type__c
					, created
					, created_by
					, last_upd
					, last_upd_by
					, asset_id
					, assetdate__c
					, inter_flag
	          	)select
					integrationid
					, chassi
					, latestmileage
					, firstactivation
					, activationdate::timestamp
					, "type"
					, created
					, created_by
					, last_upd
					, last_upd_by 
					, (select row_id from process.asset where serialnumber = chassi)
					, (select billing_date__c from process.asset where serialnumber = chassi)
					, 'if_in'
				from 
					landing.if_auto_vehicle_bluelink_ws libl
	          	where
	          		libl.row_id = CAST(param_id[v_i] AS INTEGER);
	          end if;
		     --param_id[v_i];
		     
	     END LOOP;

	END;
$procedure$
;

-- DROP PROCEDURE process.if_auto_vehicle_rsa_claim_ws(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_auto_vehicle_rsa_claim_ws(IN param_id character varying, IN proc_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
    declare rsarowid varchar;
    begin
        if checkcu = 'insert' then
            -- insert 'road_side_assistant'
            insert into process.road_side_assistant
            (
                integration_id 
                , req_first_name 
                , req_last_name 
                , req_document 
                , req_vehicle_rel 
                , claim_date 
                , claim_reason 
                , brkdwn_desc 
                , brkdwn_cd
                , brkdwn_nature 
                , status_cd 
                --, serialnumber
                , eff_start_date 
                , eff_end_date 
                , exchange_date 
                --, vehicleplate
                , mileage 
                , inter_flag
            )
            select
                lrsa.claimid 
                , lrsa.requesterfirstname 
                , lrsa.requesterlastname 
                , lrsa.requesterdocument 
                , lrsa.requesterrelationship 
                , lrsa.createdate 
                , lrsa.reason 
                , lrsa.breakdowndescription 
                , lrsa.breakdowncode 
                , lrsa.breakdownnature 
                , lrsa.claimstatus 
                --, lrsa.serialnumber 
                , lrsa.effectivestartdate 
                , lrsa.effectiveenddate 
                , lrsa.exchangedate 
                --, lrsa.vehicleplate 
                , lrsa.vehiclemileage 
                , 'if_in'
            from
                landing.if_auto_vehicle_rsa_claim_ws lrsa
            where
                lrsa.row_id = CAST(param_id as INTEGER);
            
            
            
            select 
                pr.row_id into rsarowid
            from
                process.road_side_assistant pr
            join
                landing.if_auto_vehicle_rsa_claim_ws lr
            on
                pr.integration_id = lr.claimid 
            where
                lr.row_id = CAST(param_id as INTEGER);
                
            
            -- insert 'road_side_assistant_service'
            insert into process.road_side_assistant_service
            (
                "name" 
                , createdate__c 
                , servicecode__c 
                , specialty__c 
                , provider__c 
                , vehicleproblem__c 
                , problemdescription__c 
                , tmcpredicted__c 
                , important__c 
                , requeststatus__c 
                , actuationstatus__c 
                , addressname__c 
                , addressnumber__c 
                , addresscomplement__c 
                , county__c 
                , city__c 
                , state__c 
                , latitude__c 
                , longitude__c 
                , reference__c 
                , zipcode__c 
                , dealername__c 
                , dealernickname__c 
                , expense__c 
                , rsa_row_id 
                , inter_flag
            )
            select
                lrss.serviceid 
                , lrss.createdate 
                , lrss.servicecode 
                , lrss.specialty 
                , lrss.provider 
                , lrss.vehicleproblem 
                , lrss.problemdescription 
                , lrss.tmcpredicted 
                , lrss.important 
                , lrss.requeststatus 
                , lrss.actuationstatus 
                , lrss.addressname 
                , lrss.addressnumber 
                , lrss.addresscomplement 
                , lrss.county 
                , lrss.city 
                , lrss.state 
                , lrss.latitude 
                , lrss.longitude 
                , lrss.reference 
                , lrss.zipcode 
                , lrss.dealername 
                , lrss.dealernickname 
                , lrss.expense 
                , rsarowid
                , 'if_in'
            from
                landing.if_auto_vehicle_rsa_claim_ws_rsaservice lrss 
            where
                lrss.par_row_id = cast(param_id as Integer); 
            
            
        end if;
    
    
        if checkcu = 'update' then 
            -- update 'road_side_assistant'
            update process.road_side_assistant as prsa set 
                req_first_name = case when lrsa.requesterfirstname isnull then prsa.req_first_name when lrsa.requesterfirstname = '' then prsa.req_first_name else lrsa.requesterfirstname end 
                , req_last_name = case when lrsa.requesterlastname isnull then prsa.req_last_name when lrsa.requesterlastname = '' then prsa.req_last_name else lrsa.requesterlastname end 
                , req_document = case when lrsa.requesterdocument isnull then prsa.req_document when lrsa.requesterdocument = '' then prsa.req_document else lrsa.requesterdocument end 
                , req_vehicle_rel =  case when lrsa.requesterrelationship isnull then prsa.req_vehicle_rel when lrsa.requesterrelationship = '' then prsa.req_vehicle_rel else lrsa.requesterrelationship end 
                , claim_date = case when lrsa.createdate isnull then prsa.claim_date else lrsa.createdate end 
                , claim_reason = case when lrsa.reason isnull then prsa.claim_reason when lrsa.reason = '' then prsa.claim_reason else lrsa.reason end 
                , brkdwn_desc = case when lrsa.breakdowndescription isnull then prsa.brkdwn_desc when lrsa.breakdowndescription = '' then prsa.brkdwn_desc else lrsa.breakdowndescription end 
                , brkdwn_cd = case when lrsa.breakdowncode isnull then prsa.brkdwn_cd when lrsa.breakdowncode = '' then prsa.brkdwn_cd else lrsa.breakdowncode end 
                , brkdwn_nature =  case when lrsa.breakdownnature isnull then prsa.brkdwn_nature when lrsa.breakdownnature = '' then prsa.brkdwn_nature else lrsa.breakdownnature end 
                , status_cd = case when lrsa.claimstatus isnull then prsa.status_cd when lrsa.claimstatus = '' then prsa.status_cd else lrsa.claimstatus end 
                --, serialnumber
                , eff_start_date = case when lrsa.effectivestartdate isnull then prsa.eff_start_date else lrsa.effectivestartdate end 
                , eff_end_date = case when lrsa.effectiveenddate isnull then prsa.eff_end_date else lrsa.effectiveenddate end 
                , exchange_date = case when lrsa.exchangedate isnull then prsa.exchange_date else lrsa.exchangedate end 
                --, vehicleplate
                , mileage = case when lrsa.vehiclemileage isnull then prsa.mileage else lrsa.vehiclemileage end 
                , inter_flag = 'if_up'
            from
                landing.if_auto_vehicle_rsa_claim_ws lrsa
            where
                lrsa.row_id = CAST(param_id as Integer)
            and
                prsa.row_id = proc_id;
            
            -- delete 'road_side_assistant_service'
            delete from 
                process.road_side_assistant_service 
            where 
                rsa_row_id = proc_id;
            
            -- insert 'road_side_assistant_service'
            insert into process.road_side_assistant_service
            (
                "name" 
                , createdate__c 
                , servicecode__c 
                , specialty__c 
                , provider__c 
                , vehicleproblem__c 
                , problemdescription__c 
                , tmcpredicted__c 
                , important__c 
                , requeststatus__c 
                , actuationstatus__c 
                , addressname__c 
                , addressnumber__c 
                , addresscomplement__c 
                , county__c 
                , city__c 
                , state__c 
                , latitude__c 
                , longitude__c 
                , reference__c 
                , zipcode__c 
                , dealername__c 
                , dealernickname__c 
                , expense__c 
                , rsa_row_id 
                , inter_flag
            )
            select
                lrss.serviceid 
                , lrss.createdate 
                , lrss.servicecode 
                , lrss.specialty 
                , lrss.provider 
                , lrss.vehicleproblem 
                , lrss.problemdescription 
                , lrss.tmcpredicted 
                , lrss.important 
                , lrss.requeststatus 
                , lrss.actuationstatus 
                , lrss.addressname 
                , lrss.addressnumber 
                , lrss.addresscomplement 
                , lrss.county 
                , lrss.city 
                , lrss.state 
                , lrss.latitude 
                , lrss.longitude 
                , lrss.reference 
                , lrss.zipcode 
                , lrss.dealername 
                , lrss.dealernickname 
                , lrss.expense 
                , proc_id
                , 'if_in'
            from
                landing.if_auto_vehicle_rsa_claim_ws_rsaservice lrss 
            where
                lrss.par_row_id = cast(param_id as Integer);
        
        
        end if;

    END;
$procedure$
;

-- DROP PROCEDURE process.if_auto_vehicle_ws_wf(_text, _text, _text, _text, _text);

CREATE OR REPLACE PROCEDURE process.if_auto_vehicle_ws_wf(IN param_id text[], IN proc_asset_id text[], IN proc_invoice_id text[], IN account_rowid text[], IN contact_rowid text[])
 LANGUAGE plpgsql
AS $procedure$
	declare 
		c_len integer;
		c_i integer;
		c_rowid varchar;
		l_status varchar;
		a_len integer;
		a_i integer;
		a_count integer;
		procassetrowid varchar;
		account_row_id varchar;
		contact_row_id varchar;
		invoice_contact_check integer;
		contact_status varchar;
		nego_type integer;
		fo_count integer;
	begin
		c_len := array_length(contact_rowid, 1);
		a_len := array_length(account_rowid, 1);		
		
		-- contact status inactive   
		select 
			lower(lc.status), position('cancelled' in lower(lv.negotiationtype))  into contact_status, nego_type
		from
			process.invoiceinfo pn
		join
			landing.if_auto_vehicle_ws_wf_contact lc
		on
			pn.person_account_id = lc.connexcontactid 
		join
			landing.if_auto_vehicle_ws_wf lv
		on
			lc.par_row_id = lv.row_id 		
		where
			lv.row_id = CAST(PARAM_ID[1] as INTEGER)
		and 
			lc.serialnumber = pn."name"
		and 
			pn.row_id = proc_invoice_id[1];
		
		select 
			connexaccountid into account_row_id
		from
			landing.if_auto_vehicle_ws_wf_account la
		join
			landing.if_auto_vehicle_ws_wf l
		on
			l.row_id = la.par_row_id 
		where
			la.par_row_id  = Cast(param_id[1] as Integer);
		
		select 
			connexcontactid into contact_row_id
		from
			landing.if_auto_vehicle_ws_wf_contact lc
		join
			landing.if_auto_vehicle_ws_wf l
		on
			l.row_id = lc.par_row_id 
		where
			l.row_id = Cast(param_id[1] as Integer);
				
		
		if (array_length(proc_asset_id, 1) is null or array_length(proc_asset_id, 1) <= 0) then
			--raise 'proc_asset is empty.';
			-- insert 'asset'
			insert into process.asset 
			(
				assetaccountrollupkey__c 
				, serialnumber 
				, renavam_code__c 
				, enginenumber__c 
				, carregistrationnumber__c 
				, fsc__c 
				, modelname__c 
				, vehicleinternalcolor__c 
				, vehiclecolor__c 
				, fueltype__c 
				, purchaseprice__c 
				, manufacturedate 
				, modelyear__c 
				, latestmileage__c 
				, dealer_rcpt_dt__c 
				, warranty_start_dt__c 
				, billing_date__c 
				, vehicledeliverydate__c 
				, dealercode__c 
				, oper_status_cd__c 
				, ownr_type_cd__c 
				, purch_loc_desc__c 
				, dlr_con_int_id__c 
				, salesrepfirstname 
				, salesreplastname 
				, special_moment__c
				, urlphotodate__c 
				, urlauthopublication__c 
				, vehicle_license_date__c 
				, x_dig_sales__c 
				, x_del_home__c 
				, x_td_home__c 
				, cf_eval_svc_cd__c 
				, status 
				, account_row_id__c 
				, contact_row_id__c 
				, inter_flag				
			)
			select
				lv.integrationid 
				, lv.serialnumber 
				, lv.renavamcode 
				, lv.enginenumber 
				, lv.vehiclelicensenumber 
				, lv.fsc_ocn 
				, lv.modelname 
				, lv.internalcolorcode 
				, lv.externalcolorcode 
				, lv.fuel 
				, lv.purchaseprice 
				, lv.manufactureyear 
				, lv.modelyear 
				, lv.mileage 
				, lv.saletodealerdate
				, lv.warrantystartdate::timestamp 
				, lv.billingdate::timestamp 
				, lv.delivertocustomerdate::timestamp
				, lv.sellingdealercode 
				, lv.negotiationtype 
				, lv.subscriptiontype 
				, lv.fiscalreceipt 
				, lv.salesrepid 
				, lv.salesrepfirstname 
				, lv.salesreplastname 
				, lv.urlphoto 
				, lv.urlphotodate 
				, lv.urlauthpublication 
				, lv.vehiclelicensedate 
				, (case when lv.digitalsales = 'Y' then true when lv.digitalsales = 'N' then false else null end)
				, (case when lv.deliveryathome= 'Y' then true when lv.deliveryathome = 'N' then false else null end)
				, (case when lv.tdathome = 'Y' then true when lv.tdathome = 'N' then false else null end)
				, lv.ccs_flg 
				, lv.status 
				, account_row_id
				, contact_row_id
				, 'if_in'
			from
				landing.if_auto_vehicle_ws_wf lv
			where
				lv.row_id = CAST(PARAM_ID[1] as INTEGER);
			
			select 
				pass.row_id into procassetrowid
			from
				process.asset pass
			join
				landing.if_auto_vehicle_ws_wf lv
			on
				pass.serialnumber = lv.serialnumber 
			where
				lv.row_id = CAST(PARAM_ID[1] as INTEGER);		
			
			
		
			if c_len > 0 then
				-- insert 'customer_vehicle' (person)
				for c_i in 1..c_len
					loop							
						
						insert into process.customer_vehicle
						(
							cv_type
							, account_id 
							, relation_type_cd 
							, status_cd 
							, x_employee_flg 
							, asset_id 
							, inter_flag 
						)
						select
							'Person'
							, lc.connexcontactid
							, lc."type" 
							, lc.status 
							, ( case when lc.employee = 'Y' then true when lc.employee = 'N' then false else null end )
							, procassetrowid
							, 'if_in'
						from
							landing.if_auto_vehicle_ws_wf_contact lc
						where
							lc.row_id = CAST(CONTACT_ROWID[c_i] as INTEGER);
					end loop;
			end if;
			
		else	
			
			
				
		
			-- update 'asset'
			update process.asset as pass set
				assetaccountrollupkey__c = case when lv.integrationid isnull then pass.assetaccountrollupkey__c when lv.integrationid = '' then pass.assetaccountrollupkey__c else lv.integrationid end 
				, status = case when lv.status isnull then pass.status when lv.status = '' then pass.status else lv.status end 
				, serialnumber = case when lv.serialnumber isnull then pass.serialnumber when lv.serialnumber = '' then pass.serialnumber else lv.serialnumber end 
				, renavam_code__c = case when lv.renavamcode isnull then pass.renavam_code__c when lv.renavamcode = '' then pass.renavam_code__c else lv.renavamcode end 
				, enginenumber__c = case when lv.enginenumber isnull then pass.enginenumber__c when lv.enginenumber = '' then pass.enginenumber__c else lv.enginenumber end 
				, carregistrationnumber__c = case when lv.vehiclelicensenumber isnull then pass.carregistrationnumber__c when lv.vehiclelicensenumber = '' then pass.carregistrationnumber__c else lv.vehiclelicensenumber end 
				, fsc__c = case when lv.fsc_ocn isnull then pass.fsc__c when lv.fsc_ocn = '' then pass.fsc__c else lv.fsc_ocn end 
				, modelname__c = case when lv.modelname isnull then pass.modelname__c when lv.modelname = '' then pass.modelname__c else lv.modelname end 
				, vehicleinternalcolor__c = case when lv.internalcolorcode isnull then pass.vehicleinternalcolor__c when lv.internalcolorcode = '' then pass.vehicleinternalcolor__c else lv.internalcolorcode end 
				, vehiclecolor__c = case when lv.externalcolorcode isnull then pass.vehiclecolor__c when lv.externalcolorcode = '' then pass.vehiclecolor__c else lv.externalcolorcode end 
				, fueltype__c = case when lv.fuel isnull then pass.fueltype__c when lv.fuel = '' then pass.fueltype__c else lv.fuel end 
				, purchaseprice__c = case when lv.purchaseprice isnull then pass.purchaseprice__c else lv.purchaseprice end 
				, manufacturedate = case when lv.manufactureyear isnull then pass.manufacturedate else lv.manufactureyear end 
				, modelyear__c = case when lv.modelyear isnull then pass.modelyear__c else cast(lv.modelyear as VARCHAR(255))end 
				, latestmileage__c = case when lv.mileage isnull then pass.latestmileage__c else lv.mileage end 
				, dealer_rcpt_dt__c = case when lv.saletodealerdate isnull then pass.dealer_rcpt_dt__c else lv.saletodealerdate end 
				, warranty_start_dt__c = case when lv.warrantystartdate isnull then pass.warranty_start_dt__c else lv.warrantystartdate end 
				, billing_date__c = case when lv.billingdate isnull then pass.billing_date__c else lv.billingdate end 
				, vehicledeliverydate__c = case when lv.delivertocustomerdate isnull then pass.vehicledeliverydate__c else lv.delivertocustomerdate end 
				, dealercode__c = case when lv.sellingdealercode isnull then pass.dealercode__c when lv.sellingdealercode = '' then pass.dealercode__c else lv.sellingdealercode end 
				, oper_status_cd__c = case when lv.negotiationtype isnull then pass.oper_status_cd__c when lv.negotiationtype = '' then pass.oper_status_cd__c else lv.negotiationtype end 
				, ownr_type_cd__c = case when lv.subscriptiontype isnull then pass.ownr_type_cd__c when lv.subscriptiontype = '' then pass.ownr_type_cd__c else lv.subscriptiontype end 
				, purch_loc_desc__c = case when lv.fiscalreceipt isnull then pass.purch_loc_desc__c when lv.fiscalreceipt = '' then pass.purch_loc_desc__c else lv.fiscalreceipt end 
				, dlr_con_int_id__c = case when lv.salesrepid isnull then pass.dlr_con_int_id__c when lv.salesrepid = '' then pass.dlr_con_int_id__c else lv.salesrepid end 
				, salesrepfirstname = case when lv.salesrepfirstname isnull then pass.salesrepfirstname when lv.salesrepfirstname = '' then pass.salesrepfirstname else lv.salesrepfirstname end 
				, salesreplastname = case when lv.salesreplastname isnull then pass.salesreplastname when lv.salesreplastname = '' then pass.salesreplastname else lv.salesreplastname end 
				, special_moment__c = case when lv.urlphoto isnull then pass.special_moment__c when lv.urlphoto = '' then pass.special_moment__c else lv.urlphoto end 
				, urlphotodate__c = case when lv.urlphotodate isnull then pass.urlphotodate__c else lv.urlphotodate end 
				, urlauthopublication__c = case when lv.urlauthpublication isnull then pass.urlauthopublication__c when lv.urlauthpublication = '' then pass.urlauthopublication__c else lv.urlauthpublication end 
				, vehicle_license_date__c = case when lv.vehiclelicensedate isnull then pass.vehicle_license_date__c else lv.vehiclelicensedate end 
				, x_dig_sales__c = case when lv.digitalsales isnull then pass.x_dig_sales__c when lv.digitalsales = '' then pass.x_dig_sales__c else case when lv.digitalsales = 'Y' then true when lv.digitalsales = 'N' then false else null end end
				, x_del_home__c = case when lv.deliveryathome isnull then pass.x_del_home__c when lv.deliveryathome = '' then pass.x_del_home__c else case when lv.deliveryathome= 'Y' then true when lv.deliveryathome = 'N' then false else null end end 
				, x_td_home__c = case when lv.tdathome isnull then pass.x_td_home__c when lv.tdathome = '' then pass.x_td_home__c else case when lv.tdathome = 'Y' then true when lv.tdathome = 'N' then false else null end end
				, cf_eval_svc_cd__c = case when lv.ccs_flg isnull then pass.cf_eval_svc_cd__c when lv.ccs_flg = '' then pass.cf_eval_svc_cd__c else lv.ccs_flg end
				, contact_row_id__c = case when lc.connexcontactid isnull then pass.contact_row_id__c else lc.connexcontactid end
				, inter_flag = 'if_up'
			from
				landing.if_auto_vehicle_ws_wf lv
			join 
				landing.if_auto_vehicle_ws_wf_contact lc 
			on
				lv.row_id = lc.par_row_id 
			where
				lv.row_id = CAST(param_id[1] as Integer)		
			and
				pass.row_id = proc_asset_id[1];
			
			
			
						
			
			if c_len > 0 then			
				for c_i in 1..c_len
					loop
						
						select
							pv.row_id into c_rowid
						from
							process.customer_vehicle pv
						join
							landing.if_auto_vehicle_ws_wf_contact lc
						on
							pv.account_id  = lc.connexcontactid
						join
							process.asset pass
						on 
							pv.asset_id = pass.row_id 
						where
							lc.row_id = CAST(CONTACT_ROWID[c_i] as Integer)
						and
							pass.serialnumber = lc.serialnumber;
						
						
									
						--  contactid status check
						select 
							lower(l.status) into l_status
						from 
							landing.if_auto_vehicle_ws_wf_contact l
						where 
							l.row_id = CAST(CONTACT_ROWID[c_i] as Integer);
						
						
						if l_status = 'active' then
						
						
							 -- Check First Owner 
						    select 
						    	count(*) into fo_count
						    from 
						    	process.customer_vehicle pc
						    where 
						    	pc.asset_id = proc_asset_id[1]
						    and
						    	lower(pc.cv_type) = 'person'
						    and
						    	lower(relation_type_cd) = 'first owner';
						
						    
						    if fo_count = 0 then
						    
						    
								--  Active  Inactive update
								update process.customer_vehicle as c set	
									relation_type_cd = 'First Owner'
									, status_cd = 'Inactive'
									, relationshipenddate__c = now()
									, inter_flag = 'if_up'
								where
									c.asset_id = proc_asset_id[1]
								and
									lower(c.cv_type) = 'person'
								and
									lower(c.status_cd) = 'active';
							else
							
								update process.customer_vehicle as c set	
									status_cd = 'Inactive'
									, relationshipenddate__c = now()
									, inter_flag = 'if_up'
								where
									c.asset_id = proc_asset_id[1]
								and
									lower(c.cv_type) = 'person'
								and
									lower(c.status_cd) = 'active';
							end if;
							
						end if;
						
						
						if c_rowid isnull then
							-- insert 'customer_vehicle' (Person)
							insert into process.customer_vehicle
							(
								cv_type
								, account_id 
								, asset_id 
								, relation_type_cd 
								, status_cd 
								, x_employee_flg 
								, inter_flag 
							)
							select
								'Person'
								, lc.connexcontactid
								, proc_asset_id[1]
								, lc."type" 
								, lc.status 
								, case when lc.employee = 'Y' then true when lc.employee = 'N' then false else null end
								, 'if_in'
							from
								landing.if_auto_vehicle_ws_wf_contact lc 
							where
								lc.row_id = CAST(CONTACT_ROWID[c_i] as INTEGER);
							
							
							-- asset  account(person)  
							update process.asset as pa set 
								contact_row_id__c = lc.connexcontactid 
							from						 
								landing.if_auto_vehicle_ws_wf_contact lc
							where								
								lc.row_id = CAST(CONTACT_ROWID[c_i] as INTEGER)
							and 
								pa.row_id = proc_asset_id[1];
						
						else
							-- update 'customer_vehicle' (Person)
							update process.customer_vehicle as pc set
								status_cd = case when lc.status isnull then pc.status_cd when lc.status = '' then pc.status_cd else lc.status end 
								, x_employee_flg = case when lc.employee isnull then pc.x_employee_flg when lc.employee = '' then pc.x_employee_flg else case when lc.employee = 'Y' then true when lc.employee = 'N' then false else null end end 
								, inter_flag = 'if_up'
							from
								landing.if_auto_vehicle_ws_wf_contact lc
							where
								lc.row_id = CAST(CONTACT_ROWID[c_i] as INTEGER)
							and
								pc.asset_id = proc_asset_id[1]
							and 
								pc.account_id = lc.connexcontactid;
							
							
							-- asset  account(person)  
							update process.asset as pa set 
								contact_row_id__c = lc.connexcontactid 
							from						 
								landing.if_auto_vehicle_ws_wf_contact lc
							where								
								lc.row_id = CAST(CONTACT_ROWID[c_i] as INTEGER)
							and 
								pa.row_id = proc_asset_id[1];
							
								
						end if;
							
					end loop;
				
				if contact_status = 'inactive' and nego_type > 0 then
			
					update process.asset as pass set 
						status = 'Cancelled'
						, contact_row_id__c = null
						, inter_flag = 'if_up'
					from
						landing.if_auto_vehicle_ws_wf lv
					where
						lv.row_id = CAST(param_id[1] as Integer)		
					and
						pass.row_id = proc_asset_id[1];
				
				end if;
				
			end if;			

		
		
		end if;
	
	
	
	
		if (array_length(proc_invoice_id, 1) is null or array_length(proc_invoice_id, 1) <= 0) then
		
			if array_length(contact_rowid, 1) > 0 then
				-- insert 'invoiceinfo'
				insert into process.invoiceinfo 
				(
					status
					, "name" 	
					, renavamcode__c
					, enginenumber__c
					, vehiclelicensenumber__c
					, fsc_ocn__c
					, modelname__c
					, internalcolorcode__c
					, externalcolorcode__c
					, fueltype__c
					, purchaseprice__c
					, manufactureyear__c
					, modelyear__c
					, mileage__c
					, salestodealerdate__c
					, warrantystartdate__c
					, billingdate__c
					, delivertocustomerdate__c
					, dealercode__c
					, negotiationtype__c
					, subscriptiontype__c
					, fiscalreceipt__c
					, salespersonid__c
					, salespersonfirstname__c
					, salespersonlastname__c
					, urlphoto__c
					, urlphotodate__c
					, urlauthopublication__c
					, vehiclelicensedate__c
					, digitalsales__c
					, deliveryathome 
					, tdathome 
					, ccs_flg
					, person_account_id  
					, inter_flag 
				)
				select
					lv.status 
					, lv.serialnumber 
					, lv.renavamcode 
					, lv.enginenumber 
					, lv.vehiclelicensenumber 
					, lv.fsc_ocn 
					, lv.modelname 
					, lv.internalcolorcode 
					, lv.externalcolorcode 
					, lv.fuel 
					, lv.purchaseprice 
					, lv.manufactureyear 
					, lv.modelyear 
					, lv.mileage 
					, lv.saletodealerdate 
					, lv.warrantystartdate 
					, lv.billingdate 
					, lv.delivertocustomerdate 
					, lv.sellingdealercode 
					, lv.negotiationtype 
					, lv.subscriptiontype 
					, lv.fiscalreceipt 
					, lv.salesrepid 
					, lv.salesrepfirstname 
					, lv.salesreplastname 
					, lv.urlphoto 
					, lv.urlphotodate 
					, lv.urlauthpublication 
					, lv.vehiclelicensedate 
					, (case when lv.digitalsales = 'Y' then true when lv.digitalsales = 'N' then false else null end)
					, (case when lv.deliveryathome = 'Y' then true when lv.deliveryathome = 'N' then false else null end) 
					, (case when lv.tdathome = 'Y' then true when lv.tdathome = 'N' then false else null end)
					, (case when lv.ccs_flg = 'Y' then true when lv.ccs_flg = 'N' then false else null end)
					, (select lc.connexcontactid from landing.if_auto_vehicle_ws_wf_contact lc where lc.par_row_id = lv.row_id)
					, 'if_in'
				from
					landing.if_auto_vehicle_ws_wf lv
				where
					lv.row_id = CAST(PARAM_ID[1] as INTEGER);
			end if;
		else
		

		
			
			
			
		
			if contact_status = 'inactive' and nego_type > 0 then
			
				update process.invoiceinfo as piv set 
					status = 'Inactive'
					, billingdate__c = case when lv.billingdate isnull then piv.billingdate__c else lv.billingdate end
					, inter_flag = 'if_up'
				from
					landing.if_auto_vehicle_ws_wf lv
				where
					lv.row_id = CAST(PARAM_ID[1] as INTEGER)
				and
					piv.row_id = proc_invoice_id[1];
				
			elseif contact_status = 'active' then		

				-- update 'invoiceinfo'
				update process.invoiceinfo as piv set 
					status = case when lv.status isnull then piv.status when lv.status = '' then piv.status else lv.status end
					, renavamcode__c = case when lv.renavamcode isnull then piv.renavamcode__c when lv.renavamcode = '' then piv.renavamcode__c else lv.renavamcode end 
					, enginenumber__c = case when lv.enginenumber isnull then piv.enginenumber__c when lv.enginenumber = '' then piv.enginenumber__c else lv.enginenumber end 
					, vehiclelicensenumber__c = case when lv.vehiclelicensenumber isnull then piv.vehiclelicensenumber__c when lv.vehiclelicensenumber = '' then piv.vehiclelicensenumber__c else lv.vehiclelicensenumber end 
					, fsc_ocn__c = case when lv.fsc_ocn isnull then piv.fsc_ocn__c when lv.fsc_ocn = '' then piv.fsc_ocn__c else lv.fsc_ocn end 
					, modelname__c = case when lv.modelname isnull then piv.modelname__c when lv.modelname = '' then piv.modelname__c else lv.modelname end 
					, internalcolorcode__c = case when lv.internalcolorcode isnull then piv.internalcolorcode__c when lv.internalcolorcode = '' then piv.internalcolorcode__c else lv.internalcolorcode end 
					, externalcolorcode__c = case when lv.externalcolorcode isnull then piv.externalcolorcode__c when lv.externalcolorcode = '' then piv.externalcolorcode__c else lv.externalcolorcode end 
					, fueltype__c = case when lv.fuel isnull then piv.fueltype__c when lv.fuel = '' then piv.fueltype__c else lv.fuel end 
					, purchaseprice__c = case when lv.purchaseprice isnull then piv.purchaseprice__c else lv.purchaseprice end 
					, manufactureyear__c = case when lv.manufactureyear isnull then piv.manufactureyear__c else lv.manufactureyear end 
					, modelyear__c = case when lv.modelyear isnull then piv.modelyear__c else cast(lv.modelyear as varchar(255))end 
					, mileage__c = case when lv.mileage isnull then piv.mileage__c else lv.mileage end 
					, salestodealerdate__c = case when lv.saletodealerdate isnull then piv.salestodealerdate__c else lv.saletodealerdate end 
					, warrantystartdate__c = case when lv.warrantystartdate isnull then piv.warrantystartdate__c else lv.warrantystartdate end 
					, billingdate__c = case when lv.billingdate isnull then piv.billingdate__c else lv.billingdate end 
					, delivertocustomerdate__c = case when lv.delivertocustomerdate isnull then piv.delivertocustomerdate__c else lv.delivertocustomerdate end 
					, dealercode__c = case when lv.sellingdealercode isnull then piv.dealercode__c when lv.sellingdealercode = '' then piv.dealercode__c else lv.sellingdealercode end 
					, negotiationtype__c = case when lv.negotiationtype isnull then piv.negotiationtype__c when lv.negotiationtype = '' then piv.negotiationtype__c else lv.negotiationtype end 
					, subscriptiontype__c = case when lv.subscriptiontype isnull then piv.subscriptiontype__c when lv.subscriptiontype = '' then piv.subscriptiontype__c else lv.subscriptiontype end 
					, fiscalreceipt__c = case when lv.fiscalreceipt isnull then piv.fiscalreceipt__c when lv.fiscalreceipt = '' then piv.fiscalreceipt__c else lv.fiscalreceipt end 
					, salespersonid__c = case when lv.salesrepid isnull then piv.salespersonid__c when lv.salesrepid = '' then piv.salespersonid__c else lv.salesrepid end 
					, salespersonfirstname__c = case when lv.salesrepfirstname isnull then piv.salespersonfirstname__c when lv.salesrepfirstname = '' then piv.salespersonfirstname__c else lv.salesrepfirstname end 
					, salespersonlastname__c = case when lv.salesreplastname isnull then piv.salespersonlastname__c when lv.salesreplastname = '' then piv.salespersonlastname__c else lv.salesreplastname end 
					, urlphoto__c = case when lv.urlphoto isnull then piv.urlphoto__c when lv.urlphoto = '' then piv.urlphoto__c else lv.urlphoto end 
					, urlphotodate__c = case when lv.urlphotodate isnull then piv.urlphotodate__c else lv.urlphotodate end 
					, urlauthopublication__c = case when lv.urlauthpublication isnull then piv.urlauthopublication__c when lv.urlauthpublication = '' then piv.urlauthopublication__c else lv.urlauthpublication end 
					, vehiclelicensedate__c = case when lv.vehiclelicensedate isnull then piv.vehiclelicensedate__c else lv.vehiclelicensedate end 
					, digitalsales__c = case when lv.digitalsales isnull then piv.digitalsales__c when lv.digitalsales = '' then piv.digitalsales__c else case when lv.digitalsales = 'Y' then true when lv.digitalsales = 'N' then false else null end end
					, deliveryathome  = case when lv.deliveryathome isnull then piv.deliveryathome when lv.deliveryathome = '' then piv.deliveryathome else case when lv.deliveryathome = 'Y' then true when lv.deliveryathome = 'N' then false else null end end 
					, tdathome  = case when lv.tdathome isnull then piv.tdathome when lv.tdathome = '' then piv.tdathome else case when lv.tdathome = 'Y' then true when lv.tdathome = 'N' then false else null end end
					, ccs_flg = case when lv.ccs_flg isnull then piv.ccs_flg when lv.ccs_flg = '' then piv.ccs_flg else (case when lv.ccs_flg = 'Y' then true when lv.ccs_flg = 'N' then false else null end) end
					, inter_flag = 'if_up'
				from
					landing.if_auto_vehicle_ws_wf lv
				where
					lv.row_id = CAST(PARAM_ID[1] as INTEGER)
				and
					piv.row_id = proc_invoice_id[1];
				
			else
				
				insert into process.invoiceinfo 
				(
					status
					, "name" 	
					, renavamcode__c
					, enginenumber__c
					, vehiclelicensenumber__c
					, fsc_ocn__c
					, modelname__c
					, internalcolorcode__c
					, externalcolorcode__c
					, fueltype__c
					, purchaseprice__c
					, manufactureyear__c
					, modelyear__c
					, mileage__c
					, salestodealerdate__c
					, warrantystartdate__c
					, billingdate__c
					, delivertocustomerdate__c
					, dealercode__c
					, negotiationtype__c
					, subscriptiontype__c
					, fiscalreceipt__c
					, salespersonid__c
					, salespersonfirstname__c
					, salespersonlastname__c
					, urlphoto__c
					, urlphotodate__c
					, urlauthopublication__c
					, vehiclelicensedate__c
					, digitalsales__c
					, deliveryathome 
					, tdathome 
					, ccs_flg
					, person_account_id  
					, inter_flag 
				)
				select
					lv.status 
					, lv.serialnumber 
					, lv.renavamcode 
					, lv.enginenumber 
					, lv.vehiclelicensenumber 
					, lv.fsc_ocn 
					, lv.modelname 
					, lv.internalcolorcode 
					, lv.externalcolorcode 
					, lv.fuel 
					, lv.purchaseprice 
					, lv.manufactureyear 
					, lv.modelyear 
					, lv.mileage 
					, lv.saletodealerdate 
					, lv.warrantystartdate 
					, lv.billingdate 
					, lv.delivertocustomerdate 
					, lv.sellingdealercode 
					, lv.negotiationtype 
					, lv.subscriptiontype 
					, lv.fiscalreceipt 
					, lv.salesrepid 
					, lv.salesrepfirstname 
					, lv.salesreplastname 
					, lv.urlphoto 
					, lv.urlphotodate 
					, lv.urlauthpublication 
					, lv.vehiclelicensedate 
					, (case when lv.digitalsales = 'Y' then true when lv.digitalsales = 'N' then false else null end)
					, (case when lv.deliveryathome = 'Y' then true when lv.deliveryathome = 'N' then false else null end) 
					, (case when lv.tdathome = 'Y' then true when lv.tdathome = 'N' then false else null end)
					, (case when lv.ccs_flg = 'Y' then true when lv.ccs_flg = 'N' then false else null end)
					, (select lc.connexcontactid from landing.if_auto_vehicle_ws_wf_contact lc where lc.par_row_id = lv.row_id)
					, 'if_in'
				from
					landing.if_auto_vehicle_ws_wf lv
				where
					lv.row_id = CAST(PARAM_ID[1] as INTEGER);
			
			end if;
					 
		end if;		
	
	END;
$procedure$
;

-- DROP PROCEDURE process.if_getlead_ws(_text);

CREATE OR REPLACE PROCEDURE process.if_getlead_ws(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare 
		v_len integer;
		v_i integer;
		v_count integer;
	BEGIN
		v_len := array_length(param_id, 1);
		
		FOR v_i IN 1..v_len
	     LOOP
			update process.opportunity set
				testdriverequestdatetime__c = now()
				, transferredopportunity__c = true
				, transferredopportunitydate__c = now()
				, inter_flag = 'if_up'
			where
				protocol__c = param_id[v_i];
			
			update process.service_request set
				testdriverequestdatetime__c = now()
				, transferredopportunity__c = true
				, transferredopportunitydate__c = now()
				, inter_flag = 'if_up'
			where
				protocol__c = param_id[v_i];
		 END LOOP;

	END;
$procedure$
;

-- DROP PROCEDURE process.if_in_channel_partner_inf_wf(_text, _text, _text, _text);

CREATE OR REPLACE PROCEDURE process.if_in_channel_partner_inf_wf(IN param_id text[], IN proc_acc_id text[], IN con_rowid text[], IN checkcu text[])
 LANGUAGE plpgsql
AS $procedure$
    declare 
      c_i integer;
      c_len integer;
      a_row_id varchar;
      c_row_id varchar;
      proc_con_rowid varchar;
      rel_accnt varchar;
    BEGIN
        c_len := array_length(CON_ROWID, 1);
    
    
        if checkcu[1] = 'insert' then
            -- insert 'account'         
            insert into process.account 
                (
                    integrationid 
                    , corporateregistrationnumber__c 
                    , "name"
                    , corporaterepresentativename__c 
                    , cust_stat_cd__c 
                    , situationstatusreason__c 
                    , dealershoptype__c 
                    , dealercode__c 
                    , phone 
                    , fax 
                    , emailaddress__c 
                    , sapworkaddress__c  
                    , salesflag__c
                    , serviceflag__c
                    , prtnrshp_start_dt__c
                    , prtnrshp_end_dt__c 
                    , region__c 
                    , businesshours__c 
                    , facebook__c 
                    , website 
                    , billingstreet 
                    , billingstreet_2__c 
                    , billingstreet_3__c 
                    , billingcounty 
                    , billingcity 
                    , billingstate 
                    , billinglatitude 
                    , billinglongitude 
                    , billingpostalcode 
                    , dealergroupcode__c 
                    , salesgroup__c 
                    , salesmanager__c 
                    , servicemanager__c 
                    , servicewhatsappnumber__c 
                    , saleswhatsappnumber__c 
                    , salesdistrict__c 
                    , salesoffice__c 
                    , division__c 
                    , inter_flag
                )
                select
                    lc.integrationid 
                    , lc.cnpj 
                    , lc."name" 
                    , lc.nickname 
                    , lc.accountstatus 
                    , lc.reasonstatus 
                    , lc.dealertype 
                    , lc.dealercode 
                    , lc.mainphone 
                    , lc.fax 
                    , lc.mainemailaddress 
                    , lc.workemailaddress 
                    , case when lc.salesdealerflag = 'Y' then true when lc.salesdealerflag = 'N' then false else null end
                    , case when lc.servicedealerflag = 'Y' then true when lc.servicedealerflag = 'N' then false else null end
                    , lc.partnerstartdate 
                    , lc.partnerenddate 
                    , lc.region 
                    , lc.workinghours 
                    , lc.facebookpage 
                    , lc.homepage 
                    , lc.streetaddress 
                    , lc.streetaddress2 
                    , lc.streetaddress3 
                    , lc.county 
                    , lc.city 
                    , lc.state 
                    , lc.latitude 
                    , lc.longitude 
                    , lc.postalcode 
                    , lc.dealergroup 
                    , lc.salesgroup 
                    , lc.salesmanager 
                    , lc.servicemanager 
                    , lc.servicewhatsappnumber 
                    , lc.saleswhatsappnumber 
                    , lc.salesdistrict 
                    , lc.salesoffice 
                    , lc.division 
                    , 'if_in'
                from 
                    landing.if_in_channel_partner_inf_wf lc
                where
                    lc.row_id = cast(param_id[1] as Integer);
                
                
                select
                    pa.row_id into a_row_id
                from
                    process.account pa
                join
                    landing.if_in_channel_partner_inf_wf la     
                on
                	-- SIT Test JSON integrationid  dealercode   
                    pa.dealercode__c = la.dealercode 
                where
                    (pa.corporateregistrationnumber__c  = la.cnpj
                or
                	pa."name" = la."name")
                and
                    la.row_id = cast(param_id[1] as Integer);
                
                if con_rowid notnull then 
                
                    for c_i in 1..c_len
                    loop	                    
	                    
	                    -- cpf  contact  check 
	                    select 
	                    	pc.row_id into proc_con_rowid
	                    from
	                    	process.contact pc	     
	                    join 
	                    	landing.if_in_channel_partner_inf_wf_dlrcontact lc
	                    on
	                    	pc.cpf__c = lc.cpf  
	                    where 
	                    	lc.row_id = cast(CON_ROWID[c_i] as Integer);	                    
	                    
	                    
	                    if proc_con_rowid notnull then
	                    
	                    
	                    	-- update 'contact'
                            update process.contact as pc set 
                            	firstname = case when lc.firstname isnull then pc.firstname when lc.firstname = '' then pc.firstname else lc.firstname end 
                            	, lastname = case when lc.lastname isnull then pc.lastname when lc.lastname = '' then pc.lastname else lc.lastname end  
                            	, email = case when lc.email isnull then pc.email when lc.email = '' then pc.email else lc.email end  
                                , homephone = case when lc.homephone isnull then pc.homephone when lc.homephone = '' then pc.homephone else lc.homephone end 
                                , companyphone__c = case when lc.workphone isnull then pc.companyphone__c when lc.workphone = '' then pc.companyphone__c else lc.workphone end 
                                , mobilephone = case when lc.cellphone isnull then pc.mobilephone when lc.cellphone = '' then pc.mobilephone else lc.cellphone end 
                                , title = case when lc.jobtitle isnull then pc.title when lc.jobtitle = '' then pc.title else lc.jobtitle end 
                                , note__c = case when lc.notes isnull then pc.note__c when lc.notes = '' then pc.note__c else lc.notes end 
                                , statusdealer__c = case when lc.status isnull then pc.statusdealer__c  when lc.status = '' then pc.statusdealer__c else lc.status end
                                , account_row_id = case when pc.account_row_id isnull then a_row_id else pc.account_row_id end
                                , inter_flag = 'if_up'
                            from
                                landing.if_in_channel_partner_inf_wf_dlrcontact lc
                            where
                                lc.row_id = cast(CON_ROWID[c_i] as Integer)
                            and
                                pc.row_id = proc_con_rowid;
                               
                               
                       else 
                       		
                       		--firstname, lastname, email process.contact  
                            select 
                                pc.row_id into proc_con_rowid
                            from
                                process.contact pc
                            join
                                landing.if_in_channel_partner_inf_wf_dlrcontact lc
                            on
                                pc.firstname  = lc.firstname  
                            where
                                pc.lastname = lc.lastname 
                            and 
                                pc.email = lc.email 
                            and
                                lc.row_id = cast(CON_ROWID[c_i] as Integer);
                             
                            
                            if proc_con_rowid notnull then
                            
                            	-- update 'contact'
	                            update process.contact as pc set 
	                            	firstname = case when lc.firstname isnull then pc.firstname when lc.firstname = '' then pc.firstname else lc.firstname end 
	                            	, lastname = case when lc.lastname isnull then pc.lastname when lc.lastname = '' then pc.lastname else lc.lastname end  
	                            	, email = case when lc.email isnull then pc.email when lc.email = '' then pc.email else lc.email end 
	                                , homephone = case when lc.homephone isnull then pc.homephone when lc.homephone = '' then pc.homephone else lc.homephone end 
	                                , companyphone__c = case when lc.workphone isnull then pc.companyphone__c when lc.workphone = '' then pc.companyphone__c else lc.workphone end 
	                                , mobilephone = case when lc.cellphone isnull then pc.mobilephone when lc.cellphone = '' then pc.mobilephone else lc.cellphone end 
	                                , title = case when lc.jobtitle isnull then pc.title when lc.jobtitle = '' then pc.title else lc.jobtitle end 
	                                , note__c = case when lc.notes isnull then pc.note__c when lc.notes = '' then pc.note__c else lc.notes end 
	                                , statusdealer__c = case when lc.status isnull then pc.statusdealer__c  when lc.status = '' then pc.statusdealer__c else lc.status end
	                                , account_row_id = case when pc.account_row_id isnull then a_row_id else pc.account_row_id end
	                                , inter_flag = 'if_up'
	                            from
	                                landing.if_in_channel_partner_inf_wf_dlrcontact lc
	                            where
	                                lc.row_id = cast(CON_ROWID[c_i] as Integer)
	                            and
	                                pc.row_id = proc_con_rowid;
	                               
	                               
                           else  
                      
	                    
		                        -- insert 'contact'
		                        insert into process.contact
		                        (
		                            account_row_id
		                            , integrationid 
		                            , cpf__c 
		                            , firstname 
		                            , lastname 
		                            , email 
		                            , homephone 
		                            , companyphone__c 
		                            , mobilephone 
		                            , title 
		                            , note__c 
		                            , statusdealer__c 
		                            , con_cd__c 
		                            , inter_flag
		                        )
		                        select
		                            a_row_id
		                            , lc.integrationid 
		                            , lc.cpf  
		                            , lc.firstname 
		                            , lc.lastname 
		                            , lc.email 
		                            , lc.homephone 
		                            , lc.workphone 
		                            , lc.cellphone 
		                            , lc.jobtitle 
		                            , lc.notes 
		                            , lc.status 
		                            , 'Dealer'
		                            , 'if_in'
		                        from
		                            landing.if_in_channel_partner_inf_wf_dlrcontact lc
		                        where
		                            lc.row_id = cast(CON_ROWID[c_i] as Integer);
                           end if;	 
	                   		
                       end if;
	                    	
                    end loop;
                   
                end if;
                
        end if; 
    
    
        if checkcu[1] = 'update' then
            -- update 'account'
            update process.account as pa set 
--                corporateregistrationnumber__c = case when la.cnpj isnull then pa.corporateregistrationnumber__c when la.cnpj = '' then pa.corporateregistrationnumber__c else la.cnpj end 
                "name" = case when la."name" isnull then pa."name" when la."name" = '' then pa."name" else la."name" end 
                , corporaterepresentativename__c = case when la.nickname isnull then pa.corporaterepresentativename__c when la.nickname = '' then pa.corporaterepresentativename__c else la.nickname end 
                , cust_stat_cd__c = case when la.accountstatus isnull then pa.cust_stat_cd__c when la.accountstatus = '' then pa.cust_stat_cd__c else la.accountstatus end 
                , situationstatusreason__c = case when la.reasonstatus isnull then pa.situationstatusreason__c when la.reasonstatus = '' then pa.situationstatusreason__c else la.reasonstatus end 
                , dealershoptype__c = case when la.dealertype isnull then pa.dealershoptype__c when la.dealertype = '' then pa.dealershoptype__c else la.dealertype end 
                , dealercode__c = case when la.dealercode isnull then pa.dealercode__c when la.dealercode = '' then pa.dealercode__c else la.dealercode end 
                , phone = case when la.mainphone isnull then pa.phone when la.mainphone = '' then pa.phone else la.mainphone end 
                , fax = case when la.fax isnull then pa.fax when la.fax = '' then pa.fax else la.fax end 
                , emailaddress__c = case when la.mainemailaddress isnull then pa.emailaddress__c when la.mainemailaddress = '' then pa.emailaddress__c else la.mainemailaddress end 
                , sapworkaddress__c = case when la.workemailaddress isnull then pa.sapworkaddress__c when la.workemailaddress = '' then pa.sapworkaddress__c else la.workemailaddress end  
                , salesflag__c = case when la.salesdealerflag isnull then pa.salesflag__c when la.salesdealerflag = '' then pa.salesflag__c else case when la.salesdealerflag = 'Y' then true when la.salesdealerflag = 'N' then false else null end end
                , serviceflag__c = case when la.servicedealerflag isnull then pa.serviceflag__c when la.servicedealerflag = '' then pa.serviceflag__c else case when la.servicedealerflag = 'Y' then true when la.servicedealerflag = 'N' then false else null end end 
                , prtnrshp_start_dt__c = case when la.partnerstartdate isnull then pa.prtnrshp_start_dt__c else la.partnerstartdate end 
                , prtnrshp_end_dt__c = case when la.partnerenddate isnull then pa.prtnrshp_end_dt__c else la.partnerenddate end 
                , region__c = case when la.region isnull then pa.region__c when la.region = '' then pa.region__c else la.region end 
                , businesshours__c = case when la.workinghours isnull then pa.businesshours__c when la.workinghours = '' then pa.businesshours__c else la.workinghours end 
                , facebook__c = case when la.facebookpage isnull then pa.facebook__c when la.facebookpage = '' then pa.facebook__c else la.facebookpage end 
                , website = case when la.homepage isnull then pa.website when la.homepage = '' then pa.website else la.homepage end 
                , billingstreet = case when la.streetaddress isnull then pa.billingstreet when la.streetaddress = '' then pa.billingstreet else la.streetaddress end 
                , billingstreet_2__c = case when la.streetaddress2 isnull then pa.billingstreet_2__c when la.streetaddress2 = '' then pa.billingstreet_2__c else la.streetaddress2 end 
                , billingstreet_3__c = case when la.streetaddress3 isnull then pa.billingstreet_3__c when la.streetaddress3 = '' then pa.billingstreet_3__c else la.streetaddress3 end 
                , billingcounty  = case when la.county isnull then pa.billingcounty when la.county = '' then pa.billingcounty else la.county end 
                , billingcity = case when la.city isnull then pa.billingcity when la.city = '' then pa.billingcity else la.city end 
                , billingstate = case when la.state isnull then pa.billingstate when la.state = '' then pa.billingstate else la.state end 
                , billinglatitude = case when la.latitude isnull then pa.billinglatitude end 
                , billinglongitude = case when la.longitude isnull then pa.billinglongitude end 
                , billingpostalcode = case when la.postalcode isnull then pa.billingpostalcode when la.postalcode = '' then pa.billingpostalcode else la.postalcode end
                , dealergroupcode__c = case when la.dealergroup isnull then pa.dealergroupcode__c when la.dealergroup = '' then pa.dealergroupcode__c else la.dealergroup end 
                , salesgroup__c = case when la.salesgroup isnull then pa.salesgroup__c when la.salesgroup = '' then pa.salesgroup__c else la.salesgroup end 
                , salesmanager__c = case when la.salesmanager isnull then pa.salesmanager__c when la.salesmanager = '' then pa.salesmanager__c else pa.salesmanager__c end 
                , servicemanager__c = case when la.servicemanager isnull then pa.servicemanager__c when la.servicemanager = '' then pa.servicemanager__c else pa.servicemanager__c end 
                , servicewhatsappnumber__c = case when la.servicewhatsappnumber isnull then pa.servicewhatsappnumber__c when la.servicewhatsappnumber = '' then pa.servicewhatsappnumber__c else pa.servicewhatsappnumber__c end
                , saleswhatsappnumber__c = case when la.saleswhatsappnumber isnull then pa.saleswhatsappnumber__c when la.saleswhatsappnumber = '' then pa.saleswhatsappnumber__c else pa.saleswhatsappnumber__c end 
                , salesdistrict__c = case when la.salesdistrict isnull then pa.salesdistrict__c when la.salesdistrict = '' then pa.salesdistrict__c else la.salesdistrict end 
                , salesoffice__c = case when la.salesoffice isnull then pa.salesoffice__c when la.salesoffice = '' then pa.salesoffice__c else la.salesoffice end 
                , division__c = case when la.division isnull then pa.division__c when la.division = '' then pa.division__c else la.division end
                , inter_flag = 'if_up'
            from
                landing.if_in_channel_partner_inf_wf la
            where
                la.row_id = Cast(param_id[1] as Integer)
            and
                pa.row_id = PROC_ACC_ID[1];
            
            if con_rowid notnull then 
                for c_i in 1..c_len
                    loop
                        -- cpf process.contact  
                        select 
                            pc.row_id into c_row_id
                        from
                            process.contact pc
                        join
                            landing.if_in_channel_partner_inf_wf_dlrcontact lc
                        on
                            pc.cpf__c = lc.cpf 
                        where                            
                            lc.row_id = cast(CON_ROWID[c_i] as Integer);
                            
                        
                        if c_row_id notnull then  
                    	
                            	
                            -- update 'contact'
                            update process.contact as pc set 
                            	firstname = case when lc.firstname isnull then pc.firstname when lc.firstname = '' then pc.firstname else lc.firstname end 
                            	, lastname = case when lc.lastname isnull then pc.lastname when lc.lastname = '' then pc.lastname else lc.lastname end  
                            	, email = case when lc.email isnull then pc.email when lc.email = '' then pc.email else lc.email end 
                                , homephone = case when lc.homephone isnull then pc.homephone when lc.homephone = '' then pc.homephone else lc.homephone end 
                                , companyphone__c = case when lc.workphone isnull then pc.companyphone__c when lc.workphone = '' then pc.companyphone__c else lc.workphone end 
                                , mobilephone = case when lc.cellphone isnull then pc.mobilephone when lc.cellphone = '' then pc.mobilephone else lc.cellphone end 
                                , title = case when lc.jobtitle isnull then pc.title when lc.jobtitle = '' then pc.title else lc.jobtitle end 
                                , note__c = case when lc.notes isnull then pc.note__c when lc.notes = '' then pc.note__c else lc.notes end 
                                , statusdealer__c = case when lc.status isnull then pc.statusdealer__c  when lc.status = '' then pc.statusdealer__c else lc.status end
                                , account_row_id = case when pc.account_row_id isnull then proc_acc_id[1] else pc.account_row_id end
                                , inter_flag = 'if_up'
                            from
                                landing.if_in_channel_partner_inf_wf_dlrcontact lc
                            where
                                lc.row_id = cast(CON_ROWID[c_i] as Integer)
                            and
                                pc.row_id = c_row_id;                            
                            
                        else
                            
                            --firstname, lastname, email process.contact  
                            select 
                                pc.row_id into c_row_id
                            from
                                process.contact pc
                            join
                                landing.if_in_channel_partner_inf_wf_dlrcontact lc
                            on
                                pc.firstname  = lc.firstname  
                            where
                                pc.lastname = lc.lastname 
                            and 
                                pc.email = lc.email 
                            and
                                lc.row_id = cast(CON_ROWID[c_i] as Integer);
                            
                            if c_row_id notnull then
                                -- update 'contact'
                                update process.contact as pc set 
                                	firstname = case when lc.firstname isnull then pc.firstname when lc.firstname = '' then pc.firstname else lc.firstname end 
	                            	, lastname = case when lc.lastname isnull then pc.lastname when lc.lastname = '' then pc.lastname else lc.lastname end  
	                            	, email = case when lc.email isnull then pc.email when lc.email = '' then pc.email else lc.email end 
	                                , homephone = case when lc.homephone isnull then pc.homephone when lc.homephone = '' then pc.homephone else lc.homephone end 
	                                , companyphone__c = case when lc.workphone isnull then pc.companyphone__c when lc.workphone = '' then pc.companyphone__c else lc.workphone end 
	                                , mobilephone = case when lc.cellphone isnull then pc.mobilephone when lc.cellphone = '' then pc.mobilephone else lc.cellphone end 
	                                , title = case when lc.jobtitle isnull then pc.title when lc.jobtitle = '' then pc.title else lc.jobtitle end 
	                                , note__c = case when lc.notes isnull then pc.note__c when lc.notes = '' then pc.note__c else lc.notes end 
	                                , statusdealer__c = case when lc.status isnull then pc.statusdealer__c  when lc.status = '' then pc.statusdealer__c else lc.status end
	                                , account_row_id = case when pc.account_row_id isnull then proc_acc_id[1] else pc.account_row_id end
	                                , inter_flag = 'if_up'
                                from
                                    landing.if_in_channel_partner_inf_wf_dlrcontact lc
                                where
                                    lc.row_id = cast(CON_ROWID[c_i] as Integer)
                                and
                                    pc.row_id = c_row_id;
                            
                            else
                                -- insert 'contact'
                                insert into process.contact
                                (
                                    account_row_id
                                    , integrationid 
                                    , cpf__c 
                                    , firstname 
                                    , lastname 
                                    , email 
                                    , homephone 
                                    , companyphone__c 
                                    , mobilephone 
                                    , title 
                                    , note__c 
                                    , statusdealer__c 
                                    , con_cd__c
                                    , inter_flag
                                )
                                select
                                    proc_acc_id[1]
                                    , lc.integrationid 
                                    , lc.cpf  
                                    , lc.firstname 
                                    , lc.lastname 
                                    , lc.email 
                                    , lc.homephone 
                                    , lc.workphone 
                                    , lc.cellphone 
                                    , lc.jobtitle 
                                    , lc.notes 
                                    , lc.status 
                                    , 'Dealer'
                                    , 'if_in'
                                from
                                    landing.if_in_channel_partner_inf_wf_dlrcontact lc
                                where
                                    lc.row_id  = cast(CON_ROWID[c_i] as Integer);
                            end if;  
                            
                        end if;
                        
                    end loop;   
                end if; 
                        
        
        end if;
    END;
$procedure$
;

-- DROP PROCEDURE process.if_in_color(_text);

CREATE OR REPLACE PROCEDURE process.if_in_color(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare 
		v_len integer;
		v_i integer;
		v_count integer;
	declare codeNum int;
	declare em_check varchar(30);
	begin
		v_len := array_length(param_id, 1);
		FOR v_i IN 1..v_len
	     loop
			select 
				count(aci.row_id) into codeNum
			from
				landing.if_in_color_ws_color iicwc
			join
				process.color_information aci
			on
				iicwc.code = aci.name_code
			where 
				iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
			
			select 
				description_em into em_check
			from
				landing.if_in_color_ws_color iicwc
			where 
				iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
			
			if codeNum = 0 then
				insert into process.color_information(
					external_id__c
					, "type"
					, name_code
					, lang_id__c
					, val
					, low
					, high
					, inter_flag
				)
				select 
					row_id::text
					, "type"
					, code
					, 'PTB'
					, description_pt
					, color_type
					, color_description
					, 'if_in'
				from landing.if_in_color_ws_color iicwc
				where 
					iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
				
				if em_check = null and em_check = '' then
				else
					insert into process.color_information(
					external_id__c
					, "type"
					, name_code
					, lang_id__c
					, val
					, low
					, high
					, inter_flag
					, legacy_last_upd
					)
					select 
						row_id::text
						, "type"
						, code
						, 'ENU'
						, description_em
						, color_type
						, color_description
						, 'if_in'
						, now()::date
					from landing.if_in_color_ws_color iicwc
					where 
						iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
				end if;
			else
				update process.color_information as aci set
					val = case when iicwc.description_pt isnull then aci.val when iicwc.description_pt = '' then aci.val else iicwc.description_pt end
					, low = case when iicwc.color_type isnull then aci.low when iicwc.color_type = '' then aci.low else iicwc.color_type end
					, high = case when iicwc.color_description isnull then aci.high when iicwc.color_description = '' then aci.high else iicwc.color_description end
					, external_id__c = iicwc.row_id::text
					, legacy_last_upd = now()::date
					, inter_flag = 'if_up'
				from 
					landing.if_in_color_ws_color as iicwc
				where
					aci.name_code = (select code from landing.if_in_color_ws_color where row_id =  CAST(param_id[v_i] AS INTEGER))
				and
					aci.lang_id__c = 'PTB'
				and 
					iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
				if em_check = null and em_check = '' then
				else
					update process.color_information as aci set
						val = case when iicwc.description_em isnull then aci.val when iicwc.description_em = '' then aci.val else iicwc.description_em end
						, low = case when iicwc.color_type isnull then aci.low when iicwc.color_type = '' then aci.low else iicwc.color_type end
						, high = case when iicwc.color_description isnull then aci.high when iicwc.color_description = '' then aci.high else iicwc.color_description end
						, external_id__c = iicwc.row_id::text
						, legacy_last_upd = now()::date
						, inter_flag = 'if_up'
					from 
						landing.if_in_color_ws_color as iicwc
					where
						aci.name_code = (select code from landing.if_in_color_ws_color where row_id =  CAST(param_id[v_i] AS INTEGER))
					and
						aci.lang_id__c = 'ENU'
					and 
						iicwc.row_id = CAST(param_id[v_i] AS INTEGER);
				end if;
			end if;
	
		end loop;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_in_contact_inf_wf(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_in_contact_inf_wf(IN param_id character varying, IN checkcu character varying, IN contact_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare account_rowid varchar;
	declare list_current_car text[];
 	declare c_i integer;
 	declare c_len integer;
	begin			

		-- CurrentCar row_id array  
		list_current_car := ARRAY(
					SELECT 
						l.row_id
					from 
						landing.if_in_contact_inf_wf_car l
					where
						l.par_row_id = Cast(param_id as Integer)
					);	
		c_len := array_length(list_current_car, 1);
	
		
		if checkcu = 'insert' then
			-- insert account
			with personaccount as (
				insert into process.account 
				(
					cpf__c 
					, integrationid
		            , firstname
		            , lastname 
		            , personemail 
		            , personhomephone 
		            , workphone__c 
		            , personmobilephone 
		            , personbirthdate 	
		            , income__c 
		            , productofinterest__c 
		            , calledby__c 
		            , literacy__c 		           
		            , preferredcontactchannel__c 		            
		            , persondonotcall
		            , calloptyn__pc 
		            , blockedemails__c 
		            , blockedemails__pc 
		            , blockedletters__c 
		            , blockedletters__pc 
		            , blockedmobile__c 
		            , blockedmobile__pc 
		            , blockedsms__c 
		            , blockedsms__pc 
		            , blockedvideocall__c 
		            , blockedvideocall__pc 
		            , blockedwhatsapp__c 
		            , blockedwhatsapp__pc 		           
		            , dealercode__c  
		            , registrysource__c
					, facebook__c
					, receiveproductnewsflag__c 
					, receiveretailoffersflag__c 
					, receiveserviceoffersflag__c 
					, receivenewsletterflag__c 
					, receiveeventsflag__c 
					, receiveresearchflag__c 
					, billingcounty 
					, inter_flag 
				)
				select
					iciw.cpf 
					, iciw.integrationid 
					, iciw.firstname 
					, iciw.lastname 
					, iciw.emailaddress 
					, iciw.homephone 
					, iciw.workphone 
					, iciw.cellphone 
					, iciw.birthdate 
					, iciw.income 
					, iciw.carofinterest 
					, iciw.calledby 
					, iciw.literacy 
					, iciw.wayofcontact 
					, case when iciw.suppressallcalls = 'Y' then true when iciw.suppressallcalls = 'N' then false else null end
					, case when iciw.suppressallcalls = 'Y' then true when iciw.suppressallcalls = 'N' then false else null end
					, case when iciw.suppressallemails = 'Y' then true when iciw.suppressallemails = 'N' then false else null end 
					, case when iciw.suppressallemails = 'Y' then true when iciw.suppressallemails = 'N' then false else null end  
					, case when iciw.suppressallmailings = 'Y' then true when iciw.suppressallmailings = 'N' then false else null end
					, case when iciw.suppressallmailings = 'Y' then true when iciw.suppressallmailings = 'N' then false else null end
					, case when iciw.suppressallmobile = 'Y' then true when iciw.suppressallmobile = 'N' then false else null end
					, case when iciw.suppressallmobile = 'Y' then true when iciw.suppressallmobile = 'N' then false else null end
					, case when iciw.suppressallsms = 'Y' then true when iciw.suppressallsms = 'N' then false else null end
					, case when iciw.suppressallsms = 'Y' then true when iciw.suppressallsms = 'N' then false else null end 
					, case when iciw.suppressallvideocall = 'Y' then true when iciw.suppressallvideocall = 'N' then false else null end
					, case when iciw.suppressallvideocall = 'Y' then true when iciw.suppressallvideocall = 'N' then false else null end
					, case when iciw.suppressallwhatsapp = 'Y' then true when iciw.suppressallwhatsapp = 'N' then false else null end
					, case when iciw.suppressallwhatsapp = 'Y' then true when iciw.suppressallwhatsapp = 'N' then false else null end										
					, iciw.favorite_dealer 
					, iciw."source" 
					, iciw.facebooksegment 
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
					, iciw.country 
					, 'if_in'
				from
					landing.if_in_contact_inf_wf iciw 		
				where
					iciw.row_id = CAST(param_id as INTEGER)
				returning row_id
			)	-- insert contact
			insert into process.contact 
			(
				account_row_id
				, integrationid
	            , cpf__c
	            , firstname
	            , lastname
	            , email
	            , homephone
	            , mobilephone
	            , gender__c
	            , birthdate
	            , preferredcontactchannel__c
	            , maritalstatus__c	
	            , occupation__c
	            , attrib_36__c
	            , productofinterest__c
	            , literacy__c
	            , x_seg_behavioral__c
	            , x_seg_value__c
	            , x_seg_google__c
	            , x_seg_facebook__c
	            , x_seg_life_cycle__c
	            , x_seg_interest__c
	            , receiveproductnewsflag__c 
	            , receiveretailoffersflag__c 
	            , receiveserviceoffersflag__c 
	            , receivenewsletterflag__c 
	            , receiveeventsflag__c 
	            , receiveresearchflag__c 
	            , x_already_customer__c
	            , mailingstreet
	            , mailingstreet_2__c
	            , mailingstreet_3__c
	            , mailingcity
	            , mailingstate
	            , mailingpostalcode
	            , calledby__c
	            , inter_flag 
			) 
			select
				pa.row_id
				, iciw.integrationid 
				, iciw.cpf 
				, iciw.firstname 
				, iciw.lastname 
				, iciw.emailaddress 
				, iciw.homephone 
				, iciw.cellphone 
				, iciw.gender 
				, iciw.birthdate 
				, iciw.wayofcontact 
				, iciw.maritalstatus 		
				, iciw.occupation 
				, iciw.income 
				, iciw.carofinterest 
				, iciw.literacy 
				, iciw.behavioralsegment 
				, iciw.valuesegment 
				, iciw.googlesegment 
				, iciw.facebooksegment 
				, iciw.lifecyclesegment 
				, iciw.interestsegment				
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, iciw.already_customer 
				, iciw.streetaddress 
				, iciw.streetaddress2 
				, iciw.streetaddress3 
				, iciw.city 
				, iciw.state 
				, iciw.postalcode 
				, iciw.calledby 		
				, 'if_in'
			from
				landing.if_in_contact_inf_wf iciw, personaccount pa
			where
				iciw.row_id = CAST(param_id as INTEGER);
			
		end if;
	
		if checkcu = 'update' then
		
			-- update account
			update process.account as pa set 
--                cpf__c = case when iciw.cpf isnull then pa.cpf__c when iciw.cpf = '' then pa.cpf__c else iciw.cpf end
                firstname  = case when iciw.firstname isnull then pa.firstname when iciw.firstname = '' then pa.firstname else iciw.firstname end
                , lastname = case when iciw.lastname isnull then pa.lastname when iciw.lastname = '' then pa.lastname else iciw.lastname end  
                , personemail = case when iciw.emailaddress isnull then pa.personemail when iciw.emailaddress = '' then pa.personemail else iciw.emailaddress end  
                , workphone__c = case when iciw.workphone isnull then pa.workphone__c when iciw.workphone = '' then pa.workphone__c else iciw.workphone end  
                , personhomephone = case when iciw.homephone isnull then pa.personhomephone when iciw.homephone = '' then pa.personhomephone else iciw.homephone end  
                , gender__pc = case when iciw.gender isnull then pa.gender__pc when iciw.gender = '' then pa.gender__pc else iciw.gender end 
                , personmobilephone = case when iciw.cellphone isnull then pa.personmobilephone when iciw.cellphone = '' then pa.personmobilephone else iciw.cellphone end                 
                , personbirthdate = case when iciw.birthdate isnull then pa.personbirthdate else iciw.birthdate end  
                , income__c = case when iciw.income isnull then pa.income__c when iciw.income = '' then pa.income__c else iciw.income end  
                , productofinterest__c = case when iciw.carofinterest isnull then pa.productofinterest__c when iciw.carofinterest = '' then pa.productofinterest__c else iciw.carofinterest end  
                , calledby__c = case when iciw.calledby isnull then pa.calledby__c when iciw.calledby = '' then pa.calledby__c else iciw.calledby end 
                , literacy__c = case when iciw.literacy isnull then pa.literacy__c when iciw.literacy = '' then pa.literacy__c else iciw.literacy end  
                , preferredcontactchannel__c = case when iciw.wayofcontact isnull then pa.preferredcontactchannel__c when iciw.wayofcontact = '' then pa.preferredcontactchannel__c else iciw.wayofcontact end
                , persondonotcall = case when iciw.suppressallcalls isnull then pa.persondonotcall when iciw.suppressallcalls = '' then pa.persondonotcall else case when iciw.suppressallcalls = 'Y' then true when iciw.suppressallcalls = 'N' then false else null end end
	            , calloptyn__pc = case when iciw.suppressallcalls isnull then pa.calloptyn__pc when iciw.suppressallcalls = '' then pa.calloptyn__pc else case when iciw.suppressallcalls = 'Y' then true when iciw.suppressallcalls = 'N' then false else null end end
--	            , blockedemails__c = case when iciw.suppressallemails isnull then pa.blockedemails__c when iciw.suppressallemails = '' then pa.emailaddress__c else case when iciw.suppressallemails = 'Y' then true when iciw.suppressallemails = 'N' then false else null end end
	            , blockedemails__pc = case when iciw.suppressallemails isnull then pa.blockedemails__pc when iciw.suppressallemails = '' then pa.blockedemails__pc else case when iciw.suppressallemails = 'Y' then true when iciw.suppressallemails = 'N' then false else null end  end 
	            , blockedletters__c = case when iciw.suppressallmailings isnull then pa.blockedletters__c when iciw.suppressallmailings = '' then pa.blockedletters__c else case when iciw.suppressallmailings = 'Y' then true when iciw.suppressallmailings = 'N' then false else null end end
	            , blockedletters__pc = case when iciw.suppressallmailings isnull then pa.blockedletters__pc when iciw.suppressallmailings = '' then pa.blockedletters__pc else case when iciw.suppressallmailings = 'Y' then true when iciw.suppressallmailings = 'N' then false else null end end 
	            , blockedmobile__c = case when iciw.suppressallmobile isnull then pa.blockedmobile__c when iciw.suppressallmobile = '' then pa.blockedmobile__c else case when iciw.suppressallmobile = 'Y' then true when iciw.suppressallmobile = 'N' then false else null end end
	            , blockedmobile__pc = case when iciw.suppressallmobile isnull then pa.blockedmobile__pc when iciw.suppressallmobile = '' then pa.blockedmobile__pc else case when iciw.suppressallmobile = 'Y' then true when iciw.suppressallmobile = 'N' then false else null end end 
	            , blockedsms__c = case when iciw.suppressallsms isnull then pa.blockedsms__c when iciw.suppressallsms = '' then pa.blockedsms__c else case when iciw.suppressallsms = 'Y' then true when iciw.suppressallsms = 'N' then false else null end end
	            , blockedsms__pc = case when iciw.suppressallsms isnull then pa.blockedsms__pc when iciw.suppressallsms = '' then pa.blockedsms__pc else case when iciw.suppressallsms = 'Y' then true when iciw.suppressallsms = 'N' then false else null end end
	            , blockedvideocall__c = case when iciw.suppressallvideocall isnull then pa.blockedvideocall__c when iciw.suppressallvideocall = '' then pa.blockedvideocall__c else case when iciw.suppressallvideocall = 'Y' then true when iciw.suppressallvideocall = 'N' then false else null end end
	            , blockedvideocall__pc = case when iciw.suppressallvideocall isnull then pa.blockedvideocall__pc when iciw.suppressallvideocall = '' then pa.blockedvideocall__pc else case when iciw.suppressallvideocall = 'Y' then true when iciw.suppressallvideocall = 'N' then false else null end end
	            , blockedwhatsapp__c = case when iciw.suppressallwhatsapp isnull then pa.blockedwhatsapp__c when iciw.suppressallwhatsapp = '' then pa.blockedwhatsapp__c else case when iciw.suppressallwhatsapp = 'Y' then true when iciw.suppressallwhatsapp = 'N' then false else null end end
	            , blockedwhatsapp__pc = case when iciw.suppressallwhatsapp isnull then pa.blockedwhatsapp__pc when iciw.suppressallwhatsapp = '' then pa.blockedwhatsapp__pc else case when iciw.suppressallwhatsapp = 'Y' then true when iciw.suppressallwhatsapp = 'N' then false else null end end
				, dealercode__c = case when iciw.favorite_dealer isnull then pa.dealercode__c when iciw.favorite_dealer = '' then pa.dealercode__c else iciw.favorite_dealer end
				, registrysource__c = case when iciw."source" isnull then pa.registrysource__c when iciw."source" = '' then pa.registrysource__c else iciw."source" end
				, facebook__c = case when iciw.facebooksegment isnull then pa.facebook__c when iciw.facebooksegment = '' then pa.facebook__c else iciw.facebooksegment end
				, receiveproductnewsflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, receiveretailoffersflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, receiveserviceoffersflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, receivenewsletterflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, receiveeventsflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, receiveresearchflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
				, billingcounty = case when iciw.country isnull then pa.billingcounty when iciw.country = '' then pa.billingcounty else iciw.country end 
				, inter_flag = 'if_up'
		    from 
				landing.if_in_contact_inf_wf iciw 
			where 
				pa.row_id = contact_id
			and 
				iciw.row_id = CAST(param_id as INTEGER);
	
			
			
			
			
			
			-- update contact
			update process.contact as pc set 
--	            cpf__c = case when iciw.cpf isnull then pc.cpf__c when iciw.cpf = '' then pc.cpf__c else iciw.cpf end
                firstname = case when iciw.firstname isnull then pc.firstname when iciw.firstname = '' then pc.firstname else iciw.firstname end
                , lastname = case when iciw.lastname isnull then pc.lastname when iciw.lastname = '' then pc.lastname else iciw.lastname end  
	            , email = case when iciw.emailaddress isnull then pc.email when iciw.emailaddress = '' then pc.email else iciw.emailaddress end 
	            , homephone = case when iciw.homephone isnull then pc.homephone when iciw.homephone = '' then pc.homephone else iciw.homephone end
	            , mobilephone = case when iciw.cellphone isnull then pc.mobilephone when iciw.cellphone = '' then pc.mobilephone else iciw.cellphone end
	            , gender__c = case when iciw.gender isnull then pc.gender__c when iciw.gender = '' then pc.gender__c else iciw.gender end
	            , birthdate = case when iciw.birthdate isnull then pc.birthdate else iciw.birthdate end 
	            , preferredcontactchannel__c = case when iciw.wayofcontact isnull then pc.preferredcontactchannel__c when iciw.wayofcontact = '' then pc.preferredcontactchannel__c else iciw.wayofcontact end 
	            , maritalstatus__c = case when iciw.maritalstatus isnull then pc.maritalstatus__c when iciw.maritalstatus = '' then pc.maritalstatus__c else iciw.maritalstatus end
	            , occupation__c = case when iciw.occupation isnull then pc.occupation__c when iciw.occupation = '' then pc.occupation__c else iciw.occupation end
	            , attrib_36__c = case when iciw.income isnull then pc.attrib_36__c when iciw.income = '' then pc.attrib_36__c else iciw.income end
	            , productofinterest__c = case when iciw.carofinterest isnull then pc.productofinterest__c when iciw.carofinterest = '' then pc.productofinterest__c else iciw.carofinterest end
	            , literacy__c = case when iciw.literacy isnull then pc.literacy__c when iciw.literacy = '' then pc.literacy__c else iciw.literacy end
	            , x_seg_behavioral__c = case when iciw.behavioralsegment isnull then pc.x_seg_behavioral__c when iciw.behavioralsegment = '' then pc.x_seg_behavioral__c else iciw.behavioralsegment end
	            , x_seg_value__c = case when iciw.valuesegment isnull then pc.x_seg_value__c when iciw.valuesegment = '' then pc.x_seg_value__c else iciw.valuesegment end
	            , x_seg_google__c = case when iciw.googlesegment isnull then pc.x_seg_google__c when iciw.googlesegment = '' then pc.x_seg_google__c else iciw.googlesegment end
	            , x_seg_facebook__c = case when iciw.facebooksegment isnull then pc.x_seg_facebook__c when iciw.facebooksegment = '' then pc.x_seg_facebook__c else iciw.facebooksegment end 
	            , x_seg_life_cycle__c = case when iciw.lifecyclesegment isnull then pc.x_seg_life_cycle__c when iciw.lifecyclesegment = '' then pc.x_seg_life_cycle__c else iciw.lifecyclesegment end
	            , x_seg_interest__c = case when iciw.interestsegment isnull then pc.x_seg_interest__c when iciw.interestsegment = '' then pc.x_seg_interest__c else iciw.interestsegment end
	            , x_loyalty_optin_flg__c = case when iciw.contactoptin isnull then pc.x_loyalty_optin_flg__c when iciw.contactoptin = '' then pc.x_loyalty_optin_flg__c else iciw.contactoptin end     
	            , x_already_customer__c = case when iciw.already_customer isnull then pc.x_already_customer__c when iciw.already_customer = '' then pc.x_already_customer__c else iciw.already_customer end
	            , mailingstreet = case when iciw.streetaddress isnull then pc.mailingstreet when iciw.streetaddress = '' then pc.mailingstreet else iciw.streetaddress end
	            , mailingstreet_2__c = case when iciw.streetaddress2 isnull then pc.mailingstreet_2__c when iciw.streetaddress2 = '' then pc.mailingstreet_2__c else iciw.streetaddress2 end
	            , mailingstreet_3__c = case when iciw.streetaddress3 isnull then pc.mailingstreet_3__c when iciw.streetaddress3 = '' then pc.mailingstreet_3__c else iciw.streetaddress3 end
	            , mailingcity = case when iciw.city isnull then pc.mailingcity when iciw.city = '' then pc.mailingcity else iciw.city end
	            , mailingstate = case when iciw.state isnull then pc.mailingstate when iciw.state = '' then pc.mailingstate else iciw.state end
	            , mailingpostalcode = case when iciw.postalcode isnull then pc.mailingpostalcode when iciw.postalcode = '' then pc.mailingpostalcode else iciw.postalcode end
	            , calledby__c = case when iciw.calledby isnull then pc.calledby__c when iciw.calledby = '' then pc.calledby__c else iciw.calledby end 
	            , receiveproductnewsflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , receiveretailoffersflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , receiveserviceoffersflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , receivenewsletterflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , receiveeventsflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , receiveresearchflag__c = case when iciw.contactoptin = 'Y' then true when iciw.contactoptin = 'N' then false else null end
	            , inter_flag = 'if_up'
			from 
				landing.if_in_contact_inf_wf iciw 
			where
				pc.account_row_id  = contact_id	
			and
				iciw.row_id  = CAST(param_id as INTEGER);
			
			
			-- update 'asset' // mileage   
			
			
			
			
			
			
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_in_rental_car_rq_rs(_text);

CREATE OR REPLACE PROCEDURE process.if_in_rental_car_rq_rs(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare 
		v_len integer;
		v_i integer;
		v_count integer;
	BEGIN
		v_len := array_length(param_id, 1);
		
		FOR v_i IN 1..v_len
	    loop
		    update process.rental as prt set
		    	rental_status__c = iircrr.rental_status
		    	, deltaprotocolnumber__c = 'Delta Protocol Number'
		    	, confirmedmodelofrentalcar__c = iircrr.confirmedmodelofrentalcar
		    	, confirmedrentalstartdate__c = iircrr.confirmedrentalstartdate
		    	, confirmedrentalenddate__c = iircrr.confirmedrentalenddate
		    	, external_id__c = iircrr.row_id
		    	, inter_flag = 'if_up'
		    from
		    	landing.if_in_rental_car_rq_rs iircrr
		    where 
		    	prt.name = iircrr.name
		    and
		    	iircrr.row_id = CAST(param_id[v_i] AS INTEGER);
	    end loop;
	    
	END;
$procedure$
;

-- DROP PROCEDURE process.if_in_repair_order(varchar);

CREATE OR REPLACE PROCEDURE process.if_in_repair_order(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare repair_ck int;
	declare repair_servivce_ck int;
	declare repair_service_rowid text[];
	declare repair_service_ch int;
	declare v_rsr_i integer;
	declare v_rsr_len integer;
	declare v_rsur_i integer;
	declare v_rsur_len integer;
	declare repair_ro_id varchar;
	declare repair_part_rowid text[];
	declare repair_part_ch int;
	declare v_rpr_i integer;
	declare v_rpr_len integer;
	declare v_rpur_i integer;
	declare v_rpur_len integer;
	declare repair_insert_ck int;
	BEGIN
		select 
			count(*) into repair_ck
		from 
			landing.if_in_repair_order iiro
		join
			process.zhbrsdt1728 pz1728
		on
			iiro.soid = pz1728.soid and iiro.dealercode = pz1728.dealercode and iiro.vincode = pz1728.vincode
		where 
			row_id = CAST(param_id as INTEGER);
		
		select (soid||dealercode||vincode) into repair_ro_id from landing.if_in_repair_order as iiro where iiro.row_id = CAST(param_id as INTEGER);	
		
		if repair_ck > 0 then
			update process.zhbrsdt1728 as pz1728 set
				mileage = case when iiro.mileage isnull then pz1728.mileage else iiro.mileage end
				, cpf = case when iiro.cpf isnull then pz1728.cpf else iiro.cpf end
				, opendt = case when iiro.opendt isnull then pz1728.opendt else iiro.opendt end
				, closedt = case when iiro.closedt isnull then pz1728.closedt else iiro.closedt end
				, status = case when iiro.status isnull then pz1728.status else iiro.status end
				, total_value = case when iiro.total_value isnull then pz1728.total_value else iiro.total_value end
				, inter_flag = 'if_up'
			from landing.if_in_repair_order as iiro
			where
				pz1728.soid = iiro.soid
			and
				pz1728.dealercode = iiro.dealercode
			and
				pz1728.vincode = iiro.vincode
			and
				iiro.row_id = CAST(param_id as INTEGER);
				
		else
			
		
			insert into process.zhbrsdt1728(
				soid
				, dealercode
				, vincode
				, mileage
				, cpf
				, opendt
				, closedt
				, status
				, total_value
				, ro_id
				, account_id
				, asset_id
				, dealer_account_id
				, inter_flag
			)select
				soid
				, dealercode
				, vincode
				, mileage
				, cpf
				, opendt
				, closedt
				, status
				, total_value
				, repair_ro_id
				, (select row_id from process.account where cpf__c = cpf)
				, (select row_id from process.asset where serialnumber = vincode)
				, (select row_id from process.account where dealercode__c = dealercode limit 1)
				, 'if_in'
			from
				landing.if_in_repair_order iiro 
			where 
				iiro.row_id = CAST(param_id as INTEGER);
			
			select 
				count(repair_ro_id) into repair_insert_ck
			from
				process.zhbrsdt1728 pz1728
			where 
				ro_id = repair_ro_id
			and
				asset_id notnull
			and 
				mileage notnull;
			
			if repair_insert_ck > 0 then
				update process.asset as pas set
					latestmileage__c = pz1728.mileage 
				from
					process.zhbrsdt1728 as pz1728
				where
					pas.row_id = pz1728.asset_id 
				and
					pz1728.ro_id = repair_ro_id;
			end if;
			
		end if;
	
		
		--select repair_service_rowid(row_id::text) from landing.if_in_repair_order_service iiros where par_row_id = CAST(param_id as INTEGER);
		
		-- repair Service row_id 
		select array_agg(row_id::text) into repair_service_rowid from landing.if_in_repair_order_service iiros where par_row_id = CAST(param_id as INTEGER);
		
		v_rsr_len := array_length(repair_service_rowid, 1);	
		if 0 < v_rsr_len then
			FOR v_rsr_i IN 1..v_rsr_len
		     loop
			     -- repair Service update 
				select 
					count(iiros.row_id) into repair_service_ch
				from 
					landing.if_in_repair_order_service iiros
				join
					process.zhbrsdt1729 pz1729
				on
					iiros.soid = pz1729.soid and iiros.dealercode = pz1729.dealercode and iiros.vincode = pz1729.vincode and iiros.itmnum = pz1729.itmnum
				where 
					iiros.row_id = CAST(repair_service_rowid[v_rsr_i] as INTEGER);
				
				if 0 < repair_service_ch then
					update process.zhbrsdt1729 as pz1729 set
						sotype = case when iiros.sotype isnull then pz1729.sotype else iiros.sotype end
						, codsrc = case when iiros.codsrc isnull then pz1729.codsrc else iiros.codsrc end
						, zdesc = case when iiros.zdesc isnull then pz1729.zdesc else iiros.zdesc end
						, zqty = case when iiros.zqty isnull then pz1729.zqty else iiros.zqty end
						, value = case when iiros.value isnull then pz1729.value else iiros.value end
						, erdat = case when iiros.erdat isnull then pz1729.erdat else iiros.erdat end
						, erzet = case when iiros.erzet isnull then pz1729.erzet else iiros.erzet end
						, aedat = case when iiros.aedat isnull then pz1729.aedat else iiros.aedat end
						, aezet = case when iiros.aezet isnull then pz1729.aezet else iiros.aezet end
						, inter_flag = 'if_up'
					from 
						landing.if_in_repair_order_service iiros
					where 
						pz1729.soid = iiros.soid
					and
						pz1729.dealercode = iiros.dealercode
					and
						pz1729.vincode = iiros.vincode
					and
						pz1729.itmnum = iiros.itmnum
					and
						iiros.row_id = CAST(repair_service_rowid[v_rsr_i] as INTEGER);
				else
					insert into process.zhbrsdt1729(
						soid
						, dealercode
						, vincode
						, itmnum
						, sotype
						, codsrc
						, zdesc
						, zqty
						, value
						, erdat
						, erzet
						, aedat
						, aezet
						, ro_id
						, ro_service_id
						, inter_flag
					)select
						soid
						, dealercode
						, vincode
						, itmnum
						, sotype
						, codsrc
						, zdesc
						, zqty
						, value
						, erdat
						, erzet
						, aedat
						, aezet
						, repair_ro_id
						, soid||dealercode||vincode||itmnum
						, 'if_in'
					from 
						landing.if_in_repair_order_service iiros
					where
						iiros.row_id = CAST(repair_service_rowid[v_rsr_i] as INTEGER);
				end if;
		     end loop;
	    end if;
	   select array_agg(row_id::text) into repair_part_rowid from landing.if_in_repair_parts iirop where par_row_id = CAST(param_id as INTEGER);
	    
	   v_rpr_len := array_length(repair_part_rowid, 1);	
	   
	  if 0 < v_rpr_len then
		   FOR v_rpr_i IN 1..v_rpr_len
		     loop
		     	-- repair Service update 
				select 
					count(iirop.row_id) into repair_part_ch
				from 
					landing.if_in_repair_parts iirop
				join
					process.zhbrsdt1730 pz1730
				on
					iirop.soid = pz1730.soid and iirop.dealercode = pz1730.dealercode and iirop.vincode = pz1730.vincode and iirop.itmnum = pz1730.itmnum
				where 
					iirop.row_id = CAST(repair_part_rowid[v_rpr_i] as INTEGER);
				
				if 0 < repair_part_ch then
					update process.zhbrsdt1730 as pz1730 set
						sotype = case when iirop.sotype isnull then pz1730.sotype else iirop.sotype end
						, pncode = case when iirop.pncode isnull then pz1730.pncode else iirop.pncode end
						, zdesc = case when iirop.zdesc isnull then pz1730.zdesc else iirop.zdesc end
						, zqty = case when iirop.zqty isnull then pz1730.zqty else iirop.zqty end
						, value = case when iirop.value isnull then pz1730.value else iirop.value end
						, erdat = case when iirop.erdat isnull then pz1730.erdat else iirop.erdat end
						, erzet = case when iirop.erzet isnull then pz1730.erzet else iirop.erzet end
						, aedat = case when iirop.aedat isnull then pz1730.aedat else iirop.aedat end
						, aezet = case when iirop.aezet isnull then pz1730.aezet else iirop.aezet end
						, inter_flag = 'if_up'
					from 
						landing.if_in_repair_parts iirop
					where 
						pz1730.soid = iirop.soid
					and
						pz1730.dealercode = iirop.dealercode
					and
						pz1730.vincode = iirop.vincode
					and
						pz1730.itmnum = iirop.itmnum
					and
						iirop.row_id = CAST(repair_part_rowid[v_rpr_i] as INTEGER);
				else
					insert into process.zhbrsdt1730(
						soid
						, dealercode
						, vincode
						, itmnum
						, sotype
						, pncode
						, zdesc
						, zqty
						, value
						, erdat
						, erzet
						, aedat
						, aezet
						, ro_id
						, ro_parts_id
						, inter_flag
					 )select
					 	soid
						, dealercode
						, vincode
						, itmnum
						, sotype
						, pncode
						, zdesc
						, zqty
						, value
						, erdat
						, erzet
						, aedat
						, aezet
						, repair_ro_id
						, soid||dealercode||vincode||itmnum
						, 'if_in'
					 from 
						landing.if_in_repair_parts iirop
					where
						iirop.row_id = CAST(repair_part_rowid[v_rpr_i] as INTEGER);
				end if;
		     end loop;
	     end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_mntsrvc_manage_dlr_holiday(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_mntsrvc_manage_dlr_holiday(IN param_id character varying, IN proc_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare accntid varchar;
	begin
		
		select 
			pa.row_id into accntid
		from
			process.account pa
		join
			landing.if_mntsrvc_manage_dlr_holiday lh
		on	
			pa.dealercode__c = lh.dealer_code 
		where 
			lh.row_id = CAST(param_id as Integer)
		limit 1;
		
		IF checkcu = 'insert' then
			insert into process.dealerholiday
			(
				par_row_id__c 				
				, holiday_name__c
				, holiday_date__c
				, holiday_day__c 
				, type__c
				, inter_flag
			)
			select
	            accntid
	            , mmdh.holiday_description
	            , mmdh.holiday_date
	            , public.get_dayofweek(mmdh.holiday_date)
	            , 'Dealer Local Holiday' 
	            , 'if_in'
			from   
				landing.if_mntsrvc_manage_dlr_holiday mmdh			
			where 
				mmdh.row_id = cast(param_id as INTEGER);
		end if;
	
	
		IF checkcu ='update' then		
			update process.dealerholiday pdh set
				holiday_name__c = case when mmdh.holiday_description isnull then pdh.holiday_name__c else mmdh.holiday_description end 
				, holiday_date__c = case when mmdh.holiday_date	isnull then pdh.holiday_date__c else mmdh.holiday_date end
				, holiday_day__c = case when public.get_dayofweek(mmdh.holiday_date) isnull then pdh.holiday_day__c else public.get_dayofweek(mmdh.holiday_date) end 
				, lastmodifieddate = now()
				, lastmodifiedby = mmdh."source" 
				, inter_flag = 'if_up'
			from landing.if_mntsrvc_manage_dlr_holiday mmdh
			where 
--				pdh.holiday_date__c = mmdh.holiday_date 
--			and 
				pdh.row_id = proc_id
			and 
				mmdh.row_id = cast(param_id as INTEGER);
		
		end if;	
	
		if checkcu ='delete' then
			delete from 
				process.dealerholiday
			where 
				row_id  = PROC_ID;
			
		end if;	
	

	END;
$procedure$
;

-- DROP PROCEDURE process.if_mntsrvc_manage_dlr_svc(varchar);

CREATE OR REPLACE PROCEDURE process.if_mntsrvc_manage_dlr_svc(IN parrow_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	begin
		-- delete dealerservice
		delete from 
			process.dealerservice
		where 
			par_row_id__c = PARROW_ID;
		
		
		-- insert dealerservice
		insert into process.dealerservice 
		(
			type__c 
			, par_row_id__c 
			, dlr_srvc_type__c 
			, dlr_srvc_len__c 
			, inter_flag
		)
		select			
			'Dealer Maintenance Service'
			, ld.par_row_id 
			, ld.service_type 
			, ld.service_length 
			, 'if_in'
		from
			landing.if_mntsrvc_manage_dlr_svc_service ld		
		where
			ld.par_row_id = PARROW_ID;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_mntsrvc_mng_emp_avail(varchar);

CREATE OR REPLACE PROCEDURE process.if_mntsrvc_mng_emp_avail(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare rowidnum int;
	declare rowid varchar(30);
	BEGIN
		select 
			pma.row_id  into rowid
		from 
			process.maintenanceable_availability pma
		join
			landing.if_mntsrvc_manage_emp_avail lmmea
		on
			pma.employee_cpf = lmmea.employee_cpf
--		join 
--			landing.if_mntsrvc_manage_emp_avail_day lmmead
--		on
--			lmmea.row_id = lmmead.par_row_id
		where 
			pma.dealer_code = lmmea.dealer_code
		and
			lmmea.row_id = cast(param_id as Integer);
--		and 
--			pma.day_name = lmmead.day_name
--		and 
--			cast(to_date(pma.period1_start, 'YYYY-MM-DD') as text) = cast(to_date(lmmead.period1_start, 'YYYY-MM-DD') as text)
--		and 
--			lmmea.row_id = CAST(param_id AS INTEGER); 
		
		if rowid isnull then
			insert into process.maintenanceable_availability
				(
					created
					, created_by
					, last_upd
					, last_upd_by
					, employee_cpf
					, dealer_code
					, day_name
					, period1_start
					, period1_end
					, period2_start
					, period2_end
					, period3_start
					, period3_end
					, "source"
					, absence_period
					, inter_flag
				)
				select
					now()
	                , lmmea."source" 
	                , now()
	                , lmmea."source" 
	                , lmmea.employee_cpf
	                , lmmea.dealer_code
	                , lmmead.day_name
	                , to_timestamp(lmmead.period1_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period1_end, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period2_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period2_end, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period3_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period3_end, 'hh24:mi:ss')::timestamp
					, lmmea."source" 
					, 'Y'
					, 'if_in'
				from 
					landing.if_mntsrvc_manage_emp_avail lmmea
				join
					landing.if_mntsrvc_manage_emp_avail_day lmmead
				on
					lmmea.row_id  = lmmead.par_row_id 
				where 
					lmmea.row_id = CAST(param_id AS INTEGER);
		else
		
			delete from 
				process.maintenanceable_availability pm
			using
				landing.if_mntsrvc_manage_emp_avail lm			
			where 
				pm.employee_cpf  = lm.employee_cpf
			and 
				pm.dealer_code = lm.dealer_code
			and 
				pm.excp_date isnull
			and
				lm.row_id = cast(param_id as Integer);
			
			insert into process.maintenanceable_availability
				(
					created
					, created_by
					, last_upd
					, last_upd_by
					, employee_cpf
					, dealer_code
					, day_name
					, period1_start
					, period1_end
					, period2_start
					, period2_end
					, period3_start
					, period3_end
					, "source"
					, absence_period
					, inter_flag
				)
				select
					now()
	                , lmmea."source" 
	                , now()
	                , lmmea."source" 
	                , lmmea.employee_cpf
	                , lmmea.dealer_code
	                , lmmead.day_name
	                , to_timestamp(lmmead.period1_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period1_end, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period2_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period2_end, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period3_start, 'hh24:mi:ss')::timestamp
					, to_timestamp(lmmead.period3_end, 'hh24:mi:ss')::timestamp
					, lmmea."source" 
					, 'Y'
					, 'if_in'
				from 
					landing.if_mntsrvc_manage_emp_avail lmmea
				join
					landing.if_mntsrvc_manage_emp_avail_day lmmead
				on
					lmmea.row_id  = lmmead.par_row_id 
				where 
					lmmea.row_id = CAST(param_id AS INTEGER);
--			select 
--				CAST(pma.row_id as text) into rowid
--			from 
--				process.maintenanceable_availability pma
--			join
--				landing.if_mntsrvc_manage_emp_avail lmmea
--			on
--				pma.employee_cpf = lmmea.employee_cpf
--			join 
--				landing.if_mntsrvc_manage_emp_avail_day lmmead
--			on
--				lmmea.row_id = lmmead.par_row_id
--			where 
--				pma.dealer_code = lmmea.dealer_code
--			and 
--				pma.day_name = lmmead.day_name
--			and 
--				cast(to_date(pma.period1_start, 'YYYY-MM-DD') as text) = cast(to_date(lmmead.period1_start, 'YYYY-MM-DD') as text)
--			and 
--				lmmea.row_id = CAST(param_id AS INTEGER); 
--		
--			update process.maintenanceable_availability as pma set
--				day_name = lmmead.day_name
--				, period1_start = lmmead.period1_start
--				, period1_end = lmmead.period1_end
--				, period2_start = lmmead.period2_start
--				, period2_end = lmmead.period2_end
--				, period3_start = lmmead.period3_start
--				, period3_end = lmmead.period3_end
--				, last_upd = now()
--			from 
--				landing.if_mntsrvc_manage_emp_avail_day lmmead
--			where 
--				pma.row_id = rowid
--			and 
--				lmmead.par_row_id = CAST(param_id AS INTEGER);
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_mntsrvc_mng_emp_avail_excp(varchar);

CREATE OR REPLACE PROCEDURE process.if_mntsrvc_mng_emp_avail_excp(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare checkoperation varchar(20);
	declare dealercode varchar;
	declare checkrowid varchar;
	declare days text[];
	declare d_i integer;
	declare d_len integer;
	BEGIN
		select 
			lower(lm.operation), lm.dealer_code into checkoperation, dealercode
		from 
			landing.if_mntsrvc_manage_emp_avail_excp lm 
		where 
			lm.row_id = CAST(param_id AS INTEGER); 
		
		-- excp_start_date  excp_end_date   array  
		days := ARRAY(
					SELECT 
						to_char(generate_series( lm.excp_start_date ,lm.excp_end_date, '1 day'::interval), 'YYYYMMDD') 
					from 
						landing.if_mntsrvc_manage_emp_avail_excp lm 
					where 
						row_id = CAST(param_id as Integer)
					);
				
		d_len := array_length(days, 1);

		-- delete 'maintenanceable_availability'
		IF checkoperation = 'delete' then
			delete from process.maintenanceable_availability pm
			using 
				landing.if_mntsrvc_manage_emp_avail_excp lm 
			where
				pm.row_id  = lm.excp_id
			and
				pm.employee_cpf = lm.employee_cpf
			and
				lm.row_id = cast(Param_id as Integer);
			
		end if;
	
		IF checkoperation = 'upsert' then		
			
			
			for d_i in 1..d_len				
				loop
					-- data  check
					select 
						pm.row_id  into checkrowid 
					from 
						process.maintenanceable_availability pm
					join 
						landing.if_mntsrvc_manage_emp_avail_excp lm
					on 
						pm.dealer_code = lm.dealer_code 
					and 
						pm.employee_cpf = lm.employee_cpf 
					where 
						days[d_i]::timestamp between lm.excp_start_date and lm.excp_end_date
					and
						lm.row_id = cast(Param_id as Integer)
					and 
						days[d_i]::timestamp = pm.excp_date;
					
					
					-- insert 'maintenanceable_availability'
					if checkrowid isnull then
						insert into process.maintenanceable_availability
						(
							created
							, created_by
							, last_upd
							, last_upd_by
							, employee_cpf
							, dealer_code
							, excp_start_date
							, excp_end_date
							, absence_period
							, period1_start
							, period1_end
							, period2_start
							, period2_end
							, period3_start
							, period3_end 
							, excp_desc
							, "source"
							, excp_date 
							, inter_flag
						)
						select
							now()
			                , limmeae."source" 
			                , now()
			                , limmeae."source" 
			                , limmeae.employee_cpf
			                , limmeae.dealer_code
			                , limmeae.excp_start_date
			                , limmeae.excp_end_date
			                , limmeae.absence_period
			                , to_timestamp(limmeae.period1_start, 'hh24:mi:ss')::timestamp
							, to_timestamp(limmeae.period1_end, 'hh24:mi:ss')::timestamp
							, to_timestamp(limmeae.period2_start, 'hh24:mi:ss')::timestamp
							, to_timestamp(limmeae.period2_end, 'hh24:mi:ss')::timestamp
							, to_timestamp(limmeae.period3_start, 'hh24:mi:ss')::timestamp
							, to_timestamp(limmeae.period3_end, 'hh24:mi:ss')::timestamp
							, limmeae.excp_desc
							, limmeae."source" 
							, days[d_i]::date
							, 'if_in'
						from 
							landing.if_mntsrvc_manage_emp_avail_excp limmeae
						where 
							limmeae.row_id = CAST(param_id AS INTEGER); 
						
					else 
						-- update 'maintenanceable_availability'
						update process.maintenanceable_availability as pma set
							excp_start_date = case when limmeae.excp_start_date isnull then pma.excp_start_date else limmeae.excp_start_date end 
							, excp_end_date = case when limmeae.excp_end_date isnull then pma.excp_end_date else limmeae.excp_end_date end
							, absence_period = case when limmeae.absence_period isnull then pma.absence_period when limmeae.absence_period = '' then pma.absence_period else limmeae.absence_period end 
							, period1_start = case when limmeae.period1_start isnull then pma.period1_start when limmeae.period1_start = '' then pma.period1_start else to_timestamp(limmeae.period1_start, 'hh24:mi:ss')::timestamp end 
							, period1_end = case when limmeae.period1_end isnull then pma.period1_end when limmeae.period1_end = '' then pma.period1_end else to_timestamp(limmeae.period1_end, 'hh24:mi:ss')::timestamp end 
							, period2_start = case when limmeae.period2_start isnull then pma.period2_start when limmeae.period2_start = '' then pma.period2_start else to_timestamp(limmeae.period2_start, 'hh24:mi:ss')::timestamp end 
							, period2_end = case when limmeae.period2_end isnull then pma.period2_end when limmeae.period2_end = '' then pma.period2_end else to_timestamp(limmeae.period2_end, 'hh24:mi:ss')::timestamp end 
							, period3_start = case when limmeae.period3_start isnull then pma.period3_start when limmeae.period3_start = '' then pma.period3_start else to_timestamp(limmeae.period3_start, 'hh24:mi:ss')::timestamp end 
							, period3_end = case when limmeae.period3_end isnull then pma.period3_end when limmeae.period3_end = '' then pma.period3_end else to_timestamp(limmeae.period3_end, 'hh24:mi:ss')::timestamp end 
							, "source" = case when limmeae."source" isnull then pma."source" when limmeae."source" = '' then pma."source" else limmeae."source" end 
							, last_upd = now()
							, last_upd_by = limmeae."source" 
							, inter_flag = 'if_up'
							from 
								landing.if_mntsrvc_manage_emp_avail_excp limmeae
							where 
								limmeae.row_id = CAST(param_id AS INTEGER)
							and 
								pma.excp_date between limmeae.excp_start_date and limmeae.excp_end_date;
				
				
					end if;
					
				end loop;
					
				
						
			
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_mntsrvc_schedule_maintenace(varchar);

CREATE OR REPLACE PROCEDURE process.if_mntsrvc_schedule_maintenace(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare checkrowid int;
	declare insertsrrowid varchar(22);
	declare updatesrrowid varchar(22);
	declare accntrowid varchar;
	declare contactrowid varchar;
	declare sr_protocol varchar;
	begin
		
		select process.get_proc_id('service_request'::character varying) into insertsrrowid;
		
		select 
			count(*) into checkrowid
		from
			landing.if_mntsrvc_schedule_maintenance lm
		join
			process.service_request sr
		on
			lm.srnumber = sr.protocol__c
		where
			lm.row_id = CAST(param_id AS INTEGER)
		limit 1;
		
		-- select 'account_row_id__c' 
		select 
			pa.row_id into accntrowid
		from
			process.account pa
		join
			landing.if_mntsrvc_schedule_maintenance lm
		on
			pa.dealercode__c = lm.dealercode 
		where
			lm.row_id = CAST(param_id AS INTEGER)
		limit 1;
		
		-- select 'contact_row_id__c'
		select 
			pa.row_id into contactrowid
		from
			process.account pa
		join
			landing.if_mntsrvc_schedule_maintenance lm
		on
			pa.cpf__c  = lm.customercpf  
		where
			lm.row_id = CAST(param_id AS INTEGER)
		limit 1;
		
		
		if 0 = checkrowid then
			-- insert 'service_request'
			insert into process.service_request
				(
					row_id
					, protocol__c
					, reason__c 
					, voctype__c
					, voc_class
					, voc_level_2__c
					, voc_level_3__c
					, origin
					, "method" 
					, description
					, priority
					, status
					, dealercode__c 
					, serialnumber 
					, external_id__c
					, account_row_id__c 
					, contact_row_id__c 
					, inter_flag
				)
				select
					insertsrrowid
					, process.get_protocol_id('S')
					, srReason
					, srLevel1
					, srLevel2
					, srLevel3
					, srLevel4
					, srSource
					, srMethod
					, srDescription
					, srPriority
					, srStatus
					, dealerCode
					, chassis
					, imsm.row_id 
					, accntrowid
					, contactrowid
					, 'if_in'
				from
					landing.if_mntsrvc_schedule_maintenance imsm
				where 
					imsm.row_id = CAST(param_id AS INTEGER); 
				
			select 
				sr.protocol__c into sr_protocol
			from
				process.service_request sr 
			where
				sr.row_id = insertsrrowid
			limit 1;
				
			-- insert 'dealer_appointment_history'
			insert into process.dealer_appointment_history
				(		
					created
		            , created_by
		            , last_upd
		            , last_upd_by
		            , par_row_id
					, srvc_consultant_id
					, srvc_technician_id
					, srvc_type
					, srvc_status_cd
					, srvc_arrival_date
					, srvc_start_date
					, srvc_duration
					, srvc_delivery_date
					, protocol__c 	
					, external_id__c 
					, inter_flag
				)
				select
					now()
		            , 'interface'
		            , now()
		            , 'interface'
					, insertsrrowid
					, consultantCPF
		            , technicianCPF
		            , serviceType
		            , serviceStatus
		            , serviceArrivaldate
		            , serviceStartdate
		            , serviceDuration
		            , serviceDeliverydate
		            , sr_protocol
		            , insertsrrowid
		            , 'if_in'
		        from
		        	landing.if_mntsrvc_schedule_maintenance imsm
		        where 
					imsm.row_id = CAST(param_id AS INTEGER); 
			
		end if;
	
		if 0 < checkrowid then
		
			select 
				sr.row_id into updatesrrowid 
			from  
				process.service_request sr 
			join 
				landing.if_mntsrvc_schedule_maintenance imsm 
			on 
				sr.protocol__c = imsm.srnumber 
			where 
				imsm.row_id = CAST(param_id AS INTEGER)
			limit 1; 
			
			-- update 'service_request'
			update process.service_request as sr set		
				origin = case when imsm.srsource isnull then sr.origin when imsm.srsource = '' then sr.origin else imsm.srsource end
				, "method" = case when imsm.srmethod isnull then sr."method" when imsm.srmethod = '' then sr."method" else imsm.srmethod end 
				, description = case when imsm.srdescription isnull then sr.description when imsm.srdescription = '' then sr.description else imsm.srdescription end 
				, priority = case when imsm.srpriority isnull then sr.priority when imsm.srpriority = '' then sr.priority else imsm.srpriority end 
				, status = case when imsm.srstatus isnull then sr.status when imsm.srstatus = '' then sr.status else imsm.srstatus end 
				, external_id__c = param_id
				, inter_flag = 'if_up'
			from 
				landing.if_mntsrvc_schedule_maintenance as imsm
			where 
				sr.protocol__c = imsm.srnumber
			and 
				imsm.row_id = CAST(param_id AS INTEGER); 
			
			-- update 'dealer_appointment_history'
			update process.dealer_appointment_history as pd set
				srvc_type = case when imsm.serviceType isnull then pd.srvc_type when imsm.servicetype = '' then pd.srvc_type else imsm.servicetype end 
				, srvc_status_cd = case when imsm.serviceStatus isnull then pd.srvc_status_cd when imsm.srstatus = '' then pd.srvc_status_cd else imsm.srstatus end 
				, srvc_arrival_date = case when imsm.serviceArrivaldate isnull then pd.srvc_arrival_date else imsm.servicearrivaldate end 
				, srvc_start_date = case when imsm.serviceStartdate isnull then pd.srvc_start_date else imsm.servicestartdate end 
				, srvc_duration = case when imsm.serviceDuration isnull then pd.srvc_duration else imsm.serviceduration end 
				, srvc_delivery_date = case when imsm.serviceDeliverydate isnull then pd.srvc_delivery_date else imsm.servicedeliverydate end 
				, inter_flag = 'if_up'
			from 
				landing.if_mntsrvc_schedule_maintenance as imsm
			where  
				pd.par_row_id = updatesrrowid
			and 
				imsm.row_id = CAST(param_id AS INTEGER); 
				
		end if;	
	END;
$procedure$
;

-- DROP PROCEDURE process.if_product_in_wf(varchar);

CREATE OR REPLACE PROCEDURE process.if_product_in_wf(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
    declare product_rowid varchar(15);
    declare product_num int;

    begin
        --product_rowid := concat('PRD'::text || lpad(nextval('process.seq_product'::regclass)::text, 11, '0'::text))::character varying;
        -- Product Name  
        select
            count(*) into product_num
        from 
            landing.if_product_in_wf ipiw 
        join
            process.product p 
        on
            ipiw."name" = p."name" 
        where 
            ipiw.row_id = CAST(param_id as INTEGER);
        
        
        -- insert
        if product_num = 0 then
            insert into process.product
            (
                "name"
                , source__c 
                , product_type__c  
                , part__c  
                , advanced_desc__c 
                , model_year__c 
                , chassi_model__c 
                , body_style__c 
                , sap_cylinder_capacity__c  
                , engine__c  
                , engine_desc__c 
                , version_desc__c  
                , transmission_desc__c 
                , transmission__c  
                , fuel__c 
                , doors_amount__c 
                , suggested_price__c  
                , description 
                , productcode 
                , inter_flag
            )
            select
                ipiw."name"
                , ipiw."source"
                , ipiw."type"
                , ipiw.part
                , ipiw.advdesc
                , ipiw.modelyear
                , ipiw.chassimodel 
                , ipiw.bodystyle
                , ipiw.hmbcylindercapacity
                , ipiw.engine
                , ipiw.enginedesc
                , ipiw.versiondesc 
                , ipiw.transmissiondesc 
                , ipiw.transmission
                , ipiw.fuel
                , ipiw.doorsamnt
                , ipiw.suggestedprice
                , ipiw.description 
                , ipiw.producttypecode 
                , 'if_in'
            from 
                landing.if_product_in_wf ipiw 
            where 
                ipiw.row_id = CAST(param_id as INTEGER);
            
        -- update   
        else
            update process.product p set 
                source__c = case when ipiw."source" isnull then p.source__c else ipiw."source" end 
                , product_type__c = case when ipiw."type" isnull then p.product_type__c else ipiw."type" end 
                , sap_description__c = case when ipiw.part isnull then p.sap_description__c else ipiw.part end 
                , advanced_desc__c = case when ipiw.advdesc isnull then p.advanced_desc__c else ipiw.advdesc end 
                , model_year__c = case when cast(ipiw.modelyear as float8) isnull then p.model_year__c else cast(ipiw.modelyear as float8) end 
                , chassi_model__c = case when ipiw.chassimodel isnull then p.chassi_model__c else ipiw.chassimodel end 
                , body_style__c = case when ipiw.bodystyle isnull then p.body_style__c else ipiw.bodystyle end 
                , sap_cylinder_capacity__c = case when ipiw.hmbcylindercapacity isnull then p.sap_cylinder_capacity__c else ipiw.hmbcylindercapacity end 
                , engine__c = case when ipiw.engine isnull then p.engine__c else ipiw.engine end 
                , engine_desc__c = case when ipiw.enginedesc isnull then p.engine_desc__c else ipiw.enginedesc end 
                , version_desc__c = case when ipiw.versiondesc isnull then p.version_desc__c else ipiw.versiondesc end 
                , transmission_desc__c = case when ipiw.transmissiondesc isnull then p.transmission_desc__c else ipiw.transmissiondesc end 
                , transmission__c = case when ipiw.transmission isnull then p.transmission__c else ipiw.transmission end 
                , fuel__c = case when ipiw.fuel isnull then p.fuel__c else ipiw.fuel end 
                , doors_amount__c = case when cast(ipiw.doorsamnt as VARCHAR(30)) isnull then p.doors_amount__c else cast(ipiw.doorsamnt as VARCHAR(30)) end 
                , suggested_price__c = case when ipiw.suggestedprice isnull then p.suggested_price__c else ipiw.suggestedprice end
                , description = case when ipiw.description isnull then p.description when ipiw.description = '' then p.description else ipiw.description end 
                , productcode = case when ipiw.producttypecode isnull then p.productcode when ipiw.producttypecode = '' then p.productcode else ipiw.producttypecode end
                , inter_flag = 'if_up'
            from
                landing.if_product_in_wf ipiw 
            where 
                p."name" = ipiw."name"
            and
                ipiw.row_id = CAST(param_id as INTEGER);     
        end if;
    END;
$procedure$
;

-- DROP PROCEDURE process.if_product_list_in_wf(_text);

CREATE OR REPLACE PROCEDURE process.if_product_list_in_wf(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
    declare
        v_len integer;
        v_i integer;
        v_count integer;
    begin
        v_len := array_length(param_id, 1);
    
        for v_i in 1..v_len
            loop
                select 
                    count(*) into v_count
                from
                    landing.if_product_list_in_wf_product pliw 
                join
                    process.product pp
                on
                    pliw."name" = pp."name" 
                where
                    pliw.row_id = cast(param_id[v_i] as Integer);
                
                
                if v_count = 0 then
                    insert into process.product
                    (
                        "name" 
                        , source_system__c 
                        , product_type__c  
                        , suggested_price__c 
                        , inter_flag
                    )
                    select                      
                        pliw."name" 
                        , pliw."source" 
                        , pliw."type" 
                        , pliw.suggestedprice 
                        , 'if_in'
                    from
                        landing.if_product_list_in_wf_product pliw
                    where
                        pliw.row_id = cast(param_id[v_i] as Integer);
                    
                    
                else
                    update process.product as pp set 
                        source_system__c = case when pliw."source" isnull then pp.source_system__c when pliw."source" = '' then pp.source_system__c else pliw."source" end 
                        , product_type__c = case when pliw."type" isnull then pp.product_type__c when pliw."type" = '' then pp.product_type__c else pliw."type" end 
                        , suggested_price__c = case when pliw.suggestedprice isnull then pp.suggested_price__c else pliw.suggestedprice end
                        , inter_flag = 'if_up'
                    from
                        landing.if_product_list_in_wf_product pliw
                    where
                        pliw."name" = pp."name"
                    and
                        pliw.row_id = cast(param_id[v_i] as Integer);
                end if;
                
            end loop;           
    END;
$procedure$
;

-- DROP PROCEDURE process.if_reclaimaqui_account(_text);

CREATE OR REPLACE PROCEDURE process.if_reclaimaqui_account(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare
		v_len integer;
		v_i integer;
		v_count integer;
		recl_cpf varchar;
		v_account_row_id varchar;
	BEGIN
		v_len := array_length(param_id, 1);
		
		FOR v_i IN 1..v_len
			loop
				select 
		       		cpf into recl_cpf
		       	from
		       		landing.if_reclaimaqui_retrieve_ticket_by_id lirr
		       	where 
		       		lirr.row_id = CAST(param_id[v_i] AS INTEGER);
		       	
		       	if recl_cpf notnull then
		       		select 
		       			pa.row_id into v_account_row_id
		       		from
		       			landing.if_reclaimaqui_retrieve_ticket_by_id lirr
		       		join
		       			process.account pa
		       		on
		       			lirr.cpf = pa.cpf__c 
		       		where 
		       			lirr.row_id = CAST(param_id[v_i] AS INTEGER)
		       		limit 1;
		       	else
		       		select 
		       			pa.row_id into v_account_row_id
		       		from
		       			landing.if_reclaimaqui_retrieve_ticket_by_id lirr
		       		join
		       			process.account pa
		       		on
		       			lirr.firstname = pa.firstname 
		       		and
		       			lirr.lastname = pa.lastname 
		       		and
		       			lirr.email = pa.personemail 
		       		and
		       			lirr.phonenumbers = pa.personmobilephone
		       		where
		       			lirr.row_id = CAST(param_id[v_i] AS INTEGER)
		       		limit 1;
		       	end if;
		       
		       if v_account_row_id notnull then 
					update process.account as pa set
						legacy_last_upd = last_upd::date
						, legacy_last_upd_by = last_upd_by
						, personbirthdate = case when lirr.birthday::date isnull then pa.personbirthdate else lirr.birthday::date end
						, personemail = case when lirr.email isnull then pa.personemail else lirr.email end
						, personmobilephone = case when lirr.phonenumbers isnull then pa.personmobilephone else lirr.phonenumbers end
						, firstname = case when lirr.firstname isnull then pa.firstname else lirr.firstname end
						, lastname = case when lirr.lastname isnull then pa.lastname else lirr.lastname end
						, billingcity = case when lirr.city isnull then pa.billingcity else lirr.city end
						, billingstate = case when lirr.address_state isnull then pa.billingstate else lirr.address_state end
						, reclame_aqui_id__c = lirr.id
					from
						landing.if_reclaimaqui_retrieve_ticket_by_id lirr
					where
						pa.row_id = v_account_row_id
					and
						lirr.row_id = CAST(param_id[v_i] AS INTEGER);
				end if;
				
				if v_account_row_id isnull then 
					insert into process.account(
						legacy_created
			            , legacy_created_by
			            , legacy_last_upd
			            , legacy_last_upd_by
						, reclame_aqui_id__c
						, personbirthdate
						, cpf__c
						, personemail
						, personmobilephone
						, firstname
						, lastname
						, billingcity
						, billingstate
						, inter_flag
					)select
						created::date
			            , created_by
			            , last_upd::date
			            , last_upd_by
						, lirr.id
						, lirr.birthday::date
						, lirr.cpf
						, lirr.email
						, lirr.phonenumbers
						, lirr.firstname
						, lirr.lastname
						, lirr.city
						, lirr.address_state
						, 'if_in'
					from
						landing.if_reclaimaqui_retrieve_ticket_by_id lirr
					where
						lirr.row_id = CAST(param_id[v_i] AS INTEGER);
				end if;
			end loop;
			
	END;
$procedure$
;

-- DROP PROCEDURE process.if_reclaimaqui_retrieve_ticket_by_id(_text);

CREATE OR REPLACE PROCEDURE process.if_reclaimaqui_retrieve_ticket_by_id(IN param_id text[])
 LANGUAGE plpgsql
AS $procedure$
	declare
		v_len integer;
		v_i integer;
		v_count integer;
		recl_cpf varchar;
		v_account_cpf_ck integer;
		v_account_other_ck integer;
		ra_customer_id varchar;
		v_account_row_id varchar;
	BEGIN
		v_len := array_length(param_id, 1);
		
		FOR v_i IN 1..v_len
	     loop
	     	select 
	          	count(*) into v_count
	        from
	        	landing.if_reclaimaqui_retrieve_ticket_by_id lirr
	        join
	        	process.case pc
	        on
	        	lirr.source_external_id = pc.reclame_aqui_external_id__c
	        where 
	       		 lirr.row_id = CAST(param_id[v_i] AS INTEGER);
	       		
	       	select 
	       		cpf into recl_cpf
	       	from
	       		landing.if_reclaimaqui_retrieve_ticket_by_id lirr
	       	where 
	       		lirr.row_id = CAST(param_id[v_i] AS INTEGER);
	       	
	       	if recl_cpf notnull then
	       		select 
	       			pa.row_id into v_account_row_id
	       		from
	       			landing.if_reclaimaqui_retrieve_ticket_by_id lirr
	       		join
	       			process.account pa
	       		on
	       			lirr.cpf = pa.cpf__c 
	       		where 
	       			lirr.row_id = CAST(param_id[v_i] AS INTEGER)
	       		limit 1;
	       	else
	       		select 
	       			pa.row_id into v_account_row_id
	       		from
	       			landing.if_reclaimaqui_retrieve_ticket_by_id lirr
	       		join
	       			process.account pa
	       		on
	       			lirr.firstname = pa.firstname 
	       		and
	       			lirr.lastname = pa.lastname 
	       		and
	       			lirr.email = pa.personemail 
	       		and
	       			lirr.phonenumbers = pa.personmobilephone
	       		where
	       			lirr.row_id = CAST(param_id[v_i] AS INTEGER)
	       		limit 1;
	       	end if;
	       		
	       	if 0 < v_count then 
	       		update process.case as pc set 
					reclame_aqui_status__c = case when lirr.ra_status isnull then pc.reclame_aqui_status__c else lirr.ra_status end
					, ra_issue_resolved__c = case when lirr.resolved_issue isnull then pc.ra_issue_resolved__c else lirr.resolved_issue end
					, ra_backdoing_business__c = case when lirr.back_doing_business isnull then pc.ra_backdoing_business__c else lirr.back_doing_business end
					, ra_consumer_consideration__c = case when lirr.consumer_consideration isnull then pc.ra_consumer_consideration__c else lirr.consumer_consideration end
					--, ra_consumer_consideration_date__c = case when lirr.consumer_consideration_date::timestamp isnull then pc.ra_consumer_consideration_date__c else lirr.consumer_consideration_date::timestamp end
					, ra_rating__c = case when lirr.rating::float8 isnull then pc.ra_rating__c else lirr.rating::float8 end
					, ra_rating_date__c = case when lirr.rating_date::date isnull then pc.ra_rating_date__c else lirr.rating_date::date end
					, ra_moderation_request_message__c = case when lirr.ra_moderation_request_message isnull then pc.ra_moderation_request_message__c else lirr.ra_moderation_request_message end
					, ra_moderation_response_message__c = case when lirr.ra_moderation_response_message isnull then pc.ra_moderation_response_message__c else lirr.ra_moderation_response_message end
					, ra_active_complaint__c = case when lirr.active::bool isnull then pc.ra_active_complaint__c else lirr.active::bool end
					, ra_moderation_status__c = case when lirr.moderationstatus isnull then pc.ra_moderation_status__c else lirr.moderationstatus end
					, ra_moderation_reason__c = case when lirr.moderationreason isnull then pc.ra_moderation_reason__c else lirr.moderationreason end
					, ra_moderation_request_date__c = case when lirr.moderationrequestdate isnull then pc.ra_moderation_request_date__c else lirr.moderationrequestdate end
					, ra_moderation_response_date__c = case when lirr.moderationresponsedate isnull then pc.ra_moderation_response_date__c else lirr.moderationresponsedate end
					, ra_birthday = case when lirr.birthday::date isnull then pc.ra_birthday else lirr.birthday::date end
					, ra_cpf = case when lirr.cpf isnull then pc.ra_cpf else lirr.cpf end
					, ra_email = case when lirr.email isnull then pc.ra_email else lirr.email end
					, ra_phonenumbers = case when lirr.phonenumbers isnull then pc.ra_phonenumbers else lirr.phonenumbers end
					, ra_firstname = case when lirr.firstname isnull then pc.ra_firstname else lirr.firstname end
					, ra_lastname = case when lirr.lastname isnull then pc.ra_lastname else lirr.lastname end
					, ra_city = case when lirr.city isnull then pc.ra_city else lirr.city end
					, ra_address_state = case when lirr.address_state isnull then pc.ra_address_state else lirr.address_state end
					, attach_detail_description = case when pc.attach_detail_description isnull then lirr.attach_detail_description else pc.attach_detail_description end 
					, attach_name = case when pc.attach_name isnull then lirr.attach_name else pc.attach_name end
					, attach_creation_date = case when pc.attach_creation_date isnull then lirr.attach_creation_date else pc.attach_creation_date end
					, inter_flag = 'if_up'
				from
					landing.if_reclaimaqui_retrieve_ticket_by_id lirr
				where 
					pc.reclame_aqui_external_id__c = lirr.source_external_id
				and
					lirr.row_id = CAST(param_id[v_i] AS INTEGER);
	       	else
	       		insert into process.case(
					reclame_aqui_id__c
					, origin
					, service_request_reason__c
					, reclame_aqui_external_id__c
					, reclame_aqui_status__c
					, subject
					, ra_moderation_request__c
					, request_evaluation__c
					, ra_frozen__c
					, description
					, ra_complaint_reason__c
					, ra_customer_feeling__c
					, ra_complaint_response_contents__c
					, ra_complaint_response_date__c
					, ra_issue_resolved__c
					, ra_backdoing_business__c
					, ra_consumer_consideration__c
					--, ra_consumer_consideration_date__c
					, ra_rating__c
					, ra_rating_date__c
					, ra_moderation_request_message__c
					, ra_moderation_response_message__c
					, ra_active_complaint__c
					, ra_moderation_status__c
					, ra_moderation_reason__c
					, ra_moderation_request_date__c
					, ra_moderation_response_date__c
					, ra_contact_row_id
					, ra_birthday
					, ra_cpf
					, ra_email
					, ra_phonenumbers
					, ra_firstname
					, ra_lastname
					, ra_city
					, ra_address_state
					, attach_detail_description
					, attach_name
					, attach_creation_date
					, ra_customer_id__c
					, inter_flag
				)
				select
					id
					, 'Reclame Aqui'
					, 'Complaint'
					, source_external_id
					, ra_status
					, complaint_title
					, request_moderation::bool
					, request_evaluation
					, frozen::bool
					, complaint_content
					, ra_reason
					, ra_feeling
					, complaint_response_content
					, complaint_response_date
					, resolved_issue
					, back_doing_business
					, consumer_consideration
					--, consumer_consideration_date::timestamp
					, rating::float8
					, rating_date::date
					, ra_moderation_request_message
					, ra_moderation_response_message
					, active::bool
					, moderationstatus
					, moderationreason
					, moderationrequestdate
					, moderationresponsedate
					, v_account_row_id
					, birthday
					, cpf
					, email
					, phonenumbers
					, firstname
					, lastname
					, city
					, address_state
					, attach_detail_description
					, attach_name
					, attach_creation_date
					, v_account_row_id
					, 'if_in'
				from
					landing.if_reclaimaqui_retrieve_ticket_by_id lirr
				where 
					lirr.row_id = CAST(param_id[v_i] AS INTEGER);
	       	end if;
	     end loop;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_register_in_app_ws(varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_register_in_app_ws(IN param_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
    begin
        
        if checkcu = 'insert' then
            -- insert 'loyalty_program'
            insert into process.loyalty_program 
            (
                person_account_id
                , x_src_app__c
                , inter_flag
            )
            select
                contactid
                , appsource
                , 'if_in'
            from
                landing.if_register_in_app_ws riaw 
            where               
                riaw.row_id = cast(param_id as INTEGER);
            
            -- update 'account'
            update process.account as pa set 
                loyaltystatus__c = case when lr.appstatus isnull then pa.loyaltystatus__c when lr.appstatus = '' then pa.loyaltystatus__c else lr.appstatus end
                , optinflag__c = case when lower(lr.appstatus) = 'active' then true when lower(lr.appstatus) = 'inactive' then false else pa.optinflag__c end
                , inter_flag = 'if_up'
            from
                landing.if_register_in_app_ws lr
            where
                lr.row_id = cast(param_id as INTEGER)            
            and
                pa.row_id = lr.contactid;
            
            -- update 'contact'
            update process.contact as pc set 
                loyaltystatus__c = case when lr.appstatus isnull then pc.loyaltystatus__c when lr.appstatus = '' then pc.loyaltystatus__c else lr.appstatus end 
                , x_loyalty_optin_flg__c = case when lr.appstatus isnull then pc.x_loyalty_optin_flg__c when lr.appstatus = '' then pc.x_loyalty_optin_flg__c else lr.appstatus end 
                , inter_flag = 'if_up'
            from
                landing.if_register_in_app_ws lr
            where
                lr.row_id = cast(param_id as INTEGER)
            and 
                pc.account_row_id = lr.contactid;
            
        end if;
    
        if checkcu = 'update' then
            update process.loyalty_program as plp set 
                x_src_app__c = case when riaw.appsource isnull then plp.x_src_app__c when x_src_app__c = '' then plp.x_src_app__c else riaw.appsource end 
                , inter_flag = 'if_up'
            from
                landing.if_register_in_app_ws riaw 
            where 
                plp.person_account_id = riaw.contactid 
            and
                riaw.row_id = cast(param_id as INTEGER);
            
            -- update 'account'
            update process.account as pa set 
                loyaltystatus__c = case when lr.appstatus isnull then pa.loyaltystatus__c when lr.appstatus = '' then pa.loyaltystatus__c else lr.appstatus end
                , optinflag__c = case when lower(lr.appstatus) = 'active' then true when lower(lr.appstatus) = 'inactive' then false else pa.optinflag__c end
            	, inter_flag = 'if_up'
            from
                landing.if_register_in_app_ws lr
            where
                lr.row_id = cast(param_id as INTEGER)            
            and
                pa.row_id = lr.contactid;
            
            -- update 'contact'
            update process.contact as pc set 
                loyaltystatus__c = case when lr.appstatus isnull then pc.loyaltystatus__c when lr.appstatus = '' then pc.loyaltystatus__c else lr.appstatus end 
                , x_loyalty_optin_flg__c = case when lr.appstatus isnull then pc.x_loyalty_optin_flg__c when lr.appstatus = '' then pc.x_loyalty_optin_flg__c else lr.appstatus end                 
                , inter_flag = 'if_up'
            from
                landing.if_register_in_app_ws lr
            where
                lr.row_id = cast(param_id as INTEGER)
            and 
                pc.account_row_id = lr.contactid;
        end if;
    
    END;
$procedure$
;

-- DROP PROCEDURE process.if_register_loyalty_bnf_used_ws(varchar, varchar, varchar);

CREATE OR REPLACE PROCEDURE process.if_register_loyalty_bnf_used_ws(IN param_id character varying, IN proc_id character varying, IN checkcu character varying)
 LANGUAGE plpgsql
AS $procedure$
    begin
        
        if checkcu = 'insert' then
            insert into process.loyalty_program
            (
                person_account_id
                , partnername  
                , partnercnpj 
                , dealer_account_id 
                , x_benefit_name__c 
                , x_benefit_url__c 
                , x_src_app__c 
                , inter_flag
            )
            select
                ll.contactid
                , ll.partnername
                , ll.partnercnpj 
                , ll.partnerexternalid 
                , ll.benefitname
                , ll.benefiturl
                , ll.appsource
                , 'if_in'
            from
                landing.if_register_loyalty_bnf_used_ws ll
            where
                ll.row_id = cast(param_id as Integer);       
        end if;
    
    
        if checkcu = 'update' then
            update process.loyalty_program as pl set  
                x_benefit_name__c = case when ll.benefitname isnull then pl.x_benefit_name__c when ll.benefitname = '' then pl.x_benefit_name__c else ll.benefitname end
                , x_benefit_url__c  = case when ll.benefiturl isnull then pl.x_benefit_url__c when ll.benefiturl = '' then pl.x_benefit_url__c else ll.benefiturl end 
                , x_src_app__c = case when ll.appsource isnull then pl.x_src_app__c when ll.appsource = '' then pl.x_src_app__c else ll.appsource end
                , inter_flag = 'if_up'
            from
                landing.if_register_loyalty_bnf_used_ws ll
            where
                ll.row_id = cast(param_id as Integer)            
            and
                pl.row_id = proc_id;
        end if;

    END;
$procedure$
;

-- DROP PROCEDURE process.if_service_request_attachment(varchar);

CREATE OR REPLACE PROCEDURE process.if_service_request_attachment(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare protocol_num int;
	begin
		-- protocol  check 
		select
			count(c.row_id) into protocol_num
		from
			landing.if_service_request_attachment isra 
		join
			process."case" c 
		on
			isra.srnumber = c.protocol__c 
		where
			isra.row_id = CAST(param_id as INTEGER);
		
		
		
		if protocol_num > 0 then
			update process."case" c set 
				url = case when isra.url isnull then c.url else isra.url end 
				, inter_flag = 'if_up'
			from 
				landing.if_service_request_attachment isra 
			where
				c.protocol__c = isra.srnumber 
			and 
				isra.row_id = CAST(param_id as INTEGER);
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_svc_req_chat_ws(varchar);

CREATE OR REPLACE PROCEDURE process.if_svc_req_chat_ws(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare reason_sr varchar(30);
	declare level1_sr varchar(30);
	declare level2_sr varchar(30);
	declare protocol_sr varchar(64); --ServiceRequset Number
	declare testdrive_num int;
	declare quot_num int;
	declare case_num int;
	declare srv_req_row_id varchar(30);
	declare temperaturecheck varchar(30);
	declare temp_protocol varchar(30);
	declare sr_row_id int; -- ServiceRequset insert/update  
	declare protocol_status varchar;
	declare service_type varchar;
	declare reason_check varchar;
	begin
		select 
			count(*) into sr_row_id 
		from 
			landing.if_service_request_chat_ws srww
		join
			process.service_request psr
		on
			srww.protocol = psr.protocol__c
		where 
			srww.row_id = CAST(param_id AS INTEGER);
		
		-- reason_sr, level1_sr, level2_sr  TestDrive, Quotation, Case 
		select
			lower(status)
			, protocol
		 	, (case when reason = 'Information' and level1 = 'Sales' and level2 = 'Test drive' then 'T' 
		 		 when reason = 'Sales opportunity' and level1 = 'Sales' and level2 = 'Request a quote' then 'Q'
		 		 when reason = 'Sales opportunity' and level1 = 'Marketing' and level2 = 'Promotion' then 'P'
		 		 when reason = 'Sales opportunity' and level1 = 'Visitor' and level2 = 'Dealer' then 'P'
		 		 else '' end) into protocol_status , protocol_sr , service_type
		from landing.if_service_request_chat_ws
		where row_id = CAST(param_id AS INTEGER);
	
		select 
			isrc.dlrtemperature , isrc.protocol, isrc.reason into temperaturecheck , temp_protocol, reason_check
		from
			landing.if_service_request_chat_ws isrc
		join
			process.service_request psr
		on
			isrc.protocol = psr.protocol__c
		where 
			isrc.row_id = CAST(param_id AS INTEGER);
		
		if coalesce(temperaturecheck) isnull or temperaturecheck = '' then
			if sr_row_id = 0 then
				insert into process.service_request(
					legacy_created
					, legacy_created_by
					, legacy_last_upd
					, legacy_last_upd_by
					, protocol__c
					, reason__c
					, voctype__c
					, voc_class
					, voc_level_2__c
					, voc_level_3__c
					, origin
					, "method"
					, description
					, status
					, priority
					, solution__c
					, serialnumber
					, contact_row_id__c
					, account_row_id__c
					, tendency__c
					, customersatisfied__c
					, business_row_id
					, causing_area__c
					, immobilization_date__c
					, relatedmodel__c
					, quote_description__c
					, quotetransmission__c
					, version__c
					, quote_version_price__c
					, quote_color__c
					, quote_color_price__c
					, quote_price__c
					, quote_replace_intention__c
					, roadservicerequest
					, integrationid__c
					, testdrive_confirmed__c
					, testdrive_time__c
					, date_test_drive__c
					, sales_representative_cpf
					, pne_flag__c
					, campaignid__c
					, source_tag__c
					, stock__c
					, medium_tag__c
					, content_tag__c
					, campaign_tag__c
					, additional_comments__c
					, causing_person__c
					, cust_representative__c
					, cust_representative_rel__c
					, diagnosis_difficultyflg__c
					, diagnosis_pendingflg__c
					, dlr_fup__c
					, dlr_pending__c
					, dlr_retractionflg__c
					, dlr_reversal__c
					, hotline_flg__c
					, hotline_num__c
					, hotline_open_dt__c
					, purchase_proposal_num__c
					, pwa_flg__c
					, pwa_number__c
					, pwa_oped_dt__c
					, recurrence_flg__c
					, recurrence_num__c
					, vehicle_delivery_dt__c
					, vehicle_delivery_flg__c
					, anonymous_flag__c
					, dlr_description__c
					, wants_loan__c
					, loan_type__c
					, installments_amt__c
					, down_payment__c
					, usedcar_as_down_payment__c
					, predictive_temp__c
					, external_id__c
					, inter_flag
				)
				select 
					created
				    , created_by
				    , last_upd
				    , last_upd_by
				    , process.get_protocol_id(service_type)
				    , reason
				    , level1
				    , level2
				    , level3
				    , level4
				    , source
				    , method
				    , description
					, status
				    , priority
				    , solution    
					, serialnumber
				    , contactid
				    , accountid
				    , tendency
				    , satisfaction
				    , dealerid
				    , causingarea
				    , imobilizationdate::timestamp		    
				    , relatedmodel
				    , quotedescription
				    , enginetransmission
				    , version
				    , versionprice
				    , color
				    , colorprice
				    , finalprice
				    , carreplacementintention
				    , roadservicerequest
				    , integrationid
				    , CASE when srww.tdconfirmed='Y' then true when srww.tdconfirmed='N' then false else null end tdconfirmed
				    , tdtime
				    , tddate::timestamp
				    , salesrepid
				    , CASE when srww.pneflag='Y' then true when srww.pneflag='N' then false else null end pneflag
				    , campaignid
				    , sourcetag
				    , estoque
				    , medium
				    , content
				    , campaign
				    , additionalcomments
				    , causingperson
				    , custrepresentative
				    , custrepresentativerel
				    , CASE when srww.diagnosisdifficultyflg='Y' then true when srww.diagnosisdifficultyflg='N' then false else null end diagnosisdifficultyflg
				    , CASE when srww.diagnosispendingflg='Y' then true when srww.diagnosispendingflg='N' then false else null end diagnosispendingflg
				    , dlrfup
				    , dlrpending
				    , CASE when srww.dlrretractionflg='Y' then true when srww.dlrretractionflg='N' then false else null end dlrretractionflg
				    , dlrreversal
				    , CASE when srww.hotlineflg='Y' then true when srww.hotlineflg='N' then false else null end hotlineflg
				    , hotlinenum
				    , hotlineopendt::timestamp
				    , purchaseproposalnum
				    , CASE when srww.pwaflg='Y' then true when srww.pwaflg='N' then false else null end pwaflg
				    , pwanum
				    , pwaopendt::timestamp
				    , CASE when srww.recurrenceflg='Y' then true when srww.recurrenceflg='N' then false else null end recurrenceflg
				    , recurrencenum
				    , vehicledeliverydt::timestamp
				    , CASE when srww.vehicledeliveryflg='Y' then true when srww.vehicledeliveryflg='N' then false else null end vehicledeliveryflg
				    , CASE when srww.anonymousflag='Y' then true when srww.anonymousflag='N' then false else null end anonymousflag
				    , dlrdescription
				    , CASE when srww.wantsloan='Y' then true when srww.wantsloan='N' then false else null end wantsloan
				    , loantype
				    , installmentsamt
				    , downpayment
				    , CASE when srww.usedcarasdownpaymnt='Y' then true when srww.usedcarasdownpaymnt='N' then false else null end usedcarasdownpaymnt
				    , dlrtemperature
				    , row_id
				    , 'if_in'
				from
					landing.if_service_request_chat_ws srww
				where 
					srww.row_id = CAST(param_id AS INTEGER);
				
				update landing.if_service_request_chat_ws as srww set 
					protocol = psr.protocol__c
				from 
					process.service_request psr
				where
					psr.external_id__c = CAST(srww.row_id AS TEXT)
				and
					srww.row_id = CAST(param_id AS INTEGER);
				
				-- Test Drive 
				if service_type = 'T' then
					insert into process.TestDriveHistory
					(
						row_id 
						, reason__c
						, level1__c
						, level2__c
						, level3__c
						, level4__c
						, "SourceTag__c"
						, method__c
						, "RequestDescription__c"
						, status__c
						, dealercode__c
						, serialnumber__c
						, salespersoncode__c
						, testdriverequestdate__c
						, testdriverequesttime__c
						, testdriveconfirmed__c
						, account_id__c
						, contact_id__c
						, protocolid__c
						, external_id__c
						, dealerportaltdno__c
						, testdriverequestdatetime__c
						, inter_flag
					)
					select 
						row_id
						, reason__c
						, voctype__c
						, voc_class
						, voc_level_2__c
						, voc_level_3__c
						, origin
						, "method"
						, description
						, status
						, dealerCode__c
						, serialnumber
						, sales_representative_cpf
						, date_test_drive__c
						, testdrive_time__c
						, testdrive_confirmed__c
						, account_row_id__c
						, contact_row_id__c
						, protocol__c
						, row_id
						, integrationid__c
						, date_test_drive__c
						, 'if_in'
					from
						process.service_request psr
					where
						psr.external_id__c = param_id;
				-- Quotation
				elseif service_type = 'Q' then
					insert into process.quotehistory
					(
						row_id 
						, protocolid__c
						, reason__c
						, voctype__c
						, voc_class
						, voc_level_2__c
						, voc_level_3__c
						, source_tag__c
						, method
						, requestdescription__c
						, status
						, dealercode__c
						, relatedmodel__c
						, enginetransmission__c
						, version__c
						, carversionprice__c
						, color__c
						, colorprice
						, finalprice
						, carreplacementintention
						, pneflag__c
						, campaign_id
						, account_row_id__c
						, contact_row_id__c
						, external_id__c
						, inter_flag
					)
					select 
						row_id
						, protocol__c
						, reason__c
						, voctype__c
						, voc_class
						, voc_level_2__c
						, voc_level_3__c
						, origin
						, "method"
						, description
						, status
						, dealerCode__c
						, relatedmodel__c
						, quotetransmission__c
						, version__c
						, quote_version_price__c
						, quote_color__c
						, quote_color_price__c
		        		, quote_price__c
		        		, quote_replace_intention__c
		        		, CASE when psr.pne_flag__c='Y' then true when psr.pne_flag__c='N' then false else null end pne_flag__c
		        		, campaignid__c
		        		, account_row_id__c
						, contact_row_id__c
		        		, row_id
		        		, 'if_in'
					from
						process.service_request psr
					where 
						psr.external_id__c = param_id;	
				-- Case
				else
					
					insert into process."case"
					(
						row_id 
						, protocol__c
						, service_request_reason__c
						, voctype__c
						, voc_class
						, voc_level_2__c
						, voc_level_3__c
						, origin
						, source__c
						, description
						, status
						, priority
						, resolution__c
						, anonymous__c
						, account_row_id__c
						, contact_row_id__c
						, sr_impact_cd__c
						, customersatisfied__c
						, business_row_id
						, causing_area__c
						, date_of_immobilization__c
						, relatedModel__c
						, x_quote_desc__c
						, engine_transmission__c
						, version__c
						, car_version_price__c
						, color__c
						, colorprice__c
						, unit_value__c
						, car_replacement_intention__c
						, rsa_integration_id
						, integrationid__c
						, test_drive_confirmed__c
						, time_test_drive__c
						, date_test_drive__c
						, salesrepid__c
						, pne_flg__c
						, campaignid__c
						, source_tag__c
						, stock_tag__c
						, medium_tag__c
						, content_tag__c
						, campaign_tag__c
						, add_comment__c
						, causing_person__c
						, customer_rep__c
						, customer_rep_rel__c
						, diagnosis_difficulty__c
						, diagnosis_pending__c
						, dlr_response__c
						, dlr_fup__c
						, serialnumber__c
						, asset_id
						, external__c
						, inter_flag
					)
					select
						row_id 
						, protocol__c
						, reason__c
						, voctype__c
						, voc_class
						, voc_level_2__c
						, voc_level_3__c
						, origin
						, "method"
						, description
						, status
						, priority
						, solution__c
						, CASE when anonymous_flag__c='Y' then true when anonymous_flag__c='N' then false else null end anonymousflag
						, account_row_id__c
						, contact_row_id__c
						, tendency__c
						, customersatisfied__c
						, dealerCode__c
						, causing_area__c
						, immobilization_date__c
						, relatedmodel__c
						, quote_description__c
						, quotetransmission__c
						, version__c
						, quote_version_price__c
						, quote_color__c
						, quote_color_price__c
						, cast(quote_price__c as integer)
						, quote_replace_intention__c
						, roadservicerequest
						, integrationid__c
						, CASE when testdrive_confirmed__c='Y' then true when testdrive_confirmed__c='N' then false else null end testdrive_confirmed__c
						, testdrive_time__c
						, date_test_drive__c
						, sales_representative_cpf
						, CASE when pne_flag__c='Y' then true when pne_flag__c='N' then false else null end pne_flag__c
						, campaignid__c
						, source_tag__c
						, stock__c
						, medium_tag__c
						, content_tag__c
						, campaign_tag__c
						, additional_comments__c
						, causing_person__c
						, cust_representative__c
						, cust_representative_rel__c
						, CASE when diagnosis_difficultyflg__c='Y' then true when diagnosis_difficultyflg__c='N' then false else null end diagnosis_difficultyflg__c
						, CASE when diagnosis_pendingflg__c='Y' then true when diagnosis_pendingflg__c='N' then false else null end diagnosis_pendingflg__c
						, dlr_description__c
						, dlr_fup__c
						, serialnumber
						, (select row_id from process.asset where serialnumber = serialnumber limit 1)
						, row_id
						, 'if_in'
					from process.service_request psr
					where
						psr.external_id__c = param_id;
					
					
					insert into process.cx_chat
					(
						created
						, created_by
						, last_upd
						, last_upd_by
						, chat_date
						, chat_cd
						, description
						, "source"
						, user_name
						, protocol__c
						, inter_flag
					)
					select
						created
						, created_by
						, last_upd
						, last_upd_by
						, "date"::timestamp
						, chatcode
						, proc_result_msg
						, "source"
						, "operator"
						, (select pc.protocol__c from process."case" pc join process.service_request ps on pc.protocol__c = ps.protocol__c where ps.external_id__c  = param_id)
						, 'if_in'
					from
						landing.if_service_request_chat_ws_chat srcwc
					where  
						srcwc.par_row_id = CAST(param_id AS INTEGER);
					
					
					insert into process.cx_chat_message
					(
						created
						, created_by
						, last_upd
						, last_upd_by
						, "name"
						, msg_dt
						, db_last_upd_src
						, msg_cd
						, msg_text
						, status
						, protocol__c
						, inter_flag
					)
					select
						created
						, created_by
						, last_upd
						, last_upd_by
						, msgcode
						, "date"::timestamp
						, proc_result_yn
						, msgcode
						, msg
						, msgstatus
						, (select pc.protocol__c from process."case" pc join process.service_request ps on pc.protocol__c = ps.protocol__c where ps.external_id__c  = param_id)
						, 'if_in'
					from
						landing.if_service_request_chat_ws_message srcwm
					where 
						srcwm.par_row_id = CAST(param_id AS INTEGER);
				end if;
					
			else
				if coalesce(reason_check) isnull or reason_check = '' then 
					insert into process.cx_chat
					(
						created
						, created_by
						, last_upd
						, last_upd_by
						, chat_date
						, chat_cd
						, description
						, "source"
						, user_name
						, protocol__c
						, inter_flag
					)
					select
						created
						, created_by
						, last_upd
						, last_upd_by
						, "date"::timestamp
						, chatcode
						, proc_result_msg
						, "source"
						, "operator"
						, temp_protocol
						, 'if_in'
					from
						landing.if_service_request_chat_ws_chat srcwc
					where  
						srcwc.par_row_id = CAST(param_id AS INTEGER);
					
					
					insert into process.cx_chat_message
					(
						created
						, created_by
						, last_upd
						, last_upd_by
						, "name"
						, msg_dt
						, db_last_upd_src
						, msg_cd
						, msg_text
						, status
						, protocol__c
						, inter_flag
					)
					select
						created
						, created_by
						, last_upd
						, last_upd_by
						, msgcode
						, "date"::timestamp
						, proc_result_yn
						, msgcode
						, msg
						, msgstatus
						, temp_protocol
						, 'if_in'
					from
						landing.if_service_request_chat_ws_message srcwm
					where 
						srcwm.par_row_id = CAST(param_id AS INTEGER);
				else
					if protocol_status = 'open' then
					update process.service_request as psr set 
						legacy_last_upd  = srww.last_upd
						, legacy_last_upd_by = srww.last_upd_by
						, origin = case when srww.source isnull then psr.origin else srww.source end
						, "method" = case when srww.method isnull then psr."method" else srww.method end
						, description = case when srww.description isnull then psr.description else srww.description end
						, status = case when srww.status isnull then psr.status else srww.status end
						, priority = case when srww.priority isnull then psr.priority else srww.priority end
						, solution__c = case when srww.solution isnull then psr.solution__c else srww.solution end
						, anonymous_flag__c = CASE when srww.anonymousflag='Y' then true when srww.anonymousflag='N' then false else anonymous_flag__c end
						, serialnumber = case when srww.serialnumber isnull then psr.serialnumber else srww.serialnumber end
						, account_row_id__c = case when srww.accountid isnull then psr.account_row_id__c else srww.accountid end
						, tendency__c = case when srww.tendency isnull then psr.tendency__c else srww.tendency end
						, customersatisfied__c = case when srww.satisfaction isnull then psr.customersatisfied__c else srww.satisfaction end
						, business_row_id = case when srww.dealerid isnull then psr.business_row_id else srww.dealerid end
						, causing_area__c = case when srww.causingarea isnull then psr.causing_area__c else srww.causingarea end
						, immobilization_date__c = case when srww.imobilizationdate isnull then psr.immobilization_date__c else srww.imobilizationdate::timestamp end
						, relatedmodel__c = case when srww.relatedmodel isnull then psr.relatedmodel__c else srww.relatedmodel end
						, quote_description__c = case when srww.quotedescription isnull then psr.quote_description__c else srww.quotedescription end
						, quotetransmission__c = case when srww.enginetransmission isnull then psr.quotetransmission__c else srww.enginetransmission end
						, version__c = case when srww.version isnull then psr.version__c else srww.version end
						, quote_version_price__c = case when srww.versionprice isnull then psr.quote_version_price__c else srww.versionprice end
						, quote_color__c = case when srww.color isnull then psr.quote_color__c else srww.color end
						, quote_color_price__c = case when srww.colorprice isnull then psr.quote_color_price__c else srww.colorprice end
						, quote_price__c = case when srww.finalprice isnull then psr.quote_price__c else srww.finalprice end
						, quote_replace_intention__c = case when srww.carreplacementintention isnull then psr.quote_replace_intention__c else srww.carreplacementintention end
						, roadservicerequest = case when srww.roadservicerequest isnull then psr.roadservicerequest else srww.roadservicerequest end
						, integrationid__c = case when srww.integrationid isnull then psr.integrationid__c else srww.integrationid end
						, testdrive_confirmed__c = CASE when srww.tdconfirmed='Y' then true when srww.tdconfirmed='N' then false else testdrive_confirmed__c end
						, testdrive_time__c = case when srww.tdtime isnull then psr.testdrive_time__c else srww.tdtime end
						, date_test_drive__c = case when srww.tddate isnull then psr.date_test_drive__c else srww.tddate::timestamp end
						, sales_representative_cpf = case when srww.salesrepid isnull then psr.sales_representative_cpf else srww.salesrepid end				
						, pne_flag__c = CASE when srww.pneflag='Y' then true when srww.pneflag='N' then false else pne_flag__c end
						, campaignid__c = case when srww.campaignid isnull then psr.campaignid__c else srww.campaignid end
						, source_tag__c = case when srww.sourcetag isnull then psr.source_tag__c else srww.sourcetag end
						, stock__c = case when srww.estoque isnull then psr.stock__c else srww.estoque end
						, medium_tag__c = case when srww.medium isnull then psr.medium_tag__c else srww.medium end
						, content_tag__c = case when srww.content isnull then psr.content_tag__c else srww.content end
						, campaign_tag__c = case when srww.campaign isnull then psr.campaign_tag__c else srww.campaign end
						, additional_comments__c = case when srww.additionalcomments isnull then psr.additional_comments__c else srww.additionalcomments end
						, causing_person__c = case when srww.causingperson isnull then psr.causing_person__c else srww.causingperson end
						, cust_representative__c = case when srww.custrepresentative isnull then psr.cust_representative__c else srww.custrepresentative end
						, cust_representative_rel__c = case when srww.custrepresentativerel isnull then psr.cust_representative_rel__c else srww.custrepresentativerel end				
						, diagnosis_difficultyflg__c = CASE when srww.diagnosisdifficultyflg ='Y' then true when srww.diagnosisdifficultyflg ='N' then false else diagnosis_difficultyflg__c end				
						, diagnosis_pendingflg__c = CASE when srww.diagnosispendingflg ='Y' then true when srww.diagnosispendingflg ='N' then false else diagnosis_pendingflg__c end
						, dlr_fup__c = case when srww.dlrfup isnull then psr.dlr_fup__c else srww.dlrfup end
						, dlr_pending__c = case when srww.dlrpending isnull then psr.dlr_pending__c else srww.dlrpending end				
						, dlr_retractionflg__c = CASE when srww.dlrretractionflg ='Y' then true when srww.dlrretractionflg ='N' then false else dlr_retractionflg__c end
						, dlr_reversal__c = case when srww.dlrreversal isnull then psr.dlr_reversal__c else srww.dlrreversal end				
						, hotline_flg__c = CASE when srww.hotlineflg ='Y' then true when srww.hotlineflg ='N' then false else hotline_flg__c end
						, hotline_num__c = case when srww.hotlinenum isnull then psr.hotline_num__c else srww.hotlinenum end
						, hotline_open_dt__c = case when srww.hotlineopendt isnull then psr.hotline_open_dt__c else srww.hotlineopendt::timestamp end
						, purchase_proposal_num__c = case when srww.purchaseproposalnum isnull then psr.purchase_proposal_num__c else srww.purchaseproposalnum end				
						, pwa_flg__c = CASE when srww.pwaflg ='Y' then true when srww.pwaflg ='N' then false else pwa_flg__c end
						, pwa_number__c = case when srww.pwanum isnull then psr.pwa_number__c else srww.pwanum end
						, pwa_oped_dt__c = case when srww.pwaopendt isnull then psr.pwa_oped_dt__c else srww.pwaopendt::timestamp end				
						, recurrence_flg__c = CASE when srww.recurrenceflg ='Y' then true when srww.recurrenceflg ='N' then false else recurrence_flg__c end
						, recurrence_num__c = case when srww.recurrencenum isnull then psr.recurrence_num__c else srww.recurrencenum end
						, vehicle_delivery_dt__c = case when srww.vehicledeliverydt isnull then psr.vehicle_delivery_dt__c else srww.vehicledeliverydt::timestamp end				
						, vehicle_delivery_flg__c = CASE when srww.vehicledeliveryflg ='Y' then true when srww.vehicledeliveryflg ='N' then false else vehicle_delivery_flg__c end
						, wants_loan__c = CASE when srww.wantsloan ='Y' then true when srww.wantsloan ='N' then false else wants_loan__c end
						, loan_type__c = case when srww.loantype isnull then psr.loan_type__c else srww.loantype end
						, installments_amt__c = case when srww.installmentsamt isnull then psr.installments_amt__c else srww.installmentsamt end
						, down_payment__c = case when srww.downpayment isnull then psr.down_payment__c else srww.downpayment end
						, usedcar_as_down_payment__c = CASE when srww.usedcarasdownpaymnt='Y' then true when srww.usedcarasdownpaymnt='N' then false else usedcar_as_down_payment__c end
						, predictive_temp__c = case when srww.dlrtemperature isnull then psr.predictive_temp__c else srww.dlrtemperature end
						, external_id__c = srww.row_id
						, inter_flag = 'if_up'
					from
						landing.if_service_request_chat_ws srww
					where 
						psr.protocol__c = srww.protocol
					and
						srww.row_id = CAST(param_id AS INTEGER);
					
					
						
					if service_type = '' then
						update process.case pca set 
							voc_level_2__c = case when psr.voc_level_2__c isnull then pca.voc_level_2__c else psr.voc_level_2__c end
							, voc_level_3__c = case when psr.voc_level_3__c isnull then pca.voc_level_3__c else psr.voc_level_3__c end
							, origin = case when psr."method" isnull then pca.origin else psr."method" end
							, source__c = case when psr.origin isnull then pca.source__c else psr.origin end
							, description = case when psr.description isnull then pca.description else psr.description end
							, status = case when psr.status isnull then pca.status else psr.status end
							, priority = case when psr.priority isnull then pca.priority else psr.priority end
							, resolution__c = case when psr.solution__c isnull then pca.resolution__c else psr.solution__c end
							, anonymous__c = CASE when psr.anonymous_flag__c='Y' then true when psr.anonymous_flag__c='N' then false else anonymous__c end
							, account_row_id__c = case when psr.account_row_id__c isnull then pca.account_row_id__c else psr.account_row_id__c end
							, sr_impact_cd__c = case when psr.tendency__c isnull then pca.sr_impact_cd__c else psr.tendency__c end
							, customersatisfied__c = case when psr.customersatisfied__c isnull then pca.customersatisfied__c else psr.customersatisfied__c end
							, dealercode__c = case when psr.dealerCode__c isnull then pca.dealercode__c else psr.dealerCode__c end
							, causing_area__c = case when psr.causing_area__c isnull then pca.causing_area__c else psr.causing_area__c end
							, date_of_immobilization__c = case when psr.immobilization_date__c isnull then pca.date_of_immobilization__c else psr.immobilization_date__c end
							, relatedModel__c = case when psr.relatedmodel__c isnull then pca.relatedModel__c else psr.relatedmodel__c end
							, x_quote_desc__c = case when psr.quote_description__c isnull then pca.x_quote_desc__c else psr.quote_description__c end
							, engine_transmission__c = case when psr.quotetransmission__c isnull then pca.engine_transmission__c else psr.quotetransmission__c end
							, version__c = case when psr.version__c isnull then pca.version__c else psr.version__c end
							, car_version_price__c = case when psr.quote_version_price__c isnull then pca.car_version_price__c else psr.quote_version_price__c end
							, color__c = case when psr.quote_color__c isnull then pca.color__c else psr.quote_color__c end
							, colorprice__c = case when psr.quote_color_price__c isnull then pca.colorprice__c else psr.quote_color_price__c end
							, unit_value__c = case when cast(psr.quote_price__c as integer) isnull then pca.unit_value__c else cast(psr.quote_price__c as integer) end
							, car_replacement_intention__c = case when psr.quote_replace_intention__c isnull then pca.car_replacement_intention__c else psr.quote_replace_intention__c end
							, rsa_integration_id = case when psr.roadservicerequest isnull then pca.rsa_integration_id else psr.roadservicerequest end
							, integrationid__c = case when psr.integrationid__c isnull then pca.integrationid__c else psr.integrationid__c end
							, test_drive_confirmed__c = CASE when psr.testdrive_confirmed__c='Y' then true when psr.testdrive_confirmed__c='N' then false else test_drive_confirmed__c end
							, time_test_drive__c = case when psr.testdrive_time__c isnull then pca.time_test_drive__c else psr.testdrive_time__c end
							, date_test_drive__c = case when psr.date_test_drive__c isnull then pca.date_test_drive__c else psr.date_test_drive__c end
							, salesrepid__c = case when psr.sales_representative_cpf isnull then pca.salesrepid__c else psr.sales_representative_cpf end
							, pne_flg__c = CASE when psr.pne_flag__c='Y' then true when psr.pne_flag__c='N' then false else pne_flg__c end
							, campaignid__c = case when psr.campaignid__c isnull then pca.campaignid__c else psr.campaignid__c end
							, source_tag__c = case when psr.source_tag__c isnull then pca.source_tag__c else psr.source_tag__c end
							, stock_tag__c = case when psr.stock__c isnull then pca.stock_tag__c else psr.stock__c end
							, medium_tag__c = case when psr.medium_tag__c isnull then pca.medium_tag__c else psr.medium_tag__c end
							, content_tag__c = case when psr.content_tag__c isnull then pca.content_tag__c else psr.content_tag__c end
							, campaign_tag__c = case when psr.campaign_tag__c isnull then pca.campaign_tag__c else psr.campaign_tag__c end
							, add_comment__c = case when psr.additional_comments__c isnull then pca.add_comment__c else psr.additional_comments__c end
							, causing_person__c = case when psr.causing_person__c isnull then pca.causing_person__c else psr.causing_person__c end
							, customer_rep__c = case when psr.cust_representative__c isnull then pca.customer_rep__c else psr.cust_representative__c end
							, customer_rep_rel__c = case when psr.cust_representative_rel__c isnull then pca.customer_rep_rel__c else psr.cust_representative_rel__c end
							, diagnosis_difficulty__c = CASE when psr.diagnosis_difficultyflg__c='Y' then true when psr.diagnosis_difficultyflg__c='N' then false else diagnosis_difficulty__c end
							, diagnosis_pending__c = CASE when psr.diagnosis_pendingflg__c='Y' then true when psr.diagnosis_pendingflg__c='N' then false else diagnosis_pending__c end
							, dlr_response__c = case when psr.dlr_description__c isnull then pca.dlr_response__c else psr.dlr_description__c end
							, dlr_fup__c = case when psr.dlr_fup__c isnull then pca.dlr_fup__c else psr.dlr_fup__c end
							, serialnumber__c = case when psr.serialnumber isnull then pca.serialnumber__c else psr.serialnumber end
							, asset_id = case when psr.serialnumber isnull then pca.asset_id else (select row_id from process.asset where serialnumber = serialnumber limit 1) end
							, inter_flag = 'if_up'
						from 
							process.service_request psr
						where 
							pca.protocol__c = psr.protocol__c
						and
							psr.protocol__c = protocol_sr;
						
						insert into process.cx_chat
						(
							created
							, created_by
							, last_upd
							, last_upd_by
							, chat_date
							, chat_cd
							, description
							, "source"
							, user_name
							, protocol__c
							, inter_flag
						)
						select
							created
							, created_by
							, last_upd
							, last_upd_by
							, "date"::timestamp
							, chatcode
							, proc_result_msg
							, "source"
							, "operator"
							, (select pc.protocol__c  from process."case" pc join process.service_request ps on pc.protocol__c = ps.protocol__c where ps.external_id__c  = param_id)
							, 'if_in'
						from
							landing.if_service_request_chat_ws_chat srcwc
						where  
							srcwc.par_row_id = CAST(param_id AS INTEGER);
						
						
						insert into process.cx_chat_message
						(
							created
							, created_by
							, last_upd
							, last_upd_by
							, "name"
							, msg_dt
							, db_last_upd_src
							, msg_cd
							, msg_text
							, status
							, protocol__c
							, inter_flag
						)
						select						
							created
							, created_by
							, last_upd
							, last_upd_by
							, msgcode
							, "date"::timestamp
							, proc_result_yn
							, msgcode
							, msg
							, msgstatus
							, (select pc.protocol__c  from process."case" pc join process.service_request ps on pc.protocol__c = ps.protocol__c where ps.external_id__c  = param_id)
							, 'if_in'
						from
							landing.if_service_request_chat_ws_message srcwm
						where 
							srcwm.par_row_id = CAST(param_id AS INTEGER);
						end if;
					end if;
				end if;
				
			end if;
		else
			update process.service_request psr set
				predictive_temp__c = srww.dlrtemperature
				, inter_flag = 'if_up'
			from
				landing.if_service_request_chat_ws srww
			where 
				psr.protocol__c = temp_protocol
			and
				srww.row_id = CAST(param_id AS INTEGER);
			
			update process.opportunity po set 
				 predictive_temp__c = srww.dlrtemperature
				 , external_id__c = srww.row_id 
				 , inter_flag = 'if_up'
			from 
				landing.if_service_request_chat_ws srww
			where 
				po.testdriveprotocolid__c = temp_protocol
			and
				srww.row_id = CAST(param_id AS INTEGER);			
			
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_svc_req_ws_wf(varchar);

CREATE OR REPLACE PROCEDURE process.if_svc_req_ws_wf(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare reason_sr varchar(30);
	declare level1_sr varchar(30);
	declare level2_sr varchar(30);
	declare protocol_sr varchar(64); --ServiceRequset Number
	declare testdrive_num int;
	declare quot_num int;
	declare case_num int;
	declare lead_num int;
	declare srv_req_row_id varchar(30);
	declare temperaturecheck varchar(30);
	declare temp_protocol varchar(30);
	declare sr_row_id int; -- ServiceRequset insert/update  
	declare protocol_status varchar;
	declare service_type varchar;
	begin
		select 
			count(*) into sr_row_id 
		from 
			landing.if_service_request_ws_wf srww
		join
			process.service_request psr
		on
			srww.protocol = psr.protocol__c
		where 
			srww.row_id = CAST(param_id AS INTEGER);
		
		
		-- status 'Open'   
		select
			lower(status)
			, protocol
		 	, (case when reason = 'Information' and level1 = 'Sales' and level2 = 'Test drive' then 'T' 
		 		 when reason = 'Sales opportunity' and level1 = 'Sales' and level2 = 'Request a quote' then 'Q'
		 		 when reason = 'Sales opportunity' and level1 = 'Marketing' and level2 = 'Promotion' then 'P'
		 		 when reason = 'Sales opportunity' and level1 = 'Visitor' and level2 = 'Dealer' then 'P'
		 		 else '' end) into protocol_status , protocol_sr , service_type
		from landing.if_service_request_ws_wf
		where row_id = CAST(param_id AS INTEGER);
	
		select 
			dlrtemperature , protocol into temperaturecheck , temp_protocol
		from
			landing.if_service_request_ws_wf lr
		where 
			lr.row_id = CAST(param_id AS INTEGER);
		
		if coalesce(temperaturecheck) isnull or temperaturecheck = '' then
			if sr_row_id = 0 then
				insert into process.service_request(
					legacy_created
					, legacycreateddate__c
					, legacy_created_by
					, legacy_last_upd
					, legacy_last_upd_by
					, protocol__c
					, reason__c
					, voctype__c
					, voc_class
					, voc_level_2__c
					, voc_level_3__c
					, origin
					, "method"
					, description
					, status
					, priority
					, solution__c
					, serialnumber
					, contact_row_id__c
					, account_row_id__c
					, tendency__c
					, customersatisfied__c
					, business_row_id
					, causing_area__c
					, immobilization_date__c
					, relatedmodel__c
					, quote_description__c
					, quotetransmission__c
					, version__c
					, quote_version_price__c
					, quote_color__c
					, quote_color_price__c
					, quote_price__c
					, quote_replace_intention__c
					, roadservicerequest
					, integrationid__c
					, testdrive_confirmed__c
					, testdrive_time__c
					, date_test_drive__c
					, sales_representative_cpf
					, pne_flag__c
					, campaignid__c
					, source_tag__c
					, stock__c
					, medium_tag__c
					, content_tag__c
					, campaign_tag__c
					, additional_comments__c
					, causing_person__c
					, cust_representative__c
					, cust_representative_rel__c
					, diagnosis_difficultyflg__c
					, diagnosis_pendingflg__c
					, dlr_fup__c
					, dlr_pending__c
					, dlr_retractionflg__c
					, dlr_reversal__c
					, hotline_flg__c
					, hotline_num__c
					, hotline_open_dt__c
					, purchase_proposal_num__c
					, pwa_flg__c
					, pwa_number__c
					, pwa_oped_dt__c
					, recurrence_flg__c
					, recurrence_num__c
					, vehicle_delivery_dt__c
					, vehicle_delivery_flg__c
					, anonymous_flag__c
					, dlr_description__c
					, wants_loan__c
					, loan_type__c
					, installments_amt__c
					, down_payment__c
					, usedcar_as_down_payment__c
					, predictive_temp__c
					, payment_date__c
					, payment_method__c
					, payment_status__c
					, reserve_amount__c
					, form__c
					, sched_date
					, sched_type
					, usedcar_brand__c
					, usedcar_chassi__c
					, usedcar_color__c
					, usedcar_km__c
					, usedcar_max_price__c
					, usedcar_mid_price__c
					, usedcar_min_price__c
					, usedcar_model__c
					, usedcar_plate__c
					, usedcar_version__c
					, usedcar_year__c
					, external_id__c
					, inter_flag
				)
				select 
					created
					, created
				    , created_by
				    , last_upd
				    , last_upd_by
				    , process.get_protocol_id(service_type)
				    , reason
				    , level1
				    , level2
				    , level3
				    , level4
				    , source
				    , method
				    , description
					, status
				    , priority
				    , solution    
					, serialnumber
				    , contactid
				    , accountid
				    , tendency
				    , satisfaction
				    , dealerid
				    , causingarea
				    , imobilizationdate::timestamp
				    , relatedmodel
				    , quotedescription
				    , enginetransmission
				    , version
				    , versionprice
				    , color
				    , colorprice
				    , finalprice
				    , carreplacementintention
				    , roadservicerequest
				    , integrationid
				    , CASE when srww.tdconfirmed='Y' then true when srww.tdconfirmed='N' then false else null end tdconfirmed
				    , tdtime
				    , tddate::timestamp
				    , salesrepid
				    , CASE when srww.pneflag='Y' then true when srww.pneflag='N' then false else null end pneflag
				    , campaignid
				    , sourcetag
				    , estoque
				    , medium
				    , content
				    , campaign
				    , additionalcomments
				    , causingperson
				    , custrepresentative
				    , custrepresentativerel
				    , CASE when srww.diagnosisdifficultyflg='Y' then true when srww.diagnosisdifficultyflg='N' then false else null end diagnosisdifficultyflg
				    , CASE when srww.diagnosispendingflg='Y' then true when srww.diagnosispendingflg='N' then false else null end diagnosispendingflg
				    , dlrfup
				    , dlrpending
				    , CASE when srww.dlrretractionflg='Y' then true when srww.dlrretractionflg='N' then false else null end dlrretractionflg
				    , dlrreversal
				    , CASE when srww.hotlineflg='Y' then true when srww.hotlineflg='N' then false else null end hotlineflg
				    , hotlinenum
				    , hotlineopendt::timestamp
				    , purchaseproposalnum
				    , CASE when srww.pwaflg='Y' then true when srww.pwaflg='N' then false else null end pwaflg
				    , pwanum
				    , pwaopendt::timestamp
				    , CASE when srww.recurrenceflg='Y' then true when srww.recurrenceflg='N' then false else null end recurrenceflg
				    , recurrencenum
				    , vehicledeliverydt::timestamp
				    , CASE when srww.vehicledeliveryflg='Y' then true when srww.vehicledeliveryflg='N' then false else null end vehicledeliveryflg
				    , CASE when srww.anonymousflag='Y' then true when srww.anonymousflag='N' then false else null end anonymousflag
				    , dlrdescription
				    , CASE when srww.wantsloan='Y' then true when srww.wantsloan='N' then false else null end wantsloan
				    , loantype
				    , installmentsamt
				    , downpayment
				    , CASE when srww.usedcarasdownpaymnt='Y' then true when srww.usedcarasdownpaymnt='N' then false else null end usedcarasdownpaymnt
				    , dlrtemperature
				    , paymnt_date::timestamp
				    , paymnt_method 
				    , paymnt_status 
				    , reservation_amount 
				    , form 
				    , sched_dt::timestamp
				    , sched_type 
				    , used_brand 
				    , used_chassi 
				    , used_color 
				    , used_km 
				    , used_max_price 
				    , used_med_price 
				    , used_min_price 
				    , used_model 
				    , used_plate 
				    , used_version 
				    , used_year 
				    , row_id
				    , 'if_in'
				from
					landing.if_service_request_ws_wf srww
				where 
					srww.row_id = CAST(param_id AS INTEGER);
				
				update landing.if_service_request_ws_wf as srww set 
					protocol = psr.protocol__c
				from 
					process.service_request psr
				where
					psr.external_id__c = CAST(srww.row_id AS TEXT)
				and
					srww.row_id = CAST(param_id AS INTEGER);
				
				
				-- Test Drive 
				if service_type = 'T' then
					insert into process.testdrivehistory
						(
							row_id 
							, reason__c
							, level1__c
							, level2__c
							, level3__c
							, level4__c
							, origin
							, "SourceTag__c"
							, method__c
							, "RequestDescription__c"
							, status__c
							, dealercode__c
							, serialnumber__c
							, salespersoncode__c
							, testdriverequestdate__c
							, testdriverequesttime__c
							, testdriveconfirmed__c
							, account_id__c
							, contact_id__c
							, protocolid__c
							, external_id__c
							, dealerportaltdno__c
							, testdriverequestdatetime__c
							, relatedmodel__c 
							, priority__c 
							, inter_flag
						)
						select 
							row_id
							, reason__c
							, voctype__c
							, voc_class
							, voc_level_2__c
							, voc_level_3__c
							, origin
							, source_tag__c 
							, "method"
							, description
							, status
							, business_row_id
							, serialnumber
							, sales_representative_cpf
							, date_test_drive__c
							, testdrive_time__c
							, testdrive_confirmed__c
							, account_row_id__c
							, contact_row_id__c
							, protocol__c
							, row_id
							, integrationid__c
							, (date_test_drive__c::varchar||' '||replace(split_part(testdrive_time__c, '~', 1), ':', '')||'00')::timestamp
							, psr.relatedmodel__c 
							, psr.priority 
							, 'if_in'
						from
							process.service_request psr
						where
							psr.external_id__c = param_id;
				-- Quotation
				elseif service_type = 'Q' then
					insert into process.quotehistory
						(
							row_id 
							, protocolid__c
							, reason__c
							, voctype__c
							, voc_class
							, voc_level_2__c
							, voc_level_3__c
							, origin
							, source_tag__c
							, method
							, requestdescription__c
							, status
							, dealercode__c
							, relatedmodel__c
							, enginetransmission__c
							, version__c
							, carversionprice__c
							, color__c
							, colorprice
							, finalprice
							, carreplacementintention
							, pneflag__c
							, campaign_id
							, account_row_id__c
							, contact_row_id__c
							, external_id__c
							, priority 
							, form__c 
							, content_tag__c 
							, medium_tag__c 
							, campaign_tag__c 
							, wants_loan__c 
							, loan_type__c 
							, reserve_amount__c 
							, payment_method__c 
							, payment_status__c 
							, payment_date__c 
							, usedcar_as_down_payment__c 
							, usedcar_plate__c 
							, usedcar_chassi__c 
							, usedcar_year__c 
							, usedcar_version__c 
							, usedcar_km__c 
							, usedcar_color__c 
							, usedcar_brand__c 
							, usedcar_model__c 
							, usedcar_max_price__c 
							, usedcar_mid_price__c 
							, usedcar_min_price__c 
							, inter_flag
						)
						select 
							row_id
							, protocol__c
							, reason__c
							, voctype__c
							, voc_class
							, voc_level_2__c
							, voc_level_3__c
							, origin
							, psr.source_tag__c  
							, "method"
							, description
							, status
							, business_row_id
							, relatedmodel__c
							, quotetransmission__c
							, version__c
							, quote_version_price__c
							, quote_color__c
							, quote_color_price__c
		            		, quote_price__c
		            		, quote_replace_intention__c
		            		, CASE when psr.pne_flag__c='Y' then true when psr.pne_flag__c='N' then false else null end pne_flag__c
		            		, campaignid__c
		            		, account_row_id__c
							, contact_row_id__c
		            		, row_id
		            		, psr.priority 
		            		, psr.form__c 
		            		, psr.content_tag__c 
		            		, psr.medium_tag__c 
		            		, psr.campaign_tag__c 
		            		, psr.wants_loan__c 
		            		, psr.loan_type__c 
		            		, psr.reserve_amount__c 
		            		, psr.payment_method__c
		            		, psr.payment_status__c 
		            		, psr.payment_date__c 
		            		, psr.usedcar_as_down_payment__c 
		            		, psr.usedcar_plate__c 
		            		, psr.usedcar_chassi__c 
		            		, psr.usedcar_year__c 
		            		, psr.usedcar_version__c 
		            		, psr.usedcar_km__c 
		            		, psr.usedcar_color__c 
		            		, psr.usedcar_brand__c 
		            		, psr.usedcar_model__c 
		            		, psr.usedcar_max_price__c 
		            		, psr.usedcar_mid_price__c 
		            		, psr.usedcar_min_price__c 
		            		, 'if_in'
						from
							process.service_request psr
						where 
							psr.external_id__c = param_id;	
						
				-- Lead
				elseif service_type = 'P' then 
					insert into process."lead"
						(
							row_id
							, firstname
							, lastname
							, mobilephone
							, email
							, leadtype__c
							, cpf__c
							, dealercode__c 
							, phone 
							, personhomephone__c 
							, fax 
							, gender__c 
							, productofinterest__c 
							, description 
							, reason__c 
							, level1__c 
							, level2__c 
							, level3__c 
							, level4__c 
							, origin__c 
							, form__c 
							, sourcetag__c 
							, mediumtag__c 
							, contenttag__c 
							, campaigntag__c 
							, postalcode 
							, street 
							, state 
							, city 
							, country 						
							, external_id__c 
							, protocol__c 
	--						, salutation 
	--						, opt-in  
							, inter_flag
						)
						select
							sr.row_id 
							, pa.firstname 
							, pa.lastname 
							, pa.personmobilephone 
							, pa.personemail 
							, case when voc_class = 'Dealer' then 'Showroom' when voc_class = 'Promotion' then 'Information (Promotion)'  end
							, pa.cpf__c 
							, sr.business_row_id 
							, pa.phone 
							, pa.personhomephone 
							, pa.fax 
							, pa.gender__pc 
							, sr.relatedmodel__c 
							, sr.description 
							, sr.reason__c 
							, sr.voctype__c 
							, sr.voc_class 
							, sr.voc_level_2__c 
							, sr.voc_level_3__c 
							, sr.origin 
							, sr.form__c 
							, sr.source_tag__c 
							, sr.medium_tag__c 
							, sr.content_tag__c 
							, sr.campaign_tag__c 
							, pa.billingpostalcode 
							, concat(pa.billingstreet || ' ' || pa.billingstreet_2__c  || ' ' || pa.billingstreet_3__c )
							, pa.billingstate 
							, pa.billingcity 
							, pa.billingcountry 			
							, sr.row_id 
							, sr.protocol__c 
							, 'if_in'
						from 
							process.service_request sr
						join
							process.account pa
						on
							sr.contact_row_id__c = pa.row_id 
						where 
							sr.external_id__c = param_id;	
				-- Case
				else
					insert into process."case"
						(
							row_id 
							, protocol__c
							, service_request_reason__c
							, voctype__c
							, voc_class
							, voc_level_2__c
							, voc_level_3__c
							, origin
							, source__c
							, description
							, status
							, priority
							, resolution__c
							, anonymous__c
							, account_row_id__c
							, contact_row_id__c
							, sr_impact_cd__c
							, customersatisfied__c
							, business_row_id
							, causing_area__c
							, date_of_immobilization__c
							, relatedModel__c
							, x_quote_desc__c
							, engine_transmission__c
							, version__c
							, car_version_price__c
							, color__c
							, colorprice__c
							, unit_value__c
							, car_replacement_intention__c
							, rsa_integration_id
							, integrationid__c
							, test_drive_confirmed__c
							, time_test_drive__c
							, date_test_drive__c
							, salesrepid__c
							, pne_flg__c
							, campaignid__c
							, source_tag__c
							, stock_tag__c
							, medium_tag__c
							, content_tag__c
							, campaign_tag__c
							, add_comment__c
							, causing_person__c
							, customer_rep__c
							, customer_rep_rel__c
							, diagnosis_difficulty__c
							, diagnosis_pending__c
							, dlr_response__c
							, dlr_fup__c
							, serialnumber__c
							, asset_id
							, external__c
							, inter_flag
						)
						select
							row_id 
							, protocol__c
							, reason__c
							, voctype__c
							, voc_class
							, voc_level_2__c
							, voc_level_3__c
							, "method"
							, origin
							, description
							, status
							, priority
							, solution__c
							, CASE when anonymous_flag__c='Y' then true when anonymous_flag__c='N' then false else null end anonymousflag
							, account_row_id__c
							, contact_row_id__c
							, tendency__c
							, customersatisfied__c
							, business_row_id
							, causing_area__c
							, immobilization_date__c
							, relatedmodel__c
							, quote_description__c
							, quotetransmission__c
							, version__c
							, quote_version_price__c
							, quote_color__c
							, quote_color_price__c
							, quote_price__c
							, quote_replace_intention__c
							, roadservicerequest
							, integrationid__c
							, CASE when testdrive_confirmed__c='Y' then true when testdrive_confirmed__c='N' then false else null end testdrive_confirmed__c
							, testdrive_time__c
							, date_test_drive__c
							, sales_representative_cpf
							, CASE when pne_flag__c='Y' then true when pne_flag__c='N' then false else null end pne_flag__c
							, campaignid__c
							, source_tag__c
							, stock__c
							, medium_tag__c
							, content_tag__c
							, campaign_tag__c
							, additional_comments__c
							, causing_person__c
							, cust_representative__c
							, cust_representative_rel__c
							, CASE when diagnosis_difficultyflg__c='Y' then true when diagnosis_difficultyflg__c='N' then false else null end diagnosis_difficultyflg__c
							, CASE when diagnosis_pendingflg__c='Y' then true when diagnosis_pendingflg__c='N' then false else null end diagnosis_pendingflg__c
							, dlr_description__c
							, dlr_fup__c
							, serialnumber
							, (select row_id from process.asset where serialnumber = serialnumber limit 1)
							, row_id
							, 'if_in'
						from process.service_request psr
						where
							psr.external_id__c = param_id;
					end if;
			else
				
				if protocol_status = 'open' then
							
					update process.service_request as psr set 
						legacy_last_upd  = srww.last_upd
						, legacy_last_upd_by = srww.last_upd_by
						, origin = case when srww.source isnull then psr.origin else srww.source end
						, "method" = case when srww.method isnull then psr."method" else srww.method end
						, description = case when srww.description isnull then psr.description else srww.description end
						, status = case when srww.status isnull then psr.status else srww.status end
						, priority = case when srww.priority isnull then psr.priority else srww.priority end
						, solution__c = case when srww.solution isnull then psr.solution__c else srww.solution end
						, anonymous_flag__c = CASE when srww.anonymousflag='Y' then true when srww.anonymousflag='N' then false else anonymous_flag__c end
						, serialnumber = case when srww.serialnumber isnull then psr.serialnumber else srww.serialnumber end
						, account_row_id__c = case when srww.accountid isnull then psr.account_row_id__c else srww.accountid end
						, tendency__c = case when srww.tendency isnull then psr.tendency__c else srww.tendency end
						, customersatisfied__c = case when srww.satisfaction isnull then psr.customersatisfied__c else srww.satisfaction end
						, business_row_id = case when srww.dealerid isnull then psr.business_row_id else srww.dealerid end
						, causing_area__c = case when srww.causingarea isnull then psr.causing_area__c else srww.causingarea end
						, immobilization_date__c = case when srww.imobilizationdate isnull then psr.immobilization_date__c else srww.imobilizationdate::timestamp end
						, relatedmodel__c = case when srww.relatedmodel isnull then psr.relatedmodel__c else srww.relatedmodel end
						, quote_description__c = case when srww.quotedescription isnull then psr.quote_description__c else srww.quotedescription end
						, quotetransmission__c = case when srww.enginetransmission isnull then psr.quotetransmission__c else srww.enginetransmission end
						, version__c = case when srww.version isnull then psr.version__c else srww."version"  end
						, quote_version_price__c = case when srww.versionprice isnull then psr.quote_version_price__c else srww.versionprice end
						, quote_color__c = case when srww.color isnull then psr.quote_color__c else srww.color end
						, quote_color_price__c = case when srww.colorprice isnull then psr.quote_color_price__c else srww.colorprice end
						, quote_price__c = case when srww.finalprice isnull then psr.quote_price__c else srww.finalprice end
						, quote_replace_intention__c = case when srww.carreplacementintention isnull then psr.quote_replace_intention__c else srww.carreplacementintention end
						, roadservicerequest = case when srww.roadservicerequest isnull then psr.roadservicerequest else srww.roadservicerequest end
						, integrationid__c = case when srww.integrationid isnull then psr.integrationid__c else srww.integrationid end
						, testdrive_confirmed__c = CASE when srww.tdconfirmed='Y' then true when srww.tdconfirmed='N' then false else testdrive_confirmed__c end
						, testdrive_time__c = case when srww.tdtime isnull then psr.testdrive_time__c else srww.tdtime end
						, date_test_drive__c = case when srww.tddate isnull then psr.date_test_drive__c else srww.tddate::timestamp end
						, sales_representative_cpf = case when srww.salesrepid isnull then psr.sales_representative_cpf else srww.salesrepid end				
						, pne_flag__c = CASE when srww.pneflag='Y' then true when srww.pneflag='N' then false else pne_flag__c end
						, campaignid__c = case when srww.campaignid isnull then psr.campaignid__c else srww.campaignid end
						, source_tag__c = case when srww.sourcetag isnull then psr.source_tag__c else srww.sourcetag end
						, stock__c = case when srww.estoque isnull then psr.stock__c else srww.estoque end
						, medium_tag__c = case when srww.medium isnull then psr.medium_tag__c else srww.medium end
						, content_tag__c = case when srww.content isnull then psr.content_tag__c else srww.content end
						, campaign_tag__c = case when srww.campaign isnull then psr.campaign_tag__c else srww.campaign end
						, additional_comments__c = case when srww.additionalcomments isnull then psr.additional_comments__c else srww.additionalcomments end
						, causing_person__c = case when srww.causingperson isnull then psr.causing_person__c else srww.causingperson end
						, cust_representative__c = case when srww.custrepresentative isnull then psr.cust_representative__c else srww.custrepresentative end
						, cust_representative_rel__c = case when srww.custrepresentativerel isnull then psr.cust_representative_rel__c else srww.custrepresentativerel end				
						, diagnosis_difficultyflg__c = CASE when srww.diagnosisdifficultyflg ='Y' then true when srww.diagnosisdifficultyflg ='N' then false else diagnosis_difficultyflg__c end				
						, diagnosis_pendingflg__c = CASE when srww.diagnosispendingflg ='Y' then true when srww.diagnosispendingflg ='N' then false else diagnosis_pendingflg__c end
						, dlr_fup__c = case when srww.dlrfup isnull then psr.dlr_fup__c else srww.dlrfup end
						, dlr_pending__c = case when srww.dlrpending isnull then psr.dlr_pending__c else srww.dlrpending end				
						, dlr_retractionflg__c = CASE when srww.dlrretractionflg ='Y' then true when srww.dlrretractionflg ='N' then false else dlr_retractionflg__c end
						, dlr_reversal__c = case when srww.dlrreversal isnull then psr.dlr_reversal__c else srww.dlrreversal end				
						, hotline_flg__c = CASE when srww.hotlineflg ='Y' then true when srww.hotlineflg ='N' then false else hotline_flg__c end
						, hotline_num__c = case when srww.hotlinenum isnull then psr.hotline_num__c else srww.hotlinenum end
						, hotline_open_dt__c = case when srww.hotlineopendt isnull then psr.hotline_open_dt__c else srww.hotlineopendt::timestamp end
						, purchase_proposal_num__c = case when srww.purchaseproposalnum isnull then psr.purchase_proposal_num__c else srww.purchaseproposalnum end				
						, pwa_flg__c = CASE when srww.pwaflg ='Y' then true when srww.pwaflg ='N' then false else pwa_flg__c end
						, pwa_number__c = case when srww.pwanum isnull then psr.pwa_number__c else srww.pwanum end
						, pwa_oped_dt__c = case when srww.pwaopendt isnull then psr.pwa_oped_dt__c else srww.pwaopendt::timestamp end				
						, recurrence_flg__c = CASE when srww.recurrenceflg ='Y' then true when srww.recurrenceflg ='N' then false else recurrence_flg__c end
						, recurrence_num__c = case when srww.recurrencenum isnull then psr.recurrence_num__c else srww.recurrencenum end
						, vehicle_delivery_dt__c = case when srww.vehicledeliverydt isnull then psr.vehicle_delivery_dt__c else srww.vehicledeliverydt::timestamp end				
						, vehicle_delivery_flg__c = CASE when srww.vehicledeliveryflg ='Y' then true when srww.vehicledeliveryflg ='N' then false else vehicle_delivery_flg__c end
						, wants_loan__c = CASE when srww.wantsloan ='Y' then true when srww.wantsloan ='N' then false else wants_loan__c end
						, loan_type__c = case when srww.loantype isnull then psr.loan_type__c else srww.loantype end
						, installments_amt__c = case when srww.installmentsamt isnull then psr.installments_amt__c else srww.installmentsamt end
						, down_payment__c = case when srww.downpayment isnull then psr.down_payment__c else srww.downpayment end
						, usedcar_as_down_payment__c = CASE when srww.usedcarasdownpaymnt='Y' then true when srww.usedcarasdownpaymnt='N' then false else usedcar_as_down_payment__c end
						, predictive_temp__c = case when srww.dlrtemperature isnull then psr.predictive_temp__c else srww.dlrtemperature end
						, payment_date__c = case when srww.paymnt_date isnull then psr.payment_date__c else srww.paymnt_date::timestamp end
						, payment_method__c = case when srww.paymnt_method isnull then psr.payment_method__c else srww.paymnt_method end
						, payment_status__c = case when srww.paymnt_status isnull then psr.payment_status__c else srww.paymnt_status end
						, reserve_amount__c = case when srww.reservation_amount isnull then psr.reserve_amount__c else srww.reservation_amount end
						, form__c = case when srww.form isnull then psr.form__c else srww.form end
						, sched_date = case when srww.sched_dt isnull then psr.sched_date else srww.sched_dt::timestamp end
						, sched_type = case when srww.sched_type isnull then psr.sched_type else srww.sched_type end
						, usedcar_brand__c = case when srww.used_brand isnull then psr.usedcar_brand__c else srww.used_brand end
						, usedcar_chassi__c = case when srww.used_chassi isnull then psr.usedcar_chassi__c else srww.used_chassi end
						, usedcar_color__c = case when srww.used_color isnull then psr.usedcar_color__c else srww.used_color end
						, usedcar_km__c = case when srww.used_km isnull then psr.usedcar_km__c else srww.used_km end
						, usedcar_max_price__c = case when srww.used_max_price isnull then psr.usedcar_max_price__c else srww.used_max_price end
						, usedcar_mid_price__c = case when srww.used_med_price isnull then psr.usedcar_mid_price__c else srww.used_med_price end
						, usedcar_min_price__c = case when srww.used_min_price isnull then psr.usedcar_min_price__c else srww.used_min_price end
						, usedcar_model__c = case when srww.used_model isnull then psr.usedcar_model__c else srww.used_model end
						, usedcar_plate__c = case when srww.used_plate isnull then psr.usedcar_plate__c else srww.used_plate end
						, usedcar_version__c = case when srww.used_version isnull then psr.usedcar_version__c else srww.used_version end
						, usedcar_year__c = case when srww.used_year isnull then psr.usedcar_year__c else srww.used_year end
						, external_id__c = srww.row_id
						, inter_flag = 'if_up'
					from
						landing.if_service_request_ws_wf srww
					where 
						psr.protocol__c = srww.protocol
					and
						srww.row_id = CAST(param_id AS INTEGER);
					
					if service_type = '' then
						update process.case pca set 
								voc_level_2__c = case when psr.voc_level_2__c isnull then pca.voc_level_2__c else psr.voc_level_2__c end
								, voc_level_3__c = case when psr.voc_level_3__c isnull then pca.voc_level_3__c else psr.voc_level_3__c end
								, description = case when psr.description isnull then pca.description else psr.description end
								, status = case when psr.status isnull then pca.status else psr.status end
								, priority = case when psr.priority isnull then pca.priority else psr.priority end
								, resolution__c = case when psr.solution__c isnull then pca.resolution__c else psr.solution__c end
								, anonymous__c = CASE when psr.anonymous_flag__c='Y' then true when psr.anonymous_flag__c='N' then false else anonymous__c end
								, sr_impact_cd__c = case when psr.tendency__c isnull then pca.sr_impact_cd__c else psr.tendency__c end
								, customersatisfied__c = case when psr.customersatisfied__c isnull then pca.customersatisfied__c else psr.customersatisfied__c end
								, business_row_id = case when psr.dealercode__c isnull then pca.business_row_id else psr.dealercode__c end
								, causing_area__c = case when psr.causing_area__c isnull then pca.causing_area__c else psr.causing_area__c end
								, date_of_immobilization__c = case when psr.immobilization_date__c isnull then pca.date_of_immobilization__c else psr.immobilization_date__c end
								, relatedModel__c = case when psr.relatedmodel__c isnull then pca.relatedModel__c else psr.relatedmodel__c end
								, x_quote_desc__c = case when psr.quote_description__c isnull then pca.x_quote_desc__c else psr.quote_description__c end
								, engine_transmission__c = case when psr.quotetransmission__c isnull then pca.engine_transmission__c else psr.quotetransmission__c end
								, version__c = case when psr.version__c isnull then pca.version__c else psr.version__c end
								, car_version_price__c = case when psr.quote_version_price__c isnull then pca.car_version_price__c else psr.quote_version_price__c end
								, color__c = case when psr.quote_color__c isnull then pca.color__c else psr.quote_color__c end
								, colorprice__c = case when psr.quote_color_price__c isnull then pca.colorprice__c else psr.quote_color_price__c end
								, unit_value__c = case when psr.quote_price__c isnull then pca.unit_value__c else psr.quote_price__c end
								, car_replacement_intention__c = case when psr.quote_replace_intention__c isnull then pca.car_replacement_intention__c else psr.quote_replace_intention__c end
								, rsa_integration_id = case when psr.roadservicerequest isnull then pca.rsa_integration_id else psr.roadservicerequest end
								, integrationid__c = case when psr.integrationid__c isnull then pca.integrationid__c else psr.integrationid__c end
								, test_drive_confirmed__c = CASE when psr.testdrive_confirmed__c='Y' then true when psr.testdrive_confirmed__c='N' then false else test_drive_confirmed__c end
								, time_test_drive__c = case when psr.testdrive_time__c isnull then pca.time_test_drive__c else psr.testdrive_time__c end
								, date_test_drive__c = case when psr.date_test_drive__c isnull then pca.date_test_drive__c else psr.date_test_drive__c end
								, salesrepid__c = case when psr.sales_representative_cpf isnull then pca.salesrepid__c else psr.sales_representative_cpf end
								, pne_flg__c = CASE when psr.pne_flag__c='Y' then true when psr.pne_flag__c='N' then false else pne_flg__c end
								, campaignid__c = case when psr.campaignid__c isnull then pca.campaignid__c else psr.campaignid__c end
								, source_tag__c = case when psr.source_tag__c isnull then pca.source_tag__c else psr.source_tag__c end
								, stock_tag__c = case when psr.stock__c isnull then pca.stock_tag__c else psr.stock__c end
								, medium_tag__c = case when psr.medium_tag__c isnull then pca.medium_tag__c else psr.medium_tag__c end
								, content_tag__c = case when psr.content_tag__c isnull then pca.content_tag__c else psr.content_tag__c end
								, campaign_tag__c = case when psr.campaign_tag__c isnull then pca.campaign_tag__c else psr.campaign_tag__c end
								, add_comment__c = case when psr.additional_comments__c isnull then pca.add_comment__c else psr.additional_comments__c end
								, causing_person__c = case when psr.causing_person__c isnull then pca.causing_person__c else psr.causing_person__c end
								, customer_rep__c = case when psr.cust_representative__c isnull then pca.customer_rep__c else psr.cust_representative__c end
								, customer_rep_rel__c = case when psr.cust_representative_rel__c isnull then pca.customer_rep_rel__c else psr.cust_representative_rel__c end
								, diagnosis_difficulty__c = CASE when psr.diagnosis_difficultyflg__c='Y' then true when psr.diagnosis_difficultyflg__c='N' then false else diagnosis_difficulty__c end
								, diagnosis_pending__c = CASE when psr.diagnosis_pendingflg__c='Y' then true when psr.diagnosis_pendingflg__c='N' then false else diagnosis_pending__c end
								, dlr_response__c = case when psr.dlr_description__c isnull then pca.dlr_response__c else psr.dlr_description__c end
								, dlr_fup__c = case when psr.dlr_fup__c isnull then pca.dlr_fup__c else psr.dlr_fup__c end
								, serialnumber__c = case when psr.serialnumber isnull then pca.serialnumber__c else psr.serialnumber end
								, asset_id = case when psr.serialnumber isnull then pca.asset_id else (select row_id from process.asset where serialnumber = serialnumber limit 1) end
								, inter_flag = 'if_up'
							from 
								process.service_request psr
							where 
								pca.protocol__c = psr.protocol__c
							and
								psr.protocol__c = protocol_sr;
					end if;
				end if;
			end if;		
		else
			update process.service_request psr set
				predictive_temp__c = case when srww.dlrtemperature isnull then psr.predictive_temp__c else case when srww.dlrtemperature = 'F' then 'Hot' when srww.dlrtemperature = 'Q' then 'Cold' when srww.dlrtemperature = 'M' then 'Warm' else null end end
				, external_id__c = srww.row_id
				, inter_flag = 'if_up'
			from 
				landing.if_service_request_ws_wf srww
			where 
				psr.protocol__c = srww.protocol
			and
				srww.row_id = CAST(param_id AS INTEGER);
			
			update process.opportunity po set 
				 predictive_temp__c = srww.dlrtemperature 
				 , external_id__c = srww.row_id 
				 , inter_flag = 'if_up'
			from 
				landing.if_service_request_ws_wf srww
			where 
				po.protocol__c = srww.protocol
			and
				srww.row_id = CAST(param_id AS INTEGER);
		end if;
	END;
$procedure$
;

-- DROP PROCEDURE process.if_update_contact_in_wf(_text, _text, _text);

CREATE OR REPLACE PROCEDURE process.if_update_contact_in_wf(IN param_id text[], IN vehicle_id text[], IN proc_account_id text[])
 LANGUAGE plpgsql
AS $procedure$
    declare 
        v_len integer;
        v_i integer;
        v_count integer;
        relation varchar;
        fo_count integer;
    begin
        v_len := array_length(vehicle_id, 1);
    
        -- update account
        update process.account as pa set
            cnhexpirationdate__c  = case when la.cnhexpirationdate isnull then pa.cnhexpirationdate__c else la.cnhexpirationdate end
            , firstname = case when la.firstname isnull then pa.firstname when la.firstname = '' then pa.firstname else la.firstname end 
            , lastname = case when la.lastname isnull then pa.lastname when la.lastname = '' then pa.lastname else la.lastname end 
            , personbirthdate = case when la.birthdate isnull then pa.personbirthdate else la.birthdate end 
            , gender__pc = case when la.genre isnull then pa.gender__pc when la.genre = '' then pa.gender__pc else la.genre end 
            , hkmeretaildate = case when la.hkmeretaildate isnull then pa.hkmeretaildate else la.hkmeretaildate end 
            , personhomephone = case when la.homephone isnull then pa.personhomephone when la.homephone = '' then pa.personhomephone else la.homephone end 
            , workphone__c  = case when la.workphone isnull then pa.workphone__c when la.workphone = '' then pa.workphone__c else la.workphone end 
            , personmobilephone = case when la.cellularphone isnull then pa.personmobilephone when la.cellularphone = '' then pa.personmobilephone else la.cellularphone end 
            , personemail = case when la.emailaddress isnull then pa.personemail when la.emailaddress = '' then pa.personemail else la.emailaddress end 
            , optinflag__c = case when la.loyaltyoptinflag isnull then pa.optinflag__c else case when la.loyaltyoptinflag = 'Y' then true when la.loyaltyoptinflag = 'N' then false else null end end 
            , billingstreet = case when la.streetaddress  isnull then pa.billingstreet when la.streetaddress = '' then pa.billingstreet else la.streetaddress end 
            , billingstreet_2__c = case when la.addressnumber  isnull then pa.billingstreet_2__c when la.addressnumber = '' then pa.billingstreet_2__c else la.addressnumber end 
            , billingstreet_3__c = case when la.addresscomplement isnull then pa.billingstreet_3__c when la.addresscomplement = '' then pa.billingstreet_3__c else la.addresscomplement end 
            , billingcountry = case when la.addresscountry isnull then pa.billingcountry when la.addresscountry = '' then pa.billingcountry else la.addresscountry end
            , billingcounty = case when la.addresscounty isnull then pa.billingcounty when la.addresscounty = '' then pa.billingcounty else la.addresscounty end 
            , billingcity = case when la.addresscity isnull then pa.billingcity when la.addresscity = '' then pa.billingcity else la.addresscity end 
            , billingstate = case when la.addressstate isnull then pa.billingstate when la.addressstate = '' then pa.billingstate else la.addressstate end 
            , billingpostalcode = case when la.addresspostalcode isnull then pa.billingpostalcode when la.addresspostalcode = '' then pa.billingpostalcode else la.addresspostalcode end 
  			, persondonotcall = case when la.suppressallcalls isnull then pa.persondonotcall when la.suppressallcalls = '' then pa.persondonotcall else case when la.suppressallcalls = 'Y' then true when la.suppressallcalls = 'N' then false else null end end
            , calloptyn__pc = case when la.suppressallcalls isnull then pa.calloptyn__pc when la.suppressallcalls = '' then pa.calloptyn__pc else case when la.suppressallcalls = 'Y' then true when la.suppressallcalls = 'N' then false else null end end
--	            , blockedemails__c = case when la.suppressallemails isnull then pa.blockedemails__c when la.suppressallemails = '' then pa.emailaddress__c else case when la.suppressallemails = 'Y' then true when la.suppressallemails = 'N' then false else null end end
            , blockedemails__pc = case when la.suppressallemails isnull then pa.blockedemails__pc when la.suppressallemails = '' then pa.blockedemails__pc else case when la.suppressallemails = 'Y' then true when la.suppressallemails = 'N' then false else null end  end 
            , blockedletters__c = case when la.suppressallmailings isnull then pa.blockedletters__c when la.suppressallmailings = '' then pa.blockedletters__c else case when la.suppressallmailings = 'Y' then true when la.suppressallmailings = 'N' then false else null end end
            , blockedletters__pc = case when la.suppressallmailings isnull then pa.blockedletters__pc when la.suppressallmailings = '' then pa.blockedletters__pc else case when la.suppressallmailings = 'Y' then true when la.suppressallmailings = 'N' then false else null end end 
            , blockedmobile__c = case when la.suppressallmobile isnull then pa.blockedmobile__c when la.suppressallmobile = '' then pa.blockedmobile__c else case when la.suppressallmobile = 'Y' then true when la.suppressallmobile = 'N' then false else null end end
            , blockedmobile__pc = case when la.suppressallmobile isnull then pa.blockedmobile__pc when la.suppressallmobile = '' then pa.blockedmobile__pc else case when la.suppressallmobile = 'Y' then true when la.suppressallmobile = 'N' then false else null end end 
            , blockedsms__c = case when la.suppressallsms isnull then pa.blockedsms__c when la.suppressallsms = '' then pa.blockedsms__c else case when la.suppressallsms = 'Y' then true when la.suppressallsms = 'N' then false else null end end
            , blockedsms__pc = case when la.suppressallsms isnull then pa.blockedsms__pc when la.suppressallsms = '' then pa.blockedsms__pc else case when la.suppressallsms = 'Y' then true when la.suppressallsms = 'N' then false else null end end
            , blockedvideocall__c = case when la.suppressallvideocall isnull then pa.blockedvideocall__c when la.suppressallvideocall = '' then pa.blockedvideocall__c else case when la.suppressallvideocall = 'Y' then true when la.suppressallvideocall = 'N' then false else null end end
            , blockedvideocall__pc = case when la.suppressallvideocall isnull then pa.blockedvideocall__pc when la.suppressallvideocall = '' then pa.blockedvideocall__pc else case when la.suppressallvideocall = 'Y' then true when la.suppressallvideocall = 'N' then false else null end end
            , blockedwhatsapp__c = case when la.suppressallwhatsapp isnull then pa.blockedwhatsapp__c when la.suppressallwhatsapp = '' then pa.blockedwhatsapp__c else case when la.suppressallwhatsapp = 'Y' then true when la.suppressallwhatsapp = 'N' then false else null end end
            , blockedwhatsapp__pc = case when la.suppressallwhatsapp isnull then pa.blockedwhatsapp__pc when la.suppressallwhatsapp = '' then pa.blockedwhatsapp__pc else case when la.suppressallwhatsapp = 'Y' then true when la.suppressallwhatsapp = 'N' then false else null end end
            , inter_flag = 'if_up'
        from
            landing.if_update_contact_in_wf la
        where
            pa.row_id =  proc_account_id[1]
        and
            la.row_id = cast(param_id[1] as INTEGER);
           
           
           
           
    
        -- update contact
        update process.contact as pc set
            firstname = case when lc.firstname isnull then pc.firstname when lc.firstname = '' then pc.firstname else lc.firstname end 
            , lastname = case when lc.lastname isnull then pc.lastname when lc.lastname = '' then pc.lastname else lc.lastname end 
            , birthdate = case when lc.birthdate isnull then pc.birthdate else lc.birthdate end 
            , gender__c = case when lc.genre isnull then pc.gender__c when lc.genre = '' then pc.gender__c else lc.genre end 
            , homephone = case when lc.homephone isnull then pc.homephone when lc.homephone = '' then pc.homephone else lc.homephone end 
            , mobilephone = case when lc.cellularphone isnull then pc.mobilephone when lc.cellularphone = '' then pc.mobilephone else lc.cellularphone end 
            , email = case when lc.emailaddress isnull then pc.email when lc.emailaddress = '' then pc.email else lc.emailaddress end 
            , x_amount_friends__c = case when lc.amountfriends isnull then pc.x_amount_friends__c else lc.amountfriends::float8 end 
            , x_amount_children__c = case when lc.amountchildren isnull then pc.x_amount_children__c else lc.amountchildren::float8 end 
            , x_loyalty_optin_flg__c = case when lc.loyaltyoptinflag isnull then pc.x_loyalty_optin_flg__c when lc.loyaltyoptinflag = '' then pc.x_loyalty_optin_flg__c else lc.loyaltyoptinflag end 
            , mailingstreet = case when lc.streetaddress isnull then pc.mailingstreet when lc.streetaddress = '' then pc.mailingstreet else lc.streetaddress end 
            , mailingstreet_2__c = case when lc.addressnumber isnull then pc.mailingstreet_2__c when lc.addressnumber = '' then pc.mailingstreet_2__c else lc.addressnumber end 
            , mailingstreet_3__c = case when lc.addresscomplement isnull then pc.mailingstreet_3__c when lc.addresscomplement = '' then pc.mailingstreet_3__c else lc.addresscomplement end 
            , mailingcountry = case when lc.addresscountry isnull then pc.mailingcountry when lc.addresscountry = '' then pc.mailingcountry else lc.addresscountry end 
            , mailingcounty = case when lc.addresscounty isnull then pc.mailingcounty when lc.addresscounty = '' then pc.mailingcounty else lc.addresscounty end 
            , mailingcity = case when lc.addresscity isnull then pc.mailingcity when lc.addresscity = '' then pc.mailingcity else lc.addresscity end 
            , mailingstate = case when lc.addressstate isnull then pc.mailingstate when lc.addressstate = '' then pc.mailingstate else lc.addressstate end 
            , mailingpostalcode = case when lc.addresspostalcode isnull then pc.mailingpostalcode when lc.addresspostalcode = '' then pc.mailingpostalcode else lc.addresspostalcode end 
            , x_printed_card__c = case when lc.hmbprintedcard isnull then pc.x_printed_card__c when lc.hmbprintedcard = '' then pc.x_printed_card__c else case when lc.hmbprintedcard = 'Y' then true when lc.hmbprintedcard = 'N' then false else null end end  
            , inter_flag = 'if_up'
        from
            landing.if_update_contact_in_wf lc
        where
            pc.account_row_id = proc_account_id[1]
        and
            lc.row_id = cast(param_id[1] as INTEGER);
        
        if v_len > 0 then 
	        for v_i in 1..v_len
	            loop
	                
	                select 
	                    count(*)  into v_count
	                from
	                    process.customer_vehicle pcv
	                join
	                    landing.if_update_contact_in_wf_vehicle v               
	                on
	                    pcv.asset_id = v.vehicleid 
	                where
	                    pcv.account_id = proc_account_id[1]
	                and
	                    v.row_id = cast(vehicle_id[v_i] as Integer);             
	                
	                --  asset FirstOwner     
	                select
	                	count(*) into fo_count
	                from 
	                	process.customer_vehicle pc
	                join
	                	landing.if_update_contact_in_wf_vehicle v 
	                on 
	                	pc.asset_id = v.vehicleid 
	                where 
	                	lower(pc.cv_type) = 'person'
	                and
				    	lower(relation_type_cd) = 'first owner'
				    and
				   		v.par_row_id = cast(param_id[1] as Integer);
				    
				    --  Customer_vehicle relation&status 
				    if fo_count = 0 then
				    
				    	update process.customer_vehicle as pc set	
							relation_type_cd = 'First Owner'
							, status_cd = 'Inactive'
							, relationshipenddate__c = now()
							, inter_flag = 'if_up'
						from
							landing.if_update_contact_in_wf_vehicle v
						where 
							pc.asset_id = v.vehicleid
						and
							lower(pc.cv_type) = 'person'	
						and 
							lower(pc.status_cd) = 'active'
					    and
							v.par_row_id = cast(param_id[1] as INTEGER);
						
					else
					
						update process.customer_vehicle as pc set	
							status_cd = 'Inactive'
							, relationshipenddate__c = now()
							, inter_flag = 'if_up'
						from
							landing.if_update_contact_in_wf_vehicle v
						where 
							pc.asset_id = v.vehicleid
						and
							lower(pc.cv_type) = 'person'
		                and
		                	lower(pc.status_cd) = 'active'
					    and
							v.par_row_id = cast(param_id[1] as INTEGER);
					end if;
				    		
	                
	                if v_count = 0 then
	                    -- customer_vehicle insert 
	                    insert into process.customer_vehicle
	                    (
	                        relation_type_cd
	                        , asset_id 
	                        , account_id 
	                        , retail_date
	                        , cv_type 
	                        , status_cd 
	                        , inter_flag
	                    )
	                    select
	                        v.relationshipstatus  
	                        , v.vehicleid
	                        , proc_account_id[1]
	                        , l.hkmeretaildate
	                        , 'Person'
	                        , 'Active'
	                        , 'if_in'
	                    from
	                        landing.if_update_contact_in_wf_vehicle v 
	                    join
	                    	landing.if_update_contact_in_wf l 
	                    on
	                    	l.row_id = v.par_row_id
	                    where
	                        v.row_id = cast(nullif(vehicle_id[v_i],'') as Integer);
	                       
	                       
	                    update process.asset as pa set
	                    	renavam_code__c = case when v.hmbrenavamcode isnull then pa.renavam_code__c else v.hmbrenavamcode end
	                        , latestmileage__c = case when v.currentmileage isnull then pa.latestmileage__c else v.currentmileage end
	                        , carregistrationnumber__c = case when v.vehiclelicensenumber isnull then pa.carregistrationnumber__c else v.vehiclelicensenumber end
	                        , contact_row_id__c = proc_account_id[1]
	                        , inter_flag = 'if_up'                    	
	                    from
	                        landing.if_update_contact_in_wf_vehicle v 
	                    join
	                    	landing.if_update_contact_in_wf l 
	                    on
	                    	l.row_id = v.par_row_id
	                    where
	                        v.row_id = cast(nullif(vehicle_id[v_i],'') as Integer)
	                    and 
	                   		pa.row_id = v.vehicleid ;
	                    	
	                
	                else
	                    -- customer_vehicle update 
	                    update process.customer_vehicle as pcv set
	                        relation_type_cd = case when v.relationshipstatus isnull then pcv.relation_type_cd when v.relationshipstatus = '' then pcv.relation_type_cd else v.relationshipstatus end
	                        , retail_date = case when l.hkmeretaildate isnull then pcv.retail_date else l.hkmeretaildate end 
	                        , status_cd = 'Active'
	                        , inter_flag = 'if_up'
	                    from
	                        landing.if_update_contact_in_wf_vehicle v
	                    join
	                    	landing.if_update_contact_in_wf l 
	                    on
	                    	l.row_id = v.par_row_id                    	
	                    where
	                        pcv.asset_id = v.vehicleid
	                    and
	                        v.row_id = cast(vehicle_id[v_i] as Integer);
	                       
	                       
--	                    update process.asset as pa set
--	                    	contact_row_id__c  = proc_account_id[1]
--	                    from
--	                        landing.if_update_contact_in_wf_vehicle v 
--	                    join
--	                    	landing.if_update_contact_in_wf l 
--	                    on
--	                    	l.row_id = v.par_row_id
--	                    where
--	                        v.row_id = cast(nullif(vehicle_id[v_i],'') as Integer)
--	                    and 
--	                   		pa.row_id = v.vehicleid ;
	                   	
	                   	
	                   	update process.asset as pass set
	                        renavam_code__c = case when v.hmbrenavamcode isnull then pass.renavam_code__c else v.hmbrenavamcode end
	                        , latestmileage__c = case when v.currentmileage isnull then pass.latestmileage__c else v.currentmileage end
	                        , carregistrationnumber__c = case when v.vehiclelicensenumber isnull then pass.carregistrationnumber__c else v.vehiclelicensenumber end
	                        , contact_row_id__c = proc_account_id[1]
	                        , inter_flag = 'if_up'
	                    from
	                        landing.if_update_contact_in_wf_vehicle v
	                    where
	                        pass.row_id = v.vehicleid
	                    and
	                        v.row_id = cast(vehicle_id[v_i] as Integer);
	                   	
	                end if; 
	            
	            end loop;
	     	end if;
    END;
$procedure$
;

-- DROP PROCEDURE process.if_update_lead_ws(varchar);

CREATE OR REPLACE PROCEDURE process.if_update_lead_ws(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	declare protocol_val varchar(30);
	declare interaction_row_id text[];
	declare temperature_row_id text[];
	declare v_rsr_i integer;
	declare v_rsr_len integer;
	declare v_rpur_len integer;
	declare v_tsr_i integer;
	declare v_tsr_len integer;
	declare checkinteractnum integer;
	begin
		
--	select protocol into protocol_val from landing.if_update_lead_ws where row_id = CAST(param_id AS INTEGER);	
		
		update process.opportunity as po set
			--predictive_temp__c = liulwt.temperature 
			TransferredOpportunity__c = true
			, TransferredOpportunityDate__c = now()
			, lostreason__c = case when liulw.salereason isnull then po.lostreason__c else liulw.salereason end 
			, description = case when liulw."result" isnull then po.description else liulw."result" end 
			, inter_flag = 'if_up'
		from landing.if_update_lead_ws as liulw
		join
			landing.if_update_lead_ws_temperature as liulwt
		on
			liulw.row_id = liulwt.par_row_id 
		where 
			po.protocol__c = liulw.protocol; 
		
		
		select 
			array_agg(iulwi.row_id) into interaction_row_id 
		from 
			landing.if_update_lead_ws_interation iulwi
		where  
			iulwi.par_row_id = CAST(param_id AS INTEGER);
		
		v_rsr_len := array_length(interaction_row_id, 1);
		
		FOR v_rsr_i IN 1..v_rsr_len
		     loop
			     select 
				 	count(*) into checkinteractnum
				 from
				 	process.sales_consult_history psch
				 join
					landing.if_update_lead_ws_interation iulwi
				 on
				 	psch.protocol__c = (select protocol from landing.if_update_lead_ws where row_id = CAST(param_id AS INTEGER))
				 and
				 	psch.interactionnumber__c = iulwi.interactionnum
				 where
				 	iulwi.row_id = CAST(interaction_row_id[v_rsr_i] AS INTEGER);
			     	
			     if 0 = checkinteractnum then
				     insert into process.sales_consult_history(
						external_id__c
						, description_interaction__c
						, first_interaction_date__c
						, contact_flag__c
						, createddate
						, salesstatus__c
						, contactcustomer__c
						, result__c
						, source__c
						, subsidiarycode__c
						, pcd__c
						, date__c
						, salescpf__c
						, visitdate__c
						, visitstatus__c
						, scheduledvisitdate__c
						, protocol__c
						, interactionnumber__c
						, interactionstartdate__c
						, temperaturenumber__c
						, predictivetemp__c
						, integrationid__c
						, lostreason__c
						, inter_flag
					) select 
						iulw.row_id
						, iulw."result"
						, iulw.firstinterationdate
						, CASE when iulw.firstinterationdate notnull then true when iulw.firstinterationdate isnull then false else null end firstinterationdate
						, iulw.created 
					 	, iulw.salesstatus
						, CASE when iulwi.contactcustomer='Y' then true when iulwi.contactcustomer='N' then false else null end contactcustomer
						, iulw."result"
						, iulw."source"
						, 'HMB'
						, CASE when iulw.pcd='Y' then true when iulw.pcd='N' then false else null end pcd
						, iulw.dlrreceivedate
						, iulw.salecpf
						, iulw.visitdate
						, iulw.visitstat
						, iulw.schedvisit
						, iulw.protocol
						, iulwi.interactionnum
						, iulwi.date
						, case when iulwi.interactionnum = iulwt.temperaturenum then iulwt.temperaturenum else null end 
						, case when iulwi.interactionnum = iulwt.temperaturenum then iulwt.temperature else null end 
						, iulw.integrationid
						, iulw.salereason
						, 'if_in'
					from
						landing.if_update_lead_ws iulw
					join
						landing.if_update_lead_ws_interation iulwi
					on
						iulw.row_id = iulwi.par_row_id
					left join 
						landing.if_update_lead_ws_temperature iulwt
					on
						iulw.row_id = iulwt.par_row_id
					and
						iulwi.interactionnum = iulwt.temperaturenum 
					where 
						iulwi.row_id = CAST(interaction_row_id[v_rsr_i] AS INTEGER);
				end if;
			end loop;
	END;
$procedure$
;

-- DROP PROCEDURE process.interface_proc_acc(varchar);

CREATE OR REPLACE PROCEDURE process.interface_proc_acc(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account(
            		external_id__c
            		, corporateregistrationnumber__c
            		, name, corporaterepresentativename__c
            		, ori_cd__c
            		, x_contracted_since__c
            		, registrysource__c
            		, phone
            		, fax
            		, emailaddress
            		, website
            		, x_reason_status__c
            		, dealercode__c
            		, region__c
            		, type
            		, prtnrshp_start_dt__c
            		, prtnrshp_end_dt__c
            		, fleet__c
            		, industry
            		, numberofemployees
            		, x_tot_flt_size__c
            		, businesstype__c
            		, dealershoptype__c
            		, personemail
            		, salesflag__c
            		, serviceflag__c
            		, x_working_hours__c
            		, s_social_url__c
            		, x_dlr_srvc_type__c
            		, attrib_14__c
            		, billingstreet
            		, billingstreet_2__c
            		, billingstreet_3__c
            		, billingcountry
            		, billingcity
            		, billingstate
            		, billingpostalcode
            		, billinglatitude
            		, billinglongitude
            		, x_sales_rep__c
            		, description
            		, x_attrib_99__c
            		, x_dms__c
            		, x_api_key__c
            		, x_whatsapp_ph_num__c
            		, personassistantphone
            		, cust_stat_cd__c
            		, inter_flag
		      )
			select
				soe.INTEGRATION_ID, soe.X_CNPJ, soe.Name, soe.X_NICKNAME, soe.ORI_CD, soe.X_CONTRACTED_SINCE
				, soe.SOURCE_CD, soe.MAIN_PH_NUM, soe.MAIN_FAX_PH_NUM, soe.MAIN_EMAIL_ADDR, soe.URL, soe.X_REASON_STATUS
				, soe.OU_NUM, soe.REGION, soe.ACCNT_TYPE_CD, soe.PRTNRSHP_START_DT, sop.PTSHP_END_DT, soex.X_FLT_ACCT_TYPE
				, soex.X_FLT_IND_TYPE, soex.ATTRIB_07, soex.X_TOT_FLT_SIZE, soex.X_FLT_ORG_TYPE, soex.ATTRIB_39, soex.ATTRIB_51
				, soex.ATTRIB_10, soex.ATTRIB_11, soex.X_WORKING_HOURS, soex.X_SOCIAL_URL, soex2.X_DLR_SRVC_TYPE, soex.ATTRIB_14
				, sap.ADDR, sap.ADDR_LINE_2, sap.ADDR_LINE_3, sap.COUNTY, sap.CITY, sap.STATE, sap.ZIPCODE, sap.LATITUDE
				, sap.LONGITUDE, soe.X_SALES_REP, soe.DESC_TEXT, soex.X_ATTRIB_99, soex.X_DMS, soex.X_API_KEY, soe.X_WHATSAPP_PH_NUM
				, soe.X_SCHEDULING_PH_NUM, soe.CUST_STAT_CD
				, 'if_in'
	        from
	            landing.s_org_ext soe
			join
	            landing.s_org_ext_x soex
	        on
	            soe.row_id = soex.par_row_id            
			join 
	            landing.s_addr_per sap
	        on
	            soe.pr_addr_id = sap.row_id           
	        join
	            landing.s_org_ext_xm soex2
	        on
	            soe.row_id = soex2.par_row_id
	        join
	            landing.s_org_prtnr sop
	        on
	            soe.row_id = sop.par_row_id 
			where row_id = PARAM_ID;
	END;
$procedure$
;

-- DROP PROCEDURE process.interface_proc_con();

CREATE OR REPLACE PROCEDURE process.interface_proc_con()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.contact(external_id__c, cpf__c, firstname, lastname, email__c, homephone, companyphone, mobilephone, title
		                          , gender__c, birthdate, x_sanitized_flg__c, con_cd__c, preferredcontactchannel__c, maritalstatus__c, calloptyn__c, directmailoptyn__c
		                          , emailoptyn__c, x_printed_card__c, leadsource, occupation__c, attrib_36__c, attrib_49__c, x_literacy__c
		                          , x_seg_behavioral__c, x_seg_value__c, x_seg_google__c, x_seg_facebook__c, x_seg_life_cycle__c, x_seg_interest__c, x_loyalty_optin_flg__c
		                          , x_amount_friends__c, x_amount_children__c, x_cnh_exp_date__c, x_loyalty_act_dt__c, x_loyalty_exp_dt__c, x_loyalty_engagement__c
		                          , x_loyalty_satisfaction__c, x_loyalty_crm_index__c, x_loyalty__status__c, x_already_customer__c, mailingstreet, mailingstreet_2__c, mailingstreet_3__c
		                          , mailingcountry__c, mailingcity__c, mailingstate, mailingpostalcode, salutation, x_called_by__c, attrib_45__c, attrib_50__c, x_pne_flg__c
		                          , x_rowid_to_num__c, x_employee_flg__c, x_favoite_dealer__c, department, x_emp_area__c, emp_work_loc_name__c, receiveproductnewsflag__c
		                          , receiveretailoffersflag__c, receiveserviceoffersflag__c, receivenewsletterflag__c, receiveeventsflag__c, receiveresearchflag__c, blockedmobile__c, blockedwhatsapp__c
		                          , inter_flag
		   )
		    select sc.INTEGRATION_ID, sc.X_CPF, sc.FST_NAME, sc.LAST_NAME, sc.EMAIL_ADDR, sc.HOME_PH_NUM, sc.WORK_PH_NUM, sc.CELL_PH_NUM, sc.JOB_TITLE
				, sc.SEX_MF, sc.BIRTH_DT, sc.X_SANITIZED_FLG, sc.CON_CD, sc.PREF_COMM_METH_CD, sc.MARITAL_STAT_CD, sc.SUPPRESS_CALL_FLG, sc.SUPPRESS_MAIL_FLG
				, sc.SUPPRESS_EMAIL_FLG, sc.X_PRINTED_CARD, scx.ATTRIB_50, scx.ATTRIB_34, scx.ATTRIB_36, scx.ATTRIB_49, scx.X_LITERACY
				, scx.X_SEG_BEHAVIORAL, scx.X_SEG_VALUE, scx.X_SEG_GOOGLE, scx.X_SEG_FACEBOOK, scx.X_SEG_LIFE_CYCLE, scx.X_SEG_INTEREST, scx.X_LOYALTY_OPTIN_FLG
				, scx.X_AMOUNT_FRIENDS, scx.X_AMOUNT_CHILDREN, scx.X_CNH_EXP_DATE, scx.X_LOYALTY_ACT_DT, scx.X_LOYALTY_EXP_DT, scx.X_LOYALTY_ENGAGEMENT
				, scx.X_LOYALTY_SATISFACTION, scx.X_LOYALTY_CRM_INDEX, scx.X_LOYALTY_STATUS, scx.X_ALREADY_CUSTOMER, sap.ADDR, sap.ADDR_LINE_2, sap.ADDR_LINE_3
				, sap.COUNTY, sap.CITY, sap.STATE, sap.ZIPCODE, sc.PER_TITLE, scx.X_CALLED_BY, scx.ATTRIB_45, scx.ATTRIB_50, sc.X_PNE_FLG, sc.X_ROWID_TO_NUM
				, scx.X_EMPLOYEE_FLG, scx.X_FAVORITE_DEALER, scf.DEPT_TYPE_CD, scf.X_EMP_AREA, sc.EMP_WORK_LOC_NAME, sc.X_OPTIN_PRODUCT_FLG, sc.X_OPTIN_RETAIL_FLG
				, sc.X_OPTIN_OFFER_FLG, sc.X_OPTIN_NEWS_FLG, sc.X_OPTIN_EVENTS_FLG, sc.X_OPTIN_RESEARCH_FLG, sc.X_OPTIN_PHONE, sc.X_SUP_GONE_AWAY
				, 'if_in'
		    from s_contact sc
		    join
		        landing.s_contact_x scx
		    on
		        sc.row_id = scx.par_row_id	         	                     
		    join
		        landing.s_addr_per sap
		    on
		        sc.pr_per_addr_id  = sap.row_id  	  
		    join
		        landing.s_contact_fnx scf 
		    on
		        sc.row_id  = scf.par_row_id  ; 
		       
		INSERT INTO process.account(firstname
                        		, lastname
                        		, personemail__c
                        		, personhomephone
                        		, companyphone__pc
                        		, personmobilephone
                        		, occupation__pc
                        		, gender__pc
                        		, personbirthdate
                        		, preferredcontactchannel__c
                        		, maritalstatus__pc
                        		, calloptyn__pc
                        		, directmailoptyn__pc
                        		, emailoptyn__pc
                        		, inter_flag
    		)
		    select sc.FST_NAME, sc.LAST_NAME, sc.EMAIL_ADDR, sc.HOME_PH_NUM, sc.WORK_PH_NUM, sc.CELL_PH_NUM, sc.JOB_TITLE, sc.SEX_MF, sc.BIRTH_DT, 
					sc.PREF_COMM_METH_CD, sc.MARITAL_STAT_CD, sc.SUPPRESS_CALL_FLG, sc.SUPPRESS_MAIL_FLG, sc.SUPPRESS_EMAIL_FLG
					, 'if_in'
		    from s_contact sc
		    join
		        landing.s_contact_x scx
		    on
		        sc.row_id = scx.par_row_id	         	                     
		    join
		        landing.s_addr_per sap
		    on
		        sc.pr_per_addr_id  = sap.row_id  	  
		    join
		        landing.s_contact_fnx scf 
		    on
		        sc.row_id  = scf.par_row_id  ; 		       
	END;
$procedure$
;

-- DROP PROCEDURE process.m_proc_aprovou_levou();

CREATE OR REPLACE PROCEDURE process.m_proc_aprovou_levou()
 LANGUAGE plpgsql
AS $procedure$
	begin
		insert into  process.service_request (
			external_id__c
			, protocol__c
			, dealercode__c
			, origin
			, reason__c
			, voctype__c
			, voc_class
			, voc_level_2__c
			, voc_level_3__c
		)
		select 
			('Massive'||al.row_id),
			process.get_protocol_id('P'),
			al.dealer_code,
			'CRM HMB',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-aprovou-levou'
		from landing.aprovou_levou al 
		join
			process.account a 
		on
			al.cpf_cnpj = a.cpf__c or al.cpf_cnpj = a.corporateregistrationnumber__c
		;		
		
		INSERT INTO process.aprovou_levou (
			row_id,
			protocol__c,
			par_row_id,
			cpf_cnpj,
			dealer,
			dealer_cnpj,
			first_name,
			last_name,
			email,
			telefone,
			data_validade,
			modelo,
			parcela,
			dealer_code,
			id_siebel,
			origin,
			lead_status,
			customer_type,
			lead_type,
			reason,
			level1,
			level2,
			level3
		)
		select 
			al.row_id,
			sr.protocol__c,
			al.par_row_id,
			al.cpf_cnpj,
			al.dealer,
			al.dealer_cnpj,
			al.first_name,
			a.lastname,
			al.email,
			al.telefone,
			al.data_validade,
			al.modelo,
			al.parcela,
			al.dealer_code,
			al.id_siebel,	
			'CRM HMB',
			'Opened',
			'Person',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-aprovou-levou'
		from landing.aprovou_levou al 
		join
			process.account a 
		on
			al.cpf_cnpj = a.cpf__c or al.cpf_cnpj = a.corporateregistrationnumber__c
		join 
			process.service_request sr
		on
			'Massive'||al.row_id = sr.external_id__c 
		;
	END;
$procedure$
;

-- DROP PROCEDURE process.m_proc_financing_installment();

CREATE OR REPLACE PROCEDURE process.m_proc_financing_installment()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.service_request (
			external_id__c,
			protocol__c,
			dealercode__c,
			origin,
			reason__c,
			voctype__c,
			voc_class,
			voc_level_2__c
		)
		select 
			('Massive'||fi.row_id),
			process.get_protocol_id('P'),
			ass.dealercode__c,
			'CRM HMB',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank'	
		from landing.financing_installment fi
		join
			process.asset ass 
		on
			fi.chassi = ass.serialnumber 
		join
			process.account a 
		on
			ass.contact_row_id__c = a.row_id ;	
		
		
		INSERT INTO process.financing_installment (
			row_id,
			par_row_id,
			protocol__c,
			chassi,
			produto,
			inicio,
			fim,
			prazo,
			parcela,
			ano_fabricacao,
			ano_modelo,
			marca,
			modelo,
			concessionario,
			origin,
			frase,
			lead_status,
			customer_type,
			lead_type,
			reason,
			level1,
			level2,
			firstname,
			lastname,
			email,
			mobilephone,
			cpf__c,
			dealercode
		)
		select 
			fi.row_id,			
			fi.par_row_id,
			sr.protocol__c,
			fi.chassi,
			fi.produto,
			fi.inicio,
			fi.fim,
			fi.prazo,
			fi.parcela,
			fi.ano_fabricacao,
			fi.ano_modelo,
			fi.marca,
			fi.modelo,
			fi.concessionario,
			'CRM HMB',
			'Lead ' || fi.produto || ' gerado de forma proativa e automatica pela HMB, esse cliente nao gerou nenhuma cotacao conosco, portanto a abordagem deve ser feita de forma estrategica e cuidadosa. Entrar em contato para verificar o interesse do cliente em fazer uma nova negociacao para trocar por um 0Km. Data Final do Financiamen : ' || fi.fim || ' | Prazo: ' || fi.prazo || ' | Valor da Parcela: R$ ' || fi.parcela,
			'Opened',
			'Person',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			a.firstname,
			a.lastname,
			a.personemail,
			a.personmobilephone,
			a.cpf__c,
			ass.dealercode__c
		from landing.financing_installment fi
		join
			process.asset ass 
		on
			fi.chassi = ass.serialnumber 
		join
			process.account a 
		on
			ass.contact_row_id__c = a.row_id
		join 
			process.service_request sr
		on
			'Massive'||fi.row_id = sr.external_id__c 		
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.m_proc_loyalty_retention();

CREATE OR REPLACE PROCEDURE process.m_proc_loyalty_retention()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.service_request (
			external_id__c,
			protocol__c,
			dealercode__c,
			origin,
			reason__c,
			voctype__c,
			voc_class,
			voc_level_2__c,
			voc_level_3__c
--			form__c
		)
		select 
			('Massive'||lr.row_id),
			process.get_protocol_id('P'),
			lr.delaer_code,
			'CRM HMB',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-retencao'
--			'retencaosetembro_email_bank_set23'
		from landing.loyalty_retention lr
		join
			process.asset ass 
		on
			lr.chassi = ass.serialnumber 
		join
			process.account a 
		on
			ass.contact_row_id__c = a.row_id ;		
		
		INSERT INTO process.loyalty_retention (
			row_id,
			par_row_id,
			protocol__c,			
			chassi,
			delaer_code,
			dealer_nickname,
			dealer_grupo,
			dealer_regiao,
			dealer_cidade,
			dt_ultima_venda,
			id_contato_siebel,
			marca,
			modelo,
			concessionario,
			cliente_recompra,
			origin,
			frase,
			lead_status,
			customer_type ,
			lead_type ,
			reason,
			level1 ,
			level2 ,
			level3,
			form,
			firstname,
			lastname ,
			mobilephone ,
			email
		)
		select 
			lr.row_id,
			lr.par_row_id,
			sr.protocol__c,
			lr.chassi,
			lr.delaer_code,
			lr.dealer_nickname,
			lr.dealer_grupo,
			lr.dealer_regiao,
			lr.dealer_cidade,
			lr.dt_ultima_venda,
			lr.id_contato_siebel,
			lr.marca,
			lr.modelo,
			lr.concessionario,
			lr.cliente_recompra,
			'CRM HMB',
			'CAMPANHA RECOMPRA HMB: Clientes com data da ultima compra ha 18 e 24 meses, data da ultima compra em '|| lr.modelo ||'. Oferecer  as ofertas vigentes do mes com Bonus Adicional para clientes Hyundai, conforme o comunicado "VEN 236-2023", usando o veiculo atual para possivel upgrade. VEICULO ATUAL: '|| lr.dt_ultima_venda ||' / CLIENTE COM RECOMPRA ANTERIOR: ' || lr.cliente_recompra,
			'Opened',
			'Person',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-retencao',
			'retencaosetembro_email_bank_set23',
			a.firstname,
			a.lastname,			
			a.personmobilephone,
			a.personemail
		from landing.loyalty_retention lr
		join
			process.asset ass 
		on
			lr.chassi = ass.serialnumber 
		join
			process.account a 
		on
			ass.contact_row_id__c = a.row_id 
		join 
			process.service_request sr
		on
			'Massive'||lr.row_id = sr.external_id__c 		
			;			
	END;
$procedure$
;

-- DROP PROCEDURE process.m_proc_novo_de_novo();

CREATE OR REPLACE PROCEDURE process.m_proc_novo_de_novo()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.service_request (
			external_id__c,
			protocol__c,
			origin,
			reason__c,
			voctype__c,
			voc_class,
			voc_level_2__c,
			voc_level_3__c
		)
		select 
			('Massive'||ndn.row_id),
			process.get_protocol_id('P'),
			'CRM HMB',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-novo-de-novo'
		from landing.novo_de_novo ndn
		join
			process.account a 
		on
			ndn.cpf_cnpj = a.cpf__c or ndn.cpf_cnpj = a.corporateregistrationnumber__c
		;
	
		INSERT INTO process.novo_de_novo (
			row_id,
			par_row_id,
			protocol__c,				
			campaign,
			oferta,
			cpf_cnpj,
			firstname,
			lastname,
			email,
			telefone,
			veiculo,
			modelo,
			entrada,
			parcela,
			ocn,
			origin,
			frase,
			lead_status,
			customer_type,
			lead_type,
			reason,
			level1,
			level2,
			level3
		)
		select 
			ndn.row_id,
			ndn.par_row_id,
			sr.protocol__c,			
			ndn.campaign,
			ndn.oferta,
			ndn.cpf_cnpj,
			a.firstname,
			a.lastname,
			ndn.email,
			ndn.telefone,
			ndn.veiculo,
			ndn.modelo,
			ndn.entrada,
			ndn.parcela,
			ndn.ocn,
			'CRM HMB',
			'Lead gerado pelo cliente interessado na campanha Novo de Novo do Banco Hyundai - Oferta - Entrada de:  R$ ' || entrada || ' / Parcelas de:  R$ ' || parcela || ' / Oferta disponivel para o cliente:' || oferta,
			'Opened',
			'Person',
			'Informtaiton (Promotion)',
			'Sales opportunity',
			'Marketing',
			'Hyundai Bank',
			'hyundai-novo-de-novo'
		from landing.novo_de_novo ndn
		join
			process.account a 
		on
			ndn.cpf_cnpj = a.cpf__c or ndn.cpf_cnpj = a.corporateregistrationnumber__c
		join 
			process.service_request sr
		on
			'Massive'||ndn.row_id = sr.external_id__c 				
		;
	END;
$procedure$
;

-- DROP PROCEDURE process.mig_proc_amaro();

CREATE OR REPLACE PROCEDURE process.mig_proc_amaro()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.amaro(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			db_last_upd,
			rating_all,
			rating_attendant,
			rating_mechanic,
			research_date,
			sna_cod,
			sna_date,
			account_id,
			asset_id,
			contact_id,
			db_last_upd_src,
			dealer_id,
			integration_id,
			research_name,
			sna_comment,
			sna_type,
			source,
			status,
			sub_status,
			sra_sr_id
		)
		select 
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			db_last_upd,
			rating_all,
			rating_attendant,
			rating_mechanic,
			research_date,
			sna_cod,
			sna_date,
			account_id,
			asset_id,
			contact_id,
			db_last_upd_src,
			dealer_id,
			integration_id,
			research_name,
			sna_comment,
			sna_type,
			source,
			status,
			sub_status,
			sra_sr_id
		from landing.cx_amaro 
		;
	END;
$procedure$
;

-- DROP PROCEDURE process.mig_proc_amaro_answer();

CREATE OR REPLACE PROCEDURE process.mig_proc_amaro_answer()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.amaro_answer(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			answer_value,
			db_last_upd,
			answer_compl,
			db_last_upd_src,
			integration_id,
			question_comments,
			question_id,
			question_code,
			answer_long
		)
		select 
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			answer_value,
			db_last_upd,
			answer_compl,
			db_last_upd_src,
			integration_id,
			question_comments,
			question_id,
			question_code,
			answer_long
		from landing.cx_amaro_answer 
		;
	END;
$procedure$
;

-- DROP PROCEDURE process.ob_proc_bounce_performance();

CREATE OR REPLACE PROCEDURE process.ob_proc_bounce_performance()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.bounce_performance(
			campaign_name,
			treatmenttype,
			contacttype,
			bouncestatuscode,
			bouncereasoncode,
			bounced
			)
			select *,(select count(*) from process.s_camp_con where src_id = row_id and STAT_CD = 'Bounced') "#Bounced" from (
				SELECT 
				    SRC.NAME,
				    CRTN_PRG.MEDIA_TYPE_CD,
				    ctt.CON_CD,
				    CAMP_CON.MSG_BNCD_STAT_CD,
				    CAMP_CON.MSG_BNCD_REASON_CD
				FROM 
					landing.S_DMND_CRTN_PRG CRTN_PRG,
					landing.S_CONTACT CTT,
				    landing.S_SRC SRC,
				    process.S_CAMP_CON CAMP_CON,
				    process.S_COMMUNICATION COMM
				WHERE     
				    CRTN_PRG.ROW_ID = COMM.DCP_ID
				    AND CTT.ROW_ID = COMM.PR_CON_ID
				    AND COMM.CAMP_CON_ID = CAMP_CON.ROW_ID
				    AND COMM.SRC_ID = SRC.ROW_ID
				    and CAMP_CON.created >= '2022-01-01'
				    and CAMP_CON.created < '2023-01-01'
				group by 
					SRC.NAME,
				    CRTN_PRG.MEDIA_TYPE_CD,
				    ctt.CON_CD,
				    CAMP_CON.MSG_BNCD_STAT_CD,
				    CAMP_CON.MSG_BNCD_REASON_CD
			)t1;
	END;
$procedure$
;

-- DROP PROCEDURE process.ob_proc_campaign_performance();

CREATE OR REPLACE PROCEDURE process.ob_proc_campaign_performance()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.campaign_performance_rpt(
			campaign_id,
			campaign_name,
			treatmenttype,
			contacttype,
			numberoftargeted,
			numberofdeployed,
			numberofsent,
			numberofbounced,
			numberofopened,
			numberofclicked
			)
		     SELECT CAMP.ROW_ID CAMPAIGN_ID,
		            CAMP.NAME CAMPAIGN,
		            CRTN_PRG.MEDIA_TYPE_CD Treatment_Type,
		            ctt.CON_CD Contact_Type,
		            (SELECT COUNT (1)
		               FROM process.S_CAMP_CON CAMPCON_A, landing.S_SRC CAMP_A
		              WHERE     CAMP.NAME = CAMP_A.NAME
		                    AND CAMP_A.ROW_ID = CAMPCON_A.SRC_ID
		--                    AND CAMPCON_A.LAST_UPD >= now()::date - 30
		--                    AND CAMPCON_A.LAST_UPD < (now()::date + 1)
		                    AND CAMPCON_A.STAT_CD IS NOT NULL
		                    AND CAMPCON_A.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY'))
		               "# TARGET",
		            (SELECT COUNT (1)
		               FROM process.S_CAMP_CON CAMPCON_A, landing.S_SRC CAMP_A
		              WHERE     CAMP.NAME = CAMP_A.NAME
		                    AND CAMP_A.ROW_ID = CAMPCON_A.SRC_ID
		--                    AND CAMPCON_A.LAST_UPD >= now()::date - 30
		--                    AND CAMPCON_A.LAST_UPD < (now()::date + 1)
		                    AND CAMPCON_A.STAT_CD IS NOT NULL
		                    AND CAMPCON_A.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY'))
		               "# DEPLOYED",
		            (SELECT COUNT (1)
		               FROM process.S_CAMP_CON CAMPCON_A, landing.S_SRC CAMP_A
		              WHERE     CAMP.NAME = CAMP_A.NAME
		                    AND CAMP_A.ROW_ID = CAMPCON_A.SRC_ID
		--                    AND CAMPCON_A.LAST_UPD >= now()::date - 30
		--                    AND CAMPCON_A.LAST_UPD < (now()::date + 1)
		                    AND CAMPCON_A.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY')
		                    AND CAMPCON_A.STAT_CD = 'Sent')
		               "# SENT",
		            (SELECT COUNT (1)
		               FROM process.S_CAMP_CON CAMPCON_A, landing.S_SRC CAMP_A
		              WHERE     CAMP.NAME = CAMP_A.NAME
		                    AND CAMP_A.ROW_ID = CAMPCON_A.SRC_ID
		--                    AND CAMPCON_A.LAST_UPD >= now()::date - 30
		--                    AND CAMPCON_A.LAST_UPD < (now()::date + 1)
		                    AND CAMPCON_A.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY')
		                    AND CAMPCON_A.STAT_CD = 'Bounced')
		               "# BOUNCED",
		            (SELECT COUNT (1)
		               FROM process.S_CAMP_CON CAMPCON_A, landing.S_SRC CAMP_A
		              WHERE     CAMP.NAME = CAMP_A.NAME
		                    AND CAMP_A.ROW_ID = CAMPCON_A.SRC_ID
		--                    AND CAMPCON_A.LAST_UPD >= now()::date - 30
		--                    AND CAMPCON_A.LAST_UPD < (now()::date + 1)
		                    AND CAMPCON_A.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY')
		                    AND CAMPCON_A.MSG_OPEN_TS IS NOT NULL)
		               "# OPENED",
		            (SELECT COUNT (1)
		               FROM landing.S_DMND_CRTN_PRG CRTN_PRG,
		                    landing.S_CONTACT CTT,
		                    landing.S_SRC SRC,
		                    process.S_CAMP_CON CAMP_CON,
		                    process.S_COMM_DTL COMM_DTL,
		                    process.S_COMMUNICATION COMM
		              WHERE     CAMP.NAME = SRC.NAME
		                    AND CRTN_PRG.ROW_ID = COMM.DCP_ID
		                    AND CTT.ROW_ID = COMM.PR_CON_ID
		                    AND COMM_DTL.ROW_ID = COMM.ROW_ID
		                    AND COMM.CAMP_CON_ID = CAMP_CON.ROW_ID
		                    AND COMM.SRC_ID = SRC.ROW_ID
		                    AND COMM.RESP_TYPE_CD IS NOT NULL
		--                    AND CAMP_CON.LAST_UPD >= now()::date - 30
		--                    AND CAMP_CON.LAST_UPD < (now()::date + 1)
		                    AND CAMP_CON.PR_CALL_LST_ID NOT IN
		                             ('1-ABNY4', '1-DG4PG', '1-FCH7U', '1-NNPIY'))
		               "# CLICK"
		       FROM process.S_CAMP_CON CAMPCON,
		            landing.S_SRC CAMP,
		            process.S_CAMP_LD_WAVE WAVE,
					landing.S_DMND_CRTN_PRG CRTN_PRG,
		            landing.S_CONTACT CTT,
		            process.S_COMM_DTL COMM_DTL,
		            process.S_COMMUNICATION COMM            
		      WHERE     CAMP.ROW_ID = CAMPCON.SRC_ID
		--            AND WAVE.LAST_UPD >= now()::date - 30
		--            AND WAVE.LAST_UPD < (now()::date + 1)
		            AND WAVE.CAMP_ID = CAMP.ROW_ID
		            AND CRTN_PRG.ROW_ID = COMM.DCP_ID
		            AND CTT.ROW_ID = COMM.PR_CON_ID
		            AND COMM_DTL.ROW_ID = COMM.ROW_ID
		            AND COMM.CAMP_CON_ID = CAMPCON.ROW_ID
		            AND COMM.SRC_ID = CAMP.ROW_ID        
		            and CAMPCON.created between  '2022-01-01' and '2022-12-31'
		      group by camp.row_id, 
		      		CAMP.NAME, 
		            CRTN_PRG.MEDIA_TYPE_CD ,
		            ctt.CON_CD       
		--            WAVE.CREATED,
		--            WAVE.WAVE_NUM ,
		--            WAVE.ROW_ID             
		   ORDER BY camp.row_id desc;  
	END;
$procedure$
;

-- DROP PROCEDURE process.ob_proc_click_performance();

CREATE OR REPLACE PROCEDURE process.ob_proc_click_performance()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.click_performance(
			campaign_name,
			contacttype,
			treatmenttype,
			hyperlinkname,
			responses
			)
			SELECT SRC.NAME,
			    ctt.CON_CD,
			    CRTN_PRG.MEDIA_TYPE_CD,
			    COMM_DTL.HYPERLINK_NAME,
			    count(COMM.RESP_TYPE_CD)
			FROM 
				landing.S_DMND_CRTN_PRG CRTN_PRG,
			    landing.S_CONTACT CTT,
			    landing.S_SRC SRC,
			    process.S_CAMP_CON CAMP_CON,
			    process.S_COMM_DTL COMM_DTL,
			    process.S_COMMUNICATION COMM
			WHERE     
			    CRTN_PRG.ROW_ID = COMM.DCP_ID
			    AND CTT.ROW_ID = COMM.PR_CON_ID
			    AND COMM_DTL.ROW_ID = COMM.ROW_ID
			    AND COMM.CAMP_CON_ID = CAMP_CON.ROW_ID
			    AND COMM.SRC_ID = SRC.ROW_ID
			    --and COMM.RESP_TYPE_CD != 'Clicked On URL'
			group by 
				SRC.NAME,
				ctt.CON_CD,
			    CRTN_PRG.MEDIA_TYPE_CD,
			    COMM_DTL.HYPERLINK_NAME
			    ;  
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_account_exclude();

CREATE OR REPLACE PROCEDURE process.proc_account_exclude()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account_firstname_length (
		                      row_id
                            , external_id__c
                            , corporateregistrationnumber__c
                            , "name"
                            , corporaterepresentativename__c
                            , ori_cd__c
                            , x_contracted_since__c
                            , registrysource__c
                            , phone
                            , fax
                            , emailaddress
                            , website
                            , situationstatusreason__c
                            , dealercode__c
                            , region__c
                            , "type"
                            , prtnrshp_start_dt__c
                            , prtnrshp_end_dt__c
                            , fleet__c
                            , industry
                            , numberofemployees
                            , x_tot_flt_size__c
                            , businesstype__c
                            , dealershoptype__c
                            , personemail
                            , salesflag__c
                            , serviceflag__c
                            , businesshours__c
                            , facebook__c
                            , x_dlr_srvc_type__c
                            , attrib_14__c
                            , billingstreet
                            , billingstreet_2__c
                            , billingstreet_3__c
                            , billingcountry
                            , billingcity
                            , billingstate
                            , billingpostalcode
                            , billinglatitude
                            , billinglongitude
                            , x_sales_rep__c
                            , description
                            , leadmanager__c
                            , dms__c
                            , apikey__c
                            , whatsappphone__c
                            , personassistantphone
                            , cust_stat_cd__c
                            , firstname
                            , lastname
                            , personhomephone
                            , companyphone__pc
                            , personmobilephone
                            , occupation__pc
                            , gender__pc
                            , personbirthdate
                            , preferredcontactchannel__c
                            , maritalstatus__pc
                            , calloptyn__pc
                            , directmailoptyn__pc
                            , emailoptyn__pc
                            , smsoptyn__pc
                            , emailaddress__c
                            , addr_landing_id
                            , fleettype__c
                            , sanitized__c
                            , income__c
                            , productofinterest__c
                            , literacy__c
                            , calledby__c
                            , pcd__c
                            , employee__c
                            , favoritedealer__c
                            , loyaltyexpirationdate__c
                            , loyaltyactivationdate__c
                            , receiveproductnewsflag__c
                            , receiveretailoffersflag__c
                            , receiveserviceoffersflag__c
                            , receivenewsletterflag__c
                            , receiveeventsflag__c
                            , receiveresearchflag__c
                            , blockedmobile__c
                            , blockedwhatsapp__c
                            , loyaltystatus__c
                            , countrycode__c
                            , prtnrflag__c
                            , addrssname__c
                            , position__c
                            , org_par_row_id
                            , s_con_par_row_id
                            , partnertype__c
                            , neighborhood
                            , crmindex__c
                            , engagement__c
                            , optinflag__c
                            , satificationlevel__c
                            , cpf__c
                            , x_printed_card__c
                            , department
                            , x_emp_area__c
                            , escalation_flg
                            , integrationid
                            , pr_con_id
                            , blockedsms__c
                            , amount_friends
                            , amount_children
                            , loyaltyexpirationtodate__c
                            , loyaltyengagementindex__c
                            , satisficationlevel__c
                            , loyaltylifecycle__c
                            , numeric_row_id
                            , dealergroupcode__c
                            , salesgroup__c
                            , salesmanager__c
                            , servicemanager__c
                            , servicewhatsappnumber__c
                            , saleswhatsappnumber__c
                            , salesdistrict__c
                            , salesoffice__c
                            , division__c
                            , age__c
                            , hkmeretaildate
                            , billingcounty
                            , legacy_created
                            , legacy_created_by
                            , legacy_last_upd
                            , legacy_last_upd_by
		)
		select row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		from process.account a
		where character_length(firstname)>40;
	
		INSERT INTO process.account_billingcounty_length (
		      row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		)
		select row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		from process.account 
		where char_length(billingcountry)>40;
	
		INSERT INTO process.account_cpf_dup (
            		row_id
                    , external_id__c
                    , corporateregistrationnumber__c
                    , "name"
                    , corporaterepresentativename__c
                    , ori_cd__c
                    , x_contracted_since__c
                    , registrysource__c
                    , phone
                    , fax
                    , emailaddress
                    , website
                    , situationstatusreason__c
                    , dealercode__c
                    , region__c
                    , "type"
                    , prtnrshp_start_dt__c
                    , prtnrshp_end_dt__c
                    , fleet__c
                    , industry
                    , numberofemployees
                    , x_tot_flt_size__c
                    , businesstype__c
                    , dealershoptype__c
                    , personemail
                    , salesflag__c
                    , serviceflag__c
                    , businesshours__c
                    , facebook__c
                    , x_dlr_srvc_type__c
                    , attrib_14__c
                    , billingstreet
                    , billingstreet_2__c
                    , billingstreet_3__c
                    , billingcountry
                    , billingcity
                    , billingstate
                    , billingpostalcode
                    , billinglatitude
                    , billinglongitude
                    , x_sales_rep__c
                    , description
                    , leadmanager__c
                    , dms__c
                    , apikey__c
                    , whatsappphone__c
                    , personassistantphone
                    , cust_stat_cd__c
                    , firstname
                    , lastname
                    , personhomephone
                    , companyphone__pc
                    , personmobilephone
                    , occupation__pc
                    , gender__pc
                    , personbirthdate
                    , preferredcontactchannel__c
                    , maritalstatus__pc
                    , calloptyn__pc
                    , directmailoptyn__pc
                    , emailoptyn__pc
                    , smsoptyn__pc
                    , emailaddress__c
                    , addr_landing_id
                    , fleettype__c
                    , sanitized__c
                    , income__c
                    , productofinterest__c
                    , literacy__c
                    , calledby__c
                    , pcd__c
                    , employee__c
                    , favoritedealer__c
                    , loyaltyexpirationdate__c
                    , loyaltyactivationdate__c
                    , receiveproductnewsflag__c
                    , receiveretailoffersflag__c
                    , receiveserviceoffersflag__c
                    , receivenewsletterflag__c
                    , receiveeventsflag__c
                    , receiveresearchflag__c
                    , blockedmobile__c
                    , blockedwhatsapp__c
                    , loyaltystatus__c
                    , countrycode__c
                    , prtnrflag__c
                    , addrssname__c
                    , position__c
                    , org_par_row_id
                    , s_con_par_row_id
                    , partnertype__c
                    , neighborhood
                    , crmindex__c
                    , engagement__c
                    , optinflag__c
                    , satificationlevel__c
                    , cpf__c
                    , x_printed_card__c
                    , department
                    , x_emp_area__c
                    , escalation_flg
                    , integrationid
                    , pr_con_id
                    , blockedsms__c
                    , amount_friends
                    , amount_children
                    , loyaltyexpirationtodate__c
                    , loyaltyengagementindex__c
                    , satisficationlevel__c
                    , loyaltylifecycle__c
                    , numeric_row_id
                    , dealergroupcode__c
                    , salesgroup__c
                    , salesmanager__c
                    , servicemanager__c
                    , servicewhatsappnumber__c
                    , saleswhatsappnumber__c
                    , salesdistrict__c
                    , salesoffice__c
                    , division__c
                    , age__c
                    , hkmeretaildate
                    , billingcounty
                    , legacy_created
                    , legacy_created_by
                    , legacy_last_upd
                    , legacy_last_upd_by
		)
		select row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		from process.account 
		WHERE cpf__c  IN (
			SELECT cpf__c
			FROM process.account
			GROUP BY cpf__c
			HAVING COUNT(cpf__c) > 1);	
		
		INSERT INTO process.account_lastname_validation (
		      row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		)
		select  row_id
            , external_id__c
            , corporateregistrationnumber__c
            , "name"
            , corporaterepresentativename__c
            , ori_cd__c
            , x_contracted_since__c
            , registrysource__c
            , phone
            , fax
            , emailaddress
            , website
            , situationstatusreason__c
            , dealercode__c
            , region__c
            , "type"
            , prtnrshp_start_dt__c
            , prtnrshp_end_dt__c
            , fleet__c
            , industry
            , numberofemployees
            , x_tot_flt_size__c
            , businesstype__c
            , dealershoptype__c
            , personemail
            , salesflag__c
            , serviceflag__c
            , businesshours__c
            , facebook__c
            , x_dlr_srvc_type__c
            , attrib_14__c
            , billingstreet
            , billingstreet_2__c
            , billingstreet_3__c
            , billingcountry
            , billingcity
            , billingstate
            , billingpostalcode
            , billinglatitude
            , billinglongitude
            , x_sales_rep__c
            , description
            , leadmanager__c
            , dms__c
            , apikey__c
            , whatsappphone__c
            , personassistantphone
            , cust_stat_cd__c
            , firstname
            , lastname
            , personhomephone
            , companyphone__pc
            , personmobilephone
            , occupation__pc
            , gender__pc
            , personbirthdate
            , preferredcontactchannel__c
            , maritalstatus__pc
            , calloptyn__pc
            , directmailoptyn__pc
            , emailoptyn__pc
            , smsoptyn__pc
            , emailaddress__c
            , addr_landing_id
            , fleettype__c
            , sanitized__c
            , income__c
            , productofinterest__c
            , literacy__c
            , calledby__c
            , pcd__c
            , employee__c
            , favoritedealer__c
            , loyaltyexpirationdate__c
            , loyaltyactivationdate__c
            , receiveproductnewsflag__c
            , receiveretailoffersflag__c
            , receiveserviceoffersflag__c
            , receivenewsletterflag__c
            , receiveeventsflag__c
            , receiveresearchflag__c
            , blockedmobile__c
            , blockedwhatsapp__c
            , loyaltystatus__c
            , countrycode__c
            , prtnrflag__c
            , addrssname__c
            , position__c
            , org_par_row_id
            , s_con_par_row_id
            , partnertype__c
            , neighborhood
            , crmindex__c
            , engagement__c
            , optinflag__c
            , satificationlevel__c
            , cpf__c
            , x_printed_card__c
            , department
            , x_emp_area__c
            , escalation_flg
            , integrationid
            , pr_con_id
            , blockedsms__c
            , amount_friends
            , amount_children
            , loyaltyexpirationtodate__c
            , loyaltyengagementindex__c
            , satisficationlevel__c
            , loyaltylifecycle__c
            , numeric_row_id
            , dealergroupcode__c
            , salesgroup__c
            , salesmanager__c
            , servicemanager__c
            , servicewhatsappnumber__c
            , saleswhatsappnumber__c
            , salesdistrict__c
            , salesoffice__c
            , division__c
            , age__c
            , hkmeretaildate
            , billingcounty
            , legacy_created
            , legacy_created_by
            , legacy_last_upd
            , legacy_last_upd_by
		from process.account 
		where lastname = 'N/A';		
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_asset();

CREATE OR REPLACE PROCEDURE process.proc_asset()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.asset(
				row_id, 
--				external_id__c,
				account_row_id__c, 
				contact_row_id__c, 
				product2id, 
				enginetype__c, 
				modelname__c, 
				enginecapacity__c,
				name, 
				x_vehicle_intent_change__c, 
				x_is_current_flg__c, 
				x_vehicle_cli_expec_val__c, 
				assetaccountrollupkey__c, 
				status, 
				serialnumber, 
				carregistrationnumber__c, 
				warranty_start_dt__c, 
				billing_date__c, 
				oper_status_cd__c, 
				ownr_type_cd__c, 
				purch_loc_desc__c, 
				dlr_con_int_id__c, 
				modelyear__c, 
				dealercode__c, 
				purchaseprice__c, 
				renavam_code__c, 
				latestmileage__c, 
				fueltype__c, 
				manufacturedate, 
				dealer_rcpt_dt__c, 
				vehicledeliverydate__c, 
				enginenumber__c, 
				vehicleinternalcolor__c, 
				vehiclecolor__c, 
				vehicle_license_date__c, 
				friendly_model__c, 
				transmission__c, 
				bodytype__c, 
				fsc__c, 
				latestmileagelastupdatedate__c, 
				x_sales_cancel_dt__c, 
				special_moment__c, 
				campaigncode__c, 
				x_svc_conducted__c, 
				salesman__c, 
				x_dig_sales__c, 
				x_td_home__c, 
				x_del_home__c, 
				cf_eval_svc_cd__c,
				legacy_created,
				legacy_created_by,
				legacy_last_upd,
				legacy_last_upd_by,
				version__c,
				productdate__c
			)
			select 
				sa.ROW_ID, 
--				sa.ROW_ID, 
				sa.DLR_ID, 
				sa.pr_con_id, 
				sa.prod_id,
				scx.ATTRIB_34, 
				spix.ATTRIB_34,
				spix.ATTRIB_03,
				case when spix.attrib_35 isnull then (case when sa.serial_num isnull then sa.integration_id else sa.serial_num end ) else (spix.attrib_35 || ' ' || coalesce(spix.attrib_36, '-') || ' ' || coalesce (spix.attrib_38, '')) end as asset_name,
--				scx.X_NAME,
				scx.X_VEHICLE_INTENT_CHANGE, 
				CASE when scx.X_IS_CURRENT_FLG='Y' then true when scx.X_IS_CURRENT_FLG='N' then false else null end as X_IS_CURRENT_FLG, 
				scx.X_VEHICLE_CLI_EXPEC_VAL, 
				sa.INTEGRATION_ID, 
				sa.STATUS_CD, 
				sa.SERIAL_NUM, 
				sa.LCNS_NUM, 
				sa.WARRANTY_START_DT, 
				sa.ASGN_DT, 
				sa.OPER_STATUS_CD, 
				sa.OWNR_TYPE_CD, 
				sa.PURCH_LOC_DESC, 
				sa.DLR_CON_INT_ID, 
				to_char(sa.MODEL_YR, 'FM999999999999999999'), 
				soe.OU_NUM,
--				sa.DLR_ID, 
				saa.PRCHS_PRICE, 
				saa.X_RENAVAM_CODE, 
				saa.ODOMTR_SALE, 
				spix.ATTRIB_06, 
				saa.X_MANUFACTURE_YEAR, 
				saa.DEALER_RCPT_DT, 
				saa.FIRST_SALE_DT, 
				sax.ATTRIB_38, 
				sax.ATTRIB_05, 
				sax.ATTRIB_06, 
				sax.ATTRIB_26, 
				spix.ATTRIB_35, 
				spix.ATTRIB_05, 
				spi.BODY_STYLE_CD, 
				spi.NAME, 
				saa.BOL_DT_1, 
				sa.X_SALES_CANCEL_DT, 
				sax.ATTRIB_46, 
				sax.ATTRIB_37, 
				CASE when sa.X_SVC_CONDUCTED='Y' then true when sa.X_SVC_CONDUCTED='N' then false else null end as X_SVC_CONDUCTED, 
				sax.ATTRIB_44, 
				CASE when sax.X_DIG_SALES='Y' then true when sax.X_DIG_SALES='N' then false else null end as X_DIG_SALES, 
				CASE when sax.X_TD_HOME='Y' then true when sax.X_TD_HOME='N' then false else null end as X_TD_HOME, 
				CASE when sax.X_DEL_HOME='Y' then true when sax.X_DEL_HOME='N' then false else null end as X_DEL_HOME, 
				saa.CF_EVAL_SVC_CD,			
				sa.created,
				sa.created_by,
				sa.last_upd,
				sa.last_upd_by,
				sax.attrib_42,
				sa.MFGD_DT
				
			from landing.s_asset sa 
			left join 
				landing.s_asset_x sax 
			on
				sa.row_id = sax.par_row_id 
			left join
				landing.s_asset_atx saa 
			on
				sa.row_id = saa.par_row_id 
			left join 
				landing.s_prod_int spi 
			on
				sa.prod_id = spi.row_id
			left join
				landing.s_prod_int_x spix 
			on 
				sa.prod_id = spix.row_id	
			left join 
				landing.s_org_ext soe
			on
				sa.DLR_ID  = soe.row_id  				
--			left join
--				landing.s_contact sc 
--			on
--				sa.pr_con_id  = sc.row_id 
			left join 
				landing.s_contact_xm scx 
			on
				sa.pr_con_id = scx.par_row_id 
				and scx."type" ='Current Vehicles'
				and
				 not (
				scx.X_MODEL isnull and
				scx.ATTRIB_34 isnull and
				scx.ATTRIB_14 isnull and
				scx.X_VEHICLE_COLOR isnull and
				scx.X_NAME isnull and
				scx.X_VEHICLE_YEAR_MODEL isnull and
				scx.X_LICENSE_PLATE isnull and 
				scx.X_VEHICLE_INTENT_CHANGE isnull and
				scx.X_IS_CURRENT_FLG isnull and
				scx.X_VEHICLE_CLI_EXPEC_VAL isnull
				)
				and scx."name"='HYUNDAI'
				
				;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_asset_exclude();

CREATE OR REPLACE PROCEDURE process.proc_asset_exclude()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.asset_serialnumber_old_test (
                    	row_id
                        , modelname__c
                        , enginetype__c
                        , latestmileage__c
                        , name
                        , x_license_plate__c
                        , x_vehicle_intent_change__c
                        , x_is_current_flg__c
                        , x_vehicle_cli_expec_val__c
                        , vin__c
                        , assetaccountrollupkey__c
                        , status
                        , serialnumber
                        , carregistrationnumber__c
                        , warranty_start_dt__c
                        , billing_date__c
                        , oper_status_cd__c
                        , ownr_type_cd__c
                        , purch_loc_desc__c
                        , dlr_con_int_id__c
                        , modelyear__c
                        , dealercode__c
                        , purchaseprice__c
                        , renavam_code__c
                        , fueltype__c
                        , manufacturedate
                        , dealer_rcpt_dt__c
                        , vehicledeliverydate__c
                        , enginenumber__c
                        , vehicleinternalcolor__c
                        , vehiclecolor__c
                        , bodytype__c
                        , external_id__c
                        , fsc__c
                        , dlr_accnt_ref_id__c
                        , vehicle_year_model__c
                        , car_mileage__c
                        , x_vehiclecolor__c
                        , vehicle_license_date__c
                        , friendly_model__c
                        , transmission__c
                        , x_sales_cancel_dt__c
                        , special_moment__c
                        , campaigncode__c
                        , x_svc_conducted__c
                        , salesman__c
                        , x_dig_sales__c
                        , x_td_home__c
                        , x_del_home__c
                        , cf_eval_svc_cd__c
                        , latestmileagelastupdatedate__c
                        , account_row_id__c
                        , contact_row_id__c
                        , prod_id
                        , legacy_created
                        , legacy_created_by
                        , legacy_last_upd
                        , legacy_last_upd_by
                        , product2id
                        , description
                        , start_date
                        , end_date
                        , urlphotodate__c
                        , urlauthopublication__c
                        , salesrepfirstname
                        , salesreplastname
                        , hexawarrantyflag__c
		)
		select row_id
                        , modelname__c
                        , enginetype__c
                        , latestmileage__c
                        , name
                        , x_license_plate__c
                        , x_vehicle_intent_change__c
                        , x_is_current_flg__c
                        , x_vehicle_cli_expec_val__c
                        , vin__c
                        , assetaccountrollupkey__c
                        , status
                        , serialnumber
                        , carregistrationnumber__c
                        , warranty_start_dt__c
                        , billing_date__c
                        , oper_status_cd__c
                        , ownr_type_cd__c
                        , purch_loc_desc__c
                        , dlr_con_int_id__c
                        , modelyear__c
                        , dealercode__c
                        , purchaseprice__c
                        , renavam_code__c
                        , fueltype__c
                        , manufacturedate
                        , dealer_rcpt_dt__c
                        , vehicledeliverydate__c
                        , enginenumber__c
                        , vehicleinternalcolor__c
                        , vehiclecolor__c
                        , bodytype__c
                        , external_id__c
                        , fsc__c
                        , dlr_accnt_ref_id__c
                        , vehicle_year_model__c
                        , car_mileage__c
                        , x_vehiclecolor__c
                        , vehicle_license_date__c
                        , friendly_model__c
                        , transmission__c
                        , x_sales_cancel_dt__c
                        , special_moment__c
                        , campaigncode__c
                        , x_svc_conducted__c
                        , salesman__c
                        , x_dig_sales__c
                        , x_td_home__c
                        , x_del_home__c
                        , cf_eval_svc_cd__c
                        , latestmileagelastupdatedate__c
                        , account_row_id__c
                        , contact_row_id__c
                        , prod_id
                        , legacy_created
                        , legacy_created_by
                        , legacy_last_upd
                        , legacy_last_upd_by
                        , product2id
                        , description
                        , start_date
                        , end_date
                        , urlphotodate__c
                        , urlauthopublication__c
                        , salesrepfirstname
                        , salesreplastname
                        , hexawarrantyflag__c
		from process.asset 
		where char_length(serialnumber) > 18;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_bluelink();

CREATE OR REPLACE PROCEDURE process.proc_bluelink()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.bluelink(
			asset_id,
			row_id,
			type__c,
			firstactivation__c,
			eventdate__c,
			chassi__c,
			assetdate__c,
			created,
			created_by,
			last_upd,
			last_upd_by
		)
		select 
			sa.row_id,
			sax.row_id,
			sax.ATTRIB_34,
			sax.ATTRIB_08,
			sax.ATTRIB_26,
			sa.SERIAL_NUM,
			sa.ASGN_DT,
			sax.created,
			sax.created_by,
			sax.last_upd,
			sax.last_upd_by
		from landing.s_asset_xm sax 
		left join
			landing.s_asset sa 
		on
			sax.par_row_id = sa.row_id 
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_business_acc();

CREATE OR REPLACE PROCEDURE process.proc_business_acc()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account_cleansing(
				row_id, 
				org_par_row_id,
				corporateregistrationnumber__c, 
				name, 
				corporaterepresentativename__c, 
				ori_cd__c, 
				x_contracted_since__c, 
				registrysource__c, 
				phone, 
				fax, 
				emailaddress__c, 
				website, 
				situationstatusreason__c, 
				dealercode__c, 
				region__c, 
				type, 
				prtnrshp_start_dt__c, 
				prtnrshp_end_dt__c, 
				businesstype__c, 
				industry, 
				numberofemployees, 
				x_tot_flt_size__c, 
				fleettype__c, 
				dealershoptype__c, 
				personemail, 
				salesflag__c, 
				serviceflag__c, 
				businesshours__c, 
				facebook__c, 
				attrib_14__c, 
				billingstreet, 
				billingstreet_2__c, 
				billingstreet_3__c, 
				neighborhood, 
				billingcountry, 
				billingcity, 
				billingstate, 
				billingpostalcode, 
				billinglatitude, 
				billinglongitude, 
				x_sales_rep__c, 
				description, 
				leadmanager__c, 
				dms__c, 
				apikey__c, 
				whatsappphone__c, 
				personassistantphone, 
				cust_stat_cd__c, 
				partnertype__c,
				legacy_created,
				legacy_created_by,
				legacy_last_upd,
				legacy_last_upd_by,
				process_account_type 
			)
			select
				soe.ROW_ID, 
				soe.PAR_ROW_ID,
				soe.X_CNPJ, 
				soe.Name, 
				soe.X_NICKNAME, 
				soe.ORI_CD, 
				soe.X_CONTRACTED_SINCE, 
				soe.SOURCE_CD, 
				soe.MAIN_PH_NUM, 
				soe.MAIN_FAX_PH_NUM, 
				soe.MAIN_EMAIL_ADDR, 
				soe.URL, 
				soe.X_REASON_STATUS, 
				soe.OU_NUM, 
				soe.REGION, 
				soe.ACCNT_TYPE_CD, 
				soe.PRTNRSHP_START_DT, 
				sop.PTSHP_END_DT, 
				soex.X_FLT_ACCT_TYPE, 
				soex.X_FLT_IND_TYPE, 
				soex.ATTRIB_07, 
				soex.X_TOT_FLT_SIZE, 
				soex.X_FLT_ORG_TYPE, 
				soex.ATTRIB_39, 
				soex.ATTRIB_51, 
				CASE when soex.ATTRIB_10='Y' then true when soex.ATTRIB_10='N' then false else null end as ATTRIB_10,
				CASE when soex.ATTRIB_11='Y' then true when soex.ATTRIB_11='N' then false else null end as ATTRIB_11,
				soex.X_WORKING_HOURS, 
				soex.X_SOCIAL_URL, 
				soex.ATTRIB_14, 
				sap.ADDR, 
				sap.ADDR_LINE_2, 
				sap.ADDR_LINE_3, 
				sap.COUNTY, 
				sap.COUNTRY, 
				sap.CITY, 
				sap.STATE, 
				sap.ZIPCODE, 
				sap.LATITUDE, 
				sap.LONGITUDE, 
				soe.X_SALES_REP, 
				soe.DESC_TEXT, 
				CASE when soex.X_ATTRIB_99='Y' then true when soex.X_ATTRIB_99='N' then false else null end as X_ATTRIB_99,
				soex.X_DMS, 
				soex.X_API_KEY, 
				soe.X_WHATSAPP_PH_NUM, 
				soe.X_SCHEDULING_PH_NUM, 
				soe.CUST_STAT_CD, 
				sopt.prtnr_type,
				soe.created,
				soe.created_by,
				soe.last_upd,
				soe.last_upd_by,
				'Business'
	        from
	            landing.s_org_ext soe    
	        join
	        	process.account_business_condition abc
	        on
	        	soe.row_id = abc.row_id 
			left join
	            landing.s_org_ext_x soex
	        on
	            abc.row_id = soex.par_row_id            
			left join 
	            landing.s_addr_per sap
	        on
	            abc.pr_addr_id = sap.row_id 
	        left join
	            landing.s_org_prtnr sop
	        on
	            abc.row_id = sop.par_row_id 	            
	        left join
	        	landing.s_ou_prtnr_type sopt
	       	on
	       		abc.row_id = sopt.prtnr_ou_id 
			where soe."name" not like 'Def%'	; 
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_business_acc_condition();

CREATE OR REPLACE PROCEDURE process.proc_business_acc_condition()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account_business_condition(
				row_id, 
				pr_addr_id 
			)
			select soe.row_id,
				soe.pr_addr_id
			from landing.s_org_ext soe 
			where row_id not in (
				select row_id
				from process.account_dealer_condition adc
			)
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_case();

CREATE OR REPLACE PROCEDURE process.proc_case()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.case(
			row_id,
			account_row_id__c,
			business_row_id,
			contact_row_id__c,
			asset_id,		
			owner_emp_id,
			legacycreateddate__c,
			legacylastmodifieddate__c,
			close_date__c,
			protocol__c,
			service_request_reason__c,
			voctype__c,
			voc_class,
			voc_level_2__c,
			voc_level_3__c,
			origin,
			source__c,
			description,
			status,
			status_date__c,
			priority,
			resolution__c,
			anonymous__c,
			sr_impact_cd__c,
			customersatisfied__c,
			dealercode__c,
			causing_area__c,
			date_of_immobilization__c,
			x_quote_desc__c,
			engine_transmission__c,
			version__c,
			car_version_price__c,
			color__c,
			color_price__c,
			unit_value__c,
			car_replacement_intention__c,
			sap_code_test_drive__c,
			test_drive_confirmed__c,
			time_test_drive__c,
			date_test_drive__c,
			pne_flg__c,
			campaignid__c,
			source_tag__c,
			stock_tag__c,
			medium_tag__c,
			content_tag__c,
			campaign_tag__c,
			add_comment__c,
			causing_person__c,
			customer_rep__c,
			customer_rep_rel__c,
			diagnosis_difficulty__c,
			diagnosis_pending__c,
			dlr_response__c,
			dlr_fup__c,
			dlr_pending__c,
			dlr_retraction__c,
			dlr_reversal__c,
			hotline_flg__c,
			hotline_num__c,
			hotline_open_dt__c ,
			purchase_proposal_num__c,
			pwa_flg__c,
			pwa_number__c,
			pwa_oped_dt__c,
			recurrence__c,
			recurrence_num__c,
			vehicle_delivery_dt__c,
			vehicle_delivery_flg__c,
			wants_loan__c,
			loan_type__c ,
			installments_amt__c,
			down_payment__c,
			usedcar_payment__c ,
			dlr_temp__c
			)
			select
				sr.row_id, 
				sr.account_row_id__c, 
				sr.business_row_id,
				sr.contact_row_id__c, 
				sr.asset_id,
				sr.owner_emp_id,
				sr.legacycreateddate__c, 
				sr.legacy_last_update__c, 
				sr.close_date__c,
				sr.protocol__c, 
				sr.reason__c, 
				sr.voctype__c, 
				sr.voc_class, 
				sr.voc_level_2__c, 
				sr.voc_level_3__c, 
				sr.origin, 
				sr.method, 
				sr.description, 
				sr.status, 
				sr.status_date__c, 
				sr.priority, 
				sr.solution__c, 
				sr.anonymous_flag__c, 
				sr.tendency__c, 
				sr.customersatisfied__c, 
				a.dealercode__c, 
				sr.causing_area__c, 
				sr.immobilization_date__c, 
				sr.quote_description__c, 
				sr.quotetransmission__c, 
				sr.version__c, 
				sr.quote_version_price__c, 
				sr.quote_color__c, 
				sr.quote_color_price__c, 
				sr.quote_price__c, 
				sr.quote_replace_intention__c, 
				sr.integrationid__c, 
				sr.testdrive_confirmed__c, 
				sr.testdrive_time__c, 
				sr.date_test_drive__c, 
				sr.pne_flag__c, 
				sr.campaignid__c, 
				sr.source_tag__c, 
				sr.stock__c, 
				sr.medium_tag__c, 
				sr.content_tag__c, 
				sr.campaign_tag__c, 
				sr.additional_comments__c, 
				sr.causing_person__c, 
				sr.cust_representative__c, 
				sr.cust_representative_rel__c, 
				sr.diagnosis_difficultyflg__c, 
				sr.diagnosis_pendingflg__c, 
				sr.dlr_description__c, 
				sr.dlr_fup__c, 
				sr.dlr_pending__c, 
				sr.dlr_retractionflg__c, 
				sr.dlr_reversal__c, 
				sr.hotline_flg__c, 
				sr.hotline_num__c, 
				sr.hotline_open_dt__c , 
				sr.purchase_proposal_num__c, 
				sr.pwa_flg__c, 
				sr.pwa_number__c, 
				sr.pwa_oped_dt__c, 
				sr.recurrence_flg__c, 
				sr.recurrence_num__c, 
				sr.vehicle_delivery_dt__c, 
				sr.vehicle_delivery_flg__c, 
				sr.wants_loan__c, 
				sr.loan_type__c , 
				sr.installments_amt__c, 
				sr.down_payment__c, 
				sr.usedcar_as_down_payment__c , 
				sr.predictive_temp__c
			from process.service_request sr 
			left join
				process.account a  
			on
				sr.account_row_id__c = a.row_id
			where 
				not ((upper(sr.reason__c) = upper('Information') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Test Drive'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Request a quote'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Promotion'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Hyundai Bank'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Visitor') and upper(sr.voc_class)=upper('Dealer') and upper(sr.origin)=upper('Showroom'))
				or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason Not_to_Buy'))
				or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason to Buy'))
			); 			
--		INSERT INTO process.case(
--			row_id, 
--			account_row_id__c, 
--			contact_row_id__c, 
--			legacycreateddate__c, 
--			legacylastmodifieddate__c, 
--			protocol__c, 
--			service_request_reason__c, 
--			voctype__c, 
--			voc_class, 
--			voc_level_2__c, 
--			voc_level_3__c, 
--			origin, 
--			source__c, 
--			description, 
--			status, 
--			status_date__c, 
--			priority, 
--			resolution__c, 
--			anonymous__c, 
--			sr_impact_cd__c, 
--			customersatisfied__c, 
--			dealercode__c, 
--			causing_area__c, 
--			date_of_immobilization__c, 
--			x_quote_desc__c, 
--			engine_transmission__c, 
--			version__c, 
--			car_version_price__c, 
--			color__c, 
--			color_price__c, 
--			unit_value__c, 
--			car_replacement_intention__c, 
--			sap_code_test_drive__c, 
--			test_drive_confirmed__c, 
--			time_test_drive__c, 
--			date_test_drive__c, 
--			pne_flg__c, 
--			campaignid__c, 
--			source_tag__c, 
--			stock_tag__c, 
--			medium_tag__c, 
--			content_tag__c, 
--			campaign_tag__c, 
--			add_comment__c, 
--			causing_person__c, 
--			customer_rep__c, 
--			customer_rep_rel__c, 
--			diagnosis_difficulty__c, 
--			diagnosis_pending__c, 
--			dlr_response__c, 
--			dlr_fup__c, 
--			dlr_pending__c, 
--			dlr_retraction__c, 
--			dlr_reversal__c, 
--			hotline_flg__c, 
--			hotline_num__c, 
--			hotline_open_dt__c , 
--			purchase_proposal_num__c, 
--			pwa_flg__c, 
--			pwa_number__c, 
--			pwa_oped_dt__c, 
--			recurrence__c, 
--			recurrence_num__c, 
--			vehicle_delivery_dt__c, 
--			vehicle_delivery_flg__c, 
--			wants_loan__c, 
--			loan_type__c , 
--			installments_amt__c, 
--			down_payment__c, 
--			usedcar_payment__c , 
--			dlr_temp__c
--			)
--			select
--				ssr.row_id, 
--				ssr.RTNG_DLR_ID, 
--				ssr.CST_CON_ID, 
--				ssr.CREATED,
--				ssr.LAST_UPD,
--				ssr.SR_NUM, 
--				ssr.REASON_CD,
--				ssr.SR_TYPE_CD,
--				ssr.SR_AREA,
--				ssr.SR_SUB_AREA,
--				ssrx.X_LEVEL_4,
--				CASE when ssrx.ATTRIB_43='Complaint Site' then 'Reclame Aqui' else ssrx.ATTRIB_43 end as ATTRIB_43,				
--				ssr.SR_SUBTYPE_CD,
--				ssr.DESC_TEXT, 
--				ssr.SR_STAT_ID,
--				ssr.SR_STAT_DT,
--				ssr.SR_SEV_CD,
--				ssr.RESOLUTION_CD, 
--				CASE when ssrx.X_ANONYMOUS_FLG='Y' then true when ssrx.X_ANONYMOUS_FLG='N' then false else null end as X_ANONYMOUS_FLG, 
--				ssr.SR_IMPACT_CD, 
--				ssrx.ATTRIB_46,
--				soe.OU_NUM, 
--				ssrx.X_CAUSING_AREA, 
--				ssrx.ATTRIB_29, 
--				ssrx.X_QUOTE_DESC, 
--				ssrx.X_CAR_ENGTRANSM, 
--				ssrx.X_CAR_VERSION, 
--				ssrx.X_CAR_VERSION_PRICE, 
--				ssrx.X_CAR_COLOR, 
--				ssrx.X_CAR_COLOR_PRICE, 
--				cast(replace(replace(ssrx.X_CAR_FINAL_PRICE, 'R$', ''),',','' ) as float8) as X_CAR_FINAL_PRICE, 
----				(ssrx.X_CAR_FINAL_PRICE, 'R|\$|,', '', 'g')
--				ssrx.X_CAR_REPL_INTENT, 
--				ssr.INTEGRATION_ID, 
--				CASE when ssrx.ATTRIB_11='Y' then true when ssrx.ATTRIB_11='N' then false else null end as ATTRIB_11, 
--				ssr.X_TEST_DRV_TM, 
--				ssr.X_TESTDRV_DT, 
--				CASE when ssr.X_PNE_FLG='Y' then true when ssr.X_PNE_FLG='N' then false else null end as X_PNE_FLG, 
--				CASE when ssr.X_VIPLIST_CAMPAIGN_ID='Y' then true when ssr.X_VIPLIST_CAMPAIGN_ID='N' then false else null end as X_VIPLIST_CAMPAIGN_ID, 
--				ssr.X_VIPLIST_SRC_TAG, 
--				ssr.X_VIPLIST_STOCK, 
--				ssr.X_VIPLIST_MEDIUM, 
--				ssr.X_VIPLIST_CONTENT, 
--				ssr.X_VIPLIST_CAMPAIGN, 
--				ssrx.X_ADDITIONAL_COMMENTS, 
--				ssrx.X_CAUSING_PERSON, 
--				ssrx.X_CUST_REP, 
--				ssrx.X_CUST_REP_REL, 
--				CASE when ssrx.X_DIAGNOSIS_DIFFICULTY='Y' then true when ssrx.X_DIAGNOSIS_DIFFICULTY='N' then false else null end as X_DIAGNOSIS_DIFFICULTY, 
--				CASE when ssrx.X_DIAGNOSIS_PENDING='Y' then true when ssrx.X_DIAGNOSIS_PENDING='N' then false else null end as X_DIAGNOSIS_PENDING, 
--				ssrx.X_DLR_DESCRIPTION, 
--				ssrx.X_DLR_FUP, 
--				ssrx.X_DLR_PENDING, 
--				CASE when ssrx.X_DLR_RETRACTION='Y' then true when ssrx.X_DLR_RETRACTION='N' then false else null end as X_DLR_RETRACTION, 
--				ssrx.X_DLR_REVERSAL, 
--				CASE when ssrx.X_HOTLINE_FLG='Y' then true when ssrx.X_HOTLINE_FLG='N' then false else null end as X_HOTLINE_FLG, 
--				ssrx.X_HOTLINE_NUM, 
--				ssrx.X_HOTLINE_OPEN_DT, 
--				ssrx.X_PURCHASE_PROPOSAL_NUM, 
--				CASE when ssrx.X_PWA_FLG='Y' then true when ssrx.X_PWA_FLG='N' then false else null end as X_PWA_FLG, 
--				ssrx.X_PWA_NUM, 
--				ssrx.X_PWA_OPEN_DT, 
--				CASE when ssrx.X_RECURRENCE='Y' then true when ssrx.X_RECURRENCE='N' then false else null end as X_RECURRENCE, 
--				ssrx.X_RECURRENCE_NUM, 
--				ssrx.X_VEHICLE_DELIVERY_DT, 
--				CASE when ssrx.X_VEHICLE_DELIVERY_FLG='Y' then true when ssrx.X_VEHICLE_DELIVERY_FLG='N' then false else null end as X_VEHICLE_DELIVERY_FLG, 
--				CASE when ssrx.X_OPV_WANTS_LOAN='Y' then true when ssrx.X_OPV_WANTS_LOAN='N' then false else null end as X_OPV_WANTS_LOAN, 
--				ssrx.X_OPV_LOAN_TYPE, 
--				ssrx.X_OPV_INSTALLMENTS_AMT, 
--				ssrx.X_OPV_DOWN_PAYMNT, 
--				CASE when ssrx.X_OPV_USEDCAR_PAYMNT='Y' then true when ssrx.X_OPV_USEDCAR_PAYMNT='N' then false else null end as X_OPV_USEDCAR_PAYMNT, 
--				ssrx.X_DLR_TEMPERATURE
--			from landing.s_srv_req ssr
--			left join
--				landing.s_srv_req_x ssrx 
--			on
--				ssr.row_id = ssrx.par_row_id 
--			left join
--				landing.s_org_ext soe 
--			on
--				ssr.rtng_dlr_id = soe.row_id
--			where 
--				not ((upper(ssr.REASON_CD) = upper('Information') and upper(ssr.SR_TYPE_CD)=upper('Sales') and upper(ssr.SR_AREA)=upper('Test Drive')) --test drive
--				or (upper(ssr.REASON_CD) =upper('Sales Opportunity') and upper(ssr.SR_TYPE_CD)=upper('Sales') and upper(ssr.SR_AREA)=upper('Request a quote'))) -- quotation
--				;
----			from process.service_request sr 
----			left join
----				process.account a  
----			on
----				sr.account_row_id__c = soe.row_id
----			where 
----				not ((upper(ssr.REASON_CD) = upper('Information') and upper(ssr.SR_TYPE_CD)=upper('Sales') and upper(ssr.SR_AREA)=upper('Test Drive')) --test drive
----				or (upper(ssr.REASON_CD) =upper('Sales Opportunity') and upper(ssr.SR_TYPE_CD)=upper('Sales') and upper(ssr.SR_AREA)=upper('Request a quote'))) -- quotation			
----			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_chat_message_exclude();

CREATE OR REPLACE PROCEDURE process.proc_chat_message_exclude()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.cx_chat_message_foreignkey_dup (
		              row_id
                    , created
                    , created_by
                    , last_upd
                    , last_upd_by
                    , modification_num
                    , conflict_id
                    , cht_row_id
                    , name
                    , type
                    , db_last_upd
                    , msg_dt
                    , db_last_upd_src
                    , msg_cd
                    , msg_text
                    , status
                    , x_attrib_01
--                    , origin_par_row_id
		)
		select row_id
            , created
            , created_by
            , last_upd
            , last_upd_by
            , modification_num
            , conflict_id
            , cht_row_id
            , name
            , type
            , db_last_upd
            , msg_dt
            , db_last_upd_src
            , msg_cd
            , msg_text
            , status
            , x_attrib_01
            --, origin_par_row_id
		from (
			select ccm.*, cc.cht_row_id cc_cht_row_id
--			select ccm.row_id ccm_row_id, ccm.cht_row_id, cc.cht_row_id cc_cht_row_id
			from process.cx_chat_message ccm
			left join
				 process.cx_chat cc  
			on
				cc.cht_row_id = ccm.cht_row_id
		) A
		where A.cc_cht_row_id isnull ;	
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_color_information();

CREATE OR REPLACE PROCEDURE process.proc_color_information()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.color_information(
					row_id,
					dcking_num,
					active_flg,
					dflt_lic_flg,
					lang_id__c,
					mltorg_disalw_flg,
					multi_lingual_flg,
					name_code,
					reqd_lic_flg,
					rplctn_lvl_cd,
					type,
					val,
					modifiable_flg,
					order_by,
					translate_flg__c,
					weighting_factor,
					code,
					desc_text,
					high,
					low,
					integration_id__c,
					sub_type,
					legacy_created,
					legacy_created_by,
					legacy_last_upd,
					legacy_last_upd_by
			)
			select  
					row_id,
					dcking_num
					,CASE when active_flg='Y' then true when active_flg='N' then false else null end as active_flg
					,CASE when dflt_lic_flg='Y' then true when dflt_lic_flg='N' then false else null end as dflt_lic_flg
					,lang_id
					,CASE when mltorg_disalw_flg='Y' then true when mltorg_disalw_flg='N' then false else null end as mltorg_disalw_flg
					,CASE when multi_lingual_flg='Y' then true when multi_lingual_flg='N' then false else null end as multi_lingual_flg
					,name
					,CASE when reqd_lic_flg='Y' then true when reqd_lic_flg='N' then false else null end as reqd_lic_flg
					,rplctn_lvl_cd
					,type
					,val
					,CASE when modifiable_flg='Y' then true when modifiable_flg='N' then false else null end as modifiable_flg
					,order_by
					,CASE when translate_flg='Y' then true when translate_flg='N' then false else null end as translate_flg
					,weighting_factor
					,code
					,desc_text
					,high
					,low
					,integration_id
					,sub_type
					,created
					,created_by
					,last_upd
					,last_upd_by
			from landing.s_lst_of_val;
			--where type='AUTO_EXTERIOR' or type='AUTO_INTERIOR';
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_customer_vehicle();

CREATE OR REPLACE PROCEDURE process.proc_customer_vehicle()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.customer_vehicle(
			row_id, 
			asset_id, 
			x_employee_flg, 
			relation_type_cd, 
			status_cd, 
			legacy_created, 
			legacy_created_by, 
			legacy_last_upd, 
			legacy_last_upd_by, 
			account_id, 
			cv_type, 
			billpay_enbl_flg, 
			retail_date, 
			guarantor_flg, 
			addr_per_id, 
			owner_cd, 
			revoc_flg
		)
		select 
			A.row_id, 
			A.asset_id, 
			A.x_employee_flg, 
			A.relation_type_cd, 
			A.status_cd, 
			A.legacy_created, 
			A.legacy_created_by, 
			A.legacy_last_upd, 
			A.legacy_last_upd_by, 
			A.account_id, 
			A.cv_type,
			A.billpay_enbl_flg,
			A.retail_date,
			A.guarantor_flg,
			A.addr_per_id,
			A.owner_cd,
			A.revoc_flg
		from
			(
				SELECT 
					row_id as row_id, 
					asset_id as asset_id, 
					CASE when x_employee_flg='Y' then true when x_employee_flg='N' then false else null end as x_employee_flg,
					relation_type_cd as relation_type_cd, 
					status_cd as status_cd, 
					created as legacy_created, 
					created_by as legacy_created_by, 
					last_upd as legacy_last_upd, 
					last_upd_by as legacy_last_upd_by, 
					contact_id as account_id,
					'Person' as cv_type,
					CASE when billpay_enbl_flg='Y' then true when billpay_enbl_flg='N' then false else null end as billpay_enbl_flg,
					attrib_26 as retail_date,
					CASE when guarantor_flg='Y' then true when guarantor_flg='N' then false else null end as guarantor_flg,
					addr_per_id as addr_per_id,
					owner_cd as owner_cd,
					null as revoc_flg
				FROM landing.s_asset_con
					UNION All
				SELECT 
					row_id as row_id, 
					asset_id as asset_id, 
					CASE when x_employee_flg='Y' then true when x_employee_flg='N' then false else null end as x_employee_flg, 
					rel_type_cd as relation_type_cd, 
					status_cd as status_cd, 
					created as legacy_created, 
					created_by as legacy_created_by, 
					last_upd as legacy_last_upd, 
					last_upd_by as legacy_last_upd_by, 
					accnt_id as account_id, 
					'Business' as cv_type, 
					null as billpay_enbl_flg,
					null as retail_date,
					null as guarantor_flg,
					null as addr_per_id,
					null as owner_cd,
					CASE when revoc_flg='Y' then true when revoc_flg='N' then false else null end as revoc_flg
				FROM landing.s_asset_accnt saa 
			)A ;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_dealer();

CREATE OR REPLACE PROCEDURE process.proc_dealer()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.dealerholiday (
			row_id,
			type__c,
			holiday_name__c,
			holiday_day__c,
			holiday_date__c,
			par_row_id__c,
			createddate,
			createdby,
			legacy_last_upd,
			legacy_last_upd_by
		)
	    select 
			row_id, 
			"type", 
			ATTRIB_02, 
			ATTRIB_03, 
			ATTRIB_12, 
			par_row_id,
			created,
			created_by,
			last_upd,
			last_upd_by
	    from landing.s_org_ext_xm soex
	    where type ='Dealer Local Holiday';
		   
		INSERT INTO process.dealerservice (
			row_id, 
			type__c, 
			dlr_srvc_type__c, 
			par_row_id__c,
			createddate,
			createdby,
			legacy_last_upd,
			legacy_last_upd_by
		)
	    select 
			row_id, 
			"type" , 
			X_DLR_SRVC_TYPE, 
			par_row_id,
			created,
			created_by,
			last_upd,
			last_upd_by
	    from landing.s_org_ext_xm soex
	    where type ='Dealer Maintenance Service';		   
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_dealer_acc();

CREATE OR REPLACE PROCEDURE process.proc_dealer_acc()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account_cleansing(
				row_id, 
				org_par_row_id,
				pr_con_id,
				corporateregistrationnumber__c, 
				name, 
				ori_cd__c, 
				x_contracted_since__c, 
				registrysource__c, 
				phone, 
				fax, 
				emailaddress__c, 
				website, 
				situationstatusreason__c, 
				dealercode__c, 
				customersap__c,
				region__c, 
				type, 
				prtnrshp_start_dt__c, 
				prtnrshp_end_dt__c, 
				businesstype__c, 
				industry, 
				numberofemployees, 
				x_tot_flt_size__c, 
				fleettype__c, 
				dealershoptype__c, 
				salesflag__c, 
				serviceflag__c, 
				businesshours__c, 
				facebook__c, 
				attrib_14__c, 
				billingstreet, 
				billingstreet_2__c, 
				billingstreet_3__c, 
				neighborhood, 
				billingcountry, 
				billingcity, 
				billingstate, 
				billingpostalcode, 
				billinglatitude, 
				billinglongitude, 
--				firstname, 
--				lastname, 
				x_sales_rep__c, 
				description, 
				leadmanager__c, 
				dms__c, 
				apikey__c, 
				whatsappphone__c, 
				personassistantphone, 
				cust_stat_cd__c, 
				partnertype__c,
				nickname__c,
				sapworkaddress__c,
				legacy_created,
				legacy_created_by,
				legacy_last_upd,
				legacy_last_upd_by,
				process_account_type
			)
			select
				soe.ROW_ID, 
				soe.par_row_id,
				soe.pr_con_id,
				soe.X_CNPJ, 
				soe.Name, 
				soe.ORI_CD, 
				soe.X_CONTRACTED_SINCE, 
				soe.SOURCE_CD, 
				soe.MAIN_PH_NUM, 
				soe.MAIN_FAX_PH_NUM, 
				soe.MAIN_EMAIL_ADDR, 
				soe.URL, 
				soe.X_REASON_STATUS, 
				soe.OU_NUM,
				soex.X_DEALER_CODE,
				soe.REGION, 
				soe.ACCNT_TYPE_CD, 
				soe.PRTNRSHP_START_DT, 
				sop.PTSHP_END_DT, 
				soex.X_FLT_ACCT_TYPE, 
				soex.X_FLT_IND_TYPE, 
				soex.ATTRIB_07, 
				soex.X_TOT_FLT_SIZE, 
				soex.X_FLT_ORG_TYPE, 
				soex.ATTRIB_39, 
				CASE when soex.ATTRIB_10='Y' then true when soex.ATTRIB_10='N' then false else null end as ATTRIB_10,
				CASE when soex.ATTRIB_11='Y' then true when soex.ATTRIB_11='N' then false else null end as ATTRIB_11,	
				soex.X_WORKING_HOURS, 
				soex.X_SOCIAL_URL, 
				soex.ATTRIB_14, 
				sap.ADDR, 
				sap.ADDR_LINE_2, 
				sap.ADDR_LINE_3, 
				sap.COUNTY, 
				sap.COUNTRY, 
				sap.CITY, 
				sap.STATE, 
				sap.ZIPCODE, 
				sap.LATITUDE, 
				sap.LONGITUDE, 
--				sc.FST_NAME, 
--				sc.LAST_NAME, 
				soe.X_SALES_REP, 
				soe.DESC_TEXT, 
				CASE when soex.X_ATTRIB_99='Y' then true when soex.X_ATTRIB_99='N' then false else null end as X_ATTRIB_99,	
				soex.X_DMS, 
				soex.X_API_KEY, 
				soe.X_WHATSAPP_PH_NUM, 
				soe.X_SCHEDULING_PH_NUM, 
				soe.CUST_STAT_CD, 
				sopt.prtnr_type,
				soe.X_NICKNAME, 
				soex.ATTRIB_51,
				soe.created,
				soe.created_by,
				soe.last_upd ,
				soe.last_upd_by,
				'Dealer'
			from
			    landing.s_org_ext soe
			join
				process.account_dealer_condition adc
			on
				soe.row_id = adc.row_id
			left join
			    landing.s_org_ext_x soex
			on
			    adc.row_id = soex.par_row_id            
			left join 
			    landing.s_addr_per sap
			on
			    adc.pr_addr_id = sap.row_id  
			left join
			    landing.s_org_prtnr sop
			on
			    soe.row_id = sop.par_row_id            
			left join
				landing.s_ou_prtnr_type sopt
			on
				soe.row_id  = sopt.prtnr_ou_id
			where soe."name" not like 'Def%'	
	            ; 
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_dealer_acc_condition();

CREATE OR REPLACE PROCEDURE process.proc_dealer_acc_condition()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account_dealer_condition(
				row_id, 
				pr_addr_id 
			)
			select 
				distinct t1.row_id,
				t1.pr_addr_id 
			from landing.s_org_ext t1,
				 landing.s_org_ext_x t2,
				 landing.s_org_ext_xm t3
			where 
				t1.row_id = t2.par_row_id 
				and t1.row_id = t3.par_row_id 
				and t3.type = 'Dealer Maintenance Service'
				and t1.prtnr_flg  <> 'N'
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_dealer_appointment_history();

CREATE OR REPLACE PROCEDURE process.proc_dealer_appointment_history()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
--		INSERT INTO process.dealer_appointment_history	(
--			row_id, 
--			par_row_id, 
--			created, 
--			created_by, 
--			last_upd, 
--			last_upd_by, 
--			modification_num, 
--			conflict_id, 
--			srvc_type, 
--			srvc_arrival_date, 
--			srvc_start_date, 
--			srvc_duration, 
--			srvc_delivery_date, 
--			srvc_consultant_id, 
--			srvc_technician_id, 
--			srvc_status_cd,
--			protocol__c
--		)
--		select 
--			csmx.ROW_ID, 
--			csmx.PAR_ROW_ID, 
--			csmx.CREATED, 
--			csmx.created_by, 
--			csmx.LAST_UPD, 
--			csmx.LAST_UPD_BY, 
--			csmx.MODIFICATION_NUM, 
--			csmx.CONFLICT_ID, 
--			csmx.SRVC_TYPE, 
--			csmx.SRVC_ARRIVAL_DATE, 
--			csmx.SRVC_START_DATE, 
--			csmx.SRVC_DURATION, 
--			csmx.SRVC_DELIVERY_DATE, 
--			csmx.SRVC_CONSULTANT_ID, 
--			csmx.SRVC_TECHNICIAN_ID, 
--			csmx.SRVC_STATUS_CD,
--			sr.protocol__c
--		from landing.cx_sr_mntsrvc_x csmx
--		join process.service_request sr
--		on csmx.par_row_id  = sr.row_id
--	;
		
		INSERT INTO process.dealer_appointment_history	(
			row_id, 
			par_row_id,
			contact_row_id__c,
			cpf__c,
			personemail,
			personmobilephone,
			dealercode__c,
			account_row_id__c,
			created, 
			created_by, 
			last_upd, 
			last_upd_by, 
			modification_num, 
			conflict_id, 
			srvc_type, 
			srvc_arrival_date, 
			srvc_start_date, 
			srvc_duration, 
			srvc_delivery_date, 
			srvc_consultant_id, 
			srvc_technician_id, 
			srvc_status_cd,
			protocol__c
		)
			select 
			sr.ROW_ID, 
			csmx.PAR_ROW_ID, 
			sr.contact_row_id__c,
			sc.X_CPF,
			sc.EMAIL_ADDR,
			sc.CELL_PH_NUM,
--			soe.OU_NUM,
			soe.OU_NUM,
			sr.account_row_id__c,
			sr.legacycreateddate__c, 
			sr.legacy_created_by, 
			sr.legacy_last_update__c, 
			sr.legacy_last_upd_by, 
			csmx.MODIFICATION_NUM, 
			csmx.CONFLICT_ID, 
			csmx.SRVC_TYPE, 
			csmx.SRVC_ARRIVAL_DATE, 
			csmx.SRVC_START_DATE, 
			csmx.SRVC_DURATION, 
			csmx.SRVC_DELIVERY_DATE, 
			csmx.SRVC_CONSULTANT_ID, 
			csmx.SRVC_TECHNICIAN_ID, 
			csmx.SRVC_STATUS_CD,
			sr.protocol__c
		from process.service_request sr
		left join
--			process.account sc
			landing.s_contact sc
		on
--			sr.contact_row_id__c = sc.row_id
			sr.contact_row_id__c = sc.row_id
		left join
			landing.s_org_ext soe
		on
			sr.account_row_id__c = soe.row_id
		left join
--			process.dealer_appointment_history csmx
			landing.cx_sr_mntsrvc_x csmx
		on
--			sr.row_id = csmx.par_row_id  
		  	sr.row_id = csmx.par_row_id	
		where
			sr.reason__c ='Request'
		and voctype__c ='Service'
		and voc_class = 'Review / Maintenance'
		and voc_level_2__c = 'Scheduling'
		and voc_level_3__c = 'Customer Request'
	;

	END;
$procedure$
;

-- DROP PROCEDURE process.proc_dealer_con();

CREATE OR REPLACE PROCEDURE process.proc_dealer_con()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.contact(
			row_id, 
			rownum,
			account_row_id, 
			mailingstreet, 
			mailingcountry, 
			mailingstate, 
			mailingpostalcode, 
			mailinglatitude, 
			mailinglongitude, 
			con_cd__c, 
			firstname, 
			lastname, 
			email, 
			homephone, 
			companyphone__c, 
			mobilephone, 
			title, 
			gender__c, 
			cpf__c, 
			receiveproductnewsflag__c, 
			receiveretailoffersflag__c, 
			receiveserviceoffersflag__c, 
			receivenewsletterflag__c, 
			receiveeventsflag__c, 
			receiveresearchflag__c, 
			blockedmobile__c, 
			x_printed_card__c, 
			preferredcontactchannel__c, 
			maritalstatus__c, 
			calloptyn__c, 
			directmailoptyn__c, 
			emailoptyn__c, 
			blockedwhatsapp__c, 
			department, 
			x_emp_area__c
		)
		select 
			row_id, 
			rownum,
			a_row_id,  
			ADDR, 
			CITY, 
			STATE, 
			ZIPCODE, 
			LATITUDE, 
			LONGITUDE, 
			con_cd, 
			FST_NAME, 
			LAST_NAME, 
			EMAIL_ADDR, 
			HOME_PH_NUM, 
			WORK_PH_NUM, 
			CELL_PH_NUM, 
			JOB_TITLE, 
			SEX_MF, 
			X_CPF, 
			X_OPTIN_PRODUCT_FLG,
			X_OPTIN_RETAIL_FLG,
			X_OPTIN_OFFER_FLG,
			X_OPTIN_NEWS_FLG,
			X_OPTIN_EVENTS_FLG,
			X_OPTIN_RESEARCH_FLG,
			X_OPTIN_PHONE,
			X_SUP_GONE_AWAY,
			PREF_COMM_METH_CD, 
			MARITAL_STAT_CD, 
			SUPPRESS_CALL_FLG,
			SUPPRESS_MAIL_FLG,
			SUPPRESS_EMAIL_FLG, 
			X_PRINTED_CARD,  
			DEPT_TYPE_CD, 
			X_EMP_AREA
		from(
			select sc.row_id row_id, 
					ROW_NUMBER() OVER(PARTITION BY sc.row_id ORDER BY sc.row_id desc) as rownum,
					a.row_id a_row_id,  
					sap.ADDR, 
					sap.CITY, 
					sap.STATE, 
					sap.ZIPCODE, 
					sap.LATITUDE, 
					sap.LONGITUDE, 
					sc.con_cd, 
					sc.FST_NAME, 
					sc.LAST_NAME, 
					sc.EMAIL_ADDR, 
					sc.HOME_PH_NUM, 
					sc.WORK_PH_NUM, 
					sc.CELL_PH_NUM, 
					sc.JOB_TITLE, 
					sc.SEX_MF, 
					sc.X_CPF, 
					CASE when sc.X_OPTIN_PRODUCT_FLG='Y' then true when sc.X_OPTIN_PRODUCT_FLG='N' then false else null end as X_OPTIN_PRODUCT_FLG,
					CASE when sc.X_OPTIN_RETAIL_FLG='Y' then true when sc.X_OPTIN_RETAIL_FLG='N' then false else null end as X_OPTIN_RETAIL_FLG,
					CASE when sc.X_OPTIN_OFFER_FLG='Y' then true when sc.X_OPTIN_OFFER_FLG='N' then false else null end as X_OPTIN_OFFER_FLG,
					CASE when sc.X_OPTIN_NEWS_FLG='Y' then true when sc.X_OPTIN_NEWS_FLG='N' then false else null end as X_OPTIN_NEWS_FLG,
					CASE when sc.X_OPTIN_EVENTS_FLG='Y' then true when sc.X_OPTIN_EVENTS_FLG='N' then false else null end as X_OPTIN_EVENTS_FLG,
					CASE when sc.X_OPTIN_RESEARCH_FLG='Y' then true when sc.X_OPTIN_RESEARCH_FLG='N' then false else null end as X_OPTIN_RESEARCH_FLG,
					CASE when sc.X_OPTIN_PHONE='Y' then true when sc.X_OPTIN_PHONE='N' then false else null end as X_OPTIN_PHONE,
					CASE when sc.X_SUP_GONE_AWAY='Y' then true when sc.X_SUP_GONE_AWAY='N' then false else null end as X_SUP_GONE_AWAY,
					sc.PREF_COMM_METH_CD, 
					sc.MARITAL_STAT_CD, 
					CASE when sc.SUPPRESS_CALL_FLG='Y' then true when sc.SUPPRESS_CALL_FLG='N' then false else null end as SUPPRESS_CALL_FLG,
					CASE when sc.SUPPRESS_MAIL_FLG='Y' then true when sc.SUPPRESS_MAIL_FLG='N' then false else null end as SUPPRESS_MAIL_FLG,
					CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end as SUPPRESS_EMAIL_FLG, 
					CASE when sc.X_PRINTED_CARD='Y' then true when sc.X_PRINTED_CARD='N' then false else null end as X_PRINTED_CARD,  
					scf.DEPT_TYPE_CD, 
					scf.X_EMP_AREA
			from landing.s_contact sc 
			left join 
				process.account a  
			on
				sc.row_id = a.pr_con_id 
			left join
			    landing.s_addr_per sap
			on
			    sc.pr_per_addr_id  = sap.row_id  	  
			left join
			    landing.s_contact_fnx scf 	
			on
			    sc.row_id  = scf.par_row_id    
			where 
				sc.con_cd = 'Dealer'
		)t where rownum = 1;
--		from landing.s_contact sc 
--		join (
--			select (max(row_id)) row_id, pr_con_id
--			from process.account
--			where
--				"type" = 'Dealer'
--			group by
--				pr_con_id
--			) a 
--		on
--			sc.row_id = a.pr_con_id  
--		left join
--		    landing.s_addr_per sap
--		on
--		    sc.pr_per_addr_id  = sap.row_id  	  
--		left join
--		    landing.s_contact_fnx scf 	
--		on
--		    sc.row_id  = scf.par_row_id    
--		where 
--			sc.con_cd = 'Dealer';
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_escalationflg_up();

CREATE OR REPLACE PROCEDURE process.proc_escalationflg_up()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		update process.account aa
		set		
			escalation_flg = 'N' 
		from process.account a 
		where
			aa.row_id = a.row_id 
			and
			a.type in ('c_Customer', 'c_Ex-Customer', 'c_Prospect') and char_length(a.firstname)>40 ;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_file_attachment();

CREATE OR REPLACE PROCEDURE process.proc_file_attachment()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.file_attachment(
    		row_id,
    		par_row_id__c,
    		legacy_created,
    		legacy_created_by,
    		legacy_last_upd,
    		legacy_last_upd_by,
    		modification_num__c,
    		file_auto_upd_flg__c,
    		file_defer_flg__c,
    		file_dock_req_flg__c,
    		file_dock_stat_flg__c,
    		file_name__c,
    		db_last_upd__c,
    		file_date__c,
    		file_size__c,
    		comments__c,
    		db_last_upd_src__c,
    		file_ext__c,
    		file_rev_num__c,
    		file_src_path__c,
    		file_src_type__c,
    		publish_cd__c,
    		x_dp_if_dt__c,
    		x_dp_if_filename__c,
    		x_dp_if_flg__c
		)
		select 
    		row_id, 
    		par_row_id, 
    		created,
    		created_by,
    		last_upd,
    		last_upd_by,
    		modification_num,
    		file_auto_upd_flg,
    		file_defer_flg, 
    		file_dock_req_flg, 
    		file_dock_stat_flg, 
    		file_name, 
    		db_last_upd, 
    		file_date, 
    		file_size, 
    		comments, 
    		db_last_upd_src, 
    		file_ext, 
    		file_rev_num, 
    		file_src_path, 
    		file_src_type, 
    		publish_cd, 
    		x_dp_if_dt, 
    		x_dp_if_filename, 
    		x_dp_if_flg
		from landing.S_SR_ATT;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_loyalty_program();

CREATE OR REPLACE PROCEDURE process.proc_loyalty_program()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.loyalty_program (
			row_id,
			person_account_id,
			dealer_account_id,
			legacy_created,
			legacy_created_by,
			legacy_last_upd,
			legacy_last_upd_by,
			legacy_modification_num,
			name__c,
			type__c,
			x_benefit_use__c,
			x_benefit_name__c,
			x_src_app__c,
			x_benefit_url__c
		)
		select 
			row_id,
			par_row_id,
			x_account_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			name,
			type,
			x_benefit_use,
			x_benefit_name,
			x_src_app,
			x_benefit_url
		from landing.cx_cnt_bnf_xm ccbx ;
--		join 
--			landing.s_org_ext soe  
--		on
--			ccbx.x_account_id = soe.row_id
--		join 
--			process.account a  
--		on
--			ccbx.x_account_id = a.row_id  
--		join 
--			landing.s_contact sc   
--		on
--			ccbx.par_row_id = sc.row_id  	
--		join 
--			process.account a2  
--		on
--			ccbx.par_row_id = a2.row_id ; 	
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_oppty();

CREATE OR REPLACE PROCEDURE process.proc_oppty()
 LANGUAGE plpgsql
AS $procedure$
	begin
--		
--2634921   
--CREATE TEMP TABLE temp_service_request as
--  SELECT  
--		sr.row_id, 
--		soe.ou_num,
--		sr.contact_row_id__c, 
--		sr.account_row_id__c, 
--		sr.protocol__c, 
--		sr.campaign_tag__c, 
--		sr.legacycreateddate__c::date +90 as legacycreateddate__c,
--		sr.close_date__c,
--		sr.content_tag__c, 
--		sr.description, 
--		sr.form__c, 
--		sr.voctype__c, 
--		sr.voc_class, 
--		sr.voc_level_2__c, 
--		sr.voc_level_3__c, 
--		sr.medium_tag__c, 
--		sr.origin, 
--		sr.predictive_temp__c,
--		sr.reason__c, 
--		sr.source_tag__c, 
--		case when sr.status ='Closed' then 'Closed Lost' else 'Distributed' end as status
--    FROM process.service_request sr
--    left join
--    	landing.s_org_ext soe
--    on
--    	sr.account_row_id__c = soe.row_id    
--   WHERE legacycreateddate__c::date between '2022-01-01' and '2023-10-24'; 
--  
-- 999798
--CREATE TEMP TABLE temp_service_event_act as
--select sea.sra_sr_id
--	, max(case when sea."type" in ('Request a quote', 'Test drive - add', 'Test drive - update' ) then sea."type" else '' end) as "type"
--	, max(reason__c) as reason__c
--from process.service_event_act sea 
--where 
--	sea."type" in ('Request a quote', 'Test drive - add', 'Test drive - update' )
--and sea.created  between '2022-01-01' and '2023-10-24'
--group by sea.sra_sr_id;
--
--select *
--from temp_service_request tsr;
--
--select *
--from temp_service_event_act tsr;
--
--999,563
--select count(*)
--from temp_service_request tsr
--join
--	temp_service_event_act tset
--on
--	tsr.row_id = tset.sra_sr_id;  

		
		
--		INSERT INTO process.opportunity(
--				row_id, 
--				dealercode__c, 
--				contact_row_id__c, 
--				dealeraccount__c, 
--				protocol__c, 
----				oppty_name, 
--				campaign_tag__c, 
--				close_date__c, 
--				completedate__c,
--				content_tag__c, 
--				description, 
--				form__c, 
--				voctype__c, 
--				voc_class, 
--				voc_level_2__c, 
--				voc_level_3__c, 
--				lostreason__c, 
--				medium_tag__c, 
--				type, 
--				origin, 
--				predictive_temp__c, 
--				reason__c, 
--				source_tag__c, 
--				status
--			)
--			select
--				tsr.row_id, 
--				tsr.ou_num,  
--				tsr.contact_row_id__c, 
--				tsr.account_row_id__c, 
--				tsr.protocol__c, 
--			--	oppty_name, 
--				tsr.campaign_tag__c, 
--				tsr.legacycreateddate__c,
--				tsr.close_date__c,
--				tsr.content_tag__c, 
--				tsr.description, 
--				tsr.form__c, 
--				tsr.voctype__c, 
--				tsr.voc_class, 
--				tsr.voc_level_2__c, 
--				tsr.voc_level_3__c, 
--				tset.reason__c, 
--				tsr.medium_tag__c, 
--				case when tsr.voctype__c='Test drive' then 'Test Drive' when tsr.voctype__c='Request a quote' then 'Quotation' when tsr.voctype__c='Dealer' then 'Showroom' when tsr.voctype__c='Hyundai Bank' then 'Hyundai Bank' when tsr.voctype__c='VOC' then 'VOC' else 'Information (Promotion)' end as type , 
--				tsr.origin, 
--				tsr.predictive_temp__c, 
--				tsr.reason__c, 
--				tsr.source_tag__c, 
--				case when tsr.status ='Closed' then 'Closed Lost' else 'Distributed' end as status
--			from temp_service_request tsr
--			join
--				temp_service_event_act tset
--			on
--				tsr.row_id = tset.sra_sr_id
--			;
			
		
		
	INSERT INTO process.opportunity(
			row_id, 
			dealercode__c, 
			contact_row_id__c, 
			dealeraccount__c, 
			protocol__c, 
--			oppty_name, 
			campaign_tag__c, 
			close_date__c, 
			completedate__c,
			content_tag__c, 
			description, 
			form__c, 
			voctype__c, 
			voc_class, 
			voc_level_2__c, 
			voc_level_3__c, 
			lostreason__c, 
			medium_tag__c, 
			type, 
			origin, 
			predictive_temp__c, 
			reason__c, 
			source_tag__c, 
			status
		)
		select
			sr.row_id, 
			soe.ou_num,  
			sr.contact_row_id__c, 
			sr.account_row_id__c, 
			sr.protocol__c, 
			--	oppty_name, 
			sr.campaign_tag__c, 
			sr.legacycreateddate__c,
			sr.close_date__c,
			sr.content_tag__c, 
			sr.description, 
			sr.form__c, 
			sr.voctype__c, 
			sr.voc_class, 
			sr.voc_level_2__c, 
			sr.voc_level_3__c, 
			tset.reason__c, 
			sr.medium_tag__c, 
			case when sr.voctype__c='Test drive' then 'Test Drive' when sr.voctype__c='Request a quote' then 'Quotation' when sr.voctype__c='Dealer' then 'Showroom' when sr.voctype__c='Hyundai Bank' then 'Hyundai Bank' when sr.voctype__c='VOC' then 'VOC' else 'Information (Promotion)' end as type , 
			sr.origin, 
			sr.predictive_temp__c, 
			sr.reason__c, 
			sr.source_tag__c, 
			case when sr.status ='Closed' then 'Closed Lost' else 'Distributed' end as status
		FROM process.service_request sr
		left join
			landing.s_org_ext soe
		on
			sr.account_row_id__c = soe.row_id    
		where 
			sr.legacycreateddate__c between '2021-01-01' and '2023-10-24'
			and ((upper(sr.reason__c) = upper('Information') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Test Drive'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Request a quote'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Promotion'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Hyundai Bank'))
				or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Visitor') and upper(sr.voc_class)=upper('Dealer') and upper(sr.origin)=upper('Showroom'))
				or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason Not_to_Buy'))
				or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason to Buy'))	
				)
				; 
		
		
		
		
		
		
		
		
		
		
		
		
		
			
			
--			select 
--				sr.row_id, 
--				tsea.dealer_code,  
--				sr.contact_row_id__c, 
--				sr.account_row_id__c, 
--				sr.protocol__c, 
----				oppty_name, 
--				sr.campaign_tag__c, 
--				sr.legacycreateddate__c +90,
--				sr.close_date__c,
--				sr.content_tag__c, 
--				sr.description, 
--				sr.form__c, 
--				sr.voctype__c, 
--				sr.voc_class, 
--				sr.voc_level_2__c, 
--				sr.voc_level_3__c, 
--				tsea.reason__c, 
--				sr.medium_tag__c, 
--				tsea.type, 
--				sr.origin, 
----				sea.predictive_temp__c, 
--				sr.reason__c, 
--				sr.source_tag__c, 
--				case when sr.status ='Closed' then 'Closed Lost' else 'Distributed' end as status
--			from process.service_request sr 
--			left join
--				(
--					select sea.sra_sr_id
--						, max(case when sea."type" in ('Request a quote', 'Test drive - add', 'Test drive - update' ) then sea."type" else '' end) as "type"
--						, max(reason__c) as reason__c
--						, max(soe.ou_num) as dealer_code
--					from process.service_event_act sea 
--					left join landing.s_org_ext soe
--					on
--						sea.dealer_account_id = soe.par_row_id
--					where 
--						sea."type" in ('Request a quote', 'Test drive - add', 'Test drive - update' )
--					and sea.created  between '2022-01-01' and '2023-10-24'
--					group by sea.sra_sr_id
--				) tsea
--			on
--				sr.row_id  =  tsea.sra_sr_id 
--			where 
--				sr.legacycreateddate__c between '2022-01-01' and '2023-10-24'
----				and sea.created  between '2022-01-01' and '2023-10-24') 
--				and ((upper(sr.reason__c) = upper('Information') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Test Drive'))
--					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Request a quote'))
--					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Promotion'))
--					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Hyundai Bank'))
--					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Visitor') and upper(sr.voc_class)=upper('Dealer') and upper(sr.origin)=upper('Showroom'))
--					or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason Not_to_Buy'))
--					or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason to Buy'))	
--					)
--					;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_person_acc();

CREATE OR REPLACE PROCEDURE process.proc_person_acc()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		with account as(
		    select 
				sc.ROW_ID, 
				sc.PAR_ROW_ID,  
				sap.ADDR, 
				sap.ADDR_LINE_2, 
				sap.ADDR_LINE_3, 
				sap.COUNTY, 
				sap.CITY, 
				sap.STATE, 
				sap.ZIPCODE, 
				sap.LATITUDE, 
				sap.LONGITUDE, 
				sc.con_cd, 
				sc.FST_NAME, 
				sc.LAST_NAME, 
				sc.EMAIL_ADDR, 
				sc.HOME_PH_NUM, 
				sc.WORK_PH_NUM, 
				sc.CELL_PH_NUM, 
				CASE when sc.SEX_MF='M' then 'Male' when sc.SEX_MF='F' then 'Female' else 'Uninformed' end as SEX_MF,
				sc.X_PNE_FLG, 
				scx.ATTRIB_36, 
				scx.ATTRIB_49, 
				scx.X_LITERACY, 
				scx.X_CALLED_BY, 
				CASE when scx.X_EMPLOYEE_FLG='Y' then true when scx.X_EMPLOYEE_FLG='N' then false else null end as X_EMPLOYEE_FLG,
				scx.X_FAVORITE_DEALER, 
				scx.x_loyalty_crm_index, 
				scx.x_loyalty_engagement, 
				CASE when scx.x_loyalty_optin_flg='Y' then true when scx.x_loyalty_optin_flg='N' then false else null end as x_loyalty_optin_flg,
				scx.x_loyalty_satisfaction, 
				scx.X_CNH_EXP_DATE, 
				scx.X_LOYALTY_ACT_DT, 
				scx.X_LOYALTY_STATUS, 
				sc.X_CPF, 
				CASE when sc.X_OPTIN_PRODUCT_FLG='Y' then true when sc.X_OPTIN_PRODUCT_FLG='N' then false else null end as X_OPTIN_PRODUCT_FLG,
				CASE when sc.X_OPTIN_RETAIL_FLG='Y' then true when sc.X_OPTIN_RETAIL_FLG='N' then false else null end as X_OPTIN_RETAIL_FLG,
				CASE when sc.X_OPTIN_OFFER_FLG='Y' then true when sc.X_OPTIN_OFFER_FLG='N' then false else null end as X_OPTIN_OFFER_FLG,
				CASE when sc.X_OPTIN_NEWS_FLG='Y' then true when sc.X_OPTIN_NEWS_FLG='N' then false else null end as X_OPTIN_NEWS_FLG,
				CASE when sc.X_OPTIN_EVENTS_FLG='Y' then true when sc.X_OPTIN_EVENTS_FLG='N' then false else null end as X_OPTIN_EVENTS_FLG,
				CASE when sc.X_OPTIN_RESEARCH_FLG='Y' then true when sc.X_OPTIN_RESEARCH_FLG='N' then false else null end as X_OPTIN_RESEARCH_FLG,
				CASE when sc.X_OPTIN_PHONE='Y' then true when sc.X_OPTIN_PHONE='N' then false else null end as X_OPTIN_PHONE,
				CASE when sc.X_SUP_GONE_AWAY='Y' then true when sc.X_SUP_GONE_AWAY='N' then false else null end as X_SUP_GONE_AWAY,
				sc.PREF_COMM_METH_CD, 
				sc.MARITAL_STAT_CD, 
				CASE when sc.SUPPRESS_CALL_FLG='Y' then true when sc.SUPPRESS_CALL_FLG='N' then false else null end as SUPPRESS_CALL_FLG,
				CASE when sc.SUPPRESS_MAIL_FLG='Y' then true when sc.SUPPRESS_MAIL_FLG='N' then false else null end as SUPPRESS_MAIL_FLG,
				CASE when sc.SUPPRESS_EMAIL_FLG='Y' then true when sc.SUPPRESS_EMAIL_FLG='N' then false else null end as SUPPRESS_EMAIL_FLG, 
				CASE when sc.X_PRINTED_CARD='Y' then true when sc.X_PRINTED_CARD='N' then false else null end as X_PRINTED_CARD,  
				scf.DEPT_TYPE_CD, 
				scf.X_EMP_AREA,
				scx.X_LOYALTY_EXP_DT,
				scx.X_LOYALTY_ENGAGEMENT,
				scx.X_SEG_LIFE_CYCLE,
				sc.PER_TITLE,
				sc.BIRTH_DT,
				scx.attrib_50,
				scx.ATTRIB_45,
				scx.X_SEG_VALUE,
				CASE when sc.X_SANITIZED_FLG='Y' then true when sc.X_SANITIZED_FLG='N' then false else null end as X_SANITIZED_FLG,			
				scx.ATTRIB_34,
				sc.created,
				sc.created_by,
				sc.last_upd,
				sc.last_upd_by 
		    from landing.s_contact sc
		    left join
		        landing.s_contact_x scx
		    on
		        sc.row_id = scx.par_row_id	         	                     
		    left join
		        landing.s_addr_per sap
		    on
		        sc.pr_per_addr_id  = sap.row_id  	  
		    left join
		        landing.s_contact_fnx scf 
		    on
		        sc.row_id  = scf.par_row_id
		    where sc.con_cd not in ('Dealer') or sc.con_cd isnull
		), personaccount as(
			INSERT INTO process.account(
				row_id, 
				s_con_par_row_id, 
				billingstreet, 
				billingstreet_2__c, 
				billingstreet_3__c, 
				neighborhood, 
				billingcountry, 
				billingstate, 
				billingpostalcode, 
				billinglatitude, 
				billinglongitude, 
				type, 
				firstname, 
				lastname, 
				personemail, 
				personhomephone, 
				companyphone__pc, 
				personmobilephone, 				
				gender__pc, 
				pcd__c, 
				income__c, 
				productofinterest__c, 
				literacy__c, 
				calledby__c, 
				employee__c, 
				favoritedealer__c, 
				crmindex__c, 
				engagement__c, 
				optinflag__c, 
				satificationlevel__c, 
				loyaltyexpirationdate__c, 
				loyaltyactivationdate__c, 
				loyaltystatus__c, 
				cpf__c, 
				receiveproductnewsflag__c, 
				receiveretailoffersflag__c, 
				receiveserviceoffersflag__c, 
				receivenewsletterflag__c, 
				receiveeventsflag__c, 
				receiveresearchflag__c, 
				blockedmobile__c, 
				x_printed_card__c, 
				preferredcontactchannel__c, 
				maritalstatus__pc, 
				calloptyn__pc, 
				directmailoptyn__pc, 
				emailoptyn__pc, 
				blockedwhatsapp__c, 
				department, 
				x_emp_area__c,
				loyaltyexpirationtodate__c,
				loyaltyengagementindex__c,
				loyaltylifecycle__c,	
				salutation,
				personbirthdate,
				influentialperson__c,
				registrysource__c,
				loyaltyvalue__c,
				sanitized__c,
				occupation__pc, 
				legacy_created,
				legacy_created_by,
				legacy_last_upd,
				legacy_last_upd_by,
				process_account_type
			)
			select 
				a.ROW_ID, 
				a.PAR_ROW_ID, 
				a.ADDR, 
				a.ADDR_LINE_2, 
				a.ADDR_LINE_3, 
				a.COUNTY, 
				a.CITY, 
				a.STATE, 
				a.ZIPCODE, 
				a.LATITUDE, 
				a.LONGITUDE, 
				concat('c_', a.con_cd), 
				a.FST_NAME, 
				a.LAST_NAME, 
				a.EMAIL_ADDR, 
				a.HOME_PH_NUM, 
				a.WORK_PH_NUM, 
				a.CELL_PH_NUM, 
				a.SEX_MF, 
				a.X_PNE_FLG, 
				a.ATTRIB_36, 
				a.ATTRIB_49, 
				a.X_LITERACY, 
				a.X_CALLED_BY, 
				a.X_EMPLOYEE_FLG, 
				a.X_FAVORITE_DEALER, 
				a.x_loyalty_crm_index, 
				a.x_loyalty_engagement, 
				a.x_loyalty_optin_flg, 
				a.x_loyalty_satisfaction, 
				a.X_CNH_EXP_DATE, 
				a.X_LOYALTY_ACT_DT, 
				a.X_LOYALTY_STATUS, 
				a.X_CPF, 
				a.X_OPTIN_PRODUCT_FLG, 
				a.X_OPTIN_RETAIL_FLG, 
				a.X_OPTIN_OFFER_FLG, 
				a.X_OPTIN_NEWS_FLG, 
				a.X_OPTIN_EVENTS_FLG, 
				a.X_OPTIN_RESEARCH_FLG, 
				a.X_OPTIN_PHONE, 
				a.X_SUP_GONE_AWAY, 
				a.PREF_COMM_METH_CD, 
				a.MARITAL_STAT_CD, 
				a.SUPPRESS_CALL_FLG, 
				a.SUPPRESS_MAIL_FLG, 
				a.SUPPRESS_EMAIL_FLG, 
				a.X_PRINTED_CARD, 
				a.DEPT_TYPE_CD, 
				a.X_EMP_AREA,
				a.X_LOYALTY_EXP_DT,
				a.X_LOYALTY_ENGAGEMENT,
				a.X_SEG_LIFE_CYCLE,
				a.PER_TITLE,
				a.BIRTH_DT,
				a.attrib_50,
				a.ATTRIB_45,
				a.X_SEG_VALUE,
				a.X_SANITIZED_FLG,							
				a.ATTRIB_34, 
				a.created,
				a.created_by,
				a.last_upd,
				a.last_upd_by,
				'Person'
			from account a
			returning row_id
		)
		INSERT INTO process.contact(
			row_id,  
			account_row_id, 
			mailingstreet, 
			mailingcountry, 
			mailingstate, 
			mailingpostalcode, 
			mailinglatitude, 
			mailinglongitude,
			con_cd__c, 
			firstname, 
			lastname, 
			email, 
			homephone, 
			companyphone__c, 
			mobilephone, 
			title, 
			gender__c,
			cpf__c, 
			receiveproductnewsflag__c, 
			receiveretailoffersflag__c, 
			receiveserviceoffersflag__c, 
			receivenewsletterflag__c, 
			receiveeventsflag__c, 
			receiveresearchflag__c, 
			blockedmobile__c, 
			x_printed_card__c, 
			preferredcontactchannel__c, 
			maritalstatus__c, 
			calloptyn__c, 
			directmailoptyn__c, 
			emailoptyn__c, 
			blockedwhatsapp__c, 
			department, 
			x_emp_area__c
		)
		select  
			a.ROW_ID, 
			pa.ROW_ID,			
			a.ADDR, 
			a.CITY, 
			a.STATE, 
			a.ZIPCODE, 
			a.LATITUDE, 
			a.LONGITUDE, 
			a.con_cd, 
			a.FST_NAME, 
			a.LAST_NAME, 
			a.EMAIL_ADDR, 
			a.HOME_PH_NUM, 
			a.WORK_PH_NUM, 
			a.CELL_PH_NUM, 
			a.JOB_TITLE, 
			a.SEX_MF, 
			a.X_CPF, 
			a.X_OPTIN_PRODUCT_FLG, 
			a.X_OPTIN_RETAIL_FLG, 
			a.X_OPTIN_OFFER_FLG, 
			a.X_OPTIN_NEWS_FLG, 
			a.X_OPTIN_EVENTS_FLG, 
			a.X_OPTIN_RESEARCH_FLG, 
			a.X_OPTIN_PHONE, 
			a.X_SUP_GONE_AWAY, 
			a.PREF_COMM_METH_CD, 
			a.MARITAL_STAT_CD, 
			a.SUPPRESS_CALL_FLG, 
			a.SUPPRESS_MAIL_FLG, 
			a.SUPPRESS_EMAIL_FLG, 
			a.X_PRINTED_CARD, 
			a.DEPT_TYPE_CD, 
			a.X_EMP_AREA
		from account a, personaccount pa
	   where a.row_id = pa.row_id
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_product();

CREATE OR REPLACE PROCEDURE process.proc_product()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.product(
			row_id,
			--external_id__c, 
			name, 
			source_system__c, 
			product_type__c, 
			part__c, 
			description, 
			model_year__c, 
			body_style__c, 
			engine__c, 
			suggested_price__c, 
			advanced_desc__c, 
			chassi_model__c, 
			sap_cylinder_capacity__c, 
			engine_desc__c, 
			version_desc__c, 
			transmission_desc__c, 
			transmission__c, 
			fuel__c, 
			doors_amount__c
		)
		select 
			spi.row_id, 
			spi.name, 
			spi.data_src, 
			spi.type, 
			spi.part_num, 
			spi.desc_text, 
			spi.model_yr, 
			spi.body_style_cd, 
			spi.engine_type_cd, 
			cast(spi.loy_sug_price as float8) as loy_sug_price, 
			spix.x_attrib_61, 
			spix.attrib_34, 
			spix.attrib_03,
			case when spix.attrib_36 isnull then null else concat(spix.attrib_36, ' cc') end as attrib_36,
			spix.attrib_37, 
			spix.attrib_38, 
			spix.attrib_05, 
			spix.attrib_06, 
			cast(spix.attrib_14 as varchar(30)) as attrib_14
		from landing.s_prod_int spi 
		left join 
			landing.s_prod_int_x spix 
		on
			spi.row_id = spix.par_row_id
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_quote_his();

CREATE OR REPLACE PROCEDURE process.proc_quote_his()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.quotehistory (
			row_id, 
			protocol__c, 
			dealercode__c, 
			dealer_account_row_id__c,
			account_row_id__c, 			 
			contact_row_id__c, 
			reason__c, 
			voctype__c, 
			voc_class, 
			voc_level_2__c, 
			voc_level_3__c, 
			origin, 
			method, 
			description, 
			status, 
			priority, 
			relatedmodel__c, 
			quote_description__c, 
			quotetransmission__c, 
			version__c, 
			quote_version_price__c, 
			quote_color__c, 
			quote_color_price__c, 
			quote_price__c, 
			quote_replace_intention__c, 
			integrationid__c, 
			source_tag__c, 
			medium_tag__c, 
			content_tag__c, 
			campaign_tag__c, 
			wants_loan__c, 
			loan_type__c, 
			usedcar_as_down_payment__c, 
			payment_method__c, 
			payment_status__c, 
			payment_date__c, 
			reserve_amount__c, 
			form__c, 
			usedcar_brand__c, 
			usedcar_model__c, 
			usedcar_chassi__c, 
			usedcar_version__c, 
			usedcar_plate__c, 
			usedcar_year__c, 
			usedcar_color__c, 
			usedcar_km__c, 
			usedcar_max_price__c, 
			usedcar_mid_price__c, 
			usedcar_min_price__c, 
			pne_flag__c,
			legacy_created_by, 
			legacycreateddate__c, 
			legacy_last_update__c, 
			legacy_last_upd_by
		)
		select 
			sea.row_id, 
			sr.protocol__c, 
			soe.ou_num, 
			sr.account_row_id__c, 
			sr.contact_row_id__c, 
			sr.contact_row_id__c, 
			sr.reason__c, 
			sr.voctype__c, 
			sr.voc_class, 
			sr.voc_level_2__c, 
			sr.voc_level_3__c, 
			sr.origin, 
			sr.method, 
			sr.description, 
			sr.status, 
			sr.priority, 
			sr.relatedmodel__c, 
			sr.quote_description__c, 
			sr.quotetransmission__c, 
			sr.version__c, 
			sr.quote_version_price__c, 
			sr.quote_color__c, 
			sr.quote_color_price__c, 
			sr.quote_price__c, 
			sr.quote_replace_intention__c, 
			sr.integrationid__c, 
			sr.source_tag__c, 
			sr.medium_tag__c, 
			sr.content_tag__c, 
			sr.campaign_tag__c, 
			sr.wants_loan__c, 
			sr.loan_type__c, 
			sr.usedcar_as_down_payment__c, 
			sr.payment_method__c, 
			sr.payment_status__c, 
			sr.payment_date__c, 
			sr.reserve_amount__c, 
			sr.form__c, 
			sr.usedcar_brand__c, 
			sr.usedcar_model__c, 
			sr.usedcar_chassi__c, 
			sr.usedcar_version__c, 
			sr.usedcar_plate__c, 
			sr.usedcar_year__c, 
			sr.usedcar_color__c, 
			sr.usedcar_km__c, 
			sr.usedcar_max_price__c, 
			sr.usedcar_mid_price__c, 
			sr.usedcar_min_price__c, 
			sr.pne_flag__c,
			sr.legacy_created_by, 
			sr.legacycreateddate__c, 
			sr.legacy_last_update__c, 
			sr.legacy_last_upd_by
		from process.service_event_act sea 
		left join
			process.service_request sr 
		on
			sea.sra_sr_id = sr.row_id 
		left join
			landing.s_org_ext soe
		on
			sr.account_row_id__c = soe.row_id 
		where sea."type"  ='Request a quote'
		;

	END;
$procedure$
;

-- DROP PROCEDURE process.proc_rsa();

CREATE OR REPLACE PROCEDURE process.proc_rsa()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.road_side_assistant
			(
				row_id, 
				case_id,
				account_id,
				created, 
				created_by, 
				last_upd, 
				last_upd_by, 
				modification_num, 
				integration_id, 
				req_first_name, 
				req_last_name, 
				req_document, 
				req_vehicle_rel, 
				claim_date, 
				claim_reason, 
				db_last_upd, 
				db_last_upd_src, 
				brkdwn_desc, 
				brkdwn_cd, 
				brkdwn_nature, 
				status_cd, 
				eff_start_date, 
				eff_end_date, 
				exchange_date, 
				mileage
			)
			select 
				csrx.ROW_ID, 
				csrx.ROW_ID,
				ac.row_id,
				csrx.created, 
				csrx.created_by, 
				csrx.last_upd, 
				csrx.last_upd_by, 
				csrx.modification_num, 
				csrx.INTEGRATION_ID, 
				csrx.REQ_FIRST_NAME, 
				csrx.REQ_LAST_NAME, 
				csrx.REQ_DOCUMENT, 
				csrx.REQ_VEHICLE_REL, 
				csrx.CLAIM_DATE, 
				csrx.CLAIM_REASON, 
				csrx.db_last_upd, 
				csrx.db_last_upd_src, 
				csrx.BRKDWN_DESC, 
				csrx.BRKDWN_CD, 
				csrx.BRKDWN_NATURE, 
				csrx.STATUS_CD, 
				csrx.EFF_START_DATE, 
				csrx.EFF_END_DATE, 
				csrx.EXCHANGE_DATE, 
				csrx.MILEAGE
			from landing.cx_sr_rsa_x csrx 
			left join 
				process.account_cleansing ac  
			on 
				csrx.req_document  = ac.cpf__c or csrx.req_document = ac.corporateregistrationnumber__c;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_rsa_service();

CREATE OR REPLACE PROCEDURE process.proc_rsa_service()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.road_side_assistant_service(
				row_id,
				rsa_row_id, 
				created, 
				created_by, 
				last_upd, 
				last_upd_by, 
				db_last_upd, 
				db_last_upd_src, 
				"name", 
				provider__c, 
				addresscomplement__c, 
				addressnumber__c, 
				zipcode__c, 
				expense__c, 
				tmcpredicted__c, 
				latitude__c, 
				longitude__c, 
				createdate__c, 
				servicecode__c, 
				specialty__c, 
				vehicleproblem__c, 
				requeststatus__c, 
				actuationstatus__c, 
				state__c, 
				county__c, 
				city__c, 
				dealername__c, 
				addressname__c, 
				reference__c, 
				dealernickname__c, 
				problemdescription__c, 
				important__c
			)
			select 
				ssrx.row_id,
				rsa.row_id, 
				ssrx.created, 
				ssrx.created_by, 
				ssrx.last_upd, 
				ssrx.last_upd_by, 
				ssrx.db_last_upd, 
				ssrx.db_last_upd_src, 
				ssrx."name", 
				ssrx.attrib_01, 
				ssrx.attrib_02, 
				ssrx.attrib_05, 
				ssrx.attrib_06, 
				ssrx.attrib_07, 
				ssrx.attrib_14, 
				ssrx.attrib_15, 
				ssrx.attrib_16, 
				ssrx.attrib_26, 
				ssrx.attrib_35, 
				ssrx.attrib_36, 
				ssrx.attrib_37, 
				ssrx.attrib_38, 
				ssrx.attrib_39, 
				ssrx.attrib_40, 
				ssrx.attrib_44, 
				ssrx.attrib_45, 
				ssrx.attrib_46, 
				ssrx.attrib_47, 
				ssrx.x_attrib_48, 
				ssrx.x_attrib_49, 
				ssrx.x_attrib_50, 
				ssrx.x_attrib_51
			from 
				landing.s_srv_req_xm ssrx  
			join 
				process.road_side_assistant rsa  
			on
				rsa.row_id  = ssrx.par_row_id
				and ssrx."type" ='RSA'
				;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_audit_item();

CREATE OR REPLACE PROCEDURE process.proc_s_audit_item()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.s_audit_item(
			item_iden_num,
			row_id,
			created ,
			created_by ,
			last_upd ,
			last_upd_by ,
			modification_num ,
			conflict_id ,
			buscomp_name ,
			operation_cd ,
			record_id ,
			user_id ,
			audit_log ,
			db_last_upd ,
			operation_dt ,
			sync_dt ,
			audit_source_cd ,
			bc_base_tbl ,
			child_bc_base_tbl,
			child_bc_name,
			child_record_id ,
			db_last_upd_src ,
			field_name ,
			group_num ,
			link_name ,
			new_val ,
			node_name,
			old_val ,
			src_dest_id ,
			tbl_name ,
			tbl_record_id
        )
        select 
	        item_iden_num,
			row_id,
			created ,
			created_by ,
			last_upd ,
			last_upd_by ,
			modification_num ,
			conflict_id ,
			buscomp_name ,
			operation_cd ,
			record_id ,
			user_id ,
			audit_log ,
			db_last_upd ,
			operation_dt ,
			sync_dt ,
			audit_source_cd ,
			bc_base_tbl ,
			child_bc_base_tbl,
			child_bc_name,
			child_record_id ,
			db_last_upd_src ,
			field_name ,
			group_num ,
			link_name ,
			new_val ,
			node_name,
			old_val ,
			src_dest_id ,
			tbl_name ,
			tbl_record_id
        from landing.s_audit_item ;

	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_camp_con();

CREATE OR REPLACE PROCEDURE process.proc_s_camp_con()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.s_camp_con(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			dcking_num,
			modification_num,
			conflict_id,
			asgn_usr_excld_flg,
			bu_id,
			ctrl_grp_flg,
			load_num,
			mark_for_del_flg,
			pr_rep_dnrm_flg,
			pr_rep_manl_flg,
			pr_rep_sys_flg,
			src_id,
			target_num,
			con_fst_name,
			con_last_name,
			actl_revn,
			actl_revn_dt,
			asgn_dt,
			batch_num,
			call_completed,
			camp_con_score,
			completed_dt,
			contacted_dt,
			db_last_upd,
			ext_score,
			msg_open_ts,
			num_dial_attempts,
			tgtrev_exch_dt,
			tgt_revn,
			actl_revn_curcy_cd,
			camp_con_num,
			camp_ld_wave_id,
			camp_wave_id,
			"comments",
			con_mid_name,
			con_per_id,
			con_pr_dept_ou_id,
			db_last_upd_src,
			dcp_id,
			dd_user_key_id,
			fn_accnt_id,
			insert_cd,
			key_01,
			key_02,
			key_03,
			key_04,
			key_05,
			key_06,
			key_07,
			lst_distr_id,
			msg_bncd_reason_cd,
			msg_bncd_stat_cd,
			msg_dlvry_stat_cd,
			opty_id,
			orggrp_id,
			outcome_cd,
			owner_per_id,
			pgroup_id,
			postn_id,
			prsp_con_per_id,
			pr_call_lst_id,
			pr_comm_id,
			referredby_prsp_id,
			referred_by_con_id,
			segment_code_1,
			segment_code_2,
			src_evt_reg_id,
			stat_cd,
			tgtrev_curcy_cd,
			x_addr1,
			x_addr2,
			x_addr3,
			x_callback_dt,
			x_camp_join_flg,
			x_cell_phone,
			x_dedup_cd,
			x_dedup_flg,
			x_dp_int_dt,
			x_dp_int_flg,
			x_ea,
			x_goneaway_flg,
			x_hkme_sales_conid,
			x_home_phone,
			x_household_id,
			x_origin,
			x_send_tdr_email_dt,
			x_send_tdr_email_flg,
			x_sms_count,
			x_suppression_cd,
			x_suppression_flg,
			x_vin,
			x_web_ems_field,
			x_sms_fail_reason
	    )
	    select 
	        row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			dcking_num,
			modification_num,
			conflict_id,
			asgn_usr_excld_flg,
			bu_id,
			ctrl_grp_flg,
			load_num,
			mark_for_del_flg,
			pr_rep_dnrm_flg,
			pr_rep_manl_flg,
			pr_rep_sys_flg,
			src_id,
			target_num,
			con_fst_name,
			con_last_name,
			actl_revn,
			actl_revn_dt,
			asgn_dt,
			batch_num,
			call_completed,
			camp_con_score,
			completed_dt,
			contacted_dt,
			db_last_upd,
			ext_score,
			msg_open_ts,
			num_dial_attempts,
			tgtrev_exch_dt,
			tgt_revn,
			actl_revn_curcy_cd,
			camp_con_num,
			camp_ld_wave_id,
			camp_wave_id,
			"comments",
			con_mid_name,
			con_per_id,
			con_pr_dept_ou_id,
			db_last_upd_src,
			dcp_id,
			dd_user_key_id,
			fn_accnt_id,
			insert_cd,
			key_01,
			key_02,
			key_03,
			key_04,
			key_05,
			key_06,
			key_07,
			lst_distr_id,
			msg_bncd_reason_cd,
			msg_bncd_stat_cd,
			msg_dlvry_stat_cd,
			opty_id,
			orggrp_id,
			outcome_cd,
			owner_per_id,
			pgroup_id,
			postn_id,
			prsp_con_per_id,
			pr_call_lst_id,
			pr_comm_id,
			referredby_prsp_id,
			referred_by_con_id,
			segment_code_1,
			segment_code_2,
			src_evt_reg_id,
			stat_cd,
			tgtrev_curcy_cd,
			x_addr1,
			x_addr2,
			x_addr3,
			x_callback_dt,
			x_camp_join_flg,
			x_cell_phone,
			x_dedup_cd,
			x_dedup_flg,
			x_dp_int_dt,
			x_dp_int_flg,
			x_ea,
			x_goneaway_flg,
			x_hkme_sales_conid,
			x_home_phone,
			x_household_id,
			x_origin,
			x_send_tdr_email_dt,
			x_send_tdr_email_flg,
			x_sms_count,
			x_suppression_cd,
			x_suppression_flg,
			x_vin,
			x_web_ems_field,
			x_sms_fail_reason
	    from landing.s_camp_con 
--2012
	    where created >='2012-01-01' and created <'2013-01-01'; 
		
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_camp_ld_wave();

CREATE OR REPLACE PROCEDURE process.proc_s_camp_ld_wave()
 LANGUAGE plpgsql
AS $procedure$
	begin
		insert into process.s_camp_ld_wave(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			camp_id,
			load_num,
			wave_num,
			alloc_pct,
			db_last_upd,
			dt_lag,
			exported_ts,
			launched_ts,
			loaded_ts,
			num_loaded_cons,
			scheduled_ts,
			db_last_upd_src,
			dt_lag_units_cd,
			exec_status_cd,
			exec_stat_desc,
			pr_dcp_id,
			wave_setting_num,
			x_ds_cons,
			x_ds_flag
		)
		select
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			camp_id,
			load_num,
			wave_num,
			alloc_pct,
			db_last_upd,
			dt_lag,
			exported_ts,
			launched_ts,
			loaded_ts,
			num_loaded_cons,
			scheduled_ts,
			db_last_upd_src,
			dt_lag_units_cd,
			exec_status_cd,
			exec_stat_desc,
			pr_dcp_id,
			wave_setting_num,
			x_ds_cons,
			x_ds_flag
		from landing.s_camp_ld_wave
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_comm_dtl();

CREATE OR REPLACE PROCEDURE process.proc_s_comm_dtl()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.s_comm_dtl(
			row_id ,
			created ,
			created_by ,
			last_upd  ,
			last_upd_by ,
			modification_num ,
			conflict_id ,
			par_row_id ,
			db_last_upd ,
			banner_ad_strng ,
			client_ip_addr ,
			current_url ,
			db_last_upd_src ,
			hyperlink_name ,
			keyword_strng ,
			mkt_srvy_lang_id ,
			referrer_url ,
			referrer_username ,
			response_url ,
			rply_dlvry_mthd_cd ,
			rply_email_addr ,
			rply_fax_ph_num ,
			rply_mail_addr ,
			rply_mail_city ,
			rply_mail_country ,
			rply_mail_county ,
			rply_mail_province ,
			rply_mail_state ,
			rply_mail_zipcode ,
			rply_ph_num ,
			rply_priority_cd ,
			rply_time_cd ,
			subscr_drct_ml_cd ,
			subscr_email_cd ,
			subscr_fax_cd ,
			subscr_phone_cd
			)
		select 
			row_id ,
			created ,
			created_by ,
			last_upd  ,
			last_upd_by ,
			modification_num ,
			conflict_id ,
			par_row_id ,
			db_last_upd ,
			banner_ad_strng ,
			client_ip_addr ,
			current_url ,
			db_last_upd_src ,
			hyperlink_name ,
			keyword_strng ,
			mkt_srvy_lang_id ,
			referrer_url ,
			referrer_username ,
			response_url ,
			rply_dlvry_mthd_cd ,
			rply_email_addr ,
			rply_fax_ph_num ,
			rply_mail_addr ,
			rply_mail_city ,
			rply_mail_country ,
			rply_mail_county ,
			rply_mail_province ,
			rply_mail_state ,
			rply_mail_zipcode ,
			rply_ph_num ,
			rply_priority_cd ,
			rply_time_cd ,
			subscr_drct_ml_cd ,
			subscr_email_cd ,
			subscr_fax_cd ,
			subscr_phone_cd
		from landing.s_comm_dtl ;

	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_contact_loyx();

CREATE OR REPLACE PROCEDURE process.proc_s_contact_loyx()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN

		INSERT INTO process.s_contact_loyx(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			par_row_id,
			smoke_flg,
			suppress_sms_flg,
			db_last_upd,
			expiration_dt,
			issue_dt,
			passport_expr_dt,
			passport_issue_dt,
			"comments",
			country,
			db_last_upd_src,
			drvr_lic_number,
			drvr_lic_state_cd,
			emgc_cell_ph_num,
			emgc_email_addr,
			emgc_per_id,
			emgc_ph_num,
			home_airport,
			issue_site,
			passport_num,
			pref1_air_id,
			pref1_hotel_id,
			pref1_rental_id,
			pref2_air_id,
			pref2_hotel_id,
			pref2_rental_id,
			pref_bed_cd,
			pref_car_cd,
			pref_cruise_ln_cd,
			pref_hotl_brand_cd,
			pref_hotl_chain_cd,
			pref_loc_cd,
			pref_meal_cd,
			pref_paper_cd,
			pref_seat_cd,
			pref_smokeing_cd,
			prev_fst_name,
			prev_lst_name,
			prev_mi_name,
			pr_fax_num_id,
			pr_loy_member_id,
			pr_sms_num_id,
			referred_by_id,
			spec_air_req_text,
			spec_hotel_req_txt,
			spec_med_req_text,
			spec_rentl_req_txt
		)
		select 
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			modification_num,
			conflict_id,
			par_row_id,
			smoke_flg,
			suppress_sms_flg,
			db_last_upd,
			expiration_dt,
			issue_dt,
			passport_expr_dt,
			passport_issue_dt,
			"comments",
			country,
			db_last_upd_src,
			drvr_lic_number,
			drvr_lic_state_cd,
			emgc_cell_ph_num,
			emgc_email_addr,
			emgc_per_id,
			emgc_ph_num,
			home_airport,
			issue_site,
			passport_num,
			pref1_air_id,
			pref1_hotel_id,
			pref1_rental_id,
			pref2_air_id,
			pref2_hotel_id,
			pref2_rental_id,
			pref_bed_cd,
			pref_car_cd,
			pref_cruise_ln_cd,
			pref_hotl_brand_cd,
			pref_hotl_chain_cd,
			pref_loc_cd,
			pref_meal_cd,
			pref_paper_cd,
			pref_seat_cd,
			pref_smokeing_cd,
			prev_fst_name,
			prev_lst_name,
			prev_mi_name,
			pr_fax_num_id,
			pr_loy_member_id,
			pr_sms_num_id,
			referred_by_id,
			spec_air_req_text,
			spec_hotel_req_txt,
			spec_med_req_text,
			spec_rentl_req_txt
		from landing.s_contact_loyx ;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_s_mktg_srvr_tsk();

CREATE OR REPLACE PROCEDURE process.proc_s_mktg_srvr_tsk()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.s_mktg_srvr_tsk(
			row_id,
			created,
			created_by,
			last_upd ,
			last_upd_by,
			modification_num ,
			conflict_id ,
			process_cd ,
			db_last_upd,
			end_ts,
			error_cnt ,
			load_row_cnt ,
			query_row_cnt,
			start_ts,
			camp_id,
			camp_ld_wave_id ,
			con_sync_schd_id,
			db_last_upd_src,
			desc_text ,
			imprt_tsk_id ,
			program_id ,
			srm_request_id ,
			stage_id ,
			status_cd ,
			user_id
		)
		select 
			row_id,
			created,
			created_by,
			last_upd ,
			last_upd_by,
			modification_num ,
			conflict_id ,
			process_cd ,
			db_last_upd,
			end_ts,
			error_cnt ,
			load_row_cnt ,
			query_row_cnt,
			start_ts,
			camp_id,
			camp_ld_wave_id ,
			con_sync_schd_id,
			db_last_upd_src,
			desc_text ,
			imprt_tsk_id ,
			program_id ,
			srm_request_id ,
			stage_id ,
			status_cd ,
			user_id
		from landing.s_mktg_srvr_tsk
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_sales_consult_his();

CREATE OR REPLACE PROCEDURE process.proc_sales_consult_his()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.sales_consult_history(
			account_row_id__c,
			contact_row_id__c,
			row_id,
			description_interaction__c,
			contact_flag__c,
			first_interaction_date__c,
			temperaturenumber__c,
			interactionnumber__c,
			predictivetemp__c,
			createddate,
			created_by,
			last_upd,
			last_upd_by,
			protocol__c,
			result__c,
			integrationid__c,
			statussales__c,
			salespersoncode__c,
			status__c,
			interactionstartdate__c,
			reason__c,
			dmsenddate__c,
			dmsreceivedate__c,
			dealerrespondetime__c,
			pne_flag__c,
			visitscheduled__c,
			visitdate__c,
			visitstatus__c
			)
			select 
				sr.contact_row_id__c,
				sr.contact_row_id__c,
				ceax.row_id,
				ceax.x_attrib_02,
				CASE when ceax.x_attrib_04='Y' then true when ceax.x_attrib_04='N' then false else null end as contact_flag__c,
				ceax.x_attrib_05::timestamp,
				ceax.X_ATTRIB_01,
				ceax.X_ATTRIB_01,
				ceax.X_ATTRIB_03,
				ceax.created,
				ceax.created_by,
				ceax.last_upd,
				ceax.last_upd_by,
				sr.protocol__c,
				sea.result__c,
				sea.integrationid__c,
				sea.statussales__c,
				sea.salespersoncode__c,
				sea.status__c,
				sea.interactionstartdate__c::timestamp,
				sea.reason__c,
				sea.dmsenddate__c::timestamp,
				sea.dmsreceivedate__c::timestamp,
				sea.dealerrespondetime__c,
				sr.pne_flag__c,
				sea.visitscheduled__c::timestamp,
				sea.visitdate__c::timestamp,
				sea.visitstatus__c
			from landing.cx_evt_act_x ceax 
			left join 
				process.service_event_act sea  
			on
				ceax.par_row_id = sea.row_id 
			left join 
				process.service_request sr 
			on
				sea.sra_sr_id  = sr.row_id
			where ceax.created between '2022-01-01' and '2023-10-24'
				and ((upper(sr.reason__c) = upper('Information') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Test Drive'))
					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Sales') and upper(sr.voc_class)=upper('Request a quote'))
					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Promotion'))
					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Hyundai Bank'))
					or (upper(sr.reason__c) =upper('Sales Opportunity') and upper(sr.voctype__c)=upper('Visitor') and upper(sr.voc_class)=upper('Dealer') and upper(sr.origin)=upper('Showroom'))
					or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason Not_to_Buy'))
					or (upper(sr.reason__c) =upper('Information') and upper(sr.voctype__c)=upper('Marketing') and upper(sr.voc_class)=upper('Survey') and upper(sr.voc_level_2__c)=upper('Reason to Buy'))	
					)
				;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_service_event_act();

CREATE OR REPLACE PROCEDURE process.proc_service_event_act()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.service_event_act (
			row_id,
			sra_sr_id,
			asset_id,
			dealer_account_id,
			contact_row_id__c,
			type,
			subject,
			priority,
			planneddt__c,
			ownerid,
			status__c,
			description,
			activitydate,
			completeddatetime,
			result__c,
			answer__c,
			plannedenddt__c,
			dpuser__c,
			statussales__c,
			salespersoncode__c,
			interactionstartdate__c,
			reason__c,
			dmsenddate__c,
			dmsreceivedate__c,
			dealerrespondetime__c,
			visitscheduled__c,
			visitdate__c,
			visitstatus__c,
			integrationid__c,
			hotlineid__c,
			hotlinecreation__c,
			pwaid__c,
			pwacreation__c,
			roid__c,
			rocreation__c,
			mobisid__c,
			mobisstatus__c,
			expecteddelivery__c,
			purchasepurposeid__c,
			created,
			ordernum__c,
			get_lead_date,
			legacy_created_by,
			legacy_last_upd,
			legacy_last_upd_by
			
		)
		select 
			sea.row_id, 
			sea.SRA_SR_ID, 
			sea.asset_id, 
			sea.X_DLR_ID, 
			sea.x_target_per_id, 
--			sea.TARGET_OU_ID, 
			sea.todo_cd, 
			sea.wc_type_cd, 
			sea.evt_priority_cd, 
			sea.todo_plan_start_dt, 
			sea.owner_login, 
			sea.evt_stat_cd, 
			sea.comments_long, 
			sea.todo_due_dt, 
			sea.todo_actl_end_dt, 
			seax.attrib_44, 
			sea.x_for_dealer, 
			sea.todo_plan_end_dt, 
			seax.x_dp_user, 
			seax.attrib_45, 
			seax.attrib_46, 
			seax.attrib_26, 
			seax.attrib_47, 
			seax.attrib_27, 
			seax.attrib_29, 
			seax.attrib_15, 
			seax.attrib_30, 
			seax.attrib_31, 
			seax.attrib_34, 
			sea.ACTIVITY_UID, 
			seax.HOTLINE_ID, 
			seax.HOTLINE_DT, 
			seax.PWA_ID, 
			sea.MDF_ALLOC_ID, 
			seax.RO_ID, 
			seax.RO_DT, 
			seax.MOBIS_ID, 
			seax.MOBIS_STATUS, 
			seax.EXPECTED_DELIVERY, 
			seax.PURCH_PURPOSE_ID, 
			sea.CREATED, 
			sea.ORDER_ID, 
			seax.ATTRIB_28,
			sea.created_by,
			sea.last_upd,
			sea.last_upd_by
		from landing.s_evt_act sea
		left join
		    landing.s_evt_act_x seax
		on
		    sea.row_id = seax.row_id;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_service_request();

CREATE OR REPLACE PROCEDURE process.proc_service_request()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.service_request (
			row_id, 
			account_row_id__c, 
			business_row_id,
			contact_row_id__c, 
			asset_id,
			owner_emp_id,
			legacycreateddate__c, 
			close_date__c, 
			legacy_last_update__c, 
			protocol__c, 
			reason__c, 
			voctype__c, 
			voc_class, 
			voc_level_2__c, 
			voc_level_3__c, 
			origin, 
			method, 
			description, 
			status, 
			status_date__c, 
			priority, 
			solution__c, 
			anonymous_flag__c, 
			tendency__c, 
			customersatisfied__c, 
			causing_area__c, 
			immobilization_date__c, 
			quote_description__c, 
			quotetransmission__c, 
			version__c, 
			quote_version_price__c, 
			quote_color__c, 
			quote_color_price__c,
			quote_price__c,
			quote_replace_intention__c, 
			integrationid__c, 
			testdrive_confirmed__c, 
			testdrive_time__c, 
			date_test_drive__c, 
			pne_flag__c, 
			campaignid__c, 
			source_tag__c, 
			stock__c, 
			medium_tag__c, 
			content_tag__c, 
			campaign_tag__c, 
			form__c, 
			additional_comments__c, 
			causing_person__c, 
			cust_representative__c, 
			cust_representative_rel__c,
			diagnosis_difficultyflg__c, 
			diagnosis_pendingflg__c, 
			dlr_description__c, 
			dlr_fup__c, 
			dlr_pending__c, 
			dlr_retractionflg__c, 
			dlr_reversal__c, 
			hotline_flg__c, 
			hotline_num__c, 
			hotline_open_dt__c , 
			purchase_proposal_num__c, 
			pwa_flg__c, 
			pwa_number__c, 
			pwa_oped_dt__c, 
			recurrence_flg__c, 
			recurrence_num__c, 
			vehicle_delivery_dt__c, 
			vehicle_delivery_flg__c, 
			wants_loan__c, 
			loan_type__c,
			installments_amt__c, 
			down_payment__c, 
			usedcar_as_down_payment__c , 
			predictive_temp__c, 
			legacy_created_by, 
			legacy_last_upd_by, 
			relatedmodel__c, 
			x_camp_id__c, 
			vechicle_sr_mileage__c, 
			ins_rec_type__c, 
			x_dlr_temperature_receive_dt__c, 
			x_dlr_webmotors_sent_dt__c, 
			x_dlr_dealer_portal_sent_dt__c, 
			usedcar_brand__c, 
			usedcar_model__c, 
			usedcar_chassi__c, 
			usedcar_version__c, 
			usedcar_plate__c, 
			usedcar_year__c, 
			usedcar_color__c, 
			usedcar_km__c, 
			usedcar_max_price__c, 
			usedcar_mid_price__c, 
			usedcar_min_price__c, 
			payment_method__c, 
			payment_status__c, 
			payment_date__c, 
			reserve_amount__c
		)
		select 
			ssr.ROW_ID, 
			ssr.RTNG_DLR_ID,
			ssr.CST_OU_ID,
			ssr.CST_CON_ID,
			ssr.asset_id,
			ssr.owner_emp_id,
			ssr.CREATED, 
			ssr.ACT_CLOSE_DT, 
			ssr.LAST_UPD, 
			ssr.SR_NUM, 
			ssr.REASON_CD, 
			ssr.SR_TYPE_CD, 
			ssr.SR_AREA, 
			ssr.SR_SUB_AREA, 
			ssrx.X_LEVEL_4, 
			CASE when ssrx.ATTRIB_43='Complaint Site' then 'Reclame Aqui' else ssrx.ATTRIB_43 end as ATTRIB_43,		
			ssr.SR_SUBTYPE_CD, 
			regexp_replace(ssr.DESC_TEXT, '"', '\"', 'g') , 
			ssr.SR_STAT_ID, 
			ssr.SR_STAT_DT, 
			ssr.SR_SEV_CD, 
			ssr.RESOLUTION_CD, 
			CASE when ssrx.X_ANONYMOUS_FLG='Y' then true when ssrx.X_ANONYMOUS_FLG='N' then false else null end as X_ANONYMOUS_FLG, 
			ssr.SR_IMPACT_CD, 
			ssrx.ATTRIB_46, 
			ssrx.X_CAUSING_AREA, 
			ssrx.ATTRIB_29, 
			regexp_replace(ssrx.X_QUOTE_DESC, '"', '\"', 'g'),
			ssrx.X_CAR_ENGTRANSM, 
			regexp_replace(ssrx.X_CAR_VERSION, '"', '\"', 'g'),
			ssrx.X_CAR_VERSION_PRICE, 
			ssrx.X_CAR_COLOR, 
			ssrx.X_CAR_COLOR_PRICE,
			ssrx.X_CAR_FINAL_PRICE,
			ssrx.X_CAR_REPL_INTENT, 
			ssr.INTEGRATION_ID, 
			CASE when ssrx.ATTRIB_11='Y' then true when ssrx.ATTRIB_11='N' then false else null end as ATTRIB_11, 
			ssr.X_TEST_DRV_TM, 
			ssr.X_TESTDRV_DT, 
			CASE when ssr.X_PNE_FLG='Y' then true when ssr.X_PNE_FLG='N' then false else null end as X_PNE_FLG, 
			CASE when ssr.X_VIPLIST_CAMPAIGN_ID='Y' then true when ssr.X_VIPLIST_CAMPAIGN_ID='N' then false else null end as X_VIPLIST_CAMPAIGN_ID, 
			ssr.X_VIPLIST_SRC_TAG, 
			ssr.X_VIPLIST_STOCK, 
			ssr.X_VIPLIST_MEDIUM, 
			ssr.X_VIPLIST_CONTENT, 
			ssr.X_VIPLIST_CAMPAIGN, 
			ssr.X_FORM, 
			ssrx.X_ADDITIONAL_COMMENTS, 
			ssrx.X_CAUSING_PERSON, 
			ssrx.X_CUST_REP, 
			ssrx.X_CUST_REP_REL,
			CASE when ssrx.X_DIAGNOSIS_DIFFICULTY='Y' then true when ssrx.X_DIAGNOSIS_DIFFICULTY='N' then false else null end as X_DIAGNOSIS_DIFFICULTY, 
			CASE when ssrx.X_DIAGNOSIS_PENDING='Y' then true when ssrx.X_DIAGNOSIS_PENDING='N' then false else null end as X_DIAGNOSIS_PENDING, 
			regexp_replace(ssrx.X_DLR_DESCRIPTION, '"', '\"', 'g'),
			regexp_replace(ssrx.X_DLR_FUP, '"', '\"', 'g'),
			regexp_replace(ssrx.X_DLR_PENDING, '"', '\"', 'g'),
			CASE when ssrx.X_DLR_RETRACTION='Y' then true when ssrx.X_DLR_RETRACTION='N' then false else null end as X_DLR_RETRACTION, 
			regexp_replace(ssrx.X_DLR_REVERSAL, '"', '\"', 'g'), 
			CASE when ssrx.X_HOTLINE_FLG='Y' then true when ssrx.X_HOTLINE_FLG='N' then false else null end as X_HOTLINE_FLG, 
			ssrx.X_HOTLINE_NUM, 
			ssrx.X_HOTLINE_OPEN_DT, 
			ssrx.X_PURCHASE_PROPOSAL_NUM, 
			CASE when ssrx.X_PWA_FLG='Y' then true when ssrx.X_PWA_FLG='N' then false else null end as X_PWA_FLG, 
			ssrx.X_PWA_NUM, 
			ssrx.X_PWA_OPEN_DT, 
			CASE when ssrx.X_RECURRENCE='Y' then true when ssrx.X_RECURRENCE='N' then false else null end as X_RECURRENCE,
			ssrx.X_RECURRENCE_NUM, 
			ssrx.X_VEHICLE_DELIVERY_DT, 
			CASE when ssrx.X_VEHICLE_DELIVERY_FLG='Y' then true when ssrx.X_VEHICLE_DELIVERY_FLG='N' then false else null end as X_VEHICLE_DELIVERY_FLG, 
			CASE when ssrx.X_OPV_WANTS_LOAN='Y' then true when ssrx.X_OPV_WANTS_LOAN='N' then false else null end as X_OPV_WANTS_LOAN, 
			ssrx.X_OPV_LOAN_TYPE,
			ssrx.X_OPV_INSTALLMENTS_AMT, 
			ssrx.X_OPV_DOWN_PAYMNT, 
			CASE when ssrx.X_OPV_USEDCAR_PAYMNT='Y' then true when ssrx.X_OPV_USEDCAR_PAYMNT='N' then false else null end as X_OPV_USEDCAR_PAYMNT,
			ssrx.X_DLR_TEMPERATURE, 
			ssr.created_by, 
			ssr.last_upd_by, 
			ssr.cem_time_uom_cd, 
			ssr.X_CAMP_ID, 
			ssr.ODOMTR_RDNG, 
			ssr.INS_REC_TYPE, 
			ssrx.X_DLR_TEMPERATURE_RECEIVE_DT, 
			ssrx.X_DLR_WEBMOTORS_SENT_DT, 
			ssrx.X_DLR_DEALER_PORTAL_SENT_DT, 
			ssr.X_USEDCAR_BR, 
			ssr.X_USEDCAR_MD, 
			ssr.X_USEDCAR_CHASSI, 
			ssr.X_USEDCAR_VERSION, 
			ssr.X_USEDCAR_PLATE, 
			ssr.X_USEDCAR_YEAR, 
			ssr.X_USEDCAR_COLOR, 
			ssr.X_USEDCAR_KM, 
			ssr.X_USEDCAR_MAXPRICE, 
			ssr.X_USEDCAR_MEDPRICE, 
			ssr.X_USEDCAR_MINPRICE, 
			ssrx.X_OPV_METHOD_PAYMNT, 
			ssrx.X_OPV_STAT_PAYMNT, 
			ssrx.X_OPV_DATE_PAYMNT, 
			ssrx.X_OPV_RESERV_AMOUNT
		from landing.s_srv_req ssr 
		join 
			landing.s_srv_req_x ssrx 
		on
			ssr.row_id = ssrx.row_id
--		where ssrx.row_id = '1-5CEG0LP'
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_synergy_act_audit();

CREATE OR REPLACE PROCEDURE process.proc_synergy_act_audit()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.synergy_action_audit (
			row_id, 
			legacy_created, 
			legacy_created_by, 
			legacy_last_upd, 
			legacy_last_upd_by, 
			modification_num, 
			name, 
			type__c, 
			question__c, 
			answer__c, 			
--			task_row_id, 
			case_id, 
			sr_row_id, 
			protocol__c
		)
		select 
			ceax.row_id, 
			ceax.created, 
			ceax.created_by, 
			ceax.last_upd, 
			ceax.last_upd_by, 
			ceax.modification_num, 
			ceax.name, 
			ceax.type, 
			ceax.x_attrib_01, 
			ceax.x_attrib_02, 
--			t.row_id, 
			sr.row_id,
			sea.sra_sr_id, 
			sr.protocol__c
		from landing.cx_evt_act_xm ceax 
		left join 
			process.service_event_act sea  
		on
			ceax.par_row_id = sea.row_id 
		left join 
			process.case sr 
		on
			sea.sra_sr_id  = sr.row_id 	;		
--		from landing.cx_evt_act_xm ceax 
--		left join
--			process.task t 
--		on
--			ceax.par_row_id = t.external_id__c 
--		left join 
--			process."case" c 
--		on
--			t.protocol__c = c.protocol__c ;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_synergy_activity();

CREATE OR REPLACE PROCEDURE process.proc_synergy_activity()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.synergy_activity (
			row_id,
			sra_sr_id,
			type,
			priority,
			planneddt__c,
			status__c,
			activitydate,
			completeddatetime,
			answer__c,
			legacy_created,
			legacy_created_by,
			legacy_last_upd,
			legacy_last_upd_by
		)
		select 
			sea.row_id,
			sea.sra_sr_id,
			sea.type,
			sea.priority,
			sea.planneddt__c,
			sea.status__c,
			sea.activitydate,
			sea.completeddatetime,
			sea.answer__c,
			sea.legacy_created,
			sea.legacy_created_by,
			sea.legacy_last_upd,
			sea.legacy_last_upd_by
		from process.service_event_act;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_targetmodel();

CREATE OR REPLACE PROCEDURE process.proc_targetmodel()
 LANGUAGE plpgsql
AS $procedure$
	begin
		truncate table process.targetmodel;
		insert into process.targetmodel(
			contactid__c,
			contact__c,
			gender__c,
			vehicleretentionperiod__c,
			totalnumberoftestdrives__c,
			numberoftestdrives1w__c,
			numberoftestdrives2w__c,
			numberoftestdrives3w__c,
			numberoftestdrives1m__c,
			numberoftestdrives2m__c,
			totalnumberofquotes__c,
			numberofquotes1w__c,
			numberofquotes2w__c,
			numberofquotes3w__c,
			numberofquotes1m__c,
			numberofquotes2m__c,
			totalnumberofcampaignparticipations__c,
			numberofcampaignparticipations1m__c,
			numberofcampaignparticipations1w__c,
			numberofcampaignparticipations2m__c,
			numberofcampaignparticipations2w__c,
			numberofcampaignparticipations3w__c,
			totalnumberofownedvehicles__c,
			numberofownedvehicles1y__c,
			numberofownedvehicles3y__c,
			numberofownedvehicles5y__c,
			age__c,
			agegroup__c,
			blockedsms__c,
			blockedemail__c,
			blockedcall__c,
			blockedwhatsapp__c,
			mailingcountry,
			mailingstate,
			mailingcity,
			ispersonaccount,
			accountid,
			name,
			lastname,
			vehicletype__c,
			latestmileage__c,
			latestpurchasedate__c,
			vehicledeliverydate__c,
			fueltype__c,
			enginecapacity__c,
			modelname__c,
			latestdeliverycarownedyn__c,
			contractchannel__c,
			repairservicepart__c,
			repairservicetype__c,
			latestmantenancedate__c,
			fatiguelimitexceed__c,
			productofinterest__c,
			subsidiarycode__c
		)
		select 	
			aa.sfid as contactid__c,
			aa.sfid as contact__c,
			aa.gender__c,
			(DATE_PART('YEAR', current_date) - DATE_PART('YEAR', ab.VehicleDeliveryDate__c :: DATE)) * 12 + (DATE_PART('Month', current_date) - DATE_PART('Month', ab.VehicleDeliveryDate__c :: DATE)) as Vehicleretentionperiod__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid) totalnumberoftestdrives__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '1 week' and current_date) numberoftestdrives1w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '2 weeks' and current_date) numberoftestdrives2w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '3 weeks' and current_date) numberoftestdrives3w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '1 month' and current_date) numberoftestdrives1m__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Test drive' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '2 months' and current_date) numberoftestdrives2m__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid) totalnumberofquotes__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '1 week' and current_date) numberofquotes1w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '2 weeks' and current_date) numberofquotes2w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '3 weeks' and current_date) numberofquotes3w__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '1 month' and current_date) numberofquotes1m__c,
			(select count(*) from replica.opportunity where replica.opportunity.level2__c = 'Request a quote' and replica.opportunity.accountid = aa.accountid and replica.opportunity.closedate between  current_date - interval '2 months' and current_date) numberofquotes2m__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign') totalnumberofcampaignparticipations__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign' and cast(process."EmailSendLog"."SentDate" as date) between current_date - interval '1 month' and current_date ) numberofcampaignparticipations1m__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign' and cast(process."EmailSendLog"."SentDate" as date) between current_date - interval '1 week' and current_date ) numberofcampaignparticipations1w__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign' and cast(process."EmailSendLog"."SentDate" as date) between current_date - interval '2 months' and current_date ) numberofcampaignparticipations2m__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign' and cast(process."EmailSendLog"."SentDate" as date) between current_date - interval '2 weeks' and current_date ) numberofcampaignparticipations2w__c,
			(select count(*) from process."EmailSendLog" where process."EmailSendLog"."Clicked" = 'TRUE' and process."EmailSendLog"."ContactKey" = aa.sfid and process."EmailSendLog"."ContactType" = 'Campaign' and cast(process."EmailSendLog"."SentDate" as date) between current_date - interval '3 weeks' and current_date ) numberofcampaignparticipations3w__c,
			(select count(*) from replica.asset where replica.asset.accountid = aa.accountid) totalnumberofownedvehicles__c,
			(select count(*) from replica.asset where replica.asset.accountid = aa.accountid and vehicledeliverydate__c between  current_date - interval '1 year' and current_date) numberofownedvehicles1y__c,
			(select count(*) from replica.asset where replica.asset.accountid = aa.accountid and vehicledeliverydate__c between  current_date - interval '3 years' and current_date) numberofownedvehicles3y__c,
			(select count(*) from replica.asset where replica.asset.accountid = aa.accountid and vehicledeliverydate__c between  current_date - interval '5 years' and current_date) numberofownedvehicles5y__c,
			cast(EXTRACT( year FROM age(CURRENT_DATE,aa.birthdate)) as int) age__c,
			((cast(EXTRACT( year FROM age(CURRENT_DATE,aa.birthdate)) as int) / 10) * 10) as agegroup__c,
			aa.BlockedSMS__c as blockedsms__c,
			aa.BlockedEmails__c as blockedemail__c,
			aa.BlockedCalls__c as blockedcall__c,
			aa.BlockedWhatsApp__c as blockedwhatsapp__c,
			aa.mailingcountry,
			aa.mailingstate,
			aa.mailingcity,
			aa.ispersonaccount,
			aa.accountid,
			aa.name,	
			aa.lastname,	
			ab.bodytype__c as vehicletype__c,
			ab.LatestMileage__c as latestmileage__c,
			ab.purchasedate as latestpurchasedate__c,
			ab.VehicleDeliveryDate__c as vehicledeliverydate__c,
			ab.FuelType__c as fueltype__c,
			ab.EngineCapacity__c as enginecapacity__c,
			ab.ModelName__c as modelname__c,
			ad.VehicleOwnYN__c as latestdeliverycarownedyn__c,
			aa.preferredcontactchannel__c as contractchannel__c,			
			ro3.zdesc as repairservicepart__c,
			ro2.zdesc as repairservicetype__c,
			case when ro2.erdat notnull then ro2.erdat else ro3.erdat end as latestmantenancedate__c,
			aa.fatiguelimitexceed1w__c as fatiguelimitexceed__c,
			(select productofinterest__c from replica.account where sfid = aa.accountid order by sfid desc limit 1) as productofinterest__c,
			aa.subsidiarycode__c
		from "replica".contact aa 
		left outer join "replica".asset ab on ab.sfid = (select sfid from "replica".asset as ac where ac.accountid = aa.accountid order by ac.sfid desc limit 1)
		left outer join "replica".customervehicle__c ad on ad.sfid = (select sfid from "replica".customervehicle__c as cv where cv.account__c = aa.accountid order by cv.sfid desc limit 1)		
		left outer join "process".zhbrsdt1728 ro1 on ro1.ro_id = (select ro_id from "process".zhbrsdt1728 as roh where roh.account_id = aa.account__external_id__c order by roh.soid desc limit 1)
		left outer join "process".zhbrsdt1729 ro2 on ro2.ro_service_id = (select ro_service_id from "process".zhbrsdt1729 as rop where rop.ro_id = ro1.ro_id order by rop.ro_service_id desc limit 1)
		left outer join "process".zhbrsdt1730 ro3 on ro3.ro_parts_id = (select ro_parts_id from "process".zhbrsdt1730 as ros where ros.ro_id = ro1.ro_id order by ros.ro_parts_id desc limit 1)
		where aa.subsidiarycode__c = 'HMB' and aa.ispersonaccount = true; -- and aa.sfid in ('003U50000019PmdIAE','003U50000019dSzIAI','003U50000019eIbIAI','003U50000019eX7IAI','003U50000019nSLIAY','003U50000019llWIAQ');
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_task();

CREATE OR REPLACE PROCEDURE process.proc_task()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.task (
			row_id,
			protocol__c,
			sra_sr_id,
			type,
			subject,
			priority,
			planneddt__c,
			ownerid,
			status,
			description,
			activitydate,
			completeddatetime,
			result__c,
			answer__c,
			dealercode__c,
			serialnumber__c,
			plannedenddt__c,
			dealerportaluser__c,
			statussales__c,
			salespersoncode__c,
			interactionstartdate__c,
			reason__c,
			DMSenddate__c,
			DMSreceivedate__c,
			dealerrespondetime__c,
			visitscheduled__c,
			visitdate__c,
			visitstatus__c,
			integrationid__c,
			hotlineid__c,
			hotlinecreation__c,
			pwaid__c,
			pwacreation__c,
			roid__c,
			rocreation__c,
			mobisid__c,
			mobisstatus__c,
			expecteddelivery__c,
			purchasepurposeid__c,
			ordernum__c,
			stock__c
		)
		select 
			sea.row_id,
			ssr.sr_num,
			sea.sra_sr_id,
			sea.todo_cd,
			sea.wc_type_cd,
			sea.evt_priority_cd,
			sea.todo_plan_start_dt,
			sea.owner_login,
			sea.evt_stat_cd,
			sea.comments_long,
			sea.todo_due_dt,
			sea.todo_actl_end_dt,
			seax.attrib_44,
			sea.x_for_dealer,
			soe.OU_NUM,
			sa.serial_num,
			sea.todo_plan_end_dt,
			seax.x_dp_user,
			seax.attrib_45,
			seax.attrib_46,
			seax.attrib_26,
			seax.attrib_47,
			seax.attrib_27,
			seax.attrib_29,
			seax.attrib_15,
			seax.attrib_30,
			seax.attrib_31,
			seax.attrib_34,
			sea.ACTIVITY_UID,
			seax.HOTLINE_ID,
			seax.HOTLINE_DT,
			seax.PWA_ID,
			sea.MDF_ALLOC_ID,
			seax.RO_ID,
			seax.RO_DT,
			seax.MOBIS_ID,
			seax.MOBIS_STATUS,
			seax.EXPECTED_DELIVERY,
			seax.PURCH_PURPOSE_ID,
			sea.ORDER_ID,
			ssr.X_VIPLIST_STOCK
		from landing.s_evt_act sea
		left join
		    landing.s_evt_act_x seax
		on
		    sea.row_id = seax.par_row_id
		left join
		    landing.s_srv_req ssr
		on
		    sea.sra_sr_id  = ssr.row_id 
		left join
			landing.s_asset sa
		on
			sea.asset_id = sa.row_id
		left join
			landing.s_org_ext soe
		on
			sea.X_DLR_ID = soe.par_row_id
		where sea.todo_cd!='Request a quote' and sea.todo_cd !='Test drive - update' and sea.todo_cd !='Test drive - add';
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_testdrive_history();

CREATE OR REPLACE PROCEDURE process.proc_testdrive_history()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.testdrivehistory (
			row_id, 
			protocolid__c, 
			testdrivetype__c, 
			priority__c, 
			testdrivestarttime__c, 
			ownerid, 
			status__c, 
			requestdescription__c, 
			tododuedt, 
			todoactlenddt, 
			achievement, 
			answer, 
			account_id__c,
			contact_id__c,
			dealercode__c, 
			serialnumber__c, 
			testdriveendtime__c, 
			dealerportaluser__c, 
			statussales__c, 
			salespersoncode__c,
			resoninteraction__c, 
			DMSenddate__c, 
			DMSreceivedate__c, 
			dealerrespondetime__c, 
			visitscheduled__c, 
			visitdate__c, 
			visitstatus__c,
			legacy_created, 
			legacy_created_by, 
			legacy_last_upd, 
			legacy_last_upd_by, 
			integrationid__c, 
			testdriverequestdate__c, 
			testdriverequesttime__c, 
--			testdriverequestdatetime__c,
			relatedmodel__c,
			origin
		)
		select 
		    sea.row_id, 
		    sr.protocol__c, 
		    sea.type, 
		    sea.priority, 
		    sea.planneddt__c::timestamp, 
		    sea.ownerid, 
		    sea.status__c, 
		    sea.description, 
		    sea.activitydate, 
		    sea.completeddatetime, 
		    sea.result__c, 
		    sea.answer__c, 
		    sr.account_row_id__c,
		    sr.contact_row_id__c,
		    soe.OU_NUM, 
		    sa.serialnumber,
		    sea.plannedenddt__c, 
		    sea.dpuser__c, 
		    sea.statussales__c, 
		    sea.salespersoncode__c,
		    sea.reason__c, 
		    sea.DMSenddate__c, 
		    sea.DMSreceivedate__c, 
		    sea.dealerrespondetime__c, 
		    sea.visitscheduled__c, 
		    sea.visitdate__c, 
		    sea.visitstatus__c,
		    sr.legacycreateddate__c, 
		    sr.legacy_created_by, 
		    sr.legacy_last_update__c, 
		    sr.legacy_last_upd_by, 
		    sr.integrationid__c, 
		    sr.date_test_drive__c, 
		    sr.testdrive_time__c,
--		    (sr.date_test_drive__c::varchar||' '||replace(split_part(sr.testdrive_time__c , '~', 1), ':', '')||'00')::timestamp,
		    sr.relatedmodel__c,
		    sr.origin
		from process.service_event_act sea 
--		from landing.s_evt_act sea
--		left join
--		    landing.s_evt_act_x seax
--		on
--		    sea.row_id = seax.par_row_id
--		left join
--		    landing.s_srv_req ssr
--		on
--		    sea.sra_sr_id  = ssr.row_id 
		left join
			process.service_request sr 
		on
			sea.sra_sr_id = sr.row_id 
		left join
			process.asset sa
		on
			sea.asset_id = sa.row_id
		left join
			landing.s_org_ext soe
		on
			sr.account_row_id__c = soe.row_id 
		where sea."type"  ='Test drive - update' or sea."type"  ='Test drive - add'	;
--		left join 
--			process.account a 
--		on
--			sea.X_TARGET_PER_ID = a.external_id__c;	
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_user();

CREATE OR REPLACE PROCEDURE process.proc_user()
 LANGUAGE plpgsql
AS $procedure$
	begin
		INSERT INTO process.user(
			row_id,
			legacy_created,
			legacy_created_by,
			legacy_last_upd,
			legacy_last_upd_by,
			conflict_id,
			par_row_id,
			integ_user_flg,
			login,
			user_flg,
			trng_dl_admin_flg,
			ams_last_upd_dt,
			ams_pwd_expr_dt,
			days_comp_trng,
			days_inv_audit,
			days_overdue_ack,
			days_report_loss,
			days_smpl_warning,
			days_transfer_in,
			days_trsfr_discr,
			day_overdue_invchk,
			db_last_upd,
			last_login_ts,
			last_uncompress_dt,
			last_upd_amspwd_dt,
			max_sample_call,
			min_inventory,
			num_nws_archv_days,
			num_nws_hdlns_disp,
			pw_last_upd,
			ams_pwd_freq_cd,
			challenge_answer,
			challenge_question,
			comments,
			cti_acd_userid,
			cti_pwd,
			db_last_upd_src,
			exchng_prof_name,
			exchng_prof_pwd,
			exchng_storeid,
			exchng_sync_type,
			login_domain,
			password,
			rpt_srvr_pwd,
			status_cd,
			trng_cal_cd,
			x_cti_stat,
			x_email_flg,
			x_group_cd,
			x_teleset_no,
			x_vrs_id,
			x_agent_lst_upd,
			chlng_ans_encrpkey,
			chlng_qst_encrpkey,
			pr_tag_id,
			modification_num
		)
		select 
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			conflict_id,
			par_row_id,
			CASE when integ_user_flg='Y' then true when integ_user_flg='N' then false else null end as integ_user_flg,
			login,
			CASE when user_flg='Y' then true when user_flg='N' then false else null end as user_flg,
			CASE when trng_dl_admin_flg='Y' then true when trng_dl_admin_flg='N' then false else null end as trng_dl_admin_flg,
			ams_last_upd_dt,
			ams_pwd_expr_dt,
			days_comp_trng,
			days_inv_audit,
			days_overdue_ack,
			days_report_loss,
			days_smpl_warning,
			days_transfer_in,
			days_trsfr_discr,
			day_overdue_invchk,
			db_last_upd,
			last_login_ts,
			last_uncompress_dt,
			last_upd_amspwd_dt,
			max_sample_call,
			min_inventory,
			num_nws_archv_days,
			num_nws_hdlns_disp,
			pw_last_upd,
			ams_pwd_freq_cd,
			challenge_answer,
			challenge_question,
			comments,
			cti_acd_userid,
			cti_pwd,
			db_last_upd_src,
			exchng_prof_name,
			exchng_prof_pwd,
			exchng_storeid,
			exchng_sync_type,
			login_domain,
			password,
			rpt_srvr_pwd,
			status_cd,
			trng_cal_cd,
			x_cti_stat,
			x_email_flg,
			x_group_cd,
			x_teleset_no,
			x_vrs_id,
			x_agent_lst_upd,
			chlng_ans_encrpkey,
			chlng_qst_encrpkey,
			pr_tag_id,
			modification_num
		from landing.s_user
			;
	END;
$procedure$
;

-- DROP PROCEDURE process.proc_zipcode();

CREATE OR REPLACE PROCEDURE process.proc_zipcode()
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.zipcode(
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			dcking_num,
			modification_num,
			conflict_id,
			country,
			zipcode,
			db_last_upd,
			latitude,
			longitude,
			city,
			continent,
			county,
			db_last_upd_src,
			state_prov,
			street_abbrev,
			street_name,
			x_neighborhood,
			x_user_key,
			x_zipcode,
			x_complement
		)
		select 
			row_id,
			created,
			created_by,
			last_upd,
			last_upd_by,
			dcking_num,
			modification_num,
			conflict_id,
			country,
			zipcode,
			db_last_upd,
			latitude,
			longitude,
			city,
			continent,
			county,
			db_last_upd_src,
			state_prov,
			street_abbrev,
			street_name,
			x_neighborhood,
			x_user_key,
			x_zipcode,
			x_complement
		from landing.s_zipcode 
		;
	END;
$procedure$
;

-- DROP PROCEDURE process.process_account_deplicate(varchar);

CREATE OR REPLACE PROCEDURE process.process_account_deplicate(IN param_id character varying)
 LANGUAGE plpgsql
AS $procedure$
	BEGIN
		INSERT INTO process.account(
		          external_id__c
            		, corporateregistrationnumber__c
            		, name
            		, corporaterepresentativename__c
            		, ori_cd__c
            		, x_contracted_since__c
            		, registrysource__c
            		, phone
            		, fax
            		, emailaddress
            		, website
            		, x_reason_status__c
            		, dealercode__c
            		, region__c
            		, type
            		, prtnrshp_start_dt__c
            		, prtnrshp_end_dt__c
            		, fleet__c
            		, industry
            		, numberofemployees
            		, x_tot_flt_size__c
            		, businesstype__c
            		, dealershoptype__c
            		, personemail
            		, salesflag__c
            		, serviceflag__c
            		, x_working_hours__c
            		, s_social_url__c
            		, x_dlr_srvc_type__c
            		, attrib_14__c
            		, billingstreet
            		, billingstreet_2__c
            		, billingstreet_3__c
            		, billingcountry
            		, billingcity
            		, billingstate
            		, billingpostalcode
            		, billinglatitude
            		, billinglongitude
            		, x_sales_rep__c
            		, description
            		, x_attrib_99__c
            		, x_dms__c
            		, x_api_key__c
            		, x_whatsapp_ph_num__c
            		, personassistantphone
            		, cust_stat_cd__c
            
		)
			select
				soe.INTEGRATION_ID, soe.X_CNPJ, soe.Name, soe.X_NICKNAME, soe.ORI_CD, soe.X_CONTRACTED_SINCE
				, soe.SOURCE_CD, soe.MAIN_PH_NUM, soe.MAIN_FAX_PH_NUM, soe.MAIN_EMAIL_ADDR, soe.URL, soe.X_REASON_STATUS
				, soe.OU_NUM, soe.REGION, soe.ACCNT_TYPE_CD, soe.PRTNRSHP_START_DT, sop.PTSHP_END_DT, soex.X_FLT_ACCT_TYPE
				, soex.X_FLT_IND_TYPE, soex.ATTRIB_07, soex.X_TOT_FLT_SIZE, soex.X_FLT_ORG_TYPE, soex.ATTRIB_39, soex.ATTRIB_51
				, soex.ATTRIB_10, soex.ATTRIB_11, soex.X_WORKING_HOURS, soex.X_SOCIAL_URL, soex2.X_DLR_SRVC_TYPE, soex.ATTRIB_14
				, sap.ADDR, sap.ADDR_LINE_2, sap.ADDR_LINE_3, sap.COUNTY, sap.CITY, sap.STATE, sap.ZIPCODE, sap.LATITUDE
				, sap.LONGITUDE, soe.X_SALES_REP, soe.DESC_TEXT, soex.X_ATTRIB_99, soex.X_DMS, soex.X_API_KEY, soe.X_WHATSAPP_PH_NUM
				, soe.X_SCHEDULING_PH_NUM, soe.CUST_STAT_CD
		
	        from
	            landing.s_org_ext soe
			join
	            landing.s_org_ext_x soex
	        on
	            soe.row_id = soex.par_row_id            
			join 
	            landing.s_addr_per sap
	        on
	            soe.pr_addr_id = sap.row_id           
	        join
	            landing.s_org_ext_xm soex2
	        on
	            soe.row_id = soex2.par_row_id
	        join
	            landing.s_org_prtnr sop
	        on
	            soe.row_id = sop.par_row_id 
			where row_id = PARAM_ID;
	END;
$procedure$
;